# Reproduces LocalStack CloudFormation v2 deletion bug
#
# This is a minimal template demonstrating a bug in LocalStack's CloudFormation v2 engine.
# The bug causes stack deletion to fail when a template contains:
# 1. A conditionally-created resource (with `Condition:` attribute)
# 2. Another resource that references it via `!GetAtt` inside an `!If`
# 3. The condition evaluated to `false` during creation (resource was NOT created)
#
# Steps to reproduce:
#
# 1. Start LocalStack WITHOUT legacy engine (using v2 engine - the default):
#    docker run -p 4566:4566 -e SERVICES=cloudformation,sqs localstack/localstack
#
# 2. Deploy with condition=false (SQS queue NOT created):
#    aws --endpoint-url=http://localhost:4566 cloudformation create-stack \
#      --stack-name repro-bug \
#      --template-body file://localstack-v2-bug-repro.yaml \
#      --parameters ParameterKey=DeployQueue,ParameterValue=false
#
# 3. Wait for CREATE_COMPLETE:
#    aws --endpoint-url=http://localhost:4566 cloudformation wait stack-create-complete \
#      --stack-name repro-bug
#
# 4. Delete stack (this FAILS with v2 engine):
#    aws --endpoint-url=http://localhost:4566 cloudformation delete-stack \
#      --stack-name repro-bug
#
# Expected: Stack deletes successfully
# Actual (v2): "Template format error: Unresolved resource dependencies [MyQueue]
#              in the Resources block of the template"
#
# Workaround: Use PROVIDER_OVERRIDE_CLOUDFORMATION=engine-legacy
#    docker run -p 4566:4566 \
#      -e SERVICES=cloudformation,sqs \
#      -e PROVIDER_OVERRIDE_CLOUDFORMATION=engine-legacy \
#      localstack/localstack

AWSTemplateFormatVersion: '2010-09-09'
Description: Minimal reproduction of LocalStack v2 CloudFormation deletion bug

Parameters:
  DeployQueue:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether to deploy the conditional SQS queue

Conditions:
  ShouldDeployQueue: !Equals [!Ref DeployQueue, 'true']

Resources:
  # This resource is conditionally created
  MyQueue:
    Type: AWS::SQS::Queue
    Condition: ShouldDeployQueue
    Properties:
      QueueName: conditional-queue

  # This resource always exists but references the conditional resource
  # When ShouldDeployQueue=false, MyQueue doesn't exist, but v2 engine
  # still tries to resolve !GetAtt MyQueue.Arn during deletion
  AlwaysCreatedResource:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: always-created-queue
      Tags:
        - Key: ConditionalQueueArn
          # This !If should handle the case when MyQueue doesn't exist,
          # but v2 engine incorrectly resolves !GetAtt MyQueue.Arn during
          # deletion even when MyQueue was never created
          Value: !If
            - ShouldDeployQueue
            - !GetAtt MyQueue.Arn
            - "not-deployed"

Outputs:
  AlwaysCreatedQueueUrl:
    Description: URL of the always-created queue
    Value: !Ref AlwaysCreatedResource

  ConditionalQueueUrl:
    Condition: ShouldDeployQueue
    Description: URL of the conditional queue (only when deployed)
    Value: !Ref MyQueue
