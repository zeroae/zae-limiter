AWSTemplateFormatVersion: '2010-09-09'
Description: >
  zae-limiter infrastructure - DynamoDB table with streams and
  Lambda aggregator for usage snapshots.

Parameters:
  SnapshotWindows:
    Type: String
    Default: hourly,daily
    Description: Comma-separated list of snapshot windows (hourly, daily, monthly)

  SnapshotRetentionDays:
    Type: Number
    Default: 90
    Description: Number of days to retain usage snapshots
    MinValue: 1
    MaxValue: 3650

  LambdaMemorySize:
    Type: Number
    Default: 256
    Description: Memory size for the aggregator Lambda
    MinValue: 128
    MaxValue: 3008

  LambdaTimeout:
    Type: Number
    Default: 60
    Description: Timeout for the aggregator Lambda in seconds
    MinValue: 1
    MaxValue: 900

  EnableAggregator:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether to deploy the aggregator Lambda

  SchemaVersion:
    Type: String
    Default: '1.0.0'
    Description: Schema version for the rate limiter infrastructure

  PITRRecoveryPeriodDays:
    Type: String
    Default: ''
    Description: >
      (Optional) Number of days for Point-in-Time Recovery period (1-35).
      Leave empty to use AWS default (35 days). Not supported in all AWS partitions (e.g., aws-iso).

  EnableAlarms:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether to deploy CloudWatch alarms for monitoring

  AlarmSNSTopicArn:
    Type: String
    Default: ''
    Description: (Optional) SNS topic ARN for alarm notifications. Leave empty to skip SNS notifications.

  LogRetentionDays:
    Type: Number
    Default: 30
    AllowedValues:
      - 1
      - 3
      - 5
      - 7
      - 14
      - 30
      - 60
      - 90
      - 120
      - 150
      - 180
      - 365
      - 400
      - 545
      - 731
      - 1096
      - 1827
      - 2192
      - 2557
      - 2922
      - 3288
      - 3653
    Description: Number of days to retain Lambda logs (CloudWatch standard retention periods)

  LambdaDurationThreshold:
    Type: Number
    Default: 48000
    Description: Lambda duration alarm threshold in milliseconds (default 48000 = 80% of 60s timeout)
    MinValue: 1
    MaxValue: 900000

  PermissionBoundary:
    Type: String
    Default: ''
    Description: >
      (Optional) IAM permission boundary for the Lambda execution role.
      Accepts policy name or full ARN. If a name is provided,
      the ARN is constructed automatically.

  AggregatorRoleName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the Lambda aggregator execution role.
      If empty, uses default: {stack_name}-aggr.

  AppRoleName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the application IAM role.
      If empty, uses default: {stack_name}-app.

  AdminRoleName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the admin IAM role.
      If empty, uses default: {stack_name}-admin.

  ReadOnlyRoleName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the read-only IAM role.
      If empty, uses default: {stack_name}-read.

  RoleNameFormat:
    Type: String
    Default: ''
    Description: >
      (Optional) Format template for IAM role names. Use {} as placeholder.
      Example: 'PowerUserPB-{}' produces 'PowerUserPB-mystack-aggr'.
      Exported for use by dependent stacks (e.g., stress test).

  AcquireOnlyPolicyName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the acquire-only IAM managed policy.
      If empty, uses default: {stack_name}-acq.

  FullAccessPolicyName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the full-access IAM managed policy.
      If empty, uses default: {stack_name}-full.

  ReadOnlyPolicyName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the read-only IAM managed policy.
      If empty, uses default: {stack_name}-read.

  NamespaceAcquirePolicyName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the namespace-scoped acquire-only IAM managed policy.
      If empty, uses default: {stack_name}-ns-acq.

  NamespaceFullAccessPolicyName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the namespace-scoped full-access IAM managed policy.
      If empty, uses default: {stack_name}-ns-full.

  NamespaceReadOnlyPolicyName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom name for the namespace-scoped read-only IAM managed policy.
      If empty, uses default: {stack_name}-ns-read.

  EnableAuditArchival:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Archive expired audit events to S3 via TTL deletion

  AuditArchiveGlacierTransitionDays:
    Type: Number
    Default: 90
    Description: Days before transitioning audit archives to Glacier Instant Retrieval
    MinValue: 1
    MaxValue: 3650

  EnableTracing:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether to enable AWS X-Ray tracing for the aggregator Lambda

  EnableIAMRoles:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether to create App/Admin/ReadOnly IAM roles for application access

  EnableIAM:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: >
      Create IAM resources (managed policies, roles). Set to false for restricted
      IAM environments (e.g., PowerUserAccess). When false, aggregator is disabled
      unless AggregatorRoleArn is provided.

  AggregatorRoleArn:
    Type: String
    Default: ''
    Description: >
      (Optional) ARN of an existing IAM role for the Lambda aggregator.
      Use this to deploy with a pre-created role when you lack iam:CreateRole
      permissions.

  EnableDeletionProtection:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable DynamoDB table deletion protection

Conditions:
  # Basic toggles from parameters
  DeployAggregator: !Equals [!Ref EnableAggregator, 'true']
  DeployAlarms: !Equals [!Ref EnableAlarms, 'true']
  DeployIAMRoles: !Equals [!Ref EnableIAMRoles, 'true']
  DeployIAM: !Equals [!Ref EnableIAM, 'true']
  UsePITRRecoveryPeriod: !Not [!Equals [!Ref PITRRecoveryPeriodDays, '']]
  UseExternalAggregatorRole: !Not [!Equals [!Ref AggregatorRoleArn, '']]

  # Optional resource name checks
  HasSNSTopic: !Not [!Equals [!Ref AlarmSNSTopicArn, '']]
  HasPermissionBoundary: !Not [!Equals [!Ref PermissionBoundary, '']]
  HasCustomAggregatorRoleName: !Not [!Equals [!Ref AggregatorRoleName, '']]
  HasCustomAppRoleName: !Not [!Equals [!Ref AppRoleName, '']]
  HasCustomAdminRoleName: !Not [!Equals [!Ref AdminRoleName, '']]
  HasCustomReadOnlyRoleName: !Not [!Equals [!Ref ReadOnlyRoleName, '']]
  HasCustomAcquireOnlyPolicyName: !Not [!Equals [!Ref AcquireOnlyPolicyName, '']]
  HasCustomFullAccessPolicyName: !Not [!Equals [!Ref FullAccessPolicyName, '']]
  HasCustomReadOnlyPolicyName: !Not [!Equals [!Ref ReadOnlyPolicyName, '']]
  HasCustomNamespaceAcquirePolicyName: !Not [!Equals [!Ref NamespaceAcquirePolicyName, '']]
  HasCustomNamespaceFullAccessPolicyName: !Not [!Equals [!Ref NamespaceFullAccessPolicyName, '']]
  HasCustomNamespaceReadOnlyPolicyName: !Not [!Equals [!Ref NamespaceReadOnlyPolicyName, '']]
  PermissionBoundaryIsArn: !Equals
    - !Select [0, !Split [':', !Ref PermissionBoundary]]
    - 'arn'

  # Create aggregator role only if: IAM enabled AND no external role provided AND aggregator enabled
  CreateAggregatorRole: !And
    - !Condition DeployAggregator
    - !Condition DeployIAM
    - !Not [!Condition UseExternalAggregatorRole]

  # Deploy aggregator Lambda if: aggregator enabled AND (IAM enabled OR external role)
  DeployAggregatorLambda: !And
    - !Condition DeployAggregator
    - !Or
      - !Condition DeployIAM
      - !Condition UseExternalAggregatorRole

  # Deploy app/admin/read roles only if IAM enabled AND role creation enabled
  DeployIAMRolesWithIAM: !And
    - !Condition DeployIAMRoles
    - !Condition DeployIAM

  # Aggregator alarms depend on Lambda being deployed
  DeployAggregatorAlarms: !And
    - !Condition DeployAggregatorLambda
    - !Condition DeployAlarms

  DeployAuditArchive: !And
    - !Condition DeployAggregatorLambda
    - !Equals [!Ref EnableAuditArchival, 'true']

  TracingEnabled: !And
    - !Condition DeployAggregatorLambda
    - !Equals [!Ref EnableTracing, 'true']
  EnableTableDeletionProtection: !Equals [!Ref EnableDeletionProtection, 'true']

Resources:
  # -------------------------------------------------------------------------
  # DynamoDB Table
  # -------------------------------------------------------------------------
  RateLimitsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref AWS::StackName
      BillingMode: PAY_PER_REQUEST
      DeletionProtectionEnabled: !If
        - EnableTableDeletionProtection
        - true
        - false

      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
        - AttributeName: GSI4PK
          AttributeType: S
        - AttributeName: GSI4SK
          AttributeType: S

      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE

      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

        - IndexName: GSI3
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: KEYS_ONLY

        - IndexName: GSI4
          KeySchema:
            - AttributeName: GSI4PK
              KeyType: HASH
            - AttributeName: GSI4SK
              KeyType: RANGE
          Projection:
            ProjectionType: KEYS_ONLY

      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
        RecoveryPeriodInDays: !If
          - UsePITRRecoveryPeriod
          - !Ref PITRRecoveryPeriodDays
          - !Ref AWS::NoValue

      Tags:
        - Key: Application
          Value: zae-limiter

  # -------------------------------------------------------------------------
  # Audit Archive S3 Bucket
  # -------------------------------------------------------------------------
  AuditArchiveBucket:
    Type: AWS::S3::Bucket
    Condition: DeployAuditArchive
    Properties:
      # BucketName omitted: CloudFormation auto-generates a globally unique name
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: TransitionToGlacier
            Status: Enabled
            Transitions:
              - TransitionInDays: !Ref AuditArchiveGlacierTransitionDays
                StorageClass: GLACIER_IR
      Tags:
        - Key: Application
          Value: zae-limiter

  # -------------------------------------------------------------------------
  # IAM Managed Policies (Created when EnableIAM=true)
  # -------------------------------------------------------------------------

  # AcquireOnlyPolicy: For applications running acquire() - read + transact write
  AcquireOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: DeployIAM
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - W3037  # TransactWriteItems is valid but missing from cfn-lint's action database
    Properties:
      ManagedPolicyName: !If
        - HasCustomAcquireOnlyPolicyName
        - !Ref AcquireOnlyPolicyName
        - !Sub ${AWS::StackName}-acq
      Description: Rate limiter acquire-only access (read + transact write)
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Query
              - dynamodb:TransactWriteItems
            Resource:
              - !GetAtt RateLimitsTable.Arn
              - !Sub ${RateLimitsTable.Arn}/index/*

  # FullAccessPolicy: Full access for apps and ops - all operations
  FullAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: DeployIAM
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - W3037  # TransactWriteItems is valid but missing from cfn-lint's action database
    Properties:
      ManagedPolicyName: !If
        - HasCustomFullAccessPolicyName
        - !Ref FullAccessPolicyName
        - !Sub ${AWS::StackName}-full
      Description: Rate limiter full access (all operations)
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Query
              - dynamodb:Scan
              - dynamodb:DescribeTable
              - dynamodb:TransactWriteItems
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:UpdateItem
              - dynamodb:BatchWriteItem
            Resource:
              - !GetAtt RateLimitsTable.Arn
              - !Sub ${RateLimitsTable.Arn}/index/*

  # ReadOnlyPolicy: For observability/monitoring - read only
  ReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: DeployIAM
    Properties:
      ManagedPolicyName: !If
        - HasCustomReadOnlyPolicyName
        - !Ref ReadOnlyPolicyName
        - !Sub ${AWS::StackName}-read
      Description: Rate limiter read-only access (monitoring)
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Query
              - dynamodb:Scan
              - dynamodb:DescribeTable
            Resource:
              - !GetAtt RateLimitsTable.Arn
              - !Sub ${RateLimitsTable.Arn}/index/*

  # -------------------------------------------------------------------------
  # Namespace-Scoped IAM Managed Policies (Created when EnableIAM=true)
  # Tag-based access control using zael_namespace_id principal tag.
  # LeadingKeys restricts DynamoDB access to items within the tagged namespace.
  # -------------------------------------------------------------------------

  # NamespaceAcquirePolicy: For tenant apps running acquire() - scoped to namespace
  NamespaceAcquirePolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: DeployIAM
    Properties:
      ManagedPolicyName: !If
        - HasCustomNamespaceAcquirePolicyName
        - !Ref NamespaceAcquirePolicyName
        - !Sub ${AWS::StackName}-ns-acq
      Description: Namespace-scoped acquire-only access (read + update within namespace)
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: NamespaceAcquireAccess
            Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Query
              - dynamodb:UpdateItem
            Resource:
              - !GetAtt RateLimitsTable.Arn
              - !Sub ${RateLimitsTable.Arn}/index/*
            Condition:
              ForAllValues:StringLike:
                dynamodb:LeadingKeys:
                  - "${aws:PrincipalTag/zael_namespace_id}/*"
          - Sid: SharedReadAccess
            Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Query
            Resource:
              - !GetAtt RateLimitsTable.Arn
              - !Sub ${RateLimitsTable.Arn}/index/*
            Condition:
              ForAllValues:StringLike:
                dynamodb:LeadingKeys:
                  - "_/*"

  # NamespaceFullAccessPolicy: Full access scoped to namespace + shared prefix
  NamespaceFullAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: DeployIAM
    Properties:
      ManagedPolicyName: !If
        - HasCustomNamespaceFullAccessPolicyName
        - !Ref NamespaceFullAccessPolicyName
        - !Sub ${AWS::StackName}-ns-full
      Description: Namespace-scoped full access (all operations within namespace)
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: NamespaceFullAccess
            Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Query
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
            Resource:
              - !GetAtt RateLimitsTable.Arn
              - !Sub ${RateLimitsTable.Arn}/index/*
            Condition:
              ForAllValues:StringLike:
                dynamodb:LeadingKeys:
                  - "${aws:PrincipalTag/zael_namespace_id}/*"
                  - "_/*"

  # NamespaceReadOnlyPolicy: Read-only access scoped to namespace + shared prefix
  NamespaceReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: DeployIAM
    Properties:
      ManagedPolicyName: !If
        - HasCustomNamespaceReadOnlyPolicyName
        - !Ref NamespaceReadOnlyPolicyName
        - !Sub ${AWS::StackName}-ns-read
      Description: Namespace-scoped read-only access (monitoring within namespace)
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: NamespaceReadAccess
            Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Query
            Resource:
              - !GetAtt RateLimitsTable.Arn
              - !Sub ${RateLimitsTable.Arn}/index/*
            Condition:
              ForAllValues:StringLike:
                dynamodb:LeadingKeys:
                  - "${aws:PrincipalTag/zael_namespace_id}/*"
                  - "_/*"

  # -------------------------------------------------------------------------
  # Lambda Aggregator
  # -------------------------------------------------------------------------
  AggregatorDLQ:
    Type: AWS::SQS::Queue
    Condition: DeployAggregator
    Properties:
      QueueName: !Sub ${AWS::StackName}-aggregator-dlq
      MessageRetentionPeriod: 1209600  # 14 days (max retention)
      VisibilityTimeout: 300  # 5 minutes
      Tags:
        - Key: Application
          Value: zae-limiter

  AggregatorDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAggregatorAlarms
    Properties:
      AlarmName: !Sub ${AWS::StackName}-aggregator-dlq-alarm
      AlarmDescription: Alert when messages appear in the aggregator DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300  # 5 minutes
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt AggregatorDLQ.QueueName
      TreatMissingData: notBreaching

  AggregatorLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: DeployAggregator
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}-aggregator
      RetentionInDays: !Ref LogRetentionDays

  AggregatorRole:
    Type: AWS::IAM::Role
    Condition: CreateAggregatorRole
    Properties:
      RoleName: !If
        - HasCustomAggregatorRoleName
        - !Ref AggregatorRoleName
        - !Sub ${AWS::StackName}-aggr
      PermissionsBoundary: !If
        - HasPermissionBoundary
        - !If
          - PermissionBoundaryIsArn
          - !Ref PermissionBoundary
          - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/${PermissionBoundary}'
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole

      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"

      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Read/write access to table
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt RateLimitsTable.Arn
                  - !Sub ${RateLimitsTable.Arn}/index/*

              # Stream access
              - Effect: Allow
                Action:
                  - dynamodb:GetRecords
                  - dynamodb:GetShardIterator
                  - dynamodb:DescribeStream
                  - dynamodb:ListStreams
                Resource:
                  - !GetAtt RateLimitsTable.StreamArn

              # DLQ access
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  - !GetAtt AggregatorDLQ.Arn

        - !If
          - DeployAuditArchive
          - PolicyName: S3ArchiveAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - s3:PutObject
                  Resource:
                    - !Sub ${AuditArchiveBucket.Arn}/*
          - !Ref AWS::NoValue

        - !If
          - TracingEnabled
          - PolicyName: XRayAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - xray:PutTraceSegments
                    - xray:PutTelemetryRecords
                  Resource: '*'
          - !Ref AWS::NoValue

  # -------------------------------------------------------------------------
  # Application IAM Roles
  # -------------------------------------------------------------------------

  # AppRole: For applications running acquire() - read + transact write
  AppRole:
    Type: AWS::IAM::Role
    Condition: DeployIAMRolesWithIAM
    Properties:
      RoleName: !If
        - HasCustomAppRoleName
        - !Ref AppRoleName
        - !Sub ${AWS::StackName}-app
      PermissionsBoundary: !If
        - HasPermissionBoundary
        - !If
          - PermissionBoundaryIsArn
          - !Ref PermissionBoundary
          - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/${PermissionBoundary}
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref AcquireOnlyPolicy
      Tags:
        - Key: Application
          Value: zae-limiter
        - Key: Role
          Value: app

  # AdminRole: For ops team managing config - full CRUD
  AdminRole:
    Type: AWS::IAM::Role
    Condition: DeployIAMRolesWithIAM
    Properties:
      RoleName: !If
        - HasCustomAdminRoleName
        - !Ref AdminRoleName
        - !Sub ${AWS::StackName}-admin
      PermissionsBoundary: !If
        - HasPermissionBoundary
        - !If
          - PermissionBoundaryIsArn
          - !Ref PermissionBoundary
          - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/${PermissionBoundary}
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref FullAccessPolicy
      Tags:
        - Key: Application
          Value: zae-limiter
        - Key: Role
          Value: admin

  # ReadOnlyRole: For observability/monitoring - read only
  ReadOnlyRole:
    Type: AWS::IAM::Role
    Condition: DeployIAMRolesWithIAM
    Properties:
      RoleName: !If
        - HasCustomReadOnlyRoleName
        - !Ref ReadOnlyRoleName
        - !Sub ${AWS::StackName}-read
      PermissionsBoundary: !If
        - HasPermissionBoundary
        - !If
          - PermissionBoundaryIsArn
          - !Ref PermissionBoundary
          - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/${PermissionBoundary}
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref ReadOnlyPolicy
      Tags:
        - Key: Application
          Value: zae-limiter
        - Key: Role
          Value: readonly

  AggregatorFunction:
    Type: AWS::Lambda::Function
    Condition: DeployAggregatorLambda
    DependsOn: AggregatorLogGroup
    Properties:
      FunctionName: !Sub ${AWS::StackName}-aggregator
      Description: Aggregates rate limiter usage into hourly/daily snapshots
      Runtime: python3.12
      Handler: zae_limiter_aggregator.handler.handler
      MemorySize: !Ref LambdaMemorySize
      Timeout: !Ref LambdaTimeout
      Role: !If
        - UseExternalAggregatorRole
        - !Ref AggregatorRoleArn
        - !GetAtt AggregatorRole.Arn

      TracingConfig:
        Mode: !If [TracingEnabled, Active, PassThrough]

      Environment:
        Variables:
          TABLE_NAME: !Ref AWS::StackName
          SNAPSHOT_WINDOWS: !Ref SnapshotWindows
          SNAPSHOT_TTL_DAYS: !Ref SnapshotRetentionDays
          ZAE_LIMITER_SCHEMA_VERSION: !Ref SchemaVersion
          ENABLE_ARCHIVAL: !Ref EnableAuditArchival
          ARCHIVE_BUCKET_NAME: !If
            - DeployAuditArchive
            - !Ref AuditArchiveBucket
            - ''

      # Note: Code must be deployed separately via SAM, CDK, or manual upload
      # This is a placeholder that will need to be replaced
      Code:
        ZipFile: |
          def handler(event, context):
              # Placeholder Lambda - intentionally fails to trigger ESM retries.
              # Events will be retried and processed by real code after deployment.
              raise RuntimeError("Placeholder Lambda - waiting for code deployment")

      Tags:
        - Key: Application
          Value: zae-limiter

  AggregatorEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Condition: DeployAggregatorLambda
    Properties:
      EventSourceArn: !GetAtt RateLimitsTable.StreamArn
      FunctionName: !Ref AggregatorFunction
      StartingPosition: LATEST
      BatchSize: 100
      MaximumBatchingWindowInSeconds: 5
      MaximumRetryAttempts: 3
      MaximumRecordAgeInSeconds: 3600  # 1 hour
      BisectBatchOnFunctionError: true

      # Send failed batches to DLQ
      DestinationConfig:
        OnFailure:
          Destination: !GetAtt AggregatorDLQ.Arn

      # Filter to process:
      # 1. MODIFY events on BUCKET records (for usage snapshots)
      # 2. REMOVE events on AUDIT records (for S3 archival)
      FilterCriteria:
        Filters:
          # Usage snapshots: bucket modifications
          - Pattern: >-
              {
                "eventName": ["MODIFY"],
                "dynamodb": {
                  "NewImage": {
                    "SK": {
                      "S": [{"prefix": "#BUCKET#"}]
                    }
                  }
                }
              }
          # Audit archival: TTL-deleted audit events
          - Pattern: >-
              {
                "eventName": ["REMOVE"],
                "dynamodb": {
                  "OldImage": {
                    "PK": {
                      "S": [{"prefix": "AUDIT#"}]
                    }
                  }
                }
              }

  # -------------------------------------------------------------------------
  # CloudWatch Alarms
  # -------------------------------------------------------------------------
  LambdaErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAggregatorAlarms
    Properties:
      AlarmName: !Sub ${AWS::StackName}-aggregator-error-rate
      AlarmDescription: Alert when Lambda error rate exceeds 1%
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300  # 5 minutes
      EvaluationPeriods: 2
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref AggregatorFunction
      TreatMissingData: notBreaching
      AlarmActions: !If
        - HasSNSTopic
        - [!Ref AlarmSNSTopicArn]
        - !Ref AWS::NoValue

  LambdaDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAggregatorAlarms
    Properties:
      AlarmName: !Sub ${AWS::StackName}-aggregator-duration
      AlarmDescription: !Sub Alert when Lambda duration exceeds threshold (${LambdaDurationThreshold}ms)
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 300  # 5 minutes
      EvaluationPeriods: 2
      Threshold: !Ref LambdaDurationThreshold
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref AggregatorFunction
      TreatMissingData: notBreaching
      AlarmActions: !If
        - HasSNSTopic
        - [!Ref AlarmSNSTopicArn]
        - !Ref AWS::NoValue

  DynamoDBReadThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub ${AWS::StackName}-read-throttle
      AlarmDescription: Alert when DynamoDB read requests are throttled
      MetricName: ReadThrottleEvents
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300  # 5 minutes
      EvaluationPeriods: 2
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref RateLimitsTable
      TreatMissingData: notBreaching
      AlarmActions: !If
        - HasSNSTopic
        - [!Ref AlarmSNSTopicArn]
        - !Ref AWS::NoValue

  DynamoDBWriteThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    Properties:
      AlarmName: !Sub ${AWS::StackName}-write-throttle
      AlarmDescription: Alert when DynamoDB write requests are throttled
      MetricName: WriteThrottleEvents
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300  # 5 minutes
      EvaluationPeriods: 2
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref RateLimitsTable
      TreatMissingData: notBreaching
      AlarmActions: !If
        - HasSNSTopic
        - [!Ref AlarmSNSTopicArn]
        - !Ref AWS::NoValue

  StreamIteratorAgeAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAggregatorAlarms
    Properties:
      AlarmName: !Sub ${AWS::StackName}-stream-iterator-age
      AlarmDescription: Alert when stream processing lag exceeds 30 seconds
      MetricName: IteratorAge
      Namespace: AWS/Lambda
      Statistic: Maximum
      Period: 300  # 5 minutes
      EvaluationPeriods: 2
      Threshold: 30000  # 30 seconds in milliseconds
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref AggregatorFunction
      TreatMissingData: notBreaching
      AlarmActions: !If
        - HasSNSTopic
        - [!Ref AlarmSNSTopicArn]
        - !Ref AWS::NoValue

Outputs:
  TableName:
    Description: DynamoDB table name
    Value: !Ref RateLimitsTable
    Export:
      Name: !Sub ${AWS::StackName}-TableName

  TableArn:
    Description: DynamoDB table ARN
    Value: !GetAtt RateLimitsTable.Arn
    Export:
      Name: !Sub ${AWS::StackName}-TableArn

  StreamArn:
    Description: DynamoDB stream ARN
    Value: !GetAtt RateLimitsTable.StreamArn
    Export:
      Name: !Sub ${AWS::StackName}-StreamArn

  AggregatorFunctionArn:
    Condition: DeployAggregatorLambda
    Description: Aggregator Lambda function ARN
    Value: !GetAtt AggregatorFunction.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AggregatorArn

  AggregatorFunctionName:
    Condition: DeployAggregatorLambda
    Description: Aggregator Lambda function name
    Value: !Ref AggregatorFunction
    Export:
      Name: !Sub ${AWS::StackName}-AggregatorName

  AggregatorDLQUrl:
    Condition: DeployAggregator
    Description: Aggregator Dead Letter Queue URL
    Value: !Ref AggregatorDLQ
    Export:
      Name: !Sub ${AWS::StackName}-DLQUrl

  AggregatorDLQArn:
    Condition: DeployAggregator
    Description: Aggregator Dead Letter Queue ARN
    Value: !GetAtt AggregatorDLQ.Arn
    Export:
      Name: !Sub ${AWS::StackName}-DLQArn

  AggregatorDLQAlarmName:
    Condition: DeployAggregatorAlarms
    Description: CloudWatch alarm for DLQ monitoring
    Value: !Ref AggregatorDLQAlarm
    Export:
      Name: !Sub ${AWS::StackName}-DLQAlarmName

  LambdaErrorRateAlarmName:
    Condition: DeployAggregatorAlarms
    Description: CloudWatch alarm for Lambda error rate
    Value: !Ref LambdaErrorRateAlarm
    Export:
      Name: !Sub ${AWS::StackName}-LambdaErrorRateAlarmName

  LambdaDurationAlarmName:
    Condition: DeployAggregatorAlarms
    Description: CloudWatch alarm for Lambda duration
    Value: !Ref LambdaDurationAlarm
    Export:
      Name: !Sub ${AWS::StackName}-LambdaDurationAlarmName

  DynamoDBReadThrottleAlarmName:
    Condition: DeployAlarms
    Description: CloudWatch alarm for DynamoDB read throttles
    Value: !Ref DynamoDBReadThrottleAlarm
    Export:
      Name: !Sub ${AWS::StackName}-ReadThrottleAlarmName

  DynamoDBWriteThrottleAlarmName:
    Condition: DeployAlarms
    Description: CloudWatch alarm for DynamoDB write throttles
    Value: !Ref DynamoDBWriteThrottleAlarm
    Export:
      Name: !Sub ${AWS::StackName}-WriteThrottleAlarmName

  StreamIteratorAgeAlarmName:
    Condition: DeployAggregatorAlarms
    Description: CloudWatch alarm for stream iterator age
    Value: !Ref StreamIteratorAgeAlarm
    Export:
      Name: !Sub ${AWS::StackName}-StreamIteratorAgeAlarmName

  AuditArchiveBucketName:
    Condition: DeployAuditArchive
    Description: S3 bucket name for audit event archives
    Value: !Ref AuditArchiveBucket
    Export:
      Name: !Sub ${AWS::StackName}-AuditArchiveBucketName

  AuditArchiveBucketArn:
    Condition: DeployAuditArchive
    Description: S3 bucket ARN for audit event archives
    Value: !GetAtt AuditArchiveBucket.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AuditArchiveBucketArn

  # -------------------------------------------------------------------------
  # IAM Managed Policy Outputs (Created when EnableIAM=true)
  # -------------------------------------------------------------------------

  AcquireOnlyPolicyArn:
    Condition: DeployIAM
    Description: IAM managed policy ARN for acquire-only operations
    Value: !Ref AcquireOnlyPolicy
    Export:
      Name: !Sub ${AWS::StackName}-AcquireOnlyPolicyArn

  FullAccessPolicyArn:
    Condition: DeployIAM
    Description: IAM managed policy ARN for full access (all operations)
    Value: !Ref FullAccessPolicy
    Export:
      Name: !Sub ${AWS::StackName}-FullAccessPolicyArn

  ReadOnlyPolicyArn:
    Condition: DeployIAM
    Description: IAM managed policy ARN for read-only access (monitoring)
    Value: !Ref ReadOnlyPolicy
    Export:
      Name: !Sub ${AWS::StackName}-ReadOnlyPolicyArn

  # -------------------------------------------------------------------------
  # Namespace-Scoped IAM Managed Policy Outputs
  # -------------------------------------------------------------------------

  NamespaceAcquirePolicyArn:
    Condition: DeployIAM
    Description: IAM managed policy ARN for namespace-scoped acquire-only access
    Value: !Ref NamespaceAcquirePolicy
    Export:
      Name: !Sub ${AWS::StackName}-NamespaceAcquirePolicyArn

  NamespaceFullAccessPolicyArn:
    Condition: DeployIAM
    Description: IAM managed policy ARN for namespace-scoped full access
    Value: !Ref NamespaceFullAccessPolicy
    Export:
      Name: !Sub ${AWS::StackName}-NamespaceFullAccessPolicyArn

  NamespaceReadOnlyPolicyArn:
    Condition: DeployIAM
    Description: IAM managed policy ARN for namespace-scoped read-only access
    Value: !Ref NamespaceReadOnlyPolicy
    Export:
      Name: !Sub ${AWS::StackName}-NamespaceReadOnlyPolicyArn

  # -------------------------------------------------------------------------
  # Application IAM Role Outputs
  # -------------------------------------------------------------------------

  AppRoleArn:
    Condition: DeployIAMRolesWithIAM
    Description: IAM role ARN for applications (acquire/release operations)
    Value: !GetAtt AppRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AppRoleArn

  AppRoleName:
    Condition: DeployIAMRolesWithIAM
    Description: IAM role name for applications
    Value: !Ref AppRole
    Export:
      Name: !Sub ${AWS::StackName}-AppRoleName

  AdminRoleArn:
    Condition: DeployIAMRolesWithIAM
    Description: IAM role ARN for administrators (config management)
    Value: !GetAtt AdminRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AdminRoleArn

  AdminRoleName:
    Condition: DeployIAMRolesWithIAM
    Description: IAM role name for administrators
    Value: !Ref AdminRole
    Export:
      Name: !Sub ${AWS::StackName}-AdminRoleName

  ReadOnlyRoleArn:
    Condition: DeployIAMRolesWithIAM
    Description: IAM role ARN for read-only access (monitoring)
    Value: !GetAtt ReadOnlyRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-ReadOnlyRoleArn

  ReadOnlyRoleName:
    Condition: DeployIAMRolesWithIAM
    Description: IAM role name for read-only access
    Value: !Ref ReadOnlyRole
    Export:
      Name: !Sub ${AWS::StackName}-ReadOnlyRoleName

  # -------------------------------------------------------------------------
  # IAM Configuration Outputs (for stress test stack to import)
  # -------------------------------------------------------------------------

  PermissionBoundaryArn:
    Description: Permission boundary ARN used for IAM roles (empty if none)
    Value: !If
      - HasPermissionBoundary
      - !If
        - PermissionBoundaryIsArn
        - !Ref PermissionBoundary
        - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/${PermissionBoundary}'
      - ''
    Export:
      Name: !Sub ${AWS::StackName}-PermissionBoundaryArn

  RoleNameFormat:
    Description: Role name format template (empty if using defaults)
    Value: !Ref RoleNameFormat
    Export:
      Name: !Sub ${AWS::StackName}-RoleNameFormat

  CodeBucketName:
    Condition: DeployAuditArchive
    Description: S3 bucket name for deployment artifacts (reuses audit archive bucket)
    Value: !Ref AuditArchiveBucket
    Export:
      Name: !Sub ${AWS::StackName}-CodeBucketName
