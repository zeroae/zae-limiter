
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Rate limiting library backed by DynamoDB using the token bucket algorithm">
      
      
        <meta name="author" content="ZeroAE">
      
      
        <link rel="canonical" href="https://zeroae.github.io/zae-limiter/0.10.1/contributing/architecture/">
      
      
        <link rel="prev" href="../testing/">
      
      
        <link rel="next" href="../../adr/000-adr-format-standard/">
      
      
        
      
      
      <link rel="icon" href="../../assets/zae-limiter.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Architecture - zae-limiter</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="zae-limiter" class="md-header__button md-logo" aria-label="zae-limiter" data-md-component="logo">
      
  <img src="../../assets/zae-limiter-icon-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            zae-limiter
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Architecture
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zeroae/zae-limiter" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zeroae/zae-limiter
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="zae-limiter" class="md-nav__button md-logo" aria-label="zae-limiter" data-md-component="logo">
      
  <img src="../../assets/zae-limiter-icon-white.svg" alt="logo">

    </a>
    zae-limiter
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zeroae/zae-limiter" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zeroae/zae-limiter
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/token-bucket/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Token Bucket Algorithm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/basic-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/config-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hierarchical/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hierarchical Limits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/llm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/usage-snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage Snapshots
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/unavailability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unavailability Handling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Operator Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Operator Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/cloudformation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CloudFormation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Migrations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Migrations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../migrations/namespace-keys/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Namespace Keys (v0.10.0)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/auditing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Auditing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/limiter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RateLimiter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/repository/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repository
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmarks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmarks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Contributing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Development Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../localstack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LocalStack
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dynamodb-schema-single-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        DynamoDB Schema (Single Table)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDB Schema (Single Table)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-secondary-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Secondary Indexes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#namespace-isolation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Namespace Isolation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimized-read-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimized Read Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-resolution-adr-122" class="md-nav__link">
    <span class="md-ellipsis">
      
        Config Resolution (ADR-122)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#item-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Item Structure
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-bucket-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Token Bucket Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token Bucket Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Functions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mathematical-formulas" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical Formulas
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integer-arithmetic-for-precision" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integer Arithmetic for Precision
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refill-rate-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Refill Rate Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lazy-refill-with-drift-compensation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lazy Refill with Drift Compensation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negative-buckets-debt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Negative Buckets (Debt)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design Decisions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#atomicity-and-write-paths" class="md-nav__link">
    <span class="md-ellipsis">
      
        Atomicity and Write Paths
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Atomicity and Write Paths">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#write-path-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Write Path Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transactwriteitems-initial-consumption" class="md-nav__link">
    <span class="md-ellipsis">
      
        TransactWriteItems (Initial Consumption)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#independent-writes-adjustments-and-rollbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Independent Writes (Adjustments and Rollbacks)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speculative-write-path-issue-315" class="md-nav__link">
    <span class="md-ellipsis">
      
        Speculative Write Path (Issue #315)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregator-refill-path-issue-317" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aggregator Refill Path (Issue #317)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimistic-locking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimistic Locking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Project Structure
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Design Decisions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ADRs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    ADRs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/000-adr-format-standard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR Format
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Foundational (v0.1.0-v0.4.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Foundational (v0.1.0-v0.4.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/001-single-table-dynamodb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-001 Single-Table DynamoDB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/002-integer-arithmetic-millitokens/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-002 Integer Arithmetic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/003-cloudformation-infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-003 CloudFormation Infra
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/004-declarative-stack-options/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-004 StackOptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/005-exception-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-005 Exception Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/006-flat-schema-snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-006 Flat Schema Snapshots
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/007-input-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-007 Input Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/008-security-audit-logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-008 Audit Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/009-version-migration-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-009 Version Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/010-total-consumed-counter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-010 Consumed Counter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/011-api-cli-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-011 API/CLI Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/012-cloudformation-docs-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-012 CloudFormation Docs Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/013-module-documentation-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-013 Module Documentation Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Centralized Config (v0.5.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Centralized Config (v0.5.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/100-centralized-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-100 Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/101-flat-schema-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-101 Flat Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/102-config-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-102 Config Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/103-config-caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-103 Config Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/104-stored-limits-default/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-104 Stored Limits Default
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/105-eventual-consistency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-105 Eventual Consistency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/106-audit-entity-ids-for-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-106 Audit Entity IDs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/107-iam-roles-for-application-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-107 IAM Roles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Repository Protocol (v0.5.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Repository Protocol (v0.5.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/108-repository-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-108 Repository Protocol
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/109-backend-capability-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-109 Backend Capabilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/110-deprecation-constructor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-110 Deprecation Strategy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Schema & Infra (v0.6.0+)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Schema & Infra (v0.6.0+)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/111-flatten-all-records/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-111 Flatten All Records
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/112-cascade-per-entity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-112 Cascade Per Entity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/113-lambda-packaging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-113 Lambda Packaging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dynamodb-schema-single-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        DynamoDB Schema (Single Table)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDB Schema (Single Table)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-secondary-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Secondary Indexes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#namespace-isolation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Namespace Isolation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimized-read-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimized Read Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-resolution-adr-122" class="md-nav__link">
    <span class="md-ellipsis">
      
        Config Resolution (ADR-122)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#item-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Item Structure
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-bucket-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Token Bucket Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token Bucket Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Functions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mathematical-formulas" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical Formulas
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integer-arithmetic-for-precision" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integer Arithmetic for Precision
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refill-rate-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Refill Rate Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lazy-refill-with-drift-compensation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lazy Refill with Drift Compensation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negative-buckets-debt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Negative Buckets (Debt)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design Decisions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#atomicity-and-write-paths" class="md-nav__link">
    <span class="md-ellipsis">
      
        Atomicity and Write Paths
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Atomicity and Write Paths">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#write-path-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Write Path Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transactwriteitems-initial-consumption" class="md-nav__link">
    <span class="md-ellipsis">
      
        TransactWriteItems (Initial Consumption)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#independent-writes-adjustments-and-rollbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Independent Writes (Adjustments and Rollbacks)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speculative-write-path-issue-315" class="md-nav__link">
    <span class="md-ellipsis">
      
        Speculative Write Path (Issue #315)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregator-refill-path-issue-317" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aggregator Refill Path (Issue #317)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimistic-locking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimistic Locking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Project Structure
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Design Decisions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
  
  
                  


  
    <a href="https://github.com/zeroae/zae-limiter/edit/main/docs/contributing/architecture.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h1>
<p>This guide covers the internal architecture of zae-limiter, including the DynamoDB schema and token bucket implementation.</p>
<h2 id="dynamodb-schema-single-table">DynamoDB Schema (Single Table)<a class="headerlink" href="#dynamodb-schema-single-table" title="Permanent link">&para;</a></h2>
<p>All data is stored in a single DynamoDB table using a composite key pattern:</p>
<table>
<thead>
<tr>
<th>Record Type</th>
<th>PK</th>
<th>SK</th>
</tr>
</thead>
<tbody>
<tr>
<td>Entity metadata</td>
<td><code>{ns}/ENTITY#{id}</code></td>
<td><code>#META</code></td>
</tr>
<tr>
<td>Bucket (v0.9.0+)</td>
<td><code>{ns}/BUCKET#{id}#{resource}#{shard}</code></td>
<td><code>#STATE</code></td>
</tr>
<tr>
<td>Entity config</td>
<td><code>{ns}/ENTITY#{id}</code></td>
<td><code>#CONFIG#{resource}</code></td>
</tr>
<tr>
<td>Resource config</td>
<td><code>{ns}/RESOURCE#{resource}</code></td>
<td><code>#CONFIG</code></td>
</tr>
<tr>
<td>System config</td>
<td><code>{ns}/SYSTEM#</code></td>
<td><code>#CONFIG</code></td>
</tr>
<tr>
<td>Usage snapshot</td>
<td><code>{ns}/ENTITY#{id}</code></td>
<td><code>#USAGE#{resource}#{window_key}</code></td>
</tr>
<tr>
<td>System version</td>
<td><code>{ns}/SYSTEM#</code></td>
<td><code>#VERSION</code></td>
</tr>
<tr>
<td>Audit events</td>
<td><code>{ns}/AUDIT#{entity_id}</code></td>
<td><code>#AUDIT#{timestamp}</code></td>
</tr>
<tr>
<td>Namespace forward</td>
<td><code>_/SYSTEM#</code></td>
<td><code>#NAMESPACE#{name}</code></td>
</tr>
<tr>
<td>Namespace reverse</td>
<td><code>_/SYSTEM#</code></td>
<td><code>#NSID#{id}</code></td>
</tr>
</tbody>
</table>
<h3 id="global-secondary-indexes">Global Secondary Indexes<a class="headerlink" href="#global-secondary-indexes" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Index</th>
<th>Purpose</th>
<th>Key Pattern</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>GSI1</strong></td>
<td>Parent  Children lookup</td>
<td><code>GSI1PK={ns}/PARENT#{id}</code>  <code>GSI1SK=CHILD#{id}</code></td>
</tr>
<tr>
<td><strong>GSI2</strong></td>
<td>Resource aggregation</td>
<td><code>GSI2PK={ns}/RESOURCE#{name}</code>  buckets/usage</td>
</tr>
<tr>
<td><strong>GSI3</strong></td>
<td>Entity config queries (sparse) + Bucket discovery by entity (KEYS_ONLY)</td>
<td><code>GSI3PK={ns}/ENTITY_CONFIG#{resource}</code>  <code>GSI3SK=entity_id</code> or <code>GSI3PK={ns}/ENTITY#{id}</code>  <code>GSI3SK=BUCKET#{resource}#{shard}</code></td>
</tr>
<tr>
<td><strong>GSI4</strong></td>
<td>Namespace item discovery (KEYS_ONLY)</td>
<td><code>GSI4PK={ns}</code>  <code>GSI4SK=PK</code></td>
</tr>
</tbody>
</table>
<h3 id="access-patterns">Access Patterns<a class="headerlink" href="#access-patterns" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Query</th>
</tr>
</thead>
<tbody>
<tr>
<td>Get entity</td>
<td><code>PK={ns}/ENTITY#{id}, SK=#META</code></td>
</tr>
<tr>
<td>Get bucket (specific shard)</td>
<td><code>PK={ns}/BUCKET#{id}#{resource}#{shard}, SK=#STATE</code></td>
</tr>
<tr>
<td>Get buckets (all resources)</td>
<td>GSI3: <code>GSI3PK={ns}/ENTITY#{id}</code> then BatchGetItem on discovered PKs</td>
</tr>
<tr>
<td>Batch get buckets</td>
<td><code>BatchGetItem</code> with multiple <code>PK={ns}/BUCKET#{id}#{resource}#0, SK=#STATE</code> pairs</td>
</tr>
<tr>
<td>Get children</td>
<td>GSI1: <code>GSI1PK={ns}/PARENT#{id}</code></td>
</tr>
<tr>
<td>Resource capacity</td>
<td>GSI2: <code>GSI2PK={ns}/RESOURCE#{name}, SK begins_with BUCKET#</code></td>
</tr>
<tr>
<td>Get version</td>
<td><code>PK={ns}/SYSTEM#, SK=#VERSION</code></td>
</tr>
<tr>
<td>Get audit events</td>
<td><code>PK={ns}/AUDIT#{entity_id}, SK begins_with #AUDIT#</code></td>
</tr>
<tr>
<td>Get usage snapshots</td>
<td><code>PK={ns}/ENTITY#{id}, SK begins_with #USAGE#</code></td>
</tr>
<tr>
<td>Get system config</td>
<td><code>PK={ns}/SYSTEM#, SK=#CONFIG</code></td>
</tr>
<tr>
<td>Get resource config</td>
<td><code>PK={ns}/RESOURCE#{resource}, SK=#CONFIG</code></td>
</tr>
<tr>
<td>Get entity config</td>
<td><code>PK={ns}/ENTITY#{id}, SK=#CONFIG#{resource}</code></td>
</tr>
<tr>
<td>List entities with custom limits</td>
<td>GSI3: <code>GSI3PK={ns}/ENTITY_CONFIG#{resource}</code></td>
</tr>
<tr>
<td>Namespace forward lookup</td>
<td><code>PK=_/SYSTEM#, SK=#NAMESPACE#{name}</code></td>
</tr>
<tr>
<td>Namespace reverse lookup</td>
<td><code>PK=_/SYSTEM#, SK=#NSID#{id}</code></td>
</tr>
<tr>
<td>List all items in namespace</td>
<td>GSI4: <code>GSI4PK={ns}</code></td>
</tr>
</tbody>
</table>
<h3 id="namespace-isolation">Namespace Isolation<a class="headerlink" href="#namespace-isolation" title="Permanent link">&para;</a></h3>
<p>All partition key values are prefixed with an opaque namespace ID (<code>{ns}/</code>), providing logical isolation between tenants within a single DynamoDB table. The reserved namespace <code>_</code> is used for the namespace registry itself (forward and reverse lookup records).</p>
<ul>
<li><strong>Namespace ID format</strong>: 11-character opaque string generated via <code>secrets.token_urlsafe(8)</code></li>
<li><strong>Default namespace</strong>: Automatically registered on first deploy (CLI) or <code>RepositoryBuilder.build()</code></li>
<li><strong>GSI4</strong>: A KEYS_ONLY index on <code>GSI4PK=namespace_id</code> enables <code>purge_namespace()</code> to discover and delete all items belonging to a namespace</li>
</ul>
<h3 id="optimized-read-patterns">Optimized Read Patterns<a class="headerlink" href="#optimized-read-patterns" title="Permanent link">&para;</a></h3>
<p>The <code>acquire()</code> operation uses <code>BatchGetItem</code> to fetch all required buckets in a
single DynamoDB round trip (see <a href="https://github.com/zeroae/zae-limiter/issues/133">Issue #133</a>):</p>
<div class="language-python lint-only highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Before: N sequential GetItem calls</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">limit_name</span> <span class="ow">in</span> <span class="n">bucket_keys</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">bucket</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_bucket</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">limit_name</span><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1"># After: 1 BatchGetItem call</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">buckets</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_get_buckets</span><span class="p">(</span><span class="n">bucket_keys</span><span class="p">)</span>
</span></code></pre></div>
<p>This optimization is particularly beneficial for cascade scenarios where both
entity and parent buckets are fetched together, reducing latency from
2N round trips to 1.</p>
<h3 id="config-resolution-adr-122">Config Resolution (ADR-122)<a class="headerlink" href="#config-resolution-adr-122" title="Permanent link">&para;</a></h3>
<p>Config resolution uses the 4-level hierarchy: <strong>Entity (resource-specific) &gt; Entity (<code>_default_</code>) &gt; Resource &gt; System</strong>. This logic lives on <code>Repository.resolve_limits()</code>, not on <code>RateLimiter</code>. Each backend can use native resolution strategies (e.g., SQL <code>UNION ALL</code>, Redis Lua scripts). The DynamoDB implementation uses <code>BatchGetItem</code> for all 4 config keys in a single round trip, with <code>ConfigCache</code> as an internal caching layer (60s TTL by default).</p>
<div class="language-python lint-only highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Repository resolves limits internally (ADR-122)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">limits</span><span class="p">,</span> <span class="n">on_unavailable</span><span class="p">,</span> <span class="n">config_source</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">resolve_limits</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># config_source: &quot;entity&quot;, &quot;entity_default&quot;, &quot;resource&quot;, &quot;system&quot;, or None</span>
</span></code></pre></div>
<p>Cache management methods (<code>invalidate_config_cache()</code>, <code>get_cache_stats()</code>) are on <code>Repository</code>, not <code>RateLimiter</code>. The <code>config_cache_ttl</code> parameter is on the <code>Repository</code> constructor.</p>
<h3 id="item-structure">Item Structure<a class="headerlink" href="#item-structure" title="Permanent link">&para;</a></h3>
<p>All records use <strong>flat schema</strong> (v0.6.0+, top-level attributes, no nested <code>data.M</code>).
See <a href="../../adr/111-flatten-all-records/">ADR-111</a>.</p>
<div class="language-python lint-only highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Entity record (FLAT structure):</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{ns}</span><span class="s2">/ENTITY#user-1&quot;</span><span class="p">,</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="s2">&quot;#META&quot;</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="s2">&quot;entity_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;User One&quot;</span><span class="p">,</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="s2">&quot;parent_id&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Bucket records</strong> (composite, one item per entity+resource+shard, v0.9.0+):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Bucket record (FLAT structure, ADR-114/115, GHSA-76rv):</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{ns}</span><span class="s2">/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>   <span class="c1"># per-(entity, resource, shard) PK</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="s2">&quot;#STATE&quot;</span><span class="p">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="s2">&quot;entity_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                       <span class="c1"># total shards for this entity+resource</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="s2">&quot;b_tpm_tk&quot;</span><span class="p">:</span> <span class="mi">9500000</span><span class="p">,</span>                    <span class="c1"># tokens_milli for tpm limit</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="s2">&quot;b_tpm_cp&quot;</span><span class="p">:</span> <span class="mi">10000000</span><span class="p">,</span>                   <span class="c1"># capacity_milli for tpm limit</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="s2">&quot;b_tpm_tc&quot;</span><span class="p">:</span> <span class="mi">500000</span><span class="p">,</span>                     <span class="c1"># total_consumed_milli for tpm</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="s2">&quot;b_rpm_tk&quot;</span><span class="p">:</span> <span class="mi">95000</span><span class="p">,</span>                      <span class="c1"># tokens_milli for rpm limit</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="s2">&quot;b_rpm_cp&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>                     <span class="c1"># capacity_milli for rpm limit</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="s2">&quot;b_rpm_tc&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>                       <span class="c1"># total_consumed_milli for rpm</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="s2">&quot;b_wcu_tk&quot;</span><span class="p">:</span> <span class="mi">999000</span><span class="p">,</span>                     <span class="c1"># wcu infrastructure limit tokens</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="s2">&quot;b_wcu_cp&quot;</span><span class="p">:</span> <span class="mi">1000000</span><span class="p">,</span>                    <span class="c1"># wcu capacity (1000 WCU/sec)</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="s2">&quot;b_wcu_tc&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>                       <span class="c1"># wcu total consumed</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="s2">&quot;rf&quot;</span><span class="p">:</span> <span class="mi">1704067200000</span><span class="p">,</span>                    <span class="c1"># last_refill_ms (shared across limits)</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="s2">&quot;cascade&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="s2">&quot;GSI2PK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{ns}</span><span class="s2">/RESOURCE#gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="s2">&quot;GSI2SK&quot;</span><span class="p">:</span> <span class="s2">&quot;BUCKET#user-1#0&quot;</span><span class="p">,</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="s2">&quot;GSI3PK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{ns}</span><span class="s2">/ENTITY#user-1&quot;</span><span class="p">,</span>         <span class="c1"># bucket discovery by entity</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    <span class="s2">&quot;GSI3SK&quot;</span><span class="p">:</span> <span class="s2">&quot;BUCKET#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="s2">&quot;ttl&quot;</span><span class="p">:</span> <span class="mi">1234567890</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>The <code>wcu</code> (write capacity unit) limit is a reserved infrastructure limit auto-injected on every bucket. It tracks per-partition write pressure and is hidden from user-facing output (get_buckets, RateLimitExceeded, usage snapshots). When exhausted, the client doubles <code>shard_count</code> to spread writes across more DynamoDB partitions.</p>
<p>The <code>total_consumed_milli</code> counter tracks net consumption (increases on consume,
decreases on release) and is used by the aggregator Lambda to accurately calculate
consumption deltas. This counter is independent of token bucket refill, solving
the issue where <code>old_tokens - new_tokens</code> gives incorrect results when refill rate
exceeds consumption rate. See <a href="https://github.com/zeroae/zae-limiter/issues/179">Issue #179</a>.</p>
<p><strong>Usage snapshots use a FLAT structure</strong> (no nested <code>data</code> map):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Usage snapshot (FLAT structure):</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{ns}</span><span class="s2">/ENTITY#user-1&quot;</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="s2">&quot;#USAGE#gpt-4#2024-01-01T14:00:00Z&quot;</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="s2">&quot;entity_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>        <span class="c1"># Top-level attribute</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="s2">&quot;window&quot;</span><span class="p">:</span> <span class="s2">&quot;hourly&quot;</span><span class="p">,</span>         <span class="c1"># Top-level attribute</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="s2">&quot;window_start&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>      <span class="c1"># Top-level attribute</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>                <span class="c1"># Counter at top-level</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="s2">&quot;total_events&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>         <span class="c1"># Counter at top-level</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="s2">&quot;GSI2PK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{ns}</span><span class="s2">/RESOURCE#gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="s2">&quot;ttl&quot;</span><span class="p">:</span> <span class="mi">1234567890</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Why snapshots are flat:</strong> DynamoDB has a limitation where you cannot SET a map path
(<code>#data = if_not_exists(#data, :map)</code>) AND ADD to paths within it (<code>#data.counter</code>)
in the same UpdateExpression - it fails with "overlapping document paths" error.
Snapshots require atomic upsert (create-or-update) with ADD counters for usage
aggregation, so they use a flat structure to enable single-call atomic updates.</p>
<p>See: <a href="https://github.com/zeroae/zae-limiter/issues/168">Issue #168</a></p>
<p><strong>Config records use composite items</strong> (v0.8.0+, ADR-114). All limits for a config level are stored in a single item:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Resource config (composite, FLAT structure):</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="p">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{ns}</span><span class="s2">/RESOURCE#gpt-4&quot;</span><span class="p">,</span>       <span class="c1"># or {ns}/SYSTEM# or {ns}/ENTITY#{id}</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="s2">&quot;#CONFIG&quot;</span><span class="p">,</span>                   <span class="c1"># or #CONFIG#{resource} for entity level</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="s2">&quot;l_tpm_cp&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>               <span class="c1"># capacity for tpm limit</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="s2">&quot;l_tpm_ra&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>               <span class="c1"># refill_amount for tpm limit</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="s2">&quot;l_tpm_rp&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>                   <span class="c1"># refill_period_seconds for tpm limit</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="s2">&quot;config_version&quot;</span><span class="p">:</span> <span class="mi">1</span>               <span class="c1"># Atomic counter for cache invalidation</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>Config records use four-level precedence: <strong>Entity (resource-specific) &gt; Entity (<em>default</em>) &gt; Resource &gt; System &gt; Constructor defaults</strong>.</p>
<p><strong>Key builders:</strong></p>
<ul>
<li><code>pk_system(namespace_id)</code> - Returns <code>{ns}/SYSTEM#</code></li>
<li><code>pk_resource(namespace_id, resource)</code> - Returns <code>{ns}/RESOURCE#{resource}</code></li>
<li><code>pk_entity(namespace_id, entity_id)</code> - Returns <code>{ns}/ENTITY#{entity_id}</code></li>
<li><code>pk_bucket(namespace_id, entity_id, resource, shard_id)</code> - Returns <code>{ns}/BUCKET#{id}#{resource}#{shard}</code> (v0.9.0+)</li>
<li><code>sk_state()</code> - Returns <code>#STATE</code> (bucket state sort key)</li>
<li><code>sk_config()</code> - Returns <code>#CONFIG</code> (system/resource level)</li>
<li><code>sk_config(resource)</code> - Returns <code>#CONFIG#{resource}</code> (entity level)</li>
<li><code>sk_namespace(name)</code> - Returns <code>#NAMESPACE#{name}</code> (forward lookup)</li>
<li><code>sk_nsid(id)</code> - Returns <code>#NSID#{id}</code> (reverse lookup)</li>
<li><code>gsi3_pk_entity(namespace_id, entity_id)</code> - Returns <code>{ns}/ENTITY#{id}</code> (bucket discovery)</li>
<li><code>gsi3_sk_bucket(resource, shard_id)</code> - Returns <code>BUCKET#{resource}#{shard}</code> (bucket discovery)</li>
<li><code>parse_bucket_pk(pk)</code> - Parses <code>{ns}/BUCKET#{id}#{res}#{shard}</code> into components</li>
</ul>
<p><strong>Audit entity IDs for config levels</strong> (see <a href="../../adr/106-audit-entity-ids-for-config/">ADR-106</a>):</p>
<ul>
<li>System config: Uses <code>$SYSTEM</code> as entity_id</li>
<li>Resource config: Uses <code>$RESOURCE:{resource_name}</code> (e.g., <code>$RESOURCE:gpt-4</code>)</li>
</ul>
<h2 id="token-bucket-implementation">Token Bucket Implementation<a class="headerlink" href="#token-bucket-implementation" title="Permanent link">&para;</a></h2>
<p>For a conceptual overview of the token bucket algorithm, see the <a href="../../guide/token-bucket/">User Guide</a>. This section covers implementation details for contributors.</p>
<h3 id="core-functions">Core Functions<a class="headerlink" href="#core-functions" title="Permanent link">&para;</a></h3>
<p>The algorithm is implemented in <a href="https://github.com/zeroae/zae-limiter/blob/main/src/zae_limiter/bucket.py"><code>bucket.py</code></a>:</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>refill_bucket()</code></td>
<td>Calculate refilled tokens with drift compensation</td>
</tr>
<tr>
<td><code>try_consume()</code></td>
<td>Atomic check-and-consume operation</td>
</tr>
<tr>
<td><code>force_consume()</code></td>
<td>Force consume (can go negative)</td>
</tr>
<tr>
<td><code>calculate_retry_after()</code></td>
<td>Calculate wait time for deficit</td>
</tr>
<tr>
<td><code>calculate_available()</code></td>
<td>Calculate currently available tokens</td>
</tr>
<tr>
<td><code>build_limit_status()</code></td>
<td>Build a LimitStatus for a bucket check</td>
</tr>
<tr>
<td><code>would_refill_satisfy()</code></td>
<td>Check if refilling would allow a request to succeed (speculative writes)</td>
</tr>
</tbody>
</table>
<h3 id="mathematical-formulas">Mathematical Formulas<a class="headerlink" href="#mathematical-formulas" title="Permanent link">&para;</a></h3>
<p><strong>Refill calculation</strong> (lazy, on-demand):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>tokens_to_add = (elapsed_ms  refill_amount_milli) // refill_period_ms
</span></code></pre></div>
<p><strong>Drift compensation</strong> (prevents accumulated rounding errors):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>time_used_ms = (tokens_to_add  refill_period_ms) // refill_amount_milli
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>new_last_refill = last_refill_ms + time_used_ms
</span></code></pre></div>
<p>The inverse calculation ensures we only "consume" the time that corresponds to whole tokens, preventing drift over many refill cycles.</p>
<p><strong>Retry-after calculation</strong>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>time_ms = (deficit_milli  refill_period_ms) // refill_amount_milli
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>retry_seconds = (time_ms + 1) / 1000.0  # +1ms rounds up
</span></code></pre></div>
<h3 id="integer-arithmetic-for-precision">Integer Arithmetic for Precision<a class="headerlink" href="#integer-arithmetic-for-precision" title="Permanent link">&para;</a></h3>
<p>All token values are stored as <strong>millitokens</strong> (1000) to avoid floating-point precision issues in distributed systems:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># User sees: 100 tokens/minute</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># Stored as: 100,000 millitokens/minute</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">capacity_milli</span> <span class="o">=</span> <span class="mi">100_000</span>
</span></code></pre></div>
<p><strong>Why integers matter in distributed systems:</strong></p>
<ul>
<li>Floating-point operations can produce different results on different hardware</li>
<li>DynamoDB stores numbers as strings, so precision loss can occur during serialization</li>
<li>Rate limiting across multiple nodes requires identical calculations</li>
</ul>
<h3 id="refill-rate-storage">Refill Rate Storage<a class="headerlink" href="#refill-rate-storage" title="Permanent link">&para;</a></h3>
<p>Refill rates are stored as a fraction (amount/period) rather than a decimal:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># 100 tokens per minute stored as:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">refill_amount_milli</span> <span class="o">=</span> <span class="mi">100_000</span>  <span class="c1"># millitokens (numerator)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">refill_period_ms</span> <span class="o">=</span> <span class="mi">60_000</span>      <span class="c1"># milliseconds (denominator)</span>
</span></code></pre></div>
<p>This avoids representing <code>1.6667 tokens/second</code> as a float. Instead:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># 100 tokens/minute = 100,000 millitokens / 60,000 ms</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="c1"># Integer division handles the math precisely</span>
</span></code></pre></div>
<h3 id="lazy-refill-with-drift-compensation">Lazy Refill with Drift Compensation<a class="headerlink" href="#lazy-refill-with-drift-compensation" title="Permanent link">&para;</a></h3>
<p>Tokens are calculated on-demand rather than via a background timer. The <code>refill_bucket()</code> function:</p>
<ol>
<li>Calculates elapsed time since last refill</li>
<li>Computes tokens to add using integer division</li>
<li>Tracks "time consumed" to prevent drift</li>
</ol>
<div class="language-python lint-only highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># From bucket.py:refill_bucket()</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">tokens_to_add</span> <span class="o">=</span> <span class="p">(</span><span class="n">elapsed_ms</span> <span class="o">*</span> <span class="n">refill_amount_milli</span><span class="p">)</span> <span class="o">//</span> <span class="n">refill_period_ms</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># Drift compensation: only advance time for tokens actually added</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">time_used_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">tokens_to_add</span> <span class="o">*</span> <span class="n">refill_period_ms</span><span class="p">)</span> <span class="o">//</span> <span class="n">refill_amount_milli</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">new_last_refill</span> <span class="o">=</span> <span class="n">last_refill_ms</span> <span class="o">+</span> <span class="n">time_used_ms</span>
</span></code></pre></div>
<p>Without drift compensation, repeated calls with small time intervals would accumulate rounding errors.</p>
<h3 id="negative-buckets-debt">Negative Buckets (Debt)<a class="headerlink" href="#negative-buckets-debt" title="Permanent link">&para;</a></h3>
<p>Buckets can go negative to support post-hoc reconciliation:</p>
<div class="language-python lint-only highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Estimate 500 tokens, actually used 2000</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">async</span> <span class="k">with</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">consume</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">})</span> <span class="k">as</span> <span class="n">lease</span><span class="p">:</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="n">actual</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_llm</span><span class="p">()</span>  <span class="c1"># Returns 2000 tokens</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="k">await</span> <span class="n">lease</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">tpm</span><span class="o">=</span><span class="mi">2000</span> <span class="o">-</span> <span class="mi">500</span><span class="p">)</span>  <span class="c1"># Bucket at -1500</span>
</span></code></pre></div>
<p>The <code>force_consume()</code> function handles this:</p>
<div class="language-python lint-only highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># From bucket.py:force_consume()</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="c1"># Consume can go negative - no bounds checking</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">new_tokens_milli</span> <span class="o">=</span> <span class="n">refill</span><span class="o">.</span><span class="n">new_tokens_milli</span> <span class="o">-</span> <span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span></code></pre></div>
<p>The debt is repaid as tokens refill over time. A bucket at -1500 millitokens needs 1.5 minutes to reach 0 (at 1000 tokens/minute).</p>
<h3 id="design-decisions">Design Decisions<a class="headerlink" href="#design-decisions" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Decision</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td>Integer over float</td>
<td>Identical results across distributed nodes; no precision drift</td>
</tr>
<tr>
<td>Lazy over continuous</td>
<td>No background timers; accurate retry_after; efficient</td>
</tr>
<tr>
<td>Negative allowed</td>
<td>Estimate-then-reconcile pattern; operations with unknown cost</td>
</tr>
<tr>
<td>Fraction over decimal</td>
<td>Exact representation of rates like 100/minute</td>
</tr>
</tbody>
</table>
<h2 id="atomicity-and-write-paths">Atomicity and Write Paths<a class="headerlink" href="#atomicity-and-write-paths" title="Permanent link">&para;</a></h2>
<h3 id="write-path-overview">Write Path Overview<a class="headerlink" href="#write-path-overview" title="Permanent link">&para;</a></h3>
<p>The <code>acquire()</code> context manager uses three distinct write paths, each with different
atomicity and cost characteristics:</p>
<table>
<thead>
<tr>
<th>Write Path</th>
<th>Method</th>
<th>API Used</th>
<th>WCU Cost</th>
<th>Atomicity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initial consumption</td>
<td><code>_commit_initial()</code></td>
<td><code>transact_write()</code></td>
<td>2 WCU (transaction) or 1 WCU (single item)</td>
<td>Cross-item atomic</td>
</tr>
<tr>
<td>Post-enter adjustments</td>
<td><code>_commit_adjustments()</code></td>
<td><code>write_each()</code></td>
<td>1 WCU per item</td>
<td>Independent per item</td>
</tr>
<tr>
<td>Rollback (on exception)</td>
<td><code>_rollback()</code></td>
<td><code>write_each()</code></td>
<td>1 WCU per item</td>
<td>Independent per item</td>
</tr>
<tr>
<td>Aggregator refill</td>
<td><code>try_refill_bucket()</code></td>
<td><code>UpdateItem</code></td>
<td>1 WCU</td>
<td>Single item</td>
</tr>
</tbody>
</table>
<h3 id="transactwriteitems-initial-consumption">TransactWriteItems (Initial Consumption)<a class="headerlink" href="#transactwriteitems-initial-consumption" title="Permanent link">&para;</a></h3>
<p>The initial consumption write (<code>_commit_initial()</code>) uses <code>transact_write()</code>, which
selects the DynamoDB API based on item count:</p>
<ul>
<li><strong>Single item</strong>: Uses PutItem/UpdateItem (1 WCU) -- non-cascade case</li>
<li><strong>Multiple items</strong>: Uses TransactWriteItems (2 WCU per item) -- cascade case</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Cascade: atomic multi-entity write</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c1"># 1. Consume from child entity bucket</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c1"># 2. Consume from parent entity bucket</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># Both succeed or both fail</span>
</span></code></pre></div>
<p>Transaction limits: max 100 items per transaction.</p>
<h3 id="independent-writes-adjustments-and-rollbacks">Independent Writes (Adjustments and Rollbacks)<a class="headerlink" href="#independent-writes-adjustments-and-rollbacks" title="Permanent link">&para;</a></h3>
<p>Adjustments (<code>_commit_adjustments()</code>) and rollbacks (<code>_rollback()</code>) use <code>write_each()</code>,
which dispatches each item independently as a single PutItem, UpdateItem, or DeleteItem
call (1 WCU each). This is safe because:</p>
<ul>
<li>These operations produce <strong>unconditional ADD</strong> expressions (no condition checks)</li>
<li>Partial success is acceptable -- each item's delta is self-contained</li>
<li>No cross-item invariant needs to hold between adjustment writes</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># write_each: each item written independently</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="c1"># Item 1: ADD child bucket delta    (1 WCU)</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="c1"># Item 2: ADD parent bucket delta   (1 WCU)</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="c1"># No transaction overhead</span>
</span></code></pre></div>
<p>This halves the WCU cost compared to using TransactWriteItems for these paths.</p>
<h3 id="speculative-write-path-issue-315">Speculative Write Path (Issue #315)<a class="headerlink" href="#speculative-write-path-issue-315" title="Permanent link">&para;</a></h3>
<p>When <code>speculative_writes=True</code>, <code>acquire()</code> adds a fast path before the normal read-write flow:</p>
<table>
<thead>
<tr>
<th>Write Path</th>
<th>Method</th>
<th>API Used</th>
<th>WCU Cost</th>
<th>Atomicity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Speculative consumption</td>
<td><code>speculative_consume()</code></td>
<td>Conditional <code>UpdateItem</code></td>
<td>1 WCU (success) or 0 WCU (reject)</td>
<td>Single item</td>
</tr>
<tr>
<td>Speculative compensation</td>
<td><code>_compensate_speculative()</code> via <code>write_each()</code></td>
<td><code>UpdateItem</code></td>
<td>1 WCU</td>
<td>Single item</td>
</tr>
<tr>
<td>Parallel speculative (issue #318)</td>
<td><code>speculative_consume()</code> via <code>asyncio.gather</code></td>
<td>2x <code>UpdateItem</code></td>
<td>2 WCU</td>
<td>Independent items</td>
</tr>
<tr>
<td>Parent-only slow path</td>
<td><code>_try_parent_only_acquire()</code> via <code>_commit_initial()</code></td>
<td><code>UpdateItem</code></td>
<td>1 WCU</td>
<td>Single item</td>
</tr>
</tbody>
</table>
<p>The speculative path uses <code>ReturnValuesOnConditionCheckFailure=ALL_OLD</code> to inspect bucket state
on failure without a separate read. On success, <code>ReturnValues=ALL_NEW</code> provides the post-write
state including denormalized <code>cascade</code> and <code>parent_id</code> fields.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>Speculative flow (first acquire  sequential, populates entity cache):
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>1. Pick shard: random.randrange(shard_count) from entity cache (shard 0 if no cache)
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>2. UpdateItem on PK={ns}/BUCKET#{id}#{resource}#{shard} with condition:
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>   attribute_exists(PK) AND all app limits tk &gt;= consumed AND wcu tk &gt;= 1000
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>   +- SUCCESS -&gt; Populate entity cache (cascade, parent_id, shard_counts), Lease pre-committed
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>   |  +- cascade=False -&gt; DONE
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>   |  +- cascade=True -&gt; Speculative UpdateItem on parent (sequential)
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>   |     +- SUCCESS -&gt; DONE (child + parent both speculative)
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>   |     +- FAIL -&gt; [parent failure handling]
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>   +- FAIL -&gt; Check ALL_OLD
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>      +- No item (bucket missing) -&gt; Fall back to normal path
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>      +- wcu exhausted -&gt; Double shard_count (conditional write on shard 0), fall back
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>      +- App limits: Refill would help -&gt; Fall back to normal path
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>      +- App limits: Refill won&#39;t help, multi-shard -&gt; Retry on another shard (up to 2 retries)
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>      +- App limits: Refill won&#39;t help, single shard -&gt; RateLimitExceeded (fast rejection)
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>Shard retry flow (when app limits exhausted on multi-shard entity):
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>1. Pick untried shard: random choice from remaining shards
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>2. Speculative UpdateItem on new shard
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>   +- SUCCESS -&gt; Lease pre-committed on new shard, DONE
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>   +- FAIL -&gt; Try next untried shard (up to _MAX_SHARD_RETRIES=2 total retries)
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>   +- All retries exhausted -&gt; RateLimitExceeded
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>Speculative flow (subsequent acquire  parallel, issue #318):
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>1. Entity cache hit: cascade=True, parent_id known, shard_counts known
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>2. asyncio.gather(child_speculative, parent_speculative)
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>   +- BOTH SUCCEED -&gt; DONE (1 round trip, 0 RCU, 2 WCU)
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>   +- CHILD FAILS, PARENT SUCCEEDS -&gt; Compensate parent, check child
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>   +- CHILD SUCCEEDS, PARENT FAILS -&gt; [parent failure handling]
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>   +- BOTH FAIL -&gt; Check child ALL_OLD, fall back or fast-reject
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>Parent failure handling (shared by sequential and parallel paths):
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>   +- No ALL_OLD / missing limit -&gt; Compensate child, fall back
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>   +- Refill won&#39;t help -&gt; Compensate child, RateLimitExceeded
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>   +- Refill would help -&gt; Parent-only slow path (read + write parent)
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>      +- SUCCESS -&gt; DONE (child speculative + parent slow path)
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>      +- FAIL -&gt; Compensate child, fall back to full slow path
</span></code></pre></div>
<p>Cascade and <code>parent_id</code> are denormalized into composite bucket items (via <code>build_composite_create</code>)
so the speculative path avoids a separate entity metadata lookup.</p>
<p><strong>Deferred cascade compensation:</strong> When the child speculative write succeeds but the parent
fails, child compensation is deferred. If refill would help the parent, a parent-only slow
path is attempted: read parent buckets (0.5 RCU), refill + try_consume, write via single-item
UpdateItem (1 WCU). This avoids the cost of compensating the child (1 WCU), re-reading it
(0.5 RCU), and using TransactWriteItems for the full cascade write (4 WCU). The child is
only compensated when the parent-only path also fails.</p>
<p><strong>Entity metadata cache (issue #318, GHSA-76rv):</strong> <code>Repository._entity_cache</code> stores
<code>{(namespace_id, entity_id): (cascade, parent_id, shard_counts)}</code> where <code>shard_counts</code> is
<code>dict[str, int]</code> mapping resource to shard count. <code>cascade</code> and <code>parent_id</code> are immutable
(no TTL); <code>shard_counts</code> is updated when shard doubling occurs. After the first acquire
populates the cache, <code>speculative_consume()</code> issues child and parent speculative writes
concurrently via <code>asyncio.gather</code>. This reduces cascade latency
from 2 sequential round trips to 1 parallel round trip. In the sync codepath,
<code>asyncio.gather(a, b)</code> is transformed to <code>self._run_in_executor(lambda: a, lambda: b)</code> using
a lazy <code>ThreadPoolExecutor(max_workers=2)</code> for true parallel execution.
The <code>_compensate_speculative()</code> method handles compensation for either child or parent when
one side of the parallel write fails.</p>
<p>The shard_count from the cache determines which shard to target. With multiple shards,
<code>speculative_consume()</code> picks a random shard via <code>random.randrange(shard_count)</code>. When the
speculative write succeeds, the returned <code>shard_count</code> from ALL_NEW updates the cache.</p>
<h3 id="aggregator-refill-path-issue-317">Aggregator Refill Path (Issue #317)<a class="headerlink" href="#aggregator-refill-path-issue-317" title="Permanent link">&para;</a></h3>
<p>The Lambda aggregator proactively refills token buckets for active entities, keeping
speculative writes on the fast path (1 RT) instead of falling back to the slow path (3 RT).</p>
<table>
<thead>
<tr>
<th>Write Path</th>
<th>Method</th>
<th>API Used</th>
<th>WCU Cost</th>
<th>Atomicity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Aggregator refill</td>
<td><code>try_refill_bucket()</code></td>
<td>Conditional <code>UpdateItem</code></td>
<td>1 WCU (success) or 0 WCU (lock lost)</td>
<td>Single item</td>
</tr>
</tbody>
</table>
<p>The aggregator processes DynamoDB Stream records in each batch to:</p>
<ol>
<li><strong>Aggregate bucket states</strong> -- <code>aggregate_bucket_states()</code> accumulates <code>tc</code> deltas and keeps
   the last NewImage per (entity_id, resource, shard_id) across all stream records in the batch</li>
<li><strong>Compute refill</strong> -- For each bucket, <code>try_refill_bucket()</code> calls <code>refill_bucket()</code> with
   effective capacity (<code>cp // shard_count</code>) and effective refill amount (<code>ra // shard_count</code>),
   then checks if projected tokens are insufficient to cover the observed consumption rate</li>
<li><strong>Write refill</strong> -- Issues a single <code>UpdateItem</code> with <code>ADD b_{limit}_tk +refill_delta</code>
   and <code>SET rf = :now</code>, conditioned on <code>rf = :expected_rf</code> (optimistic lock)</li>
<li><strong>Proactive sharding</strong> -- <code>try_proactive_shard()</code> checks if wcu consumption &gt;= 80% of capacity
   on shard 0, and conditionally doubles <code>shard_count</code></li>
<li><strong>Shard propagation</strong> -- <code>propagate_shard_count()</code> detects shard_count changes in stream records
   from shard 0 and propagates to all other shards via conditional writes (<code>shard_count &lt; :new</code>)</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>Aggregator refill flow (per composite bucket shard):
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>1. Aggregate tc deltas + last NewImage across stream batch per (entity, resource, shard)
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>2. For each limit: refill_bucket(tk, rf, now, cp/shard_count, ra/shard_count, rp)
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>   +- refill_delta = new_tk - current_tk
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>   +- projected = new_tk after refill
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>   +- consumption_estimate = max(0, accumulated tc_delta)
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>   +- projected &gt;= consumption_estimate -&gt; SKIP (sufficient tokens)
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>3. Any limit needs refill?
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>   +- NO -&gt; SKIP
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>   +- YES -&gt; UpdateItem (ADD tk +delta, SET rf = :now, condition rf = :expected_rf)
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>      +- SUCCESS -&gt; refill written (1 WCU)
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>      +- ConditionalCheckFailedException -&gt; silently skip (another writer updated rf)
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>Proactive sharding flow (per bucket):
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>1. Check wcu limit info in aggregated state
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>2. consumption_ratio = wcu_tc_delta / wcu_capacity_milli
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>   +- ratio &lt; 0.8 -&gt; SKIP
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>3. Is this shard 0?
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>   +- NO -&gt; SKIP (only shard 0 is source of truth)
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>   +- YES -&gt; UpdateItem (SET shard_count = :new, condition shard_count = :old)
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>      +- SUCCESS -&gt; shard_count doubled
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>      +- ConditionalCheckFailedException -&gt; concurrent bump, skip
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>Shard propagation flow (per stream record):
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>1. Detect shard_count increase (new &gt; old) in stream record
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>2. Is this shard 0?
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>   +- NO -&gt; SKIP
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>   +- YES -&gt; For each target shard 1..new_count:
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>      UpdateItem (SET shard_count = :new, condition shard_count &lt; :new OR not exists)
</span></code></pre></div>
<p><strong>Key design properties:</strong></p>
<ul>
<li><strong>ADD is commutative</strong> with concurrent speculative writes -- the aggregator uses <code>ADD</code>
  for token deltas, so a concurrent <code>speculative_consume()</code> (also <code>ADD</code>) does not conflict</li>
<li><strong>Optimistic lock on <code>rf</code></strong> prevents double-refill with the client slow path or another
  aggregator invocation</li>
<li><strong>No read required</strong> -- all state is derived from stream record NewImage fields</li>
<li><strong>Shard-aware capacity</strong> -- effective capacity and refill amount are divided by <code>shard_count</code>
  so each shard gets its proportional share of tokens</li>
<li><strong>Proactive sharding</strong> -- the aggregator doubles shard_count when wcu consumption &gt;= 80%
  of capacity, preventing hot partitions before clients experience throttling</li>
<li><strong>Shard propagation</strong> -- shard_count changes on shard 0 are propagated to other shards
  via conditional writes that only update if the target has a lower value</li>
</ul>
<h3 id="optimistic-locking">Optimistic Locking<a class="headerlink" href="#optimistic-locking" title="Permanent link">&para;</a></h3>
<p>Entity metadata uses version numbers for optimistic locking:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># Read entity with version 5</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="c1"># Update fails if version changed</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="n">condition_expression</span><span class="o">=</span><span class="s2">&quot;version = :expected_version&quot;</span>
</span></code></pre></div>
<h2 id="project-structure">Project Structure<a class="headerlink" href="#project-structure" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>src/zae_limiter/
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a> __init__.py            # Public API exports
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a> models.py              # Limit, Entity, LimitStatus, BucketState, StackOptions, ...
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a> exceptions.py          # RateLimitExceeded, RateLimiterUnavailable, etc.
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a> naming.py              # Resource name validation
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a> bucket.py              # Token bucket math (integer arithmetic)
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a> schema.py              # DynamoDB key builders (namespace-prefixed)
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a> repository_protocol.py # RepositoryProtocol for backend abstraction
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a> repository.py          # DynamoDB operations
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a> config_cache.py        # Client-side config caching with TTL
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a> lease.py               # Lease context manager
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a> limiter.py             # RateLimiter, SyncRateLimiter
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a> local.py               # LocalStack management commands
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a> cli.py                 # CLI commands (deploy, delete, status, list, local, ...)
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a> version.py             # Version tracking and compatibility
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a> migrations/            # Schema migration framework
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a> visualization/         # Usage snapshot formatting and display
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a> infra/
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>     stack_manager.py    # CloudFormation stack operations
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>     lambda_builder.py   # Lambda deployment package builder
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>     discovery.py        # Multi-stack discovery and listing
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>     cfn_template.yaml   # CloudFormation template
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>src/zae_limiter_aggregator/   # Lambda aggregator (top-level package)
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a> __init__.py               # Re-exports handler, processor types
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a> handler.py                # Lambda entry point (returns refills_written count)
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a> processor.py              # Stream processing: usage snapshots + bucket refill
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a> archiver.py               # S3 audit archival (gzip JSONL)
</span></code></pre></div>
<h2 id="key-design-decisions">Key Design Decisions<a class="headerlink" href="#key-design-decisions" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Write-on-enter</strong>: <code>acquire()</code> writes initial consumption to DynamoDB before yielding the lease, making tokens immediately visible to concurrent callers. On exception, a compensating write restores the consumed tokens</li>
<li><strong>Bucket can go negative</strong>: <code>lease.adjust()</code> never throws, allows debt</li>
<li><strong>Cascade is per-entity config</strong>: Set <code>cascade=True</code> on <code>create_entity()</code> to auto-cascade to parent on every <code>acquire()</code></li>
<li><strong>Stored limits are the default (v0.5.0+)</strong>: Limits resolved from System/Resource/Entity config automatically. Pass <code>limits</code> parameter to override</li>
<li><strong>Initial writes are atomic</strong>: Multi-entity initial consumption uses <code>transact_write()</code> for cross-item atomicity</li>
<li><strong>Adjustments and rollbacks use independent writes</strong>: <code>write_each()</code> dispatches each item as a single-item API call (1 WCU each), avoiding transaction overhead for unconditional ADD operations</li>
<li><strong>Speculative writes skip reads</strong>: With <code>speculative_writes=True</code>, <code>acquire()</code> tries a conditional UpdateItem first, saving 1 round trip and 1 RCU when the bucket has sufficient tokens</li>
<li><strong>Entity metadata cache enables parallel cascade</strong>: <code>Repository._entity_cache</code> stores <code>(cascade, parent_id, shard_counts)</code> per entity. <code>cascade</code> and <code>parent_id</code> are immutable; <code>shard_counts</code> (<code>dict[str, int]</code>) is updated on shard doubling. After first acquire, cascade speculative writes run concurrently via <code>asyncio.gather</code></li>
<li><strong>Aggregator-assisted refill</strong>: The Lambda aggregator proactively refills buckets for active entities, keeping speculative writes on the fast path by ensuring buckets have sufficient tokens between client requests. Effective capacity and refill amount are divided by <code>shard_count</code> so each shard receives its proportional share</li>
<li><strong>Pre-shard buckets (GHSA-76rv)</strong>: Each bucket item lives on its own DynamoDB partition (<code>PK={ns}/BUCKET#{id}#{resource}#{shard}</code>). An auto-injected <code>wcu:1000</code> infrastructure limit tracks per-partition write pressure. When wcu is exhausted, the client doubles shard_count (conditional write on shard 0). The aggregator proactively doubles shards at &gt;=80% wcu capacity and propagates shard_count changes from shard 0 to all other shards</li>
</ol>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../development/">Development Setup</a> - Setting up your environment</li>
<li><a href="../testing/">Testing</a> - Test organization and fixtures</li>
</ul>












                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../testing/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Testing">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Testing
              </div>
            </div>
          </a>
        
        
          
          <a href="../../adr/000-adr-format-standard/" class="md-footer__link md-footer__link--next" aria-label="Next: ADR Format">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                ADR Format
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/zeroae/zae-limiter" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/zae-limiter/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.top", "navigation.footer", "content.code.copy", "content.code.annotate", "content.action.edit", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
    
  </body>
</html>