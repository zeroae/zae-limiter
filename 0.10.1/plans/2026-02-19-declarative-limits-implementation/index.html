
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Rate limiting library backed by DynamoDB using the token bucket algorithm">
      
      
        <meta name="author" content="ZeroAE">
      
      
        <link rel="canonical" href="https://zeroae.github.io/zae-limiter/0.10.1/plans/2026-02-19-declarative-limits-implementation/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/zae-limiter.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Declarative Limits Implementation Plan - zae-limiter</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#declarative-limits-implementation-plan" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="zae-limiter" class="md-header__button md-logo" aria-label="zae-limiter" data-md-component="logo">
      
  <img src="../../assets/zae-limiter-icon-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            zae-limiter
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Declarative Limits Implementation Plan
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zeroae/zae-limiter" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zeroae/zae-limiter
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="zae-limiter" class="md-nav__button md-logo" aria-label="zae-limiter" data-md-component="logo">
      
  <img src="../../assets/zae-limiter-icon-white.svg" alt="logo">

    </a>
    zae-limiter
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zeroae/zae-limiter" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zeroae/zae-limiter
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/token-bucket/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Token Bucket Algorithm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/basic-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/config-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hierarchical/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hierarchical Limits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/llm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/usage-snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage Snapshots
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/unavailability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unavailability Handling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Operator Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Operator Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/cloudformation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CloudFormation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Migrations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Migrations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../migrations/namespace-keys/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Namespace Keys (v0.10.0)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/auditing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Auditing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/limiter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RateLimiter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/repository/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repository
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmarks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmarks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Contributing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Development Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/localstack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LocalStack
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ADRs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    ADRs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/000-adr-format-standard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR Format
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Foundational (v0.1.0-v0.4.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Foundational (v0.1.0-v0.4.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/001-single-table-dynamodb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-001 Single-Table DynamoDB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/002-integer-arithmetic-millitokens/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-002 Integer Arithmetic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/003-cloudformation-infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-003 CloudFormation Infra
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/004-declarative-stack-options/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-004 StackOptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/005-exception-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-005 Exception Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/006-flat-schema-snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-006 Flat Schema Snapshots
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/007-input-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-007 Input Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/008-security-audit-logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-008 Audit Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/009-version-migration-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-009 Version Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/010-total-consumed-counter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-010 Consumed Counter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/011-api-cli-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-011 API/CLI Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/012-cloudformation-docs-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-012 CloudFormation Docs Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/013-module-documentation-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-013 Module Documentation Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Centralized Config (v0.5.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Centralized Config (v0.5.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/100-centralized-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-100 Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/101-flat-schema-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-101 Flat Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/102-config-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-102 Config Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/103-config-caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-103 Config Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/104-stored-limits-default/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-104 Stored Limits Default
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/105-eventual-consistency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-105 Eventual Consistency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/106-audit-entity-ids-for-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-106 Audit Entity IDs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/107-iam-roles-for-application-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-107 IAM Roles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Repository Protocol (v0.5.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Repository Protocol (v0.5.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/108-repository-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-108 Repository Protocol
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/109-backend-capability-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-109 Backend Capabilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/110-deprecation-constructor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-110 Deprecation Strategy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Schema & Infra (v0.6.0+)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Schema & Infra (v0.6.0+)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/111-flatten-all-records/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-111 Flatten All Records
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/112-cascade-per-entity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-112 Cascade Per Entity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/113-lambda-packaging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-113 Lambda Packaging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#task-1-schema-key-builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 1: Schema Key Builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-repository-methods-for-provisioner-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 2: Repository Methods for Provisioner State
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-provisioner-package-manifest-dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 3: Provisioner Package — Manifest Dataclass
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-provisioner-package-differ-module" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 4: Provisioner Package — Differ Module
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-5-provisioner-package-applier-module" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 5: Provisioner Package — Applier Module
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-6-provisioner-package-lambda-handler" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 6: Provisioner Package — Lambda Handler
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-7-lambda-builder-for-provisioner" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 7: Lambda Builder for Provisioner
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-8-cloudformation-template-updates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 8: CloudFormation Template Updates
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-9-stack-manager-deploy-provisioner-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 9: Stack Manager — Deploy Provisioner Code
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-10-cli-limits-command-group" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 10: CLI limits Command Group
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-11-integration-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 11: Integration Tests
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-12-documentation-updates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 12: Documentation Updates
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
  
  
                  


  
    <a href="https://github.com/zeroae/zae-limiter/edit/main/docs/plans/2026-02-19-declarative-limits-implementation.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="declarative-limits-implementation-plan">Declarative Limits Implementation Plan<a class="headerlink" href="#declarative-limits-implementation-plan" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>For Claude:</strong> REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.</p>
</blockquote>
<p><strong>Goal:</strong> Enable operators to declare rate limits in YAML files and apply them through a Lambda provisioner, serving both CLI and CloudFormation paths with Terraform-style state tracking.</p>
<p><strong>Architecture:</strong> YAML files (one per namespace) are parsed by the CLI into a <code>LimitsManifest</code> dataclass, serialized to JSON, and sent to a Lambda provisioner via <code>lambda:Invoke</code>. The Lambda diffs the manifest against a <code>#PROVISIONER</code> state record in DynamoDB, applies changes via the existing Repository API, and updates the state record. The same Lambda handles CloudFormation custom resource events. The provisioner is packaged and deployed alongside the existing aggregator Lambda.</p>
<p><strong>Tech Stack:</strong> Python dataclasses, PyYAML, boto3 Lambda invoke, CloudFormation custom resources, Click CLI</p>
<hr />
<h2 id="task-1-schema-key-builder">Task 1: Schema Key Builder<a class="headerlink" href="#task-1-schema-key-builder" title="Permanent link">&para;</a></h2>
<p>Add the <code>#PROVISIONER</code> sort key constant and builder to <code>schema.py</code>.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/schema.py</code>
- Test: <code>tests/unit/test_schema.py</code></p>
<p><strong>Step 1: Write the failing test</strong></p>
<p>In <code>tests/unit/test_schema.py</code>, add:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestProvisionerKey</span><span class="p">:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for provisioner state sort key builder.&quot;&quot;&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_sk_provisioner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">sk_provisioner</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="k">assert</span> <span class="n">sk_provisioner</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;#PROVISIONER&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py::TestProvisionerKey -v</code>
Expected: FAIL with <code>ImportError: cannot import name 'sk_provisioner'</code></p>
<p><strong>Step 3: Write minimal implementation</strong></p>
<p>In <code>src/zae_limiter/schema.py</code>, add the constant near the other SK constants (after line 41):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">SK_PROVISIONER</span> <span class="o">=</span> <span class="s2">&quot;#PROVISIONER&quot;</span>
</span></code></pre></div>
<p>Add the builder function (after <code>sk_nsid_prefix</code>):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">sk_provisioner</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build sort key for provisioner state record (tracks managed limits).&quot;&quot;&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="k">return</span> <span class="n">SK_PROVISIONER</span>
</span></code></pre></div>
<p><strong>Step 4: Run test to verify it passes</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py::TestProvisionerKey -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>git add src/zae_limiter/schema.py tests/unit/test_schema.py
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>git commit -m &quot;✨ feat(schema): add sk_provisioner() key builder for #PROVISIONER record&quot;
</span></code></pre></div>
<hr />
<h2 id="task-2-repository-methods-for-provisioner-state">Task 2: Repository Methods for Provisioner State<a class="headerlink" href="#task-2-repository-methods-for-provisioner-state" title="Permanent link">&para;</a></h2>
<p>Add <code>get_provisioner_state()</code> and <code>put_provisioner_state()</code> to <code>Repository</code>.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py</code>
- Test: <code>tests/unit/test_repository.py</code></p>
<p><strong>Step 1: Write the failing tests</strong></p>
<p>In <code>tests/unit/test_repository.py</code>, add:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestProvisionerState</span><span class="p">:</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for provisioner state CRUD (declarative limits management).&quot;&quot;&quot;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_get_provisioner_state_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;get_provisioner_state returns empty state when no record exists.&quot;&quot;&quot;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_provisioner_state</span><span class="p">()</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="k">assert</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;managed_system&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>        <span class="k">assert</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="k">assert</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">{}</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="k">assert</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_applied&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="k">assert</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;applied_hash&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_put_get_provisioner_state_roundtrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;put_provisioner_state and get_provisioner_state round-trip correctly.&quot;&quot;&quot;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;claude-3&quot;</span><span class="p">],</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;user-123&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">],</span> <span class="s2">&quot;org-456&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;_default_&quot;</span><span class="p">]},</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>            <span class="s2">&quot;last_applied&quot;</span><span class="p">:</span> <span class="s2">&quot;2026-02-19T12:00:00Z&quot;</span><span class="p">,</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>            <span class="s2">&quot;applied_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:abc123&quot;</span><span class="p">,</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="p">}</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>        <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">put_provisioner_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="n">retrieved</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_provisioner_state</span><span class="p">()</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;managed_system&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;claude-3&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">{</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>            <span class="s2">&quot;user-123&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">],</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="s2">&quot;org-456&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;_default_&quot;</span><span class="p">],</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="p">}</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;last_applied&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2026-02-19T12:00:00Z&quot;</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;applied_hash&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sha256:abc123&quot;</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_put_provisioner_state_overwrites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;put_provisioner_state replaces previous state entirely.&quot;&quot;&quot;</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="n">state1</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">],</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>            <span class="s2">&quot;last_applied&quot;</span><span class="p">:</span> <span class="s2">&quot;2026-02-19T12:00:00Z&quot;</span><span class="p">,</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>            <span class="s2">&quot;applied_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:aaa&quot;</span><span class="p">,</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="p">}</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">put_provisioner_state</span><span class="p">(</span><span class="n">state1</span><span class="p">)</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="n">state2</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;claude-3&quot;</span><span class="p">],</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;claude-3&quot;</span><span class="p">]},</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>            <span class="s2">&quot;last_applied&quot;</span><span class="p">:</span> <span class="s2">&quot;2026-02-19T13:00:00Z&quot;</span><span class="p">,</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>            <span class="s2">&quot;applied_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256:bbb&quot;</span><span class="p">,</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>        <span class="p">}</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>        <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">put_provisioner_state</span><span class="p">(</span><span class="n">state2</span><span class="p">)</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>        <span class="n">retrieved</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_provisioner_state</span><span class="p">()</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>        <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;managed_system&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>        <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;claude-3&quot;</span><span class="p">]</span>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>        <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;claude-3&quot;</span><span class="p">]}</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py::TestProvisionerState -v</code>
Expected: FAIL with <code>AttributeError: 'Repository' object has no attribute 'get_provisioner_state'</code></p>
<p><strong>Step 3: Write minimal implementation</strong></p>
<p>In <code>src/zae_limiter/repository.py</code>, add two methods to the <code>Repository</code> class:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_provisioner_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the provisioner state record for this namespace.</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="sd">    Returns:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="sd">        Dict with keys: managed_system, managed_resources, managed_entities,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="sd">        last_applied, applied_hash. Returns empty state if no record exists.</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="n">TableName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>            <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">)},</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>            <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">sk_provisioner</span><span class="p">()},</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="p">},</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="p">)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Item&quot;</span><span class="p">)</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>            <span class="s2">&quot;last_applied&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>            <span class="s2">&quot;applied_hash&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="p">}</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    <span class="n">managed_entities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    <span class="n">raw_entities</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resources_attr</span> <span class="ow">in</span> <span class="n">raw_entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="n">managed_entities</span><span class="p">[</span><span class="n">entity_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>            <span class="n">r</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources_attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="p">]</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_system&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="n">r</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="p">],</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="n">managed_entities</span><span class="p">,</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="s2">&quot;last_applied&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_applied&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">),</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>        <span class="s2">&quot;applied_hash&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;applied_hash&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">),</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    <span class="p">}</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">put_provisioner_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Write the provisioner state record for this namespace.</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="sd">    Args:</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="sd">        state: Dict with keys: managed_system, managed_resources,</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a><span class="sd">               managed_entities, last_applied, applied_hash.</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>    <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>        <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">)},</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>        <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">sk_provisioner</span><span class="p">()},</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>        <span class="s2">&quot;GSI4PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">},</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>        <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;BOOL&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;managed_system&quot;</span><span class="p">]},</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>        <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>            <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">]]</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>        <span class="p">},</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>        <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>            <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>                <span class="n">entity_id</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">]}</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>                <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resources</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>            <span class="p">}</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>        <span class="p">},</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>        <span class="s2">&quot;last_applied&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_applied&quot;</span><span class="p">]},</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>        <span class="s2">&quot;applied_hash&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;applied_hash&quot;</span><span class="p">]},</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>    <span class="p">}</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py::TestProvisionerState -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>git add src/zae_limiter/repository.py tests/unit/test_repository.py
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>git commit -m &quot;✨ feat(repository): add get/put_provisioner_state() for declarative limits&quot;
</span></code></pre></div>
<hr />
<h2 id="task-3-provisioner-package-manifest-dataclass">Task 3: Provisioner Package — Manifest Dataclass<a class="headerlink" href="#task-3-provisioner-package-manifest-dataclass" title="Permanent link">&para;</a></h2>
<p>Create the <code>zae_limiter_provisioner</code> package with the YAML manifest parser.</p>
<p><strong>Files:</strong>
- Create: <code>src/zae_limiter_provisioner/__init__.py</code>
- Create: <code>src/zae_limiter_provisioner/manifest.py</code>
- Test: <code>tests/unit/test_manifest.py</code></p>
<p><strong>Step 1: Write the failing tests</strong></p>
<p>Create <code>tests/unit/test_manifest.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="sd">&quot;&quot;&quot;Tests for LimitsManifest YAML parsing and validation.&quot;&quot;&quot;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitsManifest</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLimitsManifestParsing</span><span class="p">:</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for YAML parsing into LimitsManifest.&quot;&quot;&quot;</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_parse_minimal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Minimal YAML with just namespace parses correctly.&quot;&quot;&quot;</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">}</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="s2">&quot;test-ns&quot;</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">resources</span> <span class="o">==</span> <span class="p">{}</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">entities</span> <span class="o">==</span> <span class="p">{}</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_parse_system_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;System-level limits parse with shorthand defaults.&quot;&quot;&quot;</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>                <span class="s2">&quot;on_unavailable&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span><span class="p">,</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>                <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>                    <span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">},</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>                <span class="p">},</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>            <span class="p">},</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>        <span class="p">}</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">on_unavailable</span> <span class="o">==</span> <span class="s2">&quot;allow&quot;</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="n">limit</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;rpm&quot;</span><span class="p">]</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">1000</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">burst</span> <span class="o">==</span> <span class="mi">1000</span>  <span class="c1"># default: capacity</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">refill_amount</span> <span class="o">==</span> <span class="mi">1000</span>  <span class="c1"># default: capacity</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">refill_period</span> <span class="o">==</span> <span class="mi">60</span>  <span class="c1"># default: 60</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_parse_explicit_limit_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Explicit limit fields override shorthand defaults.&quot;&quot;&quot;</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>                <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>                    <span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>                        <span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>                        <span class="s2">&quot;burst&quot;</span><span class="p">:</span> <span class="mi">75000</span><span class="p">,</span>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>                        <span class="s2">&quot;refill_amount&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>                        <span class="s2">&quot;refill_period&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>                    <span class="p">},</span>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>                <span class="p">},</span>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>            <span class="p">},</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>        <span class="p">}</span>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="n">limit</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;tpm&quot;</span><span class="p">]</span>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">50000</span>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">burst</span> <span class="o">==</span> <span class="mi">75000</span>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">refill_amount</span> <span class="o">==</span> <span class="mi">50000</span>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>        <span class="k">assert</span> <span class="n">limit</span><span class="o">.</span><span class="n">refill_period</span> <span class="o">==</span> <span class="mi">120</span>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_parse_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resource-level limits parse correctly.&quot;&quot;&quot;</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>                <span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>                    <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>                        <span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">},</span>
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>                        <span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">},</span>
</span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>                    <span class="p">},</span>
</span><span id="__span-7-74"><a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>                <span class="p">},</span>
</span><span id="__span-7-75"><a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>            <span class="p">},</span>
</span><span id="__span-7-76"><a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>        <span class="p">}</span>
</span><span id="__span-7-77"><a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-78"><a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>        <span class="k">assert</span> <span class="s2">&quot;gpt-4&quot;</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">resources</span>
</span><span id="__span-7-79"><a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span><span id="__span-7-80"><a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>
</span><span id="__span-7-81"><a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_parse_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-82"><a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Entity-level limits parse correctly with resource scoping.&quot;&quot;&quot;</span>
</span><span id="__span-7-83"><a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>                <span class="s2">&quot;user-123&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>                    <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a>                        <span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>                            <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}},</span>
</span><span id="__span-7-90"><a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>                        <span class="p">},</span>
</span><span id="__span-7-91"><a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>                        <span class="s2">&quot;_default_&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-92"><a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>                            <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}},</span>
</span><span id="__span-7-93"><a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>                        <span class="p">},</span>
</span><span id="__span-7-94"><a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>                    <span class="p">},</span>
</span><span id="__span-7-95"><a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>                <span class="p">},</span>
</span><span id="__span-7-96"><a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a>            <span class="p">},</span>
</span><span id="__span-7-97"><a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a>        <span class="p">}</span>
</span><span id="__span-7-98"><a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-99"><a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>        <span class="k">assert</span> <span class="s2">&quot;user-123&quot;</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">entities</span>
</span><span id="__span-7-100"><a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>        <span class="n">entity</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s2">&quot;user-123&quot;</span><span class="p">]</span>
</span><span id="__span-7-101"><a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>        <span class="k">assert</span> <span class="s2">&quot;gpt-4&quot;</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">resources</span>
</span><span id="__span-7-102"><a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>        <span class="k">assert</span> <span class="s2">&quot;_default_&quot;</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">resources</span>
</span><span id="__span-7-103"><a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>        <span class="k">assert</span> <span class="n">entity</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;rpm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">500</span>
</span><span id="__span-7-104"><a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>
</span><span id="__span-7-105"><a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_parse_from_yaml_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-106"><a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;from_yaml parses a YAML string into a manifest.&quot;&quot;&quot;</span>
</span><span id="__span-7-107"><a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>        <span class="n">yaml_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-7-108"><a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a><span class="s2">namespace: test-ns</span>
</span><span id="__span-7-109"><a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a><span class="s2">system:</span>
</span><span id="__span-7-110"><a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a><span class="s2">  limits:</span>
</span><span id="__span-7-111"><a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a><span class="s2">    rpm:</span>
</span><span id="__span-7-112"><a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a><span class="s2">      capacity: 1000</span>
</span><span id="__span-7-113"><a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a><span class="s2">resources:</span>
</span><span id="__span-7-114"><a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a><span class="s2">  gpt-4:</span>
</span><span id="__span-7-115"><a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a><span class="s2">    limits:</span>
</span><span id="__span-7-116"><a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a><span class="s2">      tpm:</span>
</span><span id="__span-7-117"><a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a><span class="s2">        capacity: 50000</span>
</span><span id="__span-7-118"><a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-7-119"><a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">yaml_str</span><span class="p">)</span>
</span><span id="__span-7-120"><a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="s2">&quot;test-ns&quot;</span>
</span><span id="__span-7-121"><a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;rpm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">1000</span>
</span><span id="__span-7-122"><a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>        <span class="k">assert</span> <span class="n">manifest</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;tpm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">50000</span>
</span><span id="__span-7-123"><a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>
</span><span id="__span-7-124"><a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_missing_namespace_raises</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-125"><a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Missing namespace field raises ValueError.&quot;&quot;&quot;</span>
</span><span id="__span-7-126"><a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;namespace&quot;</span><span class="p">):</span>
</span><span id="__span-7-127"><a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>            <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({})</span>
</span><span id="__span-7-128"><a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>
</span><span id="__span-7-129"><a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_to_dict_roundtrip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-130"><a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;to_dict produces a dict that round-trips through from_dict.&quot;&quot;&quot;</span>
</span><span id="__span-7-131"><a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-132"><a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-7-133"><a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-134"><a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a>                <span class="s2">&quot;on_unavailable&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span><span class="p">,</span>
</span><span id="__span-7-135"><a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>                <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}},</span>
</span><span id="__span-7-136"><a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>            <span class="p">},</span>
</span><span id="__span-7-137"><a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-138"><a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>                <span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">}}},</span>
</span><span id="__span-7-139"><a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>            <span class="p">},</span>
</span><span id="__span-7-140"><a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-141"><a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>                <span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-142"><a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>                    <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-143"><a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a>                        <span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}}},</span>
</span><span id="__span-7-144"><a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a>                    <span class="p">},</span>
</span><span id="__span-7-145"><a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>                <span class="p">},</span>
</span><span id="__span-7-146"><a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>            <span class="p">},</span>
</span><span id="__span-7-147"><a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>        <span class="p">}</span>
</span><span id="__span-7-148"><a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-149"><a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>        <span class="n">roundtripped</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="__span-7-150"><a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>        <span class="k">assert</span> <span class="n">roundtripped</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="n">manifest</span><span class="o">.</span><span class="n">namespace</span>
</span><span id="__span-7-151"><a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>        <span class="k">assert</span> <span class="n">roundtripped</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;rpm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">1000</span>
</span><span id="__span-7-152"><a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>        <span class="k">assert</span> <span class="n">roundtripped</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;tpm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">50000</span>
</span><span id="__span-7-153"><a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>        <span class="k">assert</span> <span class="n">roundtripped</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s2">&quot;user-1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="s2">&quot;rpm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">500</span>
</span><span id="__span-7-154"><a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>
</span><span id="__span-7-155"><a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>
</span><span id="__span-7-156"><a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestManifestManagedSet</span><span class="p">:</span>
</span><span id="__span-7-157"><a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for extracting the managed set from a manifest.&quot;&quot;&quot;</span>
</span><span id="__span-7-158"><a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a>
</span><span id="__span-7-159"><a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_managed_set_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-160"><a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Manifest with system section reports managed_system=True.&quot;&quot;&quot;</span>
</span><span id="__span-7-161"><a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}}</span>
</span><span id="__span-7-162"><a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-163"><a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>        <span class="n">ms</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-7-164"><a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>        <span class="k">assert</span> <span class="n">ms</span><span class="p">[</span><span class="s2">&quot;managed_system&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="__span-7-165"><a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>
</span><span id="__span-7-166"><a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_managed_set_no_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-167"><a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Manifest without system section reports managed_system=False.&quot;&quot;&quot;</span>
</span><span id="__span-7-168"><a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">})</span>
</span><span id="__span-7-169"><a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>        <span class="n">ms</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-7-170"><a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>        <span class="k">assert</span> <span class="n">ms</span><span class="p">[</span><span class="s2">&quot;managed_system&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
</span><span id="__span-7-171"><a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>
</span><span id="__span-7-172"><a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_managed_set_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-173"><a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Managed set includes all resource names.&quot;&quot;&quot;</span>
</span><span id="__span-7-174"><a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-175"><a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
</span><span id="__span-7-176"><a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-177"><a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a>                <span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
</span><span id="__span-7-178"><a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>                <span class="s2">&quot;claude-3&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
</span><span id="__span-7-179"><a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>            <span class="p">},</span>
</span><span id="__span-7-180"><a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a>        <span class="p">}</span>
</span><span id="__span-7-181"><a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-182"><a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>        <span class="n">ms</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-7-183"><a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>        <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ms</span><span class="p">[</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;claude-3&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span>
</span><span id="__span-7-184"><a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>
</span><span id="__span-7-185"><a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_managed_set_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-186"><a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Managed set includes entity-to-resource mapping.&quot;&quot;&quot;</span>
</span><span id="__span-7-187"><a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-188"><a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
</span><span id="__span-7-189"><a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-190"><a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a>                <span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-191"><a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a>                    <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-192"><a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a>                        <span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
</span><span id="__span-7-193"><a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>                        <span class="s2">&quot;_default_&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
</span><span id="__span-7-194"><a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a>                    <span class="p">},</span>
</span><span id="__span-7-195"><a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a>                <span class="p">},</span>
</span><span id="__span-7-196"><a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>            <span class="p">},</span>
</span><span id="__span-7-197"><a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>        <span class="p">}</span>
</span><span id="__span-7-198"><a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</span><span id="__span-7-199"><a id="__codelineno-7-199" name="__codelineno-7-199" href="#__codelineno-7-199"></a>        <span class="n">ms</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-7-200"><a id="__codelineno-7-200" name="__codelineno-7-200" href="#__codelineno-7-200"></a>        <span class="k">assert</span> <span class="n">ms</span><span class="p">[</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;_default_&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">]}</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_manifest.py -v</code>
Expected: FAIL with <code>ModuleNotFoundError: No module named 'zae_limiter_provisioner'</code></p>
<p><strong>Step 3: Write the implementation</strong></p>
<p>Create <code>src/zae_limiter_provisioner/__init__.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="sd">&quot;&quot;&quot;Lambda provisioner for declarative limits management.&quot;&quot;&quot;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitsManifest</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LimitsManifest&quot;</span><span class="p">]</span>
</span></code></pre></div>
<p>Create <code>src/zae_limiter_provisioner/manifest.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="sd">&quot;&quot;&quot;YAML manifest parsing and validation for declarative limits.&quot;&quot;&quot;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">LimitDecl</span><span class="p">:</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A single limit declaration with shorthand defaults.&quot;&quot;&quot;</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="n">burst</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="n">refill_amount</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="n">refill_period</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">LimitDecl</span><span class="p">:</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>        <span class="n">capacity</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;capacity&quot;</span><span class="p">]</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>            <span class="n">capacity</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>            <span class="n">burst</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;burst&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">),</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>            <span class="n">refill_amount</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refill_amount&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">),</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>            <span class="n">refill_period</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refill_period&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="p">)</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>            <span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>            <span class="s2">&quot;burst&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>            <span class="s2">&quot;refill_amount&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_amount</span><span class="p">,</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>            <span class="s2">&quot;refill_period&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_period</span><span class="p">,</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>        <span class="p">}</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="k">class</span><span class="w"> </span><span class="nc">SystemDecl</span><span class="p">:</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;System-level limit declaration.&quot;&quot;&quot;</span>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>    <span class="n">limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LimitDecl</span><span class="p">]</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>    <span class="n">on_unavailable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">SystemDecl</span><span class="p">:</span>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>            <span class="n">name</span><span class="p">:</span> <span class="n">LimitDecl</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>        <span class="p">}</span>
</span><span id="__span-9-50"><a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">on_unavailable</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on_unavailable&quot;</span><span class="p">))</span>
</span><span id="__span-9-51"><a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>
</span><span id="__span-9-52"><a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-9-53"><a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-54"><a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>            <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">lim</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">lim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
</span><span id="__span-9-55"><a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>        <span class="p">}</span>
</span><span id="__span-9-56"><a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_unavailable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-9-57"><a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;on_unavailable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_unavailable</span>
</span><span id="__span-9-58"><a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-9-59"><a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>
</span><span id="__span-9-60"><a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>
</span><span id="__span-9-61"><a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-62"><a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResourceDecl</span><span class="p">:</span>
</span><span id="__span-9-63"><a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Resource-level limit declaration.&quot;&quot;&quot;</span>
</span><span id="__span-9-64"><a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>
</span><span id="__span-9-65"><a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>    <span class="n">limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LimitDecl</span><span class="p">]</span>
</span><span id="__span-9-66"><a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>
</span><span id="__span-9-67"><a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-9-68"><a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ResourceDecl</span><span class="p">:</span>
</span><span id="__span-9-69"><a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-70"><a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>            <span class="n">name</span><span class="p">:</span> <span class="n">LimitDecl</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-9-71"><a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-72"><a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>        <span class="p">}</span>
</span><span id="__span-9-73"><a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
</span><span id="__span-9-74"><a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>
</span><span id="__span-9-75"><a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-9-76"><a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">lim</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">lim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">items</span><span class="p">()}}</span>
</span><span id="__span-9-77"><a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>
</span><span id="__span-9-78"><a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>
</span><span id="__span-9-79"><a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-80"><a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a><span class="k">class</span><span class="w"> </span><span class="nc">EntityResourceDecl</span><span class="p">:</span>
</span><span id="__span-9-81"><a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Entity-resource-level limit declaration.&quot;&quot;&quot;</span>
</span><span id="__span-9-82"><a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>
</span><span id="__span-9-83"><a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>    <span class="n">limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LimitDecl</span><span class="p">]</span>
</span><span id="__span-9-84"><a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>
</span><span id="__span-9-85"><a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-9-86"><a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">EntityResourceDecl</span><span class="p">:</span>
</span><span id="__span-9-87"><a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>        <span class="n">limits</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-88"><a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>            <span class="n">name</span><span class="p">:</span> <span class="n">LimitDecl</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-9-89"><a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-90"><a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>        <span class="p">}</span>
</span><span id="__span-9-91"><a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
</span><span id="__span-9-92"><a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>
</span><span id="__span-9-93"><a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-9-94"><a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">lim</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">lim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">items</span><span class="p">()}}</span>
</span><span id="__span-9-95"><a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a>
</span><span id="__span-9-96"><a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a>
</span><span id="__span-9-97"><a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-98"><a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a><span class="k">class</span><span class="w"> </span><span class="nc">EntityDecl</span><span class="p">:</span>
</span><span id="__span-9-99"><a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Entity-level declaration with per-resource limits.&quot;&quot;&quot;</span>
</span><span id="__span-9-100"><a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a>
</span><span id="__span-9-101"><a id="__codelineno-9-101" name="__codelineno-9-101" href="#__codelineno-9-101"></a>    <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EntityResourceDecl</span><span class="p">]</span>
</span><span id="__span-9-102"><a id="__codelineno-9-102" name="__codelineno-9-102" href="#__codelineno-9-102"></a>
</span><span id="__span-9-103"><a id="__codelineno-9-103" name="__codelineno-9-103" href="#__codelineno-9-103"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-9-104"><a id="__codelineno-9-104" name="__codelineno-9-104" href="#__codelineno-9-104"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">EntityDecl</span><span class="p">:</span>
</span><span id="__span-9-105"><a id="__codelineno-9-105" name="__codelineno-9-105" href="#__codelineno-9-105"></a>        <span class="n">resources</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-106"><a id="__codelineno-9-106" name="__codelineno-9-106" href="#__codelineno-9-106"></a>            <span class="n">name</span><span class="p">:</span> <span class="n">EntityResourceDecl</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-9-107"><a id="__codelineno-9-107" name="__codelineno-9-107" href="#__codelineno-9-107"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-108"><a id="__codelineno-9-108" name="__codelineno-9-108" href="#__codelineno-9-108"></a>        <span class="p">}</span>
</span><span id="__span-9-109"><a id="__codelineno-9-109" name="__codelineno-9-109" href="#__codelineno-9-109"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">)</span>
</span><span id="__span-9-110"><a id="__codelineno-9-110" name="__codelineno-9-110" href="#__codelineno-9-110"></a>
</span><span id="__span-9-111"><a id="__codelineno-9-111" name="__codelineno-9-111" href="#__codelineno-9-111"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-9-112"><a id="__codelineno-9-112" name="__codelineno-9-112" href="#__codelineno-9-112"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-9-113"><a id="__codelineno-9-113" name="__codelineno-9-113" href="#__codelineno-9-113"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-9-114"><a id="__codelineno-9-114" name="__codelineno-9-114" href="#__codelineno-9-114"></a>                <span class="n">name</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-115"><a id="__codelineno-9-115" name="__codelineno-9-115" href="#__codelineno-9-115"></a>            <span class="p">},</span>
</span><span id="__span-9-116"><a id="__codelineno-9-116" name="__codelineno-9-116" href="#__codelineno-9-116"></a>        <span class="p">}</span>
</span><span id="__span-9-117"><a id="__codelineno-9-117" name="__codelineno-9-117" href="#__codelineno-9-117"></a>
</span><span id="__span-9-118"><a id="__codelineno-9-118" name="__codelineno-9-118" href="#__codelineno-9-118"></a>
</span><span id="__span-9-119"><a id="__codelineno-9-119" name="__codelineno-9-119" href="#__codelineno-9-119"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-120"><a id="__codelineno-9-120" name="__codelineno-9-120" href="#__codelineno-9-120"></a><span class="k">class</span><span class="w"> </span><span class="nc">LimitsManifest</span><span class="p">:</span>
</span><span id="__span-9-121"><a id="__codelineno-9-121" name="__codelineno-9-121" href="#__codelineno-9-121"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parsed YAML manifest for declarative limits management.&quot;&quot;&quot;</span>
</span><span id="__span-9-122"><a id="__codelineno-9-122" name="__codelineno-9-122" href="#__codelineno-9-122"></a>
</span><span id="__span-9-123"><a id="__codelineno-9-123" name="__codelineno-9-123" href="#__codelineno-9-123"></a>    <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-9-124"><a id="__codelineno-9-124" name="__codelineno-9-124" href="#__codelineno-9-124"></a>    <span class="n">system</span><span class="p">:</span> <span class="n">SystemDecl</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-125"><a id="__codelineno-9-125" name="__codelineno-9-125" href="#__codelineno-9-125"></a>    <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResourceDecl</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-9-126"><a id="__codelineno-9-126" name="__codelineno-9-126" href="#__codelineno-9-126"></a>    <span class="n">entities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EntityDecl</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-9-127"><a id="__codelineno-9-127" name="__codelineno-9-127" href="#__codelineno-9-127"></a>
</span><span id="__span-9-128"><a id="__codelineno-9-128" name="__codelineno-9-128" href="#__codelineno-9-128"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-9-129"><a id="__codelineno-9-129" name="__codelineno-9-129" href="#__codelineno-9-129"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">LimitsManifest</span><span class="p">:</span>
</span><span id="__span-9-130"><a id="__codelineno-9-130" name="__codelineno-9-130" href="#__codelineno-9-130"></a>        <span class="n">namespace</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">)</span>
</span><span id="__span-9-131"><a id="__codelineno-9-131" name="__codelineno-9-131" href="#__codelineno-9-131"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span><span class="p">:</span>
</span><span id="__span-9-132"><a id="__codelineno-9-132" name="__codelineno-9-132" href="#__codelineno-9-132"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;namespace&#39; is required in limits manifest&quot;</span><span class="p">)</span>
</span><span id="__span-9-133"><a id="__codelineno-9-133" name="__codelineno-9-133" href="#__codelineno-9-133"></a>
</span><span id="__span-9-134"><a id="__codelineno-9-134" name="__codelineno-9-134" href="#__codelineno-9-134"></a>        <span class="n">system</span> <span class="o">=</span> <span class="n">SystemDecl</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;system&quot;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-9-135"><a id="__codelineno-9-135" name="__codelineno-9-135" href="#__codelineno-9-135"></a>
</span><span id="__span-9-136"><a id="__codelineno-9-136" name="__codelineno-9-136" href="#__codelineno-9-136"></a>        <span class="n">resources</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-137"><a id="__codelineno-9-137" name="__codelineno-9-137" href="#__codelineno-9-137"></a>            <span class="n">name</span><span class="p">:</span> <span class="n">ResourceDecl</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-9-138"><a id="__codelineno-9-138" name="__codelineno-9-138" href="#__codelineno-9-138"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-139"><a id="__codelineno-9-139" name="__codelineno-9-139" href="#__codelineno-9-139"></a>        <span class="p">}</span>
</span><span id="__span-9-140"><a id="__codelineno-9-140" name="__codelineno-9-140" href="#__codelineno-9-140"></a>
</span><span id="__span-9-141"><a id="__codelineno-9-141" name="__codelineno-9-141" href="#__codelineno-9-141"></a>        <span class="n">entities</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-142"><a id="__codelineno-9-142" name="__codelineno-9-142" href="#__codelineno-9-142"></a>            <span class="n">name</span><span class="p">:</span> <span class="n">EntityDecl</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-9-143"><a id="__codelineno-9-143" name="__codelineno-9-143" href="#__codelineno-9-143"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-144"><a id="__codelineno-9-144" name="__codelineno-9-144" href="#__codelineno-9-144"></a>        <span class="p">}</span>
</span><span id="__span-9-145"><a id="__codelineno-9-145" name="__codelineno-9-145" href="#__codelineno-9-145"></a>
</span><span id="__span-9-146"><a id="__codelineno-9-146" name="__codelineno-9-146" href="#__codelineno-9-146"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="__span-9-147"><a id="__codelineno-9-147" name="__codelineno-9-147" href="#__codelineno-9-147"></a>            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
</span><span id="__span-9-148"><a id="__codelineno-9-148" name="__codelineno-9-148" href="#__codelineno-9-148"></a>            <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span>
</span><span id="__span-9-149"><a id="__codelineno-9-149" name="__codelineno-9-149" href="#__codelineno-9-149"></a>            <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span>
</span><span id="__span-9-150"><a id="__codelineno-9-150" name="__codelineno-9-150" href="#__codelineno-9-150"></a>            <span class="n">entities</span><span class="o">=</span><span class="n">entities</span><span class="p">,</span>
</span><span id="__span-9-151"><a id="__codelineno-9-151" name="__codelineno-9-151" href="#__codelineno-9-151"></a>        <span class="p">)</span>
</span><span id="__span-9-152"><a id="__codelineno-9-152" name="__codelineno-9-152" href="#__codelineno-9-152"></a>
</span><span id="__span-9-153"><a id="__codelineno-9-153" name="__codelineno-9-153" href="#__codelineno-9-153"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-9-154"><a id="__codelineno-9-154" name="__codelineno-9-154" href="#__codelineno-9-154"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yaml_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LimitsManifest</span><span class="p">:</span>
</span><span id="__span-9-155"><a id="__codelineno-9-155" name="__codelineno-9-155" href="#__codelineno-9-155"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
</span><span id="__span-9-156"><a id="__codelineno-9-156" name="__codelineno-9-156" href="#__codelineno-9-156"></a>
</span><span id="__span-9-157"><a id="__codelineno-9-157" name="__codelineno-9-157" href="#__codelineno-9-157"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yaml_str</span><span class="p">)</span>
</span><span id="__span-9-158"><a id="__codelineno-9-158" name="__codelineno-9-158" href="#__codelineno-9-158"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-9-159"><a id="__codelineno-9-159" name="__codelineno-9-159" href="#__codelineno-9-159"></a>
</span><span id="__span-9-160"><a id="__codelineno-9-160" name="__codelineno-9-160" href="#__codelineno-9-160"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-9-161"><a id="__codelineno-9-161" name="__codelineno-9-161" href="#__codelineno-9-161"></a>        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">}</span>
</span><span id="__span-9-162"><a id="__codelineno-9-162" name="__codelineno-9-162" href="#__codelineno-9-162"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-9-163"><a id="__codelineno-9-163" name="__codelineno-9-163" href="#__codelineno-9-163"></a>            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="__span-9-164"><a id="__codelineno-9-164" name="__codelineno-9-164" href="#__codelineno-9-164"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
</span><span id="__span-9-165"><a id="__codelineno-9-165" name="__codelineno-9-165" href="#__codelineno-9-165"></a>            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-166"><a id="__codelineno-9-166" name="__codelineno-9-166" href="#__codelineno-9-166"></a>                <span class="n">name</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-167"><a id="__codelineno-9-167" name="__codelineno-9-167" href="#__codelineno-9-167"></a>            <span class="p">}</span>
</span><span id="__span-9-168"><a id="__codelineno-9-168" name="__codelineno-9-168" href="#__codelineno-9-168"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
</span><span id="__span-9-169"><a id="__codelineno-9-169" name="__codelineno-9-169" href="#__codelineno-9-169"></a>            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-170"><a id="__codelineno-9-170" name="__codelineno-9-170" href="#__codelineno-9-170"></a>                <span class="n">name</span><span class="p">:</span> <span class="n">ent</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-171"><a id="__codelineno-9-171" name="__codelineno-9-171" href="#__codelineno-9-171"></a>            <span class="p">}</span>
</span><span id="__span-9-172"><a id="__codelineno-9-172" name="__codelineno-9-172" href="#__codelineno-9-172"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-9-173"><a id="__codelineno-9-173" name="__codelineno-9-173" href="#__codelineno-9-173"></a>
</span><span id="__span-9-174"><a id="__codelineno-9-174" name="__codelineno-9-174" href="#__codelineno-9-174"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">managed_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-9-175"><a id="__codelineno-9-175" name="__codelineno-9-175" href="#__codelineno-9-175"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract the set of managed items from this manifest.</span>
</span><span id="__span-9-176"><a id="__codelineno-9-176" name="__codelineno-9-176" href="#__codelineno-9-176"></a>
</span><span id="__span-9-177"><a id="__codelineno-9-177" name="__codelineno-9-177" href="#__codelineno-9-177"></a><span class="sd">        Returns:</span>
</span><span id="__span-9-178"><a id="__codelineno-9-178" name="__codelineno-9-178" href="#__codelineno-9-178"></a><span class="sd">            Dict with managed_system (bool), managed_resources (list[str]),</span>
</span><span id="__span-9-179"><a id="__codelineno-9-179" name="__codelineno-9-179" href="#__codelineno-9-179"></a><span class="sd">            managed_entities (dict[str, list[str]]).</span>
</span><span id="__span-9-180"><a id="__codelineno-9-180" name="__codelineno-9-180" href="#__codelineno-9-180"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-9-181"><a id="__codelineno-9-181" name="__codelineno-9-181" href="#__codelineno-9-181"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-9-182"><a id="__codelineno-9-182" name="__codelineno-9-182" href="#__codelineno-9-182"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-9-183"><a id="__codelineno-9-183" name="__codelineno-9-183" href="#__codelineno-9-183"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
</span><span id="__span-9-184"><a id="__codelineno-9-184" name="__codelineno-9-184" href="#__codelineno-9-184"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-9-185"><a id="__codelineno-9-185" name="__codelineno-9-185" href="#__codelineno-9-185"></a>                <span class="n">entity_id</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="__span-9-186"><a id="__codelineno-9-186" name="__codelineno-9-186" href="#__codelineno-9-186"></a>                <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-9-187"><a id="__codelineno-9-187" name="__codelineno-9-187" href="#__codelineno-9-187"></a>            <span class="p">},</span>
</span><span id="__span-9-188"><a id="__codelineno-9-188" name="__codelineno-9-188" href="#__codelineno-9-188"></a>        <span class="p">}</span>
</span></code></pre></div>
<p><strong>Step 4: Register the package in pyproject.toml</strong></p>
<p>In <code>pyproject.toml</code>, update the packages list (line 97):</p>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;src/zae_limiter&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src/zae_limiter_aggregator&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src/zae_limiter_provisioner&quot;</span><span class="p">]</span>
</span></code></pre></div>
<p>Add <code>pyyaml</code> to the project dependencies if not already present (check first).</p>
<p><strong>Step 5: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_manifest.py -v</code>
Expected: PASS</p>
<p><strong>Step 6: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>git add src/zae_limiter_provisioner/ tests/unit/test_manifest.py pyproject.toml
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>git commit -m &quot;✨ feat(infra): add LimitsManifest dataclass with YAML parsing&quot;
</span></code></pre></div>
<hr />
<h2 id="task-4-provisioner-package-differ-module">Task 4: Provisioner Package — Differ Module<a class="headerlink" href="#task-4-provisioner-package-differ-module" title="Permanent link">&para;</a></h2>
<p>The diff engine compares a manifest against the previous provisioner state to produce a list of changes.</p>
<p><strong>Files:</strong>
- Create: <code>src/zae_limiter_provisioner/differ.py</code>
- Test: <code>tests/unit/test_differ.py</code></p>
<p><strong>Step 1: Write the failing tests</strong></p>
<p>Create <code>tests/unit/test_differ.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="sd">&quot;&quot;&quot;Tests for the provisioner diff engine.&quot;&quot;&quot;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.differ</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_diff</span><span class="p">,</span> <span class="n">Change</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitsManifest</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestComputeDiff</span><span class="p">:</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for diff computation between manifest and previous state.&quot;&quot;&quot;</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_first_apply_creates_everything</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;First apply (empty previous state) creates all items.&quot;&quot;&quot;</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}},</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">}}}},</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>            <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>                <span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}}}}},</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>            <span class="p">},</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="p">})</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>        <span class="p">}</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="p">{(</span><span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">}</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1/gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_no_changes_on_same_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-applying same manifest produces update actions (idempotent overwrites).&quot;&quot;&quot;</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}},</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">}}}},</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>        <span class="p">})</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">],</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>        <span class="p">}</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="p">{(</span><span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">}</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_removed_resource_produces_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resource in previous but not in manifest produces delete.&quot;&quot;&quot;</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">})</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">],</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>        <span class="p">}</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="p">{(</span><span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">}</span>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_removed_system_produces_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;System in previous but not in manifest produces delete.&quot;&quot;&quot;</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">})</span>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a>        <span class="p">}</span>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="p">{(</span><span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">}</span>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>
</span><span id="__span-12-80"><a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_removed_entity_resource_produces_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Entity resource in previous but not in manifest produces delete.&quot;&quot;&quot;</span>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">})</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]},</span>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a>        <span class="p">}</span>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="p">{(</span><span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">}</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1/gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_unmanaged_items_not_touched</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Items never in previous managed set produce no changes.&quot;&quot;&quot;</span>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
</span><span id="__span-12-100"><a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}},</span>
</span><span id="__span-12-101"><a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a>        <span class="p">})</span>
</span><span id="__span-12-102"><a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-103"><a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-12-104"><a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-12-105"><a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-12-106"><a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a>        <span class="p">}</span>
</span><span id="__span-12-107"><a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a>
</span><span id="__span-12-108"><a id="__codelineno-12-108" name="__codelineno-12-108" href="#__codelineno-12-108"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-12-109"><a id="__codelineno-12-109" name="__codelineno-12-109" href="#__codelineno-12-109"></a>        <span class="c1"># gpt-4 is new (create), but no deletes for things never managed</span>
</span><span id="__span-12-110"><a id="__codelineno-12-110" name="__codelineno-12-110" href="#__codelineno-12-110"></a>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;delete&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">)</span>
</span><span id="__span-12-111"><a id="__codelineno-12-111" name="__codelineno-12-111" href="#__codelineno-12-111"></a>
</span><span id="__span-12-112"><a id="__codelineno-12-112" name="__codelineno-12-112" href="#__codelineno-12-112"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_empty_manifest_deletes_all_managed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-113"><a id="__codelineno-12-113" name="__codelineno-12-113" href="#__codelineno-12-113"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Empty manifest (CFN Delete) deletes all previously managed items.&quot;&quot;&quot;</span>
</span><span id="__span-12-114"><a id="__codelineno-12-114" name="__codelineno-12-114" href="#__codelineno-12-114"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ns&quot;</span><span class="p">})</span>
</span><span id="__span-12-115"><a id="__codelineno-12-115" name="__codelineno-12-115" href="#__codelineno-12-115"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-116"><a id="__codelineno-12-116" name="__codelineno-12-116" href="#__codelineno-12-116"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-117"><a id="__codelineno-12-117" name="__codelineno-12-117" href="#__codelineno-12-117"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;claude-3&quot;</span><span class="p">],</span>
</span><span id="__span-12-118"><a id="__codelineno-12-118" name="__codelineno-12-118" href="#__codelineno-12-118"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;user-1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]},</span>
</span><span id="__span-12-119"><a id="__codelineno-12-119" name="__codelineno-12-119" href="#__codelineno-12-119"></a>        <span class="p">}</span>
</span><span id="__span-12-120"><a id="__codelineno-12-120" name="__codelineno-12-120" href="#__codelineno-12-120"></a>
</span><span id="__span-12-121"><a id="__codelineno-12-121" name="__codelineno-12-121" href="#__codelineno-12-121"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122" href="#__codelineno-12-122"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="p">{(</span><span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">}</span>
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123" href="#__codelineno-12-123"></a>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124" href="#__codelineno-12-124"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125" href="#__codelineno-12-125"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-126"><a id="__codelineno-12-126" name="__codelineno-12-126" href="#__codelineno-12-126"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;claude-3&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-127"><a id="__codelineno-12-127" name="__codelineno-12-127" href="#__codelineno-12-127"></a>        <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1/gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">actions</span>
</span><span id="__span-12-128"><a id="__codelineno-12-128" name="__codelineno-12-128" href="#__codelineno-12-128"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_differ.py -v</code>
Expected: FAIL with <code>ModuleNotFoundError: No module named 'zae_limiter_provisioner.differ'</code></p>
<p><strong>Step 3: Write the implementation</strong></p>
<p>Create <code>src/zae_limiter_provisioner/differ.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="sd">&quot;&quot;&quot;Diff engine for declarative limits management.</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="sd">Compares a LimitsManifest against the previous provisioner state</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="sd">to produce a list of changes (create/update/delete).</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitsManifest</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">Change</span><span class="p">:</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A single change to apply.&quot;&quot;&quot;</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;create&quot;, &quot;update&quot;, &quot;delete&quot;</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>    <span class="n">level</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;system&quot;, &quot;resource&quot;, &quot;entity&quot;</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>  <span class="c1"># resource name, &quot;entity_id/resource&quot;, or None for system</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># manifest data for create/update</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_diff</span><span class="p">(</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>    <span class="n">manifest</span><span class="p">:</span> <span class="n">LimitsManifest</span><span class="p">,</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>    <span class="n">previous</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Change</span><span class="p">]:</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute changes between a manifest and previous managed state.</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="sd">    Args:</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="sd">        manifest: The new desired state from YAML.</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="sd">        previous: The previous managed set from #PROVISIONER record.</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="sd">                  Keys: managed_system, managed_resources, managed_entities.</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="sd">    Returns:</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="sd">        List of Change objects to apply.</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>    <span class="n">changes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Change</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>    <span class="c1"># --- System ---</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>    <span class="n">prev_system</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_system&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>    <span class="k">if</span> <span class="n">manifest</span><span class="o">.</span><span class="n">system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;update&quot;</span> <span class="k">if</span> <span class="n">prev_system</span> <span class="k">else</span> <span class="s2">&quot;create&quot;</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>        <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Change</span><span class="p">(</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>            <span class="n">data</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>        <span class="p">))</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>    <span class="k">elif</span> <span class="n">prev_system</span><span class="p">:</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>        <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>    <span class="c1"># --- Resources ---</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>    <span class="n">prev_resources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">,</span> <span class="p">[]))</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a>    <span class="n">curr_resources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>    <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">curr_resources</span><span class="p">:</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;update&quot;</span> <span class="k">if</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">prev_resources</span> <span class="k">else</span> <span class="s2">&quot;create&quot;</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>        <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Change</span><span class="p">(</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>            <span class="n">data</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a>        <span class="p">))</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a>    <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">prev_resources</span> <span class="o">-</span> <span class="n">curr_resources</span><span class="p">:</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a>        <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">resource</span><span class="p">))</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a>    <span class="c1"># --- Entities ---</span>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a>    <span class="n">prev_entities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a>    <span class="n">prev_entity_resources</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a>    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resources</span> <span class="ow">in</span> <span class="n">prev_entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a>        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a>            <span class="n">prev_entity_resources</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">))</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a>    <span class="n">curr_entity_resources</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a>    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a>        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a>            <span class="n">curr_entity_resources</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">))</span>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a>    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">curr_entity_resources</span><span class="p">:</span>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a>        <span class="n">target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a>        <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;update&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span> <span class="ow">in</span> <span class="n">prev_entity_resources</span> <span class="k">else</span> <span class="s2">&quot;create&quot;</span>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a>        <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Change</span><span class="p">(</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82" href="#__codelineno-13-82"></a>            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83" href="#__codelineno-13-83"></a>            <span class="n">data</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity_id</span><span class="p">]</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84" href="#__codelineno-13-84"></a>        <span class="p">))</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85" href="#__codelineno-13-85"></a>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86" href="#__codelineno-13-86"></a>    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">prev_entity_resources</span> <span class="o">-</span> <span class="n">curr_entity_resources</span><span class="p">:</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87" href="#__codelineno-13-87"></a>        <span class="n">target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88" href="#__codelineno-13-88"></a>        <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">))</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89" href="#__codelineno-13-89"></a>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90" href="#__codelineno-13-90"></a>    <span class="k">return</span> <span class="n">changes</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_differ.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>git add src/zae_limiter_provisioner/differ.py tests/unit/test_differ.py
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>git commit -m &quot;✨ feat(infra): add diff engine for declarative limits provisioner&quot;
</span></code></pre></div>
<hr />
<h2 id="task-5-provisioner-package-applier-module">Task 5: Provisioner Package — Applier Module<a class="headerlink" href="#task-5-provisioner-package-applier-module" title="Permanent link">&para;</a></h2>
<p>The applier takes a list of <code>Change</code> objects and applies them via the Repository API (using boto3 sync, like the aggregator).</p>
<p><strong>Files:</strong>
- Create: <code>src/zae_limiter_provisioner/applier.py</code>
- Test: <code>tests/unit/test_applier.py</code></p>
<p><strong>Step 1: Write the failing tests</strong></p>
<p>Create <code>tests/unit/test_applier.py</code>. These tests mock the boto3 DynamoDB table resource to verify the applier calls the right Repository-equivalent operations. The applier uses boto3 (sync) directly since it runs in Lambda.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="sd">&quot;&quot;&quot;Tests for the provisioner applier.&quot;&quot;&quot;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">call</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.applier</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_changes</span><span class="p">,</span> <span class="n">ApplyResult</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.differ</span><span class="w"> </span><span class="kn">import</span> <span class="n">Change</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestApplyChanges</span><span class="p">:</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for applying changes to DynamoDB via Repository-equivalent operations.&quot;&quot;&quot;</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_empty_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Empty change list produces zero-change result.&quot;&quot;&quot;</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>        <span class="n">table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">([],</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns123&quot;</span><span class="p">)</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">created</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="p">[]</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_create_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create system defaults calls put_item with correct keys.&quot;&quot;&quot;</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>            <span class="p">[</span><span class="n">Change</span><span class="p">(</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;burst&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;refill_amount&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;refill_period&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}}},</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>            <span class="p">)],</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>            <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>            <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns123&quot;</span><span class="p">,</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="p">)</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">created</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_delete_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete resource defaults calls delete_item.&quot;&quot;&quot;</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>            <span class="p">[</span><span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">)],</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>            <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>            <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns123&quot;</span><span class="p">,</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>        <span class="p">)</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_create_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create entity limits calls put_item with entity/resource keys.&quot;&quot;&quot;</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>            <span class="p">[</span><span class="n">Change</span><span class="p">(</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;user-1/gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;burst&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;refill_amount&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;refill_period&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}}},</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>            <span class="p">)],</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>            <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>            <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns123&quot;</span><span class="p">,</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>        <span class="p">)</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">created</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_mixed_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mixed create/update/delete produces correct counts.&quot;&quot;&quot;</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>            <span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>                   <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;burst&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;refill_amount&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;refill_period&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}}}),</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>            <span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>                   <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;burst&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;refill_amount&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;refill_period&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}}}),</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>            <span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;claude-3&quot;</span><span class="p">),</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>            <span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;user-1/gpt-4&quot;</span><span class="p">),</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>        <span class="p">]</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns123&quot;</span><span class="p">)</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">created</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">updated</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted</span> <span class="o">==</span> <span class="mi">2</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_error_collected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Errors from individual operations are collected, not raised.&quot;&quot;&quot;</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>        <span class="c1"># This test verifies the error-collection pattern (like the aggregator)</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>            <span class="n">Change</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{}}),</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>        <span class="p">]</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>        <span class="c1"># Even with empty limits, should not crash</span>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns123&quot;</span><span class="p">)</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_applier.py -v</code>
Expected: FAIL with <code>ModuleNotFoundError: No module named 'zae_limiter_provisioner.applier'</code></p>
<p><strong>Step 3: Write the implementation</strong></p>
<p>Create <code>src/zae_limiter_provisioner/applier.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="sd">&quot;&quot;&quot;Applies limit changes to DynamoDB.</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="sd">Uses boto3 (sync) directly, like the aggregator. This module runs inside</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="sd">Lambda where aioboto3 is not available.</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.schema</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="n">limit_attr</span><span class="p">,</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="n">pk_entity</span><span class="p">,</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>    <span class="n">pk_resource</span><span class="p">,</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>    <span class="n">pk_system</span><span class="p">,</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>    <span class="n">sk_config</span><span class="p">,</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="p">)</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.differ</span><span class="w"> </span><span class="kn">import</span> <span class="n">Change</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="nd">@dataclass</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="k">class</span><span class="w"> </span><span class="nc">ApplyResult</span><span class="p">:</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of applying changes.&quot;&quot;&quot;</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>    <span class="n">created</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>    <span class="n">updated</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>    <span class="n">deleted</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>    <span class="n">errors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="k">def</span><span class="w"> </span><span class="nf">_build_limit_item</span><span class="p">(</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>    <span class="n">pk</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sk</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">extra</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a DynamoDB item for a config record with composite limit attributes.&quot;&quot;&quot;</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>    <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>        <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">},</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>        <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">sk</span><span class="p">},</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>        <span class="s2">&quot;GSI4PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">namespace_id</span><span class="p">},</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>    <span class="p">}</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>    <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extra</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>            <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">decl</span> <span class="ow">in</span> <span class="n">limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>        <span class="n">item</span><span class="p">[</span><span class="n">limit_attr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;cp&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">decl</span><span class="p">[</span><span class="s2">&quot;capacity&quot;</span><span class="p">])}</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>        <span class="n">item</span><span class="p">[</span><span class="n">limit_attr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;bx&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">decl</span><span class="p">[</span><span class="s2">&quot;burst&quot;</span><span class="p">])}</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>        <span class="n">item</span><span class="p">[</span><span class="n">limit_attr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">decl</span><span class="p">[</span><span class="s2">&quot;refill_amount&quot;</span><span class="p">])}</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>        <span class="n">item</span><span class="p">[</span><span class="n">limit_attr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;rp&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">decl</span><span class="p">[</span><span class="s2">&quot;refill_period&quot;</span><span class="p">])}</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>    <span class="k">return</span> <span class="n">item</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a><span class="k">def</span><span class="w"> </span><span class="nf">apply_changes</span><span class="p">(</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>    <span class="n">changes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Change</span><span class="p">],</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>    <span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApplyResult</span><span class="p">:</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a list of changes to DynamoDB.</span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a><span class="sd">    Args:</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a><span class="sd">        changes: List of Change objects from the differ.</span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a><span class="sd">        table_name: DynamoDB table name.</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a><span class="sd">        namespace_id: Opaque namespace ID (e.g., &#39;a7x3kq&#39;).</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a><span class="sd">    Returns:</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a><span class="sd">        ApplyResult with counts and any errors.</span>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">ApplyResult</span><span class="p">()</span>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>
</span><span id="__span-16-78"><a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a>
</span><span id="__span-16-79"><a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>    <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-16-80"><a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-16-81"><a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a>            <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span>
</span><span id="__span-16-82"><a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a>                <span class="n">_apply_delete</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span>
</span><span id="__span-16-83"><a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>                <span class="n">result</span><span class="o">.</span><span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-16-84"><a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a>            <span class="k">elif</span> <span class="n">change</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>
</span><span id="__span-16-85"><a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>                <span class="n">_apply_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span>
</span><span id="__span-16-86"><a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a>                <span class="n">result</span><span class="o">.</span><span class="n">created</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-16-87"><a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a>            <span class="k">elif</span> <span class="n">change</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span><span class="p">:</span>
</span><span id="__span-16-88"><a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a>                <span class="n">_apply_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span>
</span><span id="__span-16-89"><a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>                <span class="n">result</span><span class="o">.</span><span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-16-90"><a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-16-91"><a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a>            <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">change</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">change</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">change</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-16-92"><a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a>
</span><span id="__span-16-93"><a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-16-94"><a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a>
</span><span id="__span-16-95"><a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a>
</span><span id="__span-16-96"><a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a><span class="k">def</span><span class="w"> </span><span class="nf">_apply_set</span><span class="p">(</span>
</span><span id="__span-16-97"><a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>    <span class="n">client</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">change</span><span class="p">:</span> <span class="n">Change</span><span class="p">,</span>
</span><span id="__span-16-98"><a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-16-99"><a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a create or update change (PutItem).&quot;&quot;&quot;</span>
</span><span id="__span-16-100"><a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="__span-16-101"><a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a>    <span class="n">limits</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-16-102"><a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a>
</span><span id="__span-16-103"><a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a>    <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="__span-16-104"><a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a>        <span class="n">pk</span> <span class="o">=</span> <span class="n">pk_system</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">)</span>
</span><span id="__span-16-105"><a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a>        <span class="n">sk</span> <span class="o">=</span> <span class="n">sk_config</span><span class="p">()</span>
</span><span id="__span-16-106"><a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a>        <span class="n">extra</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-16-107"><a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a>        <span class="n">on_unavailable</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on_unavailable&quot;</span><span class="p">)</span>
</span><span id="__span-16-108"><a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a>        <span class="k">if</span> <span class="n">on_unavailable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-16-109"><a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a>            <span class="n">extra</span><span class="p">[</span><span class="s2">&quot;on_unavailable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">on_unavailable</span><span class="p">}</span>
</span><span id="__span-16-110"><a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">_build_limit_item</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
</span><span id="__span-16-111"><a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a>
</span><span id="__span-16-112"><a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>    <span class="k">elif</span> <span class="n">change</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
</span><span id="__span-16-113"><a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a>        <span class="n">resource</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">target</span>
</span><span id="__span-16-114"><a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>        <span class="n">pk</span> <span class="o">=</span> <span class="n">pk_resource</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
</span><span id="__span-16-115"><a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>        <span class="n">sk</span> <span class="o">=</span> <span class="n">sk_config</span><span class="p">()</span>
</span><span id="__span-16-116"><a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a>        <span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">resource</span><span class="p">}}</span>
</span><span id="__span-16-117"><a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">_build_limit_item</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
</span><span id="__span-16-118"><a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a>
</span><span id="__span-16-119"><a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a>    <span class="k">elif</span> <span class="n">change</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;entity&quot;</span><span class="p">:</span>
</span><span id="__span-16-120"><a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a>        <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-16-121"><a id="__codelineno-16-121" name="__codelineno-16-121" href="#__codelineno-16-121"></a>        <span class="n">pk</span> <span class="o">=</span> <span class="n">pk_entity</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">)</span>
</span><span id="__span-16-122"><a id="__codelineno-16-122" name="__codelineno-16-122" href="#__codelineno-16-122"></a>        <span class="n">sk</span> <span class="o">=</span> <span class="n">sk_config</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span><span id="__span-16-123"><a id="__codelineno-16-123" name="__codelineno-16-123" href="#__codelineno-16-123"></a>        <span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;entity_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">entity_id</span><span class="p">},</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">resource</span><span class="p">}}</span>
</span><span id="__span-16-124"><a id="__codelineno-16-124" name="__codelineno-16-124" href="#__codelineno-16-124"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">_build_limit_item</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
</span><span id="__span-16-125"><a id="__codelineno-16-125" name="__codelineno-16-125" href="#__codelineno-16-125"></a>
</span><span id="__span-16-126"><a id="__codelineno-16-126" name="__codelineno-16-126" href="#__codelineno-16-126"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-16-127"><a id="__codelineno-16-127" name="__codelineno-16-127" href="#__codelineno-16-127"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown level: </span><span class="si">{</span><span class="n">change</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-16-128"><a id="__codelineno-16-128" name="__codelineno-16-128" href="#__codelineno-16-128"></a>
</span><span id="__span-16-129"><a id="__codelineno-16-129" name="__codelineno-16-129" href="#__codelineno-16-129"></a>    <span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
</span><span id="__span-16-130"><a id="__codelineno-16-130" name="__codelineno-16-130" href="#__codelineno-16-130"></a>
</span><span id="__span-16-131"><a id="__codelineno-16-131" name="__codelineno-16-131" href="#__codelineno-16-131"></a>
</span><span id="__span-16-132"><a id="__codelineno-16-132" name="__codelineno-16-132" href="#__codelineno-16-132"></a><span class="k">def</span><span class="w"> </span><span class="nf">_apply_delete</span><span class="p">(</span>
</span><span id="__span-16-133"><a id="__codelineno-16-133" name="__codelineno-16-133" href="#__codelineno-16-133"></a>    <span class="n">client</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">change</span><span class="p">:</span> <span class="n">Change</span><span class="p">,</span>
</span><span id="__span-16-134"><a id="__codelineno-16-134" name="__codelineno-16-134" href="#__codelineno-16-134"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-16-135"><a id="__codelineno-16-135" name="__codelineno-16-135" href="#__codelineno-16-135"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a delete change (DeleteItem).&quot;&quot;&quot;</span>
</span><span id="__span-16-136"><a id="__codelineno-16-136" name="__codelineno-16-136" href="#__codelineno-16-136"></a>    <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="__span-16-137"><a id="__codelineno-16-137" name="__codelineno-16-137" href="#__codelineno-16-137"></a>        <span class="n">pk</span> <span class="o">=</span> <span class="n">pk_system</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">)</span>
</span><span id="__span-16-138"><a id="__codelineno-16-138" name="__codelineno-16-138" href="#__codelineno-16-138"></a>        <span class="n">sk</span> <span class="o">=</span> <span class="n">sk_config</span><span class="p">()</span>
</span><span id="__span-16-139"><a id="__codelineno-16-139" name="__codelineno-16-139" href="#__codelineno-16-139"></a>
</span><span id="__span-16-140"><a id="__codelineno-16-140" name="__codelineno-16-140" href="#__codelineno-16-140"></a>    <span class="k">elif</span> <span class="n">change</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;resource&quot;</span><span class="p">:</span>
</span><span id="__span-16-141"><a id="__codelineno-16-141" name="__codelineno-16-141" href="#__codelineno-16-141"></a>        <span class="n">resource</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">target</span>
</span><span id="__span-16-142"><a id="__codelineno-16-142" name="__codelineno-16-142" href="#__codelineno-16-142"></a>        <span class="n">pk</span> <span class="o">=</span> <span class="n">pk_resource</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
</span><span id="__span-16-143"><a id="__codelineno-16-143" name="__codelineno-16-143" href="#__codelineno-16-143"></a>        <span class="n">sk</span> <span class="o">=</span> <span class="n">sk_config</span><span class="p">()</span>
</span><span id="__span-16-144"><a id="__codelineno-16-144" name="__codelineno-16-144" href="#__codelineno-16-144"></a>
</span><span id="__span-16-145"><a id="__codelineno-16-145" name="__codelineno-16-145" href="#__codelineno-16-145"></a>    <span class="k">elif</span> <span class="n">change</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;entity&quot;</span><span class="p">:</span>
</span><span id="__span-16-146"><a id="__codelineno-16-146" name="__codelineno-16-146" href="#__codelineno-16-146"></a>        <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-16-147"><a id="__codelineno-16-147" name="__codelineno-16-147" href="#__codelineno-16-147"></a>        <span class="n">pk</span> <span class="o">=</span> <span class="n">pk_entity</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">)</span>
</span><span id="__span-16-148"><a id="__codelineno-16-148" name="__codelineno-16-148" href="#__codelineno-16-148"></a>        <span class="n">sk</span> <span class="o">=</span> <span class="n">sk_config</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span><span id="__span-16-149"><a id="__codelineno-16-149" name="__codelineno-16-149" href="#__codelineno-16-149"></a>
</span><span id="__span-16-150"><a id="__codelineno-16-150" name="__codelineno-16-150" href="#__codelineno-16-150"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-16-151"><a id="__codelineno-16-151" name="__codelineno-16-151" href="#__codelineno-16-151"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown level: </span><span class="si">{</span><span class="n">change</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-16-152"><a id="__codelineno-16-152" name="__codelineno-16-152" href="#__codelineno-16-152"></a>
</span><span id="__span-16-153"><a id="__codelineno-16-153" name="__codelineno-16-153" href="#__codelineno-16-153"></a>    <span class="n">client</span><span class="o">.</span><span class="n">delete_item</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">},</span> <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">sk</span><span class="p">}})</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_applier.py -v</code>
Expected: PASS (boto3 calls go to moto or need mocking — adjust test setup to use <code>@mock_aws</code> or mock the client)</p>
<p><strong>Note:</strong> The test setup may need <code>moto</code> or explicit mocking of <code>boto3.client("dynamodb")</code>. Follow the pattern in <code>tests/unit/test_handler.py</code> for mocking.</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>git add src/zae_limiter_provisioner/applier.py tests/unit/test_applier.py
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>git commit -m &quot;✨ feat(infra): add applier module for declarative limits provisioner&quot;
</span></code></pre></div>
<hr />
<h2 id="task-6-provisioner-package-lambda-handler">Task 6: Provisioner Package — Lambda Handler<a class="headerlink" href="#task-6-provisioner-package-lambda-handler" title="Permanent link">&para;</a></h2>
<p>The Lambda entry point that handles both CLI invocations and CloudFormation custom resource events.</p>
<p><strong>Files:</strong>
- Create: <code>src/zae_limiter_provisioner/handler.py</code>
- Test: <code>tests/unit/test_provisioner_handler.py</code></p>
<p><strong>Step 1: Write the failing tests</strong></p>
<p>Create <code>tests/unit/test_provisioner_handler.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="sd">&quot;&quot;&quot;Tests for the provisioner Lambda handler.&quot;&quot;&quot;</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">on_event</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestProvisionerHandler</span><span class="p">:</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for the provisioner Lambda handler.&quot;&quot;&quot;</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_plan_action_returns_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plan action computes diff without applying.&quot;&quot;&quot;</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;plan&quot;</span><span class="p">,</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>            <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="s2">&quot;test-table&quot;</span><span class="p">,</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>            <span class="s2">&quot;namespace_id&quot;</span><span class="p">:</span> <span class="s2">&quot;ns123&quot;</span><span class="p">,</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>            <span class="s2">&quot;manifest&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>                <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}},</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>            <span class="p">},</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>        <span class="p">}</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;planned&quot;</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;changes&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_action_applies_and_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply action applies changes and updates state.&quot;&quot;&quot;</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;apply&quot;</span><span class="p">,</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>            <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="s2">&quot;test-table&quot;</span><span class="p">,</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>            <span class="s2">&quot;namespace_id&quot;</span><span class="p">:</span> <span class="s2">&quot;ns123&quot;</span><span class="p">,</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>            <span class="s2">&quot;manifest&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>                <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>                <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}}},</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>            <span class="p">},</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>        <span class="p">}</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;applied&quot;</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>        <span class="k">assert</span> <span class="s2">&quot;changes&quot;</span> <span class="ow">in</span> <span class="n">result</span>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_cfn_create_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;CloudFormation Create event applies the manifest.&quot;&quot;&quot;</span>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>            <span class="s2">&quot;RequestType&quot;</span><span class="p">:</span> <span class="s2">&quot;Create&quot;</span><span class="p">,</span>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>            <span class="s2">&quot;ResourceProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>                <span class="s2">&quot;ServiceToken&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:lambda:us-east-1:123:function:test&quot;</span><span class="p">,</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>                <span class="s2">&quot;TableName&quot;</span><span class="p">:</span> <span class="s2">&quot;test-table&quot;</span><span class="p">,</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>                <span class="s2">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>                <span class="s2">&quot;NamespaceId&quot;</span><span class="p">:</span> <span class="s2">&quot;ns123&quot;</span><span class="p">,</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>                <span class="s2">&quot;System&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}},</span>
</span><span id="__span-18-55"><a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>            <span class="p">},</span>
</span><span id="__span-18-56"><a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>            <span class="s2">&quot;ResponseURL&quot;</span><span class="p">:</span> <span class="s2">&quot;https://cfn-response.example.com&quot;</span><span class="p">,</span>
</span><span id="__span-18-57"><a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>            <span class="s2">&quot;StackId&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:cloudformation:us-east-1:123:stack/test/guid&quot;</span><span class="p">,</span>
</span><span id="__span-18-58"><a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>            <span class="s2">&quot;RequestId&quot;</span><span class="p">:</span> <span class="s2">&quot;test-request-id&quot;</span><span class="p">,</span>
</span><span id="__span-18-59"><a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>            <span class="s2">&quot;LogicalResourceId&quot;</span><span class="p">:</span> <span class="s2">&quot;TenantLimits&quot;</span><span class="p">,</span>
</span><span id="__span-18-60"><a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>        <span class="p">}</span>
</span><span id="__span-18-61"><a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-18-62"><a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a>        <span class="c1"># CFN events are handled by on_event but need cfnresponse mocked</span>
</span><span id="__span-18-63"><a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a>        <span class="c1"># The handler should detect CFN events and route appropriately</span>
</span><span id="__span-18-64"><a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-18-65"><a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a>        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;applied&quot;</span><span class="p">,</span> <span class="s2">&quot;planned&quot;</span><span class="p">)</span>
</span><span id="__span-18-66"><a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a>
</span><span id="__span-18-67"><a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_cfn_delete_event_clears_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-18-68"><a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;CloudFormation Delete event applies empty manifest (deletes all managed).&quot;&quot;&quot;</span>
</span><span id="__span-18-69"><a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-18-70"><a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>            <span class="s2">&quot;RequestType&quot;</span><span class="p">:</span> <span class="s2">&quot;Delete&quot;</span><span class="p">,</span>
</span><span id="__span-18-71"><a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a>            <span class="s2">&quot;ResourceProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-18-72"><a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a>                <span class="s2">&quot;ServiceToken&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:lambda:us-east-1:123:function:test&quot;</span><span class="p">,</span>
</span><span id="__span-18-73"><a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a>                <span class="s2">&quot;TableName&quot;</span><span class="p">:</span> <span class="s2">&quot;test-table&quot;</span><span class="p">,</span>
</span><span id="__span-18-74"><a id="__codelineno-18-74" name="__codelineno-18-74" href="#__codelineno-18-74"></a>                <span class="s2">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-18-75"><a id="__codelineno-18-75" name="__codelineno-18-75" href="#__codelineno-18-75"></a>                <span class="s2">&quot;NamespaceId&quot;</span><span class="p">:</span> <span class="s2">&quot;ns123&quot;</span><span class="p">,</span>
</span><span id="__span-18-76"><a id="__codelineno-18-76" name="__codelineno-18-76" href="#__codelineno-18-76"></a>            <span class="p">},</span>
</span><span id="__span-18-77"><a id="__codelineno-18-77" name="__codelineno-18-77" href="#__codelineno-18-77"></a>            <span class="s2">&quot;ResponseURL&quot;</span><span class="p">:</span> <span class="s2">&quot;https://cfn-response.example.com&quot;</span><span class="p">,</span>
</span><span id="__span-18-78"><a id="__codelineno-18-78" name="__codelineno-18-78" href="#__codelineno-18-78"></a>            <span class="s2">&quot;StackId&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:cloudformation:us-east-1:123:stack/test/guid&quot;</span><span class="p">,</span>
</span><span id="__span-18-79"><a id="__codelineno-18-79" name="__codelineno-18-79" href="#__codelineno-18-79"></a>            <span class="s2">&quot;RequestId&quot;</span><span class="p">:</span> <span class="s2">&quot;test-request-id&quot;</span><span class="p">,</span>
</span><span id="__span-18-80"><a id="__codelineno-18-80" name="__codelineno-18-80" href="#__codelineno-18-80"></a>            <span class="s2">&quot;LogicalResourceId&quot;</span><span class="p">:</span> <span class="s2">&quot;TenantLimits&quot;</span><span class="p">,</span>
</span><span id="__span-18-81"><a id="__codelineno-18-81" name="__codelineno-18-81" href="#__codelineno-18-81"></a>        <span class="p">}</span>
</span><span id="__span-18-82"><a id="__codelineno-18-82" name="__codelineno-18-82" href="#__codelineno-18-82"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-18-83"><a id="__codelineno-18-83" name="__codelineno-18-83" href="#__codelineno-18-83"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-18-84"><a id="__codelineno-18-84" name="__codelineno-18-84" href="#__codelineno-18-84"></a>        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;applied&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_provisioner_handler.py -v</code>
Expected: FAIL with <code>ImportError</code></p>
<p><strong>Step 3: Write the implementation</strong></p>
<p>Create <code>src/zae_limiter_provisioner/handler.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="sd">&quot;&quot;&quot;Lambda handler for declarative limits provisioner.</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="sd">Handles two event types:</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="sd">1. CLI invocations: {&quot;action&quot;: &quot;plan|apply&quot;, &quot;manifest&quot;: {...}, &quot;table_name&quot;: &quot;...&quot;, &quot;namespace_id&quot;: &quot;...&quot;}</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="sd">2. CloudFormation custom resource events: {&quot;RequestType&quot;: &quot;Create|Update|Delete&quot;, &quot;ResourceProperties&quot;: {...}}</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.applier</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_changes</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.differ</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_diff</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitsManifest</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TABLE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;rate-limits&quot;</span><span class="p">)</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Lambda entry point.&quot;&quot;&quot;</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>    <span class="k">if</span> <span class="s2">&quot;RequestType&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>        <span class="k">return</span> <span class="n">_handle_cfn</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>    <span class="k">return</span> <span class="n">_handle_cli</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">_handle_cli</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle CLI invocation (plan or apply).&quot;&quot;&quot;</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>    <span class="n">action</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;plan&quot;</span><span class="p">)</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>    <span class="n">table_name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="n">TABLE_NAME</span><span class="p">)</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>    <span class="n">namespace_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;namespace_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>    <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;manifest&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a>    <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>    <span class="n">previous</span> <span class="o">=</span> <span class="n">_read_provisioner_state</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">)</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>    <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>    <span class="n">change_dicts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a>        <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">}</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>    <span class="p">]</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a>    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;plan&quot;</span><span class="p">:</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;planned&quot;</span><span class="p">,</span> <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="n">change_dicts</span><span class="p">}</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>    <span class="c1"># Apply</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">)</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a>    <span class="c1"># Update provisioner state</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>    <span class="n">manifest_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>    <span class="n">new_state</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>    <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;last_applied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a>    <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;applied_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sha256:</span><span class="si">{</span><span class="n">manifest_hash</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>    <span class="n">_write_provisioner_state</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;applied&quot;</span><span class="p">,</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a>        <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="n">change_dicts</span><span class="p">,</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a>        <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">updated</span><span class="p">,</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a>        <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted</span><span class="p">,</span>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a>        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>    <span class="p">}</span>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a>
</span><span id="__span-19-73"><a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a><span class="k">def</span><span class="w"> </span><span class="nf">_handle_cfn</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-19-74"><a id="__codelineno-19-74" name="__codelineno-19-74" href="#__codelineno-19-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle CloudFormation custom resource event.&quot;&quot;&quot;</span>
</span><span id="__span-19-75"><a id="__codelineno-19-75" name="__codelineno-19-75" href="#__codelineno-19-75"></a>    <span class="n">request_type</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;RequestType&quot;</span><span class="p">]</span>
</span><span id="__span-19-76"><a id="__codelineno-19-76" name="__codelineno-19-76" href="#__codelineno-19-76"></a>    <span class="n">properties</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ResourceProperties&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-19-77"><a id="__codelineno-19-77" name="__codelineno-19-77" href="#__codelineno-19-77"></a>
</span><span id="__span-19-78"><a id="__codelineno-19-78" name="__codelineno-19-78" href="#__codelineno-19-78"></a>    <span class="n">table_name</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TableName&quot;</span><span class="p">,</span> <span class="n">TABLE_NAME</span><span class="p">)</span>
</span><span id="__span-19-79"><a id="__codelineno-19-79" name="__codelineno-19-79" href="#__codelineno-19-79"></a>    <span class="n">namespace_id</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NamespaceId&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-19-80"><a id="__codelineno-19-80" name="__codelineno-19-80" href="#__codelineno-19-80"></a>
</span><span id="__span-19-81"><a id="__codelineno-19-81" name="__codelineno-19-81" href="#__codelineno-19-81"></a>    <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s2">&quot;Delete&quot;</span><span class="p">:</span>
</span><span id="__span-19-82"><a id="__codelineno-19-82" name="__codelineno-19-82" href="#__codelineno-19-82"></a>        <span class="c1"># Empty manifest deletes all managed items</span>
</span><span id="__span-19-83"><a id="__codelineno-19-83" name="__codelineno-19-83" href="#__codelineno-19-83"></a>        <span class="n">manifest_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;deleted&quot;</span><span class="p">)}</span>
</span><span id="__span-19-84"><a id="__codelineno-19-84" name="__codelineno-19-84" href="#__codelineno-19-84"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-85"><a id="__codelineno-19-85" name="__codelineno-19-85" href="#__codelineno-19-85"></a>        <span class="c1"># Create or Update: convert CFN properties to manifest format</span>
</span><span id="__span-19-86"><a id="__codelineno-19-86" name="__codelineno-19-86" href="#__codelineno-19-86"></a>        <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">_cfn_properties_to_manifest</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
</span><span id="__span-19-87"><a id="__codelineno-19-87" name="__codelineno-19-87" href="#__codelineno-19-87"></a>
</span><span id="__span-19-88"><a id="__codelineno-19-88" name="__codelineno-19-88" href="#__codelineno-19-88"></a>    <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
</span><span id="__span-19-89"><a id="__codelineno-19-89" name="__codelineno-19-89" href="#__codelineno-19-89"></a>    <span class="n">previous</span> <span class="o">=</span> <span class="n">_read_provisioner_state</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">)</span>
</span><span id="__span-19-90"><a id="__codelineno-19-90" name="__codelineno-19-90" href="#__codelineno-19-90"></a>    <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-19-91"><a id="__codelineno-19-91" name="__codelineno-19-91" href="#__codelineno-19-91"></a>
</span><span id="__span-19-92"><a id="__codelineno-19-92" name="__codelineno-19-92" href="#__codelineno-19-92"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">)</span>
</span><span id="__span-19-93"><a id="__codelineno-19-93" name="__codelineno-19-93" href="#__codelineno-19-93"></a>
</span><span id="__span-19-94"><a id="__codelineno-19-94" name="__codelineno-19-94" href="#__codelineno-19-94"></a>    <span class="n">manifest_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
</span><span id="__span-19-95"><a id="__codelineno-19-95" name="__codelineno-19-95" href="#__codelineno-19-95"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="__span-19-96"><a id="__codelineno-19-96" name="__codelineno-19-96" href="#__codelineno-19-96"></a>    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-19-97"><a id="__codelineno-19-97" name="__codelineno-19-97" href="#__codelineno-19-97"></a>
</span><span id="__span-19-98"><a id="__codelineno-19-98" name="__codelineno-19-98" href="#__codelineno-19-98"></a>    <span class="n">new_state</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-19-99"><a id="__codelineno-19-99" name="__codelineno-19-99" href="#__codelineno-19-99"></a>    <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;last_applied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="__span-19-100"><a id="__codelineno-19-100" name="__codelineno-19-100" href="#__codelineno-19-100"></a>    <span class="n">new_state</span><span class="p">[</span><span class="s2">&quot;applied_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sha256:</span><span class="si">{</span><span class="n">manifest_hash</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-19-101"><a id="__codelineno-19-101" name="__codelineno-19-101" href="#__codelineno-19-101"></a>    <span class="n">_write_provisioner_state</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
</span><span id="__span-19-102"><a id="__codelineno-19-102" name="__codelineno-19-102" href="#__codelineno-19-102"></a>
</span><span id="__span-19-103"><a id="__codelineno-19-103" name="__codelineno-19-103" href="#__codelineno-19-103"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-19-104"><a id="__codelineno-19-104" name="__codelineno-19-104" href="#__codelineno-19-104"></a>        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;applied&quot;</span><span class="p">,</span>
</span><span id="__span-19-105"><a id="__codelineno-19-105" name="__codelineno-19-105" href="#__codelineno-19-105"></a>        <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-19-106"><a id="__codelineno-19-106" name="__codelineno-19-106" href="#__codelineno-19-106"></a>            <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">target</span><span class="p">}</span>
</span><span id="__span-19-107"><a id="__codelineno-19-107" name="__codelineno-19-107" href="#__codelineno-19-107"></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span>
</span><span id="__span-19-108"><a id="__codelineno-19-108" name="__codelineno-19-108" href="#__codelineno-19-108"></a>        <span class="p">],</span>
</span><span id="__span-19-109"><a id="__codelineno-19-109" name="__codelineno-19-109" href="#__codelineno-19-109"></a>        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>
</span><span id="__span-19-110"><a id="__codelineno-19-110" name="__codelineno-19-110" href="#__codelineno-19-110"></a>        <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">updated</span><span class="p">,</span>
</span><span id="__span-19-111"><a id="__codelineno-19-111" name="__codelineno-19-111" href="#__codelineno-19-111"></a>        <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted</span><span class="p">,</span>
</span><span id="__span-19-112"><a id="__codelineno-19-112" name="__codelineno-19-112" href="#__codelineno-19-112"></a>        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
</span><span id="__span-19-113"><a id="__codelineno-19-113" name="__codelineno-19-113" href="#__codelineno-19-113"></a>    <span class="p">}</span>
</span><span id="__span-19-114"><a id="__codelineno-19-114" name="__codelineno-19-114" href="#__codelineno-19-114"></a>
</span><span id="__span-19-115"><a id="__codelineno-19-115" name="__codelineno-19-115" href="#__codelineno-19-115"></a>
</span><span id="__span-19-116"><a id="__codelineno-19-116" name="__codelineno-19-116" href="#__codelineno-19-116"></a><span class="k">def</span><span class="w"> </span><span class="nf">_cfn_properties_to_manifest</span><span class="p">(</span><span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-19-117"><a id="__codelineno-19-117" name="__codelineno-19-117" href="#__codelineno-19-117"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert CloudFormation ResourceProperties to manifest dict format.</span>
</span><span id="__span-19-118"><a id="__codelineno-19-118" name="__codelineno-19-118" href="#__codelineno-19-118"></a>
</span><span id="__span-19-119"><a id="__codelineno-19-119" name="__codelineno-19-119" href="#__codelineno-19-119"></a><span class="sd">    CFN uses PascalCase keys; manifest uses snake_case.</span>
</span><span id="__span-19-120"><a id="__codelineno-19-120" name="__codelineno-19-120" href="#__codelineno-19-120"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-19-121"><a id="__codelineno-19-121" name="__codelineno-19-121" href="#__codelineno-19-121"></a>    <span class="n">manifest</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)}</span>
</span><span id="__span-19-122"><a id="__codelineno-19-122" name="__codelineno-19-122" href="#__codelineno-19-122"></a>
</span><span id="__span-19-123"><a id="__codelineno-19-123" name="__codelineno-19-123" href="#__codelineno-19-123"></a>    <span class="k">if</span> <span class="s2">&quot;System&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
</span><span id="__span-19-124"><a id="__codelineno-19-124" name="__codelineno-19-124" href="#__codelineno-19-124"></a>        <span class="n">system</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-19-125"><a id="__codelineno-19-125" name="__codelineno-19-125" href="#__codelineno-19-125"></a>        <span class="n">cfn_system</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;System&quot;</span><span class="p">]</span>
</span><span id="__span-19-126"><a id="__codelineno-19-126" name="__codelineno-19-126" href="#__codelineno-19-126"></a>        <span class="k">if</span> <span class="s2">&quot;OnUnavailable&quot;</span> <span class="ow">in</span> <span class="n">cfn_system</span><span class="p">:</span>
</span><span id="__span-19-127"><a id="__codelineno-19-127" name="__codelineno-19-127" href="#__codelineno-19-127"></a>            <span class="n">system</span><span class="p">[</span><span class="s2">&quot;on_unavailable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfn_system</span><span class="p">[</span><span class="s2">&quot;OnUnavailable&quot;</span><span class="p">]</span>
</span><span id="__span-19-128"><a id="__codelineno-19-128" name="__codelineno-19-128" href="#__codelineno-19-128"></a>        <span class="k">if</span> <span class="s2">&quot;Limits&quot;</span> <span class="ow">in</span> <span class="n">cfn_system</span><span class="p">:</span>
</span><span id="__span-19-129"><a id="__codelineno-19-129" name="__codelineno-19-129" href="#__codelineno-19-129"></a>            <span class="n">system</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_cfn_limits_to_manifest</span><span class="p">(</span><span class="n">cfn_system</span><span class="p">[</span><span class="s2">&quot;Limits&quot;</span><span class="p">])</span>
</span><span id="__span-19-130"><a id="__codelineno-19-130" name="__codelineno-19-130" href="#__codelineno-19-130"></a>        <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span>
</span><span id="__span-19-131"><a id="__codelineno-19-131" name="__codelineno-19-131" href="#__codelineno-19-131"></a>
</span><span id="__span-19-132"><a id="__codelineno-19-132" name="__codelineno-19-132" href="#__codelineno-19-132"></a>    <span class="k">if</span> <span class="s2">&quot;Resources&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
</span><span id="__span-19-133"><a id="__codelineno-19-133" name="__codelineno-19-133" href="#__codelineno-19-133"></a>        <span class="n">resources</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-19-134"><a id="__codelineno-19-134" name="__codelineno-19-134" href="#__codelineno-19-134"></a>        <span class="k">for</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">cfn_resource</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Resources&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-19-135"><a id="__codelineno-19-135" name="__codelineno-19-135" href="#__codelineno-19-135"></a>            <span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-19-136"><a id="__codelineno-19-136" name="__codelineno-19-136" href="#__codelineno-19-136"></a>                <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="n">_cfn_limits_to_manifest</span><span class="p">(</span><span class="n">cfn_resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Limits&quot;</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="__span-19-137"><a id="__codelineno-19-137" name="__codelineno-19-137" href="#__codelineno-19-137"></a>            <span class="p">}</span>
</span><span id="__span-19-138"><a id="__codelineno-19-138" name="__codelineno-19-138" href="#__codelineno-19-138"></a>        <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span>
</span><span id="__span-19-139"><a id="__codelineno-19-139" name="__codelineno-19-139" href="#__codelineno-19-139"></a>
</span><span id="__span-19-140"><a id="__codelineno-19-140" name="__codelineno-19-140" href="#__codelineno-19-140"></a>    <span class="k">if</span> <span class="s2">&quot;Entities&quot;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
</span><span id="__span-19-141"><a id="__codelineno-19-141" name="__codelineno-19-141" href="#__codelineno-19-141"></a>        <span class="n">entities</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-19-142"><a id="__codelineno-19-142" name="__codelineno-19-142" href="#__codelineno-19-142"></a>        <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">cfn_entity</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Entities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-19-143"><a id="__codelineno-19-143" name="__codelineno-19-143" href="#__codelineno-19-143"></a>            <span class="n">entity_resources</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-19-144"><a id="__codelineno-19-144" name="__codelineno-19-144" href="#__codelineno-19-144"></a>            <span class="k">for</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">cfn_res</span> <span class="ow">in</span> <span class="n">cfn_entity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-19-145"><a id="__codelineno-19-145" name="__codelineno-19-145" href="#__codelineno-19-145"></a>                <span class="n">entity_resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-19-146"><a id="__codelineno-19-146" name="__codelineno-19-146" href="#__codelineno-19-146"></a>                    <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="n">_cfn_limits_to_manifest</span><span class="p">(</span><span class="n">cfn_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Limits&quot;</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="__span-19-147"><a id="__codelineno-19-147" name="__codelineno-19-147" href="#__codelineno-19-147"></a>                <span class="p">}</span>
</span><span id="__span-19-148"><a id="__codelineno-19-148" name="__codelineno-19-148" href="#__codelineno-19-148"></a>            <span class="n">entities</span><span class="p">[</span><span class="n">entity_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="n">entity_resources</span><span class="p">}</span>
</span><span id="__span-19-149"><a id="__codelineno-19-149" name="__codelineno-19-149" href="#__codelineno-19-149"></a>        <span class="n">manifest</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entities</span>
</span><span id="__span-19-150"><a id="__codelineno-19-150" name="__codelineno-19-150" href="#__codelineno-19-150"></a>
</span><span id="__span-19-151"><a id="__codelineno-19-151" name="__codelineno-19-151" href="#__codelineno-19-151"></a>    <span class="k">return</span> <span class="n">manifest</span>
</span><span id="__span-19-152"><a id="__codelineno-19-152" name="__codelineno-19-152" href="#__codelineno-19-152"></a>
</span><span id="__span-19-153"><a id="__codelineno-19-153" name="__codelineno-19-153" href="#__codelineno-19-153"></a>
</span><span id="__span-19-154"><a id="__codelineno-19-154" name="__codelineno-19-154" href="#__codelineno-19-154"></a><span class="k">def</span><span class="w"> </span><span class="nf">_cfn_limits_to_manifest</span><span class="p">(</span><span class="n">cfn_limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-19-155"><a id="__codelineno-19-155" name="__codelineno-19-155" href="#__codelineno-19-155"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert CFN PascalCase limits to manifest snake_case.&quot;&quot;&quot;</span>
</span><span id="__span-19-156"><a id="__codelineno-19-156" name="__codelineno-19-156" href="#__codelineno-19-156"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-19-157"><a id="__codelineno-19-157" name="__codelineno-19-157" href="#__codelineno-19-157"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cfn_limit</span> <span class="ow">in</span> <span class="n">cfn_limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-19-158"><a id="__codelineno-19-158" name="__codelineno-19-158" href="#__codelineno-19-158"></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="n">cfn_limit</span><span class="p">[</span><span class="s2">&quot;Capacity&quot;</span><span class="p">]}</span>
</span><span id="__span-19-159"><a id="__codelineno-19-159" name="__codelineno-19-159" href="#__codelineno-19-159"></a>        <span class="k">if</span> <span class="s2">&quot;Burst&quot;</span> <span class="ow">in</span> <span class="n">cfn_limit</span><span class="p">:</span>
</span><span id="__span-19-160"><a id="__codelineno-19-160" name="__codelineno-19-160" href="#__codelineno-19-160"></a>            <span class="n">limit</span><span class="p">[</span><span class="s2">&quot;burst&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfn_limit</span><span class="p">[</span><span class="s2">&quot;Burst&quot;</span><span class="p">]</span>
</span><span id="__span-19-161"><a id="__codelineno-19-161" name="__codelineno-19-161" href="#__codelineno-19-161"></a>        <span class="k">if</span> <span class="s2">&quot;RefillAmount&quot;</span> <span class="ow">in</span> <span class="n">cfn_limit</span><span class="p">:</span>
</span><span id="__span-19-162"><a id="__codelineno-19-162" name="__codelineno-19-162" href="#__codelineno-19-162"></a>            <span class="n">limit</span><span class="p">[</span><span class="s2">&quot;refill_amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfn_limit</span><span class="p">[</span><span class="s2">&quot;RefillAmount&quot;</span><span class="p">]</span>
</span><span id="__span-19-163"><a id="__codelineno-19-163" name="__codelineno-19-163" href="#__codelineno-19-163"></a>        <span class="k">if</span> <span class="s2">&quot;RefillPeriod&quot;</span> <span class="ow">in</span> <span class="n">cfn_limit</span><span class="p">:</span>
</span><span id="__span-19-164"><a id="__codelineno-19-164" name="__codelineno-19-164" href="#__codelineno-19-164"></a>            <span class="n">limit</span><span class="p">[</span><span class="s2">&quot;refill_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfn_limit</span><span class="p">[</span><span class="s2">&quot;RefillPeriod&quot;</span><span class="p">]</span>
</span><span id="__span-19-165"><a id="__codelineno-19-165" name="__codelineno-19-165" href="#__codelineno-19-165"></a>        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
</span><span id="__span-19-166"><a id="__codelineno-19-166" name="__codelineno-19-166" href="#__codelineno-19-166"></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-19-167"><a id="__codelineno-19-167" name="__codelineno-19-167" href="#__codelineno-19-167"></a>
</span><span id="__span-19-168"><a id="__codelineno-19-168" name="__codelineno-19-168" href="#__codelineno-19-168"></a>
</span><span id="__span-19-169"><a id="__codelineno-19-169" name="__codelineno-19-169" href="#__codelineno-19-169"></a><span class="k">def</span><span class="w"> </span><span class="nf">_read_provisioner_state</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-19-170"><a id="__codelineno-19-170" name="__codelineno-19-170" href="#__codelineno-19-170"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the #PROVISIONER state record from DynamoDB.&quot;&quot;&quot;</span>
</span><span id="__span-19-171"><a id="__codelineno-19-171" name="__codelineno-19-171" href="#__codelineno-19-171"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">pk_system</span><span class="p">,</span> <span class="n">sk_provisioner</span>
</span><span id="__span-19-172"><a id="__codelineno-19-172" name="__codelineno-19-172" href="#__codelineno-19-172"></a>
</span><span id="__span-19-173"><a id="__codelineno-19-173" name="__codelineno-19-173" href="#__codelineno-19-173"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>
</span><span id="__span-19-174"><a id="__codelineno-19-174" name="__codelineno-19-174" href="#__codelineno-19-174"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
</span><span id="__span-19-175"><a id="__codelineno-19-175" name="__codelineno-19-175" href="#__codelineno-19-175"></a>        <span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span><span id="__span-19-176"><a id="__codelineno-19-176" name="__codelineno-19-176" href="#__codelineno-19-176"></a>        <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-19-177"><a id="__codelineno-19-177" name="__codelineno-19-177" href="#__codelineno-19-177"></a>            <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">pk_system</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">)},</span>
</span><span id="__span-19-178"><a id="__codelineno-19-178" name="__codelineno-19-178" href="#__codelineno-19-178"></a>            <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">sk_provisioner</span><span class="p">()},</span>
</span><span id="__span-19-179"><a id="__codelineno-19-179" name="__codelineno-19-179" href="#__codelineno-19-179"></a>        <span class="p">},</span>
</span><span id="__span-19-180"><a id="__codelineno-19-180" name="__codelineno-19-180" href="#__codelineno-19-180"></a>    <span class="p">)</span>
</span><span id="__span-19-181"><a id="__codelineno-19-181" name="__codelineno-19-181" href="#__codelineno-19-181"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Item&quot;</span><span class="p">)</span>
</span><span id="__span-19-182"><a id="__codelineno-19-182" name="__codelineno-19-182" href="#__codelineno-19-182"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
</span><span id="__span-19-183"><a id="__codelineno-19-183" name="__codelineno-19-183" href="#__codelineno-19-183"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-19-184"><a id="__codelineno-19-184" name="__codelineno-19-184" href="#__codelineno-19-184"></a>            <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-185"><a id="__codelineno-19-185" name="__codelineno-19-185" href="#__codelineno-19-185"></a>            <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-19-186"><a id="__codelineno-19-186" name="__codelineno-19-186" href="#__codelineno-19-186"></a>            <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-19-187"><a id="__codelineno-19-187" name="__codelineno-19-187" href="#__codelineno-19-187"></a>        <span class="p">}</span>
</span><span id="__span-19-188"><a id="__codelineno-19-188" name="__codelineno-19-188" href="#__codelineno-19-188"></a>
</span><span id="__span-19-189"><a id="__codelineno-19-189" name="__codelineno-19-189" href="#__codelineno-19-189"></a>    <span class="n">managed_entities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-19-190"><a id="__codelineno-19-190" name="__codelineno-19-190" href="#__codelineno-19-190"></a>    <span class="n">raw_entities</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-19-191"><a id="__codelineno-19-191" name="__codelineno-19-191" href="#__codelineno-19-191"></a>    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resources_attr</span> <span class="ow">in</span> <span class="n">raw_entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-19-192"><a id="__codelineno-19-192" name="__codelineno-19-192" href="#__codelineno-19-192"></a>        <span class="n">managed_entities</span><span class="p">[</span><span class="n">entity_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources_attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="p">[])]</span>
</span><span id="__span-19-193"><a id="__codelineno-19-193" name="__codelineno-19-193" href="#__codelineno-19-193"></a>
</span><span id="__span-19-194"><a id="__codelineno-19-194" name="__codelineno-19-194" href="#__codelineno-19-194"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-19-195"><a id="__codelineno-19-195" name="__codelineno-19-195" href="#__codelineno-19-195"></a>        <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_system&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="__span-19-196"><a id="__codelineno-19-196" name="__codelineno-19-196" href="#__codelineno-19-196"></a>        <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-19-197"><a id="__codelineno-19-197" name="__codelineno-19-197" href="#__codelineno-19-197"></a>            <span class="n">r</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-19-198"><a id="__codelineno-19-198" name="__codelineno-19-198" href="#__codelineno-19-198"></a>        <span class="p">],</span>
</span><span id="__span-19-199"><a id="__codelineno-19-199" name="__codelineno-19-199" href="#__codelineno-19-199"></a>        <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="n">managed_entities</span><span class="p">,</span>
</span><span id="__span-19-200"><a id="__codelineno-19-200" name="__codelineno-19-200" href="#__codelineno-19-200"></a>    <span class="p">}</span>
</span><span id="__span-19-201"><a id="__codelineno-19-201" name="__codelineno-19-201" href="#__codelineno-19-201"></a>
</span><span id="__span-19-202"><a id="__codelineno-19-202" name="__codelineno-19-202" href="#__codelineno-19-202"></a>
</span><span id="__span-19-203"><a id="__codelineno-19-203" name="__codelineno-19-203" href="#__codelineno-19-203"></a><span class="k">def</span><span class="w"> </span><span class="nf">_write_provisioner_state</span><span class="p">(</span>
</span><span id="__span-19-204"><a id="__codelineno-19-204" name="__codelineno-19-204" href="#__codelineno-19-204"></a>    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-19-205"><a id="__codelineno-19-205" name="__codelineno-19-205" href="#__codelineno-19-205"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-19-206"><a id="__codelineno-19-206" name="__codelineno-19-206" href="#__codelineno-19-206"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Write the #PROVISIONER state record to DynamoDB.&quot;&quot;&quot;</span>
</span><span id="__span-19-207"><a id="__codelineno-19-207" name="__codelineno-19-207" href="#__codelineno-19-207"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">pk_system</span><span class="p">,</span> <span class="n">sk_provisioner</span>
</span><span id="__span-19-208"><a id="__codelineno-19-208" name="__codelineno-19-208" href="#__codelineno-19-208"></a>
</span><span id="__span-19-209"><a id="__codelineno-19-209" name="__codelineno-19-209" href="#__codelineno-19-209"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>
</span><span id="__span-19-210"><a id="__codelineno-19-210" name="__codelineno-19-210" href="#__codelineno-19-210"></a>    <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-19-211"><a id="__codelineno-19-211" name="__codelineno-19-211" href="#__codelineno-19-211"></a>        <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">pk_system</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">)},</span>
</span><span id="__span-19-212"><a id="__codelineno-19-212" name="__codelineno-19-212" href="#__codelineno-19-212"></a>        <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">sk_provisioner</span><span class="p">()},</span>
</span><span id="__span-19-213"><a id="__codelineno-19-213" name="__codelineno-19-213" href="#__codelineno-19-213"></a>        <span class="s2">&quot;GSI4PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">namespace_id</span><span class="p">},</span>
</span><span id="__span-19-214"><a id="__codelineno-19-214" name="__codelineno-19-214" href="#__codelineno-19-214"></a>        <span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;BOOL&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_system&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)},</span>
</span><span id="__span-19-215"><a id="__codelineno-19-215" name="__codelineno-19-215" href="#__codelineno-19-215"></a>        <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-19-216"><a id="__codelineno-19-216" name="__codelineno-19-216" href="#__codelineno-19-216"></a>            <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_resources&quot;</span><span class="p">,</span> <span class="p">[])]</span>
</span><span id="__span-19-217"><a id="__codelineno-19-217" name="__codelineno-19-217" href="#__codelineno-19-217"></a>        <span class="p">},</span>
</span><span id="__span-19-218"><a id="__codelineno-19-218" name="__codelineno-19-218" href="#__codelineno-19-218"></a>        <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-19-219"><a id="__codelineno-19-219" name="__codelineno-19-219" href="#__codelineno-19-219"></a>            <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-19-220"><a id="__codelineno-19-220" name="__codelineno-19-220" href="#__codelineno-19-220"></a>                <span class="n">eid</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">]}</span>
</span><span id="__span-19-221"><a id="__codelineno-19-221" name="__codelineno-19-221" href="#__codelineno-19-221"></a>                <span class="k">for</span> <span class="n">eid</span><span class="p">,</span> <span class="n">resources</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_entities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-19-222"><a id="__codelineno-19-222" name="__codelineno-19-222" href="#__codelineno-19-222"></a>            <span class="p">}</span>
</span><span id="__span-19-223"><a id="__codelineno-19-223" name="__codelineno-19-223" href="#__codelineno-19-223"></a>        <span class="p">},</span>
</span><span id="__span-19-224"><a id="__codelineno-19-224" name="__codelineno-19-224" href="#__codelineno-19-224"></a>        <span class="s2">&quot;last_applied&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_applied&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)},</span>
</span><span id="__span-19-225"><a id="__codelineno-19-225" name="__codelineno-19-225" href="#__codelineno-19-225"></a>        <span class="s2">&quot;applied_hash&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;applied_hash&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)},</span>
</span><span id="__span-19-226"><a id="__codelineno-19-226" name="__codelineno-19-226" href="#__codelineno-19-226"></a>    <span class="p">}</span>
</span><span id="__span-19-227"><a id="__codelineno-19-227" name="__codelineno-19-227" href="#__codelineno-19-227"></a>    <span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
</span></code></pre></div>
<p>Update <code>src/zae_limiter_provisioner/__init__.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="sd">&quot;&quot;&quot;Lambda provisioner for declarative limits management.&quot;&quot;&quot;</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.applier</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApplyResult</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.differ</span><span class="w"> </span><span class="kn">import</span> <span class="n">Change</span><span class="p">,</span> <span class="n">compute_diff</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">on_event</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitsManifest</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ApplyResult&quot;</span><span class="p">,</span> <span class="s2">&quot;Change&quot;</span><span class="p">,</span> <span class="s2">&quot;LimitsManifest&quot;</span><span class="p">,</span> <span class="s2">&quot;compute_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;on_event&quot;</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_provisioner_handler.py -v</code>
Expected: PASS (with moto mocking for DynamoDB, following aggregator test patterns)</p>
<p><strong>Note:</strong> Tests will likely need <code>@mock_aws</code> decorator or <code>unittest.mock.patch("boto3.client")</code>. Follow the pattern from <code>tests/unit/test_handler.py</code>.</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>git add src/zae_limiter_provisioner/ tests/unit/test_provisioner_handler.py
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>git commit -m &quot;✨ feat(infra): add Lambda handler for declarative limits provisioner&quot;
</span></code></pre></div>
<hr />
<h2 id="task-7-lambda-builder-for-provisioner">Task 7: Lambda Builder for Provisioner<a class="headerlink" href="#task-7-lambda-builder-for-provisioner" title="Permanent link">&para;</a></h2>
<p>Update the lambda builder to also package the provisioner, or create a separate builder.</p>
<p><strong>Files:</strong>
- Create: <code>src/zae_limiter/infra/provisioner_builder.py</code>
- Test: <code>tests/unit/test_provisioner_builder.py</code></p>
<p><strong>Step 1: Write the failing test</strong></p>
<p>Create <code>tests/unit/test_provisioner_builder.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="sd">&quot;&quot;&quot;Tests for provisioner Lambda package builder.&quot;&quot;&quot;</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestProvisionerBuilder</span><span class="p">:</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for build_provisioner_package.&quot;&quot;&quot;</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_package_contains_provisioner_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Built package contains all zae_limiter_provisioner .py files.&quot;&quot;&quot;</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.infra.provisioner_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_provisioner_package</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>        <span class="n">zip_bytes</span> <span class="o">=</span> <span class="n">build_provisioner_package</span><span class="p">()</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">zip_bytes</span><span class="p">))</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>            <span class="n">names</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter_provisioner/__init__.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter_provisioner/handler.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter_provisioner/manifest.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter_provisioner/differ.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter_provisioner/applier.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_package_contains_zae_limiter_stubs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Built package contains minimal zae_limiter stubs.&quot;&quot;&quot;</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.infra.provisioner_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_provisioner_package</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>        <span class="n">zip_bytes</span> <span class="o">=</span> <span class="n">build_provisioner_package</span><span class="p">()</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">zip_bytes</span><span class="p">))</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>            <span class="n">names</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter/__init__.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter/schema.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter/models.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>            <span class="k">assert</span> <span class="s2">&quot;zae_limiter/exceptions.py&quot;</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_provisioner_handler_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handler path matches CFN Handler property.&quot;&quot;&quot;</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.infra.provisioner_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_provisioner_info</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>        <span class="n">info</span> <span class="o">=</span> <span class="n">get_provisioner_info</span><span class="p">()</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>        <span class="k">assert</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;handler&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;zae_limiter_provisioner.handler.on_event&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_provisioner_builder.py -v</code>
Expected: FAIL with <code>ModuleNotFoundError</code></p>
<p><strong>Step 3: Write the implementation</strong></p>
<p>Create <code>src/zae_limiter/infra/provisioner_builder.py</code> — follow the same pattern as <code>lambda_builder.py</code> but copy <code>zae_limiter_provisioner</code> instead of <code>zae_limiter_aggregator</code>. Include <code>pyyaml</code> in the requirements (the provisioner uses <code>yaml.safe_load</code>).</p>
<p>The builder should:
1. Install <code>[lambda]</code> extra deps via <code>aws-lambda-builders</code> (same as aggregator)
2. Copy <code>zae_limiter_provisioner/</code> (all <code>.py</code> files)
3. Copy minimal <code>zae_limiter</code> stubs: <code>__init__.py</code> (empty), <code>schema.py</code>, <code>models.py</code>, <code>exceptions.py</code>
4. Add <code>pyyaml</code> to requirements (for YAML parsing in the handler)
5. Zip everything</p>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_provisioner_builder.py -v</code>
Expected: PASS (with <code>aws_lambda_builders.builder.LambdaBuilder</code> mocked, same as <code>test_lambda_builder.py</code>)</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>git add src/zae_limiter/infra/provisioner_builder.py tests/unit/test_provisioner_builder.py
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>git commit -m &quot;✨ feat(infra): add Lambda builder for limits provisioner&quot;
</span></code></pre></div>
<hr />
<h2 id="task-8-cloudformation-template-updates">Task 8: CloudFormation Template Updates<a class="headerlink" href="#task-8-cloudformation-template-updates" title="Permanent link">&para;</a></h2>
<p>Add the provisioner Lambda function, IAM role, and output to the existing CFN template.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/infra/cfn_template.yaml</code>
- Modify: <code>src/zae_limiter/models.py</code> (if <code>StackOptions</code> needs a new flag)</p>
<p><strong>Step 1: Plan the template changes</strong></p>
<p>Add to <code>cfn_template.yaml</code>:
- <code>DeployProvisioner</code> condition (linked to a new parameter, default <code>"true"</code>)
- <code>ProvisionerLogGroup</code> resource
- <code>ProvisionerRole</code> resource (DynamoDB read/write access to the table)
- <code>ProvisionerFunction</code> resource (placeholder code, like aggregator)
- <code>LimitsProvisionerArn</code> output (exported for cross-stack reference)</p>
<p>Follow the exact same patterns as the aggregator Lambda (conditions, role, log group, placeholder code).</p>
<p><strong>Step 2: Validate the template</strong></p>
<p>Run: <code>uv run cfn-lint src/zae_limiter/infra/cfn_template.yaml</code>
Expected: PASS (no errors)</p>
<p><strong>Step 3: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>git add src/zae_limiter/infra/cfn_template.yaml
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>git commit -m &quot;✨ feat(infra): add limits provisioner Lambda to CloudFormation template&quot;
</span></code></pre></div>
<hr />
<h2 id="task-9-stack-manager-deploy-provisioner-code">Task 9: Stack Manager — Deploy Provisioner Code<a class="headerlink" href="#task-9-stack-manager-deploy-provisioner-code" title="Permanent link">&para;</a></h2>
<p>Update the stack manager to deploy provisioner Lambda code alongside the aggregator.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/infra/stack_manager.py</code>
- Modify: <code>tests/unit/test_stack_manager.py</code></p>
<p><strong>Step 1: Write the failing test</strong></p>
<p>Add a test that verifies <code>deploy_provisioner_code()</code> calls <code>update_function_code</code> with the provisioner function name.</p>
<p><strong>Step 2: Implement <code>deploy_provisioner_code()</code></strong></p>
<p>Follow the same pattern as <code>deploy_lambda_code()</code> in <code>stack_manager.py</code>:
1. Call <code>build_provisioner_package()</code> from <code>provisioner_builder.py</code>
2. Call <code>lambda_client.update_function_code(FunctionName=f"{stack_name}-limits-provisioner", ZipFile=zip_bytes)</code>
3. Wait for function to be active</p>
<p><strong>Step 3: Update <code>deploy</code> CLI command</strong></p>
<p>After deploying the aggregator code, also deploy the provisioner code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># In cli.py deploy command, after deploy_lambda_code</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">if</span> <span class="n">provisioner_enabled</span><span class="p">:</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">deploy_provisioner_code</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_stack_manager.py -v</code></p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>git add src/zae_limiter/infra/stack_manager.py tests/unit/test_stack_manager.py src/zae_limiter/cli.py
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>git commit -m &quot;✨ feat(infra): deploy provisioner Lambda code alongside aggregator&quot;
</span></code></pre></div>
<hr />
<h2 id="task-10-cli-limits-command-group">Task 10: CLI <code>limits</code> Command Group<a class="headerlink" href="#task-10-cli-limits-command-group" title="Permanent link">&para;</a></h2>
<p>Add <code>limits plan</code>, <code>limits apply</code>, <code>limits diff</code>, and <code>limits cfn-template</code> commands.</p>
<p><strong>Files:</strong>
- Create: <code>src/zae_limiter/limits_cli.py</code>
- Modify: <code>src/zae_limiter/cli.py</code> (import + <code>cli.add_command(limits)</code>)
- Test: <code>tests/unit/test_limits_cli.py</code></p>
<p><strong>Step 1: Write the failing tests</strong></p>
<p>Create <code>tests/unit/test_limits_cli.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="sd">&quot;&quot;&quot;Tests for the limits CLI commands.&quot;&quot;&quot;</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">click.testing</span><span class="w"> </span><span class="kn">import</span> <span class="n">CliRunner</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">cli</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLimitsPlan</span><span class="p">:</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for `zae-limiter limits plan -f &lt;file&gt;`.&quot;&quot;&quot;</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_plan_shows_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plan command parses YAML, invokes Lambda, and shows diff.&quot;&quot;&quot;</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>        <span class="n">yaml_content</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}},</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>        <span class="p">}</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.yaml&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>            <span class="n">runner</span> <span class="o">=</span> <span class="n">CliRunner</span><span class="p">()</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;zae_limiter.limits_cli._invoke_provisioner&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_invoke</span><span class="p">:</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>                <span class="n">mock_invoke</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;planned&quot;</span><span class="p">,</span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>                    <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>                        <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>                    <span class="p">],</span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>                <span class="p">}</span>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="p">[</span>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>                    <span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="s2">&quot;plan&quot;</span><span class="p">,</span>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>                    <span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;test-app&quot;</span><span class="p">,</span>
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a>                    <span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>                    <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>                <span class="p">])</span>
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>                <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-27-43"><a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>                <span class="k">assert</span> <span class="s2">&quot;create&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span>
</span><span id="__span-27-44"><a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>                <span class="k">assert</span> <span class="s2">&quot;system&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span>
</span><span id="__span-27-45"><a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a>
</span><span id="__span-27-46"><a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a>
</span><span id="__span-27-47"><a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLimitsApply</span><span class="p">:</span>
</span><span id="__span-27-48"><a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for `zae-limiter limits apply -f &lt;file&gt;`.&quot;&quot;&quot;</span>
</span><span id="__span-27-49"><a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>
</span><span id="__span-27-50"><a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_invokes_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-27-51"><a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply command parses YAML and invokes Lambda with action=apply.&quot;&quot;&quot;</span>
</span><span id="__span-27-52"><a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>        <span class="n">yaml_content</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-27-53"><a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-27-54"><a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}}},</span>
</span><span id="__span-27-55"><a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a>        <span class="p">}</span>
</span><span id="__span-27-56"><a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a>        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.yaml&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-27-57"><a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="__span-27-58"><a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a>            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="__span-27-59"><a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a>
</span><span id="__span-27-60"><a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a>            <span class="n">runner</span> <span class="o">=</span> <span class="n">CliRunner</span><span class="p">()</span>
</span><span id="__span-27-61"><a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a>            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;zae_limiter.limits_cli._invoke_provisioner&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_invoke</span><span class="p">:</span>
</span><span id="__span-27-62"><a id="__codelineno-27-62" name="__codelineno-27-62" href="#__codelineno-27-62"></a>                <span class="n">mock_invoke</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-27-63"><a id="__codelineno-27-63" name="__codelineno-27-63" href="#__codelineno-27-63"></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;applied&quot;</span><span class="p">,</span>
</span><span id="__span-27-64"><a id="__codelineno-27-64" name="__codelineno-27-64" href="#__codelineno-27-64"></a>                    <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-27-65"><a id="__codelineno-27-65" name="__codelineno-27-65" href="#__codelineno-27-65"></a>                        <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">},</span>
</span><span id="__span-27-66"><a id="__codelineno-27-66" name="__codelineno-27-66" href="#__codelineno-27-66"></a>                    <span class="p">],</span>
</span><span id="__span-27-67"><a id="__codelineno-27-67" name="__codelineno-27-67" href="#__codelineno-27-67"></a>                    <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-27-68"><a id="__codelineno-27-68" name="__codelineno-27-68" href="#__codelineno-27-68"></a>                    <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-27-69"><a id="__codelineno-27-69" name="__codelineno-27-69" href="#__codelineno-27-69"></a>                    <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-27-70"><a id="__codelineno-27-70" name="__codelineno-27-70" href="#__codelineno-27-70"></a>                    <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-27-71"><a id="__codelineno-27-71" name="__codelineno-27-71" href="#__codelineno-27-71"></a>                <span class="p">}</span>
</span><span id="__span-27-72"><a id="__codelineno-27-72" name="__codelineno-27-72" href="#__codelineno-27-72"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="p">[</span>
</span><span id="__span-27-73"><a id="__codelineno-27-73" name="__codelineno-27-73" href="#__codelineno-27-73"></a>                    <span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="s2">&quot;apply&quot;</span><span class="p">,</span>
</span><span id="__span-27-74"><a id="__codelineno-27-74" name="__codelineno-27-74" href="#__codelineno-27-74"></a>                    <span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;test-app&quot;</span><span class="p">,</span>
</span><span id="__span-27-75"><a id="__codelineno-27-75" name="__codelineno-27-75" href="#__codelineno-27-75"></a>                    <span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
</span><span id="__span-27-76"><a id="__codelineno-27-76" name="__codelineno-27-76" href="#__codelineno-27-76"></a>                    <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-27-77"><a id="__codelineno-27-77" name="__codelineno-27-77" href="#__codelineno-27-77"></a>                <span class="p">])</span>
</span><span id="__span-27-78"><a id="__codelineno-27-78" name="__codelineno-27-78" href="#__codelineno-27-78"></a>                <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-27-79"><a id="__codelineno-27-79" name="__codelineno-27-79" href="#__codelineno-27-79"></a>                <span class="k">assert</span> <span class="s2">&quot;applied&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;create&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-27-80"><a id="__codelineno-27-80" name="__codelineno-27-80" href="#__codelineno-27-80"></a>
</span><span id="__span-27-81"><a id="__codelineno-27-81" name="__codelineno-27-81" href="#__codelineno-27-81"></a>
</span><span id="__span-27-82"><a id="__codelineno-27-82" name="__codelineno-27-82" href="#__codelineno-27-82"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLimitsCfnTemplate</span><span class="p">:</span>
</span><span id="__span-27-83"><a id="__codelineno-27-83" name="__codelineno-27-83" href="#__codelineno-27-83"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for `zae-limiter limits cfn-template -f &lt;file&gt;`.&quot;&quot;&quot;</span>
</span><span id="__span-27-84"><a id="__codelineno-27-84" name="__codelineno-27-84" href="#__codelineno-27-84"></a>
</span><span id="__span-27-85"><a id="__codelineno-27-85" name="__codelineno-27-85" href="#__codelineno-27-85"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_cfn_template_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-27-86"><a id="__codelineno-27-86" name="__codelineno-27-86" href="#__codelineno-27-86"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;cfn-template command generates valid CFN template.&quot;&quot;&quot;</span>
</span><span id="__span-27-87"><a id="__codelineno-27-87" name="__codelineno-27-87" href="#__codelineno-27-87"></a>        <span class="n">yaml_content</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-27-88"><a id="__codelineno-27-88" name="__codelineno-27-88" href="#__codelineno-27-88"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test-ns&quot;</span><span class="p">,</span>
</span><span id="__span-27-89"><a id="__codelineno-27-89" name="__codelineno-27-89" href="#__codelineno-27-89"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}}},</span>
</span><span id="__span-27-90"><a id="__codelineno-27-90" name="__codelineno-27-90" href="#__codelineno-27-90"></a>        <span class="p">}</span>
</span><span id="__span-27-91"><a id="__codelineno-27-91" name="__codelineno-27-91" href="#__codelineno-27-91"></a>        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.yaml&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-27-92"><a id="__codelineno-27-92" name="__codelineno-27-92" href="#__codelineno-27-92"></a>            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="__span-27-93"><a id="__codelineno-27-93" name="__codelineno-27-93" href="#__codelineno-27-93"></a>            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="__span-27-94"><a id="__codelineno-27-94" name="__codelineno-27-94" href="#__codelineno-27-94"></a>
</span><span id="__span-27-95"><a id="__codelineno-27-95" name="__codelineno-27-95" href="#__codelineno-27-95"></a>            <span class="n">runner</span> <span class="o">=</span> <span class="n">CliRunner</span><span class="p">()</span>
</span><span id="__span-27-96"><a id="__codelineno-27-96" name="__codelineno-27-96" href="#__codelineno-27-96"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="p">[</span>
</span><span id="__span-27-97"><a id="__codelineno-27-97" name="__codelineno-27-97" href="#__codelineno-27-97"></a>                <span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="s2">&quot;cfn-template&quot;</span><span class="p">,</span>
</span><span id="__span-27-98"><a id="__codelineno-27-98" name="__codelineno-27-98" href="#__codelineno-27-98"></a>                <span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;test-app&quot;</span><span class="p">,</span>
</span><span id="__span-27-99"><a id="__codelineno-27-99" name="__codelineno-27-99" href="#__codelineno-27-99"></a>                <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-27-100"><a id="__codelineno-27-100" name="__codelineno-27-100" href="#__codelineno-27-100"></a>            <span class="p">])</span>
</span><span id="__span-27-101"><a id="__codelineno-27-101" name="__codelineno-27-101" href="#__codelineno-27-101"></a>            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-27-102"><a id="__codelineno-27-102" name="__codelineno-27-102" href="#__codelineno-27-102"></a>            <span class="k">assert</span> <span class="s2">&quot;Custom::ZaeLimiterLimits&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span>
</span><span id="__span-27-103"><a id="__codelineno-27-103" name="__codelineno-27-103" href="#__codelineno-27-103"></a>            <span class="k">assert</span> <span class="s2">&quot;ServiceToken&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">output</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limits_cli.py -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Write the implementation</strong></p>
<p>Create <code>src/zae_limiter/limits_cli.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="sd">&quot;&quot;&quot;CLI commands for declarative limits management.&quot;&quot;&quot;</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">click</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">limits</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Declarative limits management.</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="sd">    Manage rate limits via YAML files. Apply through a Lambda provisioner</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="sd">    that supports both CLI and CloudFormation paths.</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>    <span class="k">pass</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="nd">@limits</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">)</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stack identifier.&quot;</span><span class="p">)</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;AWS region.&quot;</span><span class="p">)</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--endpoint-url&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;AWS endpoint URL (e.g., LocalStack).&quot;</span><span class="p">)</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;-N&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Namespace.&quot;</span><span class="p">)</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;YAML limits file.&quot;</span><span class="p">)</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">limits_plan</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Preview changes without applying (like terraform plan).&quot;&quot;&quot;</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a>    <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">_load_yaml</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">_invoke_provisioner</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="n">manifest_data</span><span class="p">)</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a>    <span class="n">changes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;changes&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;No changes. Infrastructure is up-to-date.&quot;</span><span class="p">)</span>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a>        <span class="k">return</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a>    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plan: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span><span class="si">}</span><span class="s2"> change(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a>    <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a>        <span class="n">symbol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">:</span> <span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;(system defaults)&quot;</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a>
</span><span id="__span-28-48"><a id="__codelineno-28-48" name="__codelineno-28-48" href="#__codelineno-28-48"></a><span class="nd">@limits</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;apply&quot;</span><span class="p">)</span>
</span><span id="__span-28-49"><a id="__codelineno-28-49" name="__codelineno-28-49" href="#__codelineno-28-49"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stack identifier.&quot;</span><span class="p">)</span>
</span><span id="__span-28-50"><a id="__codelineno-28-50" name="__codelineno-28-50" href="#__codelineno-28-50"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;AWS region.&quot;</span><span class="p">)</span>
</span><span id="__span-28-51"><a id="__codelineno-28-51" name="__codelineno-28-51" href="#__codelineno-28-51"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--endpoint-url&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;AWS endpoint URL (e.g., LocalStack).&quot;</span><span class="p">)</span>
</span><span id="__span-28-52"><a id="__codelineno-28-52" name="__codelineno-28-52" href="#__codelineno-28-52"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;-N&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Namespace.&quot;</span><span class="p">)</span>
</span><span id="__span-28-53"><a id="__codelineno-28-53" name="__codelineno-28-53" href="#__codelineno-28-53"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;YAML limits file.&quot;</span><span class="p">)</span>
</span><span id="__span-28-54"><a id="__codelineno-28-54" name="__codelineno-28-54" href="#__codelineno-28-54"></a><span class="k">def</span><span class="w"> </span><span class="nf">limits_apply</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-28-55"><a id="__codelineno-28-55" name="__codelineno-28-55" href="#__codelineno-28-55"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply limits from YAML file (like terraform apply).&quot;&quot;&quot;</span>
</span><span id="__span-28-56"><a id="__codelineno-28-56" name="__codelineno-28-56" href="#__codelineno-28-56"></a>    <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">_load_yaml</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-28-57"><a id="__codelineno-28-57" name="__codelineno-28-57" href="#__codelineno-28-57"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">_invoke_provisioner</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="s2">&quot;apply&quot;</span><span class="p">,</span> <span class="n">manifest_data</span><span class="p">)</span>
</span><span id="__span-28-58"><a id="__codelineno-28-58" name="__codelineno-28-58" href="#__codelineno-28-58"></a>
</span><span id="__span-28-59"><a id="__codelineno-28-59" name="__codelineno-28-59" href="#__codelineno-28-59"></a>    <span class="n">changes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;changes&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-28-60"><a id="__codelineno-28-60" name="__codelineno-28-60" href="#__codelineno-28-60"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-28-61"><a id="__codelineno-28-61" name="__codelineno-28-61" href="#__codelineno-28-61"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;No changes. Infrastructure is up-to-date.&quot;</span><span class="p">)</span>
</span><span id="__span-28-62"><a id="__codelineno-28-62" name="__codelineno-28-62" href="#__codelineno-28-62"></a>        <span class="k">return</span>
</span><span id="__span-28-63"><a id="__codelineno-28-63" name="__codelineno-28-63" href="#__codelineno-28-63"></a>
</span><span id="__span-28-64"><a id="__codelineno-28-64" name="__codelineno-28-64" href="#__codelineno-28-64"></a>    <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-28-65"><a id="__codelineno-28-65" name="__codelineno-28-65" href="#__codelineno-28-65"></a>        <span class="n">symbol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">:</span> <span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
</span><span id="__span-28-66"><a id="__codelineno-28-66" name="__codelineno-28-66" href="#__codelineno-28-66"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;(system defaults)&quot;</span>
</span><span id="__span-28-67"><a id="__codelineno-28-67" name="__codelineno-28-67" href="#__codelineno-28-67"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-28-68"><a id="__codelineno-28-68" name="__codelineno-28-68" href="#__codelineno-28-68"></a>
</span><span id="__span-28-69"><a id="__codelineno-28-69" name="__codelineno-28-69" href="#__codelineno-28-69"></a>    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
</span><span id="__span-28-70"><a id="__codelineno-28-70" name="__codelineno-28-70" href="#__codelineno-28-70"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Applied: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> created, &quot;</span>
</span><span id="__span-28-71"><a id="__codelineno-28-71" name="__codelineno-28-71" href="#__codelineno-28-71"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> updated, &quot;</span>
</span><span id="__span-28-72"><a id="__codelineno-28-72" name="__codelineno-28-72" href="#__codelineno-28-72"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> deleted.&quot;</span>
</span><span id="__span-28-73"><a id="__codelineno-28-73" name="__codelineno-28-73" href="#__codelineno-28-73"></a>    <span class="p">)</span>
</span><span id="__span-28-74"><a id="__codelineno-28-74" name="__codelineno-28-74" href="#__codelineno-28-74"></a>
</span><span id="__span-28-75"><a id="__codelineno-28-75" name="__codelineno-28-75" href="#__codelineno-28-75"></a>    <span class="n">errors</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-28-76"><a id="__codelineno-28-76" name="__codelineno-28-76" href="#__codelineno-28-76"></a>    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="__span-28-77"><a id="__codelineno-28-77" name="__codelineno-28-77" href="#__codelineno-28-77"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Errors (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-28-78"><a id="__codelineno-28-78" name="__codelineno-28-78" href="#__codelineno-28-78"></a>        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="__span-28-79"><a id="__codelineno-28-79" name="__codelineno-28-79" href="#__codelineno-28-79"></a>            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-28-80"><a id="__codelineno-28-80" name="__codelineno-28-80" href="#__codelineno-28-80"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-28-81"><a id="__codelineno-28-81" name="__codelineno-28-81" href="#__codelineno-28-81"></a>
</span><span id="__span-28-82"><a id="__codelineno-28-82" name="__codelineno-28-82" href="#__codelineno-28-82"></a>
</span><span id="__span-28-83"><a id="__codelineno-28-83" name="__codelineno-28-83" href="#__codelineno-28-83"></a><span class="nd">@limits</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">)</span>
</span><span id="__span-28-84"><a id="__codelineno-28-84" name="__codelineno-28-84" href="#__codelineno-28-84"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stack identifier.&quot;</span><span class="p">)</span>
</span><span id="__span-28-85"><a id="__codelineno-28-85" name="__codelineno-28-85" href="#__codelineno-28-85"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;AWS region.&quot;</span><span class="p">)</span>
</span><span id="__span-28-86"><a id="__codelineno-28-86" name="__codelineno-28-86" href="#__codelineno-28-86"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--endpoint-url&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;AWS endpoint URL (e.g., LocalStack).&quot;</span><span class="p">)</span>
</span><span id="__span-28-87"><a id="__codelineno-28-87" name="__codelineno-28-87" href="#__codelineno-28-87"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;-N&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Namespace.&quot;</span><span class="p">)</span>
</span><span id="__span-28-88"><a id="__codelineno-28-88" name="__codelineno-28-88" href="#__codelineno-28-88"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;YAML limits file.&quot;</span><span class="p">)</span>
</span><span id="__span-28-89"><a id="__codelineno-28-89" name="__codelineno-28-89" href="#__codelineno-28-89"></a><span class="k">def</span><span class="w"> </span><span class="nf">limits_diff</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-28-90"><a id="__codelineno-28-90" name="__codelineno-28-90" href="#__codelineno-28-90"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Show drift between YAML and live DynamoDB state.&quot;&quot;&quot;</span>
</span><span id="__span-28-91"><a id="__codelineno-28-91" name="__codelineno-28-91" href="#__codelineno-28-91"></a>    <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">_load_yaml</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-28-92"><a id="__codelineno-28-92" name="__codelineno-28-92" href="#__codelineno-28-92"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">_invoke_provisioner</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="p">,</span> <span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="n">manifest_data</span><span class="p">)</span>
</span><span id="__span-28-93"><a id="__codelineno-28-93" name="__codelineno-28-93" href="#__codelineno-28-93"></a>
</span><span id="__span-28-94"><a id="__codelineno-28-94" name="__codelineno-28-94" href="#__codelineno-28-94"></a>    <span class="n">changes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;changes&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-28-95"><a id="__codelineno-28-95" name="__codelineno-28-95" href="#__codelineno-28-95"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-28-96"><a id="__codelineno-28-96" name="__codelineno-28-96" href="#__codelineno-28-96"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;No drift detected. Live state matches YAML.&quot;</span><span class="p">)</span>
</span><span id="__span-28-97"><a id="__codelineno-28-97" name="__codelineno-28-97" href="#__codelineno-28-97"></a>        <span class="k">return</span>
</span><span id="__span-28-98"><a id="__codelineno-28-98" name="__codelineno-28-98" href="#__codelineno-28-98"></a>
</span><span id="__span-28-99"><a id="__codelineno-28-99" name="__codelineno-28-99" href="#__codelineno-28-99"></a>    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Drift detected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span><span class="si">}</span><span class="s2"> difference(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-28-100"><a id="__codelineno-28-100" name="__codelineno-28-100" href="#__codelineno-28-100"></a>    <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="__span-28-101"><a id="__codelineno-28-101" name="__codelineno-28-101" href="#__codelineno-28-101"></a>        <span class="n">symbol</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">:</span> <span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
</span><span id="__span-28-102"><a id="__codelineno-28-102" name="__codelineno-28-102" href="#__codelineno-28-102"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;(system defaults)&quot;</span>
</span><span id="__span-28-103"><a id="__codelineno-28-103" name="__codelineno-28-103" href="#__codelineno-28-103"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-28-104"><a id="__codelineno-28-104" name="__codelineno-28-104" href="#__codelineno-28-104"></a>
</span><span id="__span-28-105"><a id="__codelineno-28-105" name="__codelineno-28-105" href="#__codelineno-28-105"></a>
</span><span id="__span-28-106"><a id="__codelineno-28-106" name="__codelineno-28-106" href="#__codelineno-28-106"></a><span class="nd">@limits</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;cfn-template&quot;</span><span class="p">)</span>
</span><span id="__span-28-107"><a id="__codelineno-28-107" name="__codelineno-28-107" href="#__codelineno-28-107"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stack identifier (for ImportValue).&quot;</span><span class="p">)</span>
</span><span id="__span-28-108"><a id="__codelineno-28-108" name="__codelineno-28-108" href="#__codelineno-28-108"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;YAML limits file.&quot;</span><span class="p">)</span>
</span><span id="__span-28-109"><a id="__codelineno-28-109" name="__codelineno-28-109" href="#__codelineno-28-109"></a><span class="k">def</span><span class="w"> </span><span class="nf">limits_cfn_template</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-28-110"><a id="__codelineno-28-110" name="__codelineno-28-110" href="#__codelineno-28-110"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a CloudFormation template from YAML file.&quot;&quot;&quot;</span>
</span><span id="__span-28-111"><a id="__codelineno-28-111" name="__codelineno-28-111" href="#__codelineno-28-111"></a>    <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">_load_yaml</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="__span-28-112"><a id="__codelineno-28-112" name="__codelineno-28-112" href="#__codelineno-28-112"></a>    <span class="n">namespace</span> <span class="o">=</span> <span class="n">manifest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
</span><span id="__span-28-113"><a id="__codelineno-28-113" name="__codelineno-28-113" href="#__codelineno-28-113"></a>
</span><span id="__span-28-114"><a id="__codelineno-28-114" name="__codelineno-28-114" href="#__codelineno-28-114"></a>    <span class="c1"># Convert manifest to CFN Properties format (PascalCase)</span>
</span><span id="__span-28-115"><a id="__codelineno-28-115" name="__codelineno-28-115" href="#__codelineno-28-115"></a>    <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-116"><a id="__codelineno-28-116" name="__codelineno-28-116" href="#__codelineno-28-116"></a>        <span class="s2">&quot;ServiceToken&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Fn::ImportValue&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">-LimitsProvisionerArn&quot;</span><span class="p">},</span>
</span><span id="__span-28-117"><a id="__codelineno-28-117" name="__codelineno-28-117" href="#__codelineno-28-117"></a>        <span class="s2">&quot;TableName&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
</span><span id="__span-28-118"><a id="__codelineno-28-118" name="__codelineno-28-118" href="#__codelineno-28-118"></a>        <span class="s2">&quot;Namespace&quot;</span><span class="p">:</span> <span class="n">namespace</span><span class="p">,</span>
</span><span id="__span-28-119"><a id="__codelineno-28-119" name="__codelineno-28-119" href="#__codelineno-28-119"></a>    <span class="p">}</span>
</span><span id="__span-28-120"><a id="__codelineno-28-120" name="__codelineno-28-120" href="#__codelineno-28-120"></a>
</span><span id="__span-28-121"><a id="__codelineno-28-121" name="__codelineno-28-121" href="#__codelineno-28-121"></a>    <span class="k">if</span> <span class="s2">&quot;system&quot;</span> <span class="ow">in</span> <span class="n">manifest_data</span><span class="p">:</span>
</span><span id="__span-28-122"><a id="__codelineno-28-122" name="__codelineno-28-122" href="#__codelineno-28-122"></a>        <span class="n">system_props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-28-123"><a id="__codelineno-28-123" name="__codelineno-28-123" href="#__codelineno-28-123"></a>        <span class="n">sys_data</span> <span class="o">=</span> <span class="n">manifest_data</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span>
</span><span id="__span-28-124"><a id="__codelineno-28-124" name="__codelineno-28-124" href="#__codelineno-28-124"></a>        <span class="k">if</span> <span class="s2">&quot;on_unavailable&quot;</span> <span class="ow">in</span> <span class="n">sys_data</span><span class="p">:</span>
</span><span id="__span-28-125"><a id="__codelineno-28-125" name="__codelineno-28-125" href="#__codelineno-28-125"></a>            <span class="n">system_props</span><span class="p">[</span><span class="s2">&quot;OnUnavailable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_data</span><span class="p">[</span><span class="s2">&quot;on_unavailable&quot;</span><span class="p">]</span>
</span><span id="__span-28-126"><a id="__codelineno-28-126" name="__codelineno-28-126" href="#__codelineno-28-126"></a>        <span class="k">if</span> <span class="s2">&quot;limits&quot;</span> <span class="ow">in</span> <span class="n">sys_data</span><span class="p">:</span>
</span><span id="__span-28-127"><a id="__codelineno-28-127" name="__codelineno-28-127" href="#__codelineno-28-127"></a>            <span class="n">system_props</span><span class="p">[</span><span class="s2">&quot;Limits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_limits_to_cfn</span><span class="p">(</span><span class="n">sys_data</span><span class="p">[</span><span class="s2">&quot;limits&quot;</span><span class="p">])</span>
</span><span id="__span-28-128"><a id="__codelineno-28-128" name="__codelineno-28-128" href="#__codelineno-28-128"></a>        <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;System&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_props</span>
</span><span id="__span-28-129"><a id="__codelineno-28-129" name="__codelineno-28-129" href="#__codelineno-28-129"></a>
</span><span id="__span-28-130"><a id="__codelineno-28-130" name="__codelineno-28-130" href="#__codelineno-28-130"></a>    <span class="k">if</span> <span class="s2">&quot;resources&quot;</span> <span class="ow">in</span> <span class="n">manifest_data</span><span class="p">:</span>
</span><span id="__span-28-131"><a id="__codelineno-28-131" name="__codelineno-28-131" href="#__codelineno-28-131"></a>        <span class="n">resources_props</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-28-132"><a id="__codelineno-28-132" name="__codelineno-28-132" href="#__codelineno-28-132"></a>        <span class="k">for</span> <span class="n">res_name</span><span class="p">,</span> <span class="n">res_data</span> <span class="ow">in</span> <span class="n">manifest_data</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-28-133"><a id="__codelineno-28-133" name="__codelineno-28-133" href="#__codelineno-28-133"></a>            <span class="n">resources_props</span><span class="p">[</span><span class="n">res_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-134"><a id="__codelineno-28-134" name="__codelineno-28-134" href="#__codelineno-28-134"></a>                <span class="s2">&quot;Limits&quot;</span><span class="p">:</span> <span class="n">_limits_to_cfn</span><span class="p">(</span><span class="n">res_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="__span-28-135"><a id="__codelineno-28-135" name="__codelineno-28-135" href="#__codelineno-28-135"></a>            <span class="p">}</span>
</span><span id="__span-28-136"><a id="__codelineno-28-136" name="__codelineno-28-136" href="#__codelineno-28-136"></a>        <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Resources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources_props</span>
</span><span id="__span-28-137"><a id="__codelineno-28-137" name="__codelineno-28-137" href="#__codelineno-28-137"></a>
</span><span id="__span-28-138"><a id="__codelineno-28-138" name="__codelineno-28-138" href="#__codelineno-28-138"></a>    <span class="k">if</span> <span class="s2">&quot;entities&quot;</span> <span class="ow">in</span> <span class="n">manifest_data</span><span class="p">:</span>
</span><span id="__span-28-139"><a id="__codelineno-28-139" name="__codelineno-28-139" href="#__codelineno-28-139"></a>        <span class="n">entities_props</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-28-140"><a id="__codelineno-28-140" name="__codelineno-28-140" href="#__codelineno-28-140"></a>        <span class="k">for</span> <span class="n">ent_id</span><span class="p">,</span> <span class="n">ent_data</span> <span class="ow">in</span> <span class="n">manifest_data</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-28-141"><a id="__codelineno-28-141" name="__codelineno-28-141" href="#__codelineno-28-141"></a>            <span class="n">ent_resources</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-28-142"><a id="__codelineno-28-142" name="__codelineno-28-142" href="#__codelineno-28-142"></a>            <span class="k">for</span> <span class="n">res_name</span><span class="p">,</span> <span class="n">res_data</span> <span class="ow">in</span> <span class="n">ent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-28-143"><a id="__codelineno-28-143" name="__codelineno-28-143" href="#__codelineno-28-143"></a>                <span class="n">ent_resources</span><span class="p">[</span><span class="n">res_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-144"><a id="__codelineno-28-144" name="__codelineno-28-144" href="#__codelineno-28-144"></a>                    <span class="s2">&quot;Limits&quot;</span><span class="p">:</span> <span class="n">_limits_to_cfn</span><span class="p">(</span><span class="n">res_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="__span-28-145"><a id="__codelineno-28-145" name="__codelineno-28-145" href="#__codelineno-28-145"></a>                <span class="p">}</span>
</span><span id="__span-28-146"><a id="__codelineno-28-146" name="__codelineno-28-146" href="#__codelineno-28-146"></a>            <span class="n">entities_props</span><span class="p">[</span><span class="n">ent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Resources&quot;</span><span class="p">:</span> <span class="n">ent_resources</span><span class="p">}</span>
</span><span id="__span-28-147"><a id="__codelineno-28-147" name="__codelineno-28-147" href="#__codelineno-28-147"></a>        <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;Entities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entities_props</span>
</span><span id="__span-28-148"><a id="__codelineno-28-148" name="__codelineno-28-148" href="#__codelineno-28-148"></a>
</span><span id="__span-28-149"><a id="__codelineno-28-149" name="__codelineno-28-149" href="#__codelineno-28-149"></a>    <span class="n">template</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-150"><a id="__codelineno-28-150" name="__codelineno-28-150" href="#__codelineno-28-150"></a>        <span class="s2">&quot;AWSTemplateFormatVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;2010-09-09&quot;</span><span class="p">,</span>
</span><span id="__span-28-151"><a id="__codelineno-28-151" name="__codelineno-28-151" href="#__codelineno-28-151"></a>        <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Declarative limits for namespace &#39;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
</span><span id="__span-28-152"><a id="__codelineno-28-152" name="__codelineno-28-152" href="#__codelineno-28-152"></a>        <span class="s2">&quot;Resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-153"><a id="__codelineno-28-153" name="__codelineno-28-153" href="#__codelineno-28-153"></a>            <span class="s2">&quot;TenantLimits&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-28-154"><a id="__codelineno-28-154" name="__codelineno-28-154" href="#__codelineno-28-154"></a>                <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Custom::ZaeLimiterLimits&quot;</span><span class="p">,</span>
</span><span id="__span-28-155"><a id="__codelineno-28-155" name="__codelineno-28-155" href="#__codelineno-28-155"></a>                <span class="s2">&quot;Properties&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span>
</span><span id="__span-28-156"><a id="__codelineno-28-156" name="__codelineno-28-156" href="#__codelineno-28-156"></a>            <span class="p">},</span>
</span><span id="__span-28-157"><a id="__codelineno-28-157" name="__codelineno-28-157" href="#__codelineno-28-157"></a>        <span class="p">},</span>
</span><span id="__span-28-158"><a id="__codelineno-28-158" name="__codelineno-28-158" href="#__codelineno-28-158"></a>    <span class="p">}</span>
</span><span id="__span-28-159"><a id="__codelineno-28-159" name="__codelineno-28-159" href="#__codelineno-28-159"></a>
</span><span id="__span-28-160"><a id="__codelineno-28-160" name="__codelineno-28-160" href="#__codelineno-28-160"></a>    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span><span id="__span-28-161"><a id="__codelineno-28-161" name="__codelineno-28-161" href="#__codelineno-28-161"></a>
</span><span id="__span-28-162"><a id="__codelineno-28-162" name="__codelineno-28-162" href="#__codelineno-28-162"></a>
</span><span id="__span-28-163"><a id="__codelineno-28-163" name="__codelineno-28-163" href="#__codelineno-28-163"></a><span class="k">def</span><span class="w"> </span><span class="nf">_limits_to_cfn</span><span class="p">(</span><span class="n">limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-28-164"><a id="__codelineno-28-164" name="__codelineno-28-164" href="#__codelineno-28-164"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert manifest limits dict to CFN PascalCase format.&quot;&quot;&quot;</span>
</span><span id="__span-28-165"><a id="__codelineno-28-165" name="__codelineno-28-165" href="#__codelineno-28-165"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-28-166"><a id="__codelineno-28-166" name="__codelineno-28-166" href="#__codelineno-28-166"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-28-167"><a id="__codelineno-28-167" name="__codelineno-28-167" href="#__codelineno-28-167"></a>        <span class="n">cfn_limit</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Capacity&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">[</span><span class="s2">&quot;capacity&quot;</span><span class="p">]}</span>
</span><span id="__span-28-168"><a id="__codelineno-28-168" name="__codelineno-28-168" href="#__codelineno-28-168"></a>        <span class="k">if</span> <span class="s2">&quot;burst&quot;</span> <span class="ow">in</span> <span class="n">limit</span><span class="p">:</span>
</span><span id="__span-28-169"><a id="__codelineno-28-169" name="__codelineno-28-169" href="#__codelineno-28-169"></a>            <span class="n">cfn_limit</span><span class="p">[</span><span class="s2">&quot;Burst&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span><span class="p">[</span><span class="s2">&quot;burst&quot;</span><span class="p">]</span>
</span><span id="__span-28-170"><a id="__codelineno-28-170" name="__codelineno-28-170" href="#__codelineno-28-170"></a>        <span class="k">if</span> <span class="s2">&quot;refill_amount&quot;</span> <span class="ow">in</span> <span class="n">limit</span><span class="p">:</span>
</span><span id="__span-28-171"><a id="__codelineno-28-171" name="__codelineno-28-171" href="#__codelineno-28-171"></a>            <span class="n">cfn_limit</span><span class="p">[</span><span class="s2">&quot;RefillAmount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span><span class="p">[</span><span class="s2">&quot;refill_amount&quot;</span><span class="p">]</span>
</span><span id="__span-28-172"><a id="__codelineno-28-172" name="__codelineno-28-172" href="#__codelineno-28-172"></a>        <span class="k">if</span> <span class="s2">&quot;refill_period&quot;</span> <span class="ow">in</span> <span class="n">limit</span><span class="p">:</span>
</span><span id="__span-28-173"><a id="__codelineno-28-173" name="__codelineno-28-173" href="#__codelineno-28-173"></a>            <span class="n">cfn_limit</span><span class="p">[</span><span class="s2">&quot;RefillPeriod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span><span class="p">[</span><span class="s2">&quot;refill_period&quot;</span><span class="p">]</span>
</span><span id="__span-28-174"><a id="__codelineno-28-174" name="__codelineno-28-174" href="#__codelineno-28-174"></a>        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfn_limit</span>
</span><span id="__span-28-175"><a id="__codelineno-28-175" name="__codelineno-28-175" href="#__codelineno-28-175"></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-28-176"><a id="__codelineno-28-176" name="__codelineno-28-176" href="#__codelineno-28-176"></a>
</span><span id="__span-28-177"><a id="__codelineno-28-177" name="__codelineno-28-177" href="#__codelineno-28-177"></a>
</span><span id="__span-28-178"><a id="__codelineno-28-178" name="__codelineno-28-178" href="#__codelineno-28-178"></a><span class="k">def</span><span class="w"> </span><span class="nf">_load_yaml</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-28-179"><a id="__codelineno-28-179" name="__codelineno-28-179" href="#__codelineno-28-179"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and parse a YAML file.&quot;&quot;&quot;</span>
</span><span id="__span-28-180"><a id="__codelineno-28-180" name="__codelineno-28-180" href="#__codelineno-28-180"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-28-181"><a id="__codelineno-28-181" name="__codelineno-28-181" href="#__codelineno-28-181"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="__span-28-182"><a id="__codelineno-28-182" name="__codelineno-28-182" href="#__codelineno-28-182"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-28-183"><a id="__codelineno-28-183" name="__codelineno-28-183" href="#__codelineno-28-183"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Error: YAML file must contain a mapping&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-28-184"><a id="__codelineno-28-184" name="__codelineno-28-184" href="#__codelineno-28-184"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-28-185"><a id="__codelineno-28-185" name="__codelineno-28-185" href="#__codelineno-28-185"></a>    <span class="k">return</span> <span class="n">data</span>
</span><span id="__span-28-186"><a id="__codelineno-28-186" name="__codelineno-28-186" href="#__codelineno-28-186"></a>
</span><span id="__span-28-187"><a id="__codelineno-28-187" name="__codelineno-28-187" href="#__codelineno-28-187"></a>
</span><span id="__span-28-188"><a id="__codelineno-28-188" name="__codelineno-28-188" href="#__codelineno-28-188"></a><span class="k">def</span><span class="w"> </span><span class="nf">_invoke_provisioner</span><span class="p">(</span>
</span><span id="__span-28-189"><a id="__codelineno-28-189" name="__codelineno-28-189" href="#__codelineno-28-189"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-28-190"><a id="__codelineno-28-190" name="__codelineno-28-190" href="#__codelineno-28-190"></a>    <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-28-191"><a id="__codelineno-28-191" name="__codelineno-28-191" href="#__codelineno-28-191"></a>    <span class="n">endpoint_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-28-192"><a id="__codelineno-28-192" name="__codelineno-28-192" href="#__codelineno-28-192"></a>    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-28-193"><a id="__codelineno-28-193" name="__codelineno-28-193" href="#__codelineno-28-193"></a>    <span class="n">manifest_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-28-194"><a id="__codelineno-28-194" name="__codelineno-28-194" href="#__codelineno-28-194"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-28-195"><a id="__codelineno-28-195" name="__codelineno-28-195" href="#__codelineno-28-195"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Invoke the provisioner Lambda function.</span>
</span><span id="__span-28-196"><a id="__codelineno-28-196" name="__codelineno-28-196" href="#__codelineno-28-196"></a>
</span><span id="__span-28-197"><a id="__codelineno-28-197" name="__codelineno-28-197" href="#__codelineno-28-197"></a><span class="sd">    Args:</span>
</span><span id="__span-28-198"><a id="__codelineno-28-198" name="__codelineno-28-198" href="#__codelineno-28-198"></a><span class="sd">        name: Stack name (used to derive Lambda function name and table name).</span>
</span><span id="__span-28-199"><a id="__codelineno-28-199" name="__codelineno-28-199" href="#__codelineno-28-199"></a><span class="sd">        region: AWS region.</span>
</span><span id="__span-28-200"><a id="__codelineno-28-200" name="__codelineno-28-200" href="#__codelineno-28-200"></a><span class="sd">        endpoint_url: AWS endpoint URL (for LocalStack).</span>
</span><span id="__span-28-201"><a id="__codelineno-28-201" name="__codelineno-28-201" href="#__codelineno-28-201"></a><span class="sd">        action: &quot;plan&quot; or &quot;apply&quot;.</span>
</span><span id="__span-28-202"><a id="__codelineno-28-202" name="__codelineno-28-202" href="#__codelineno-28-202"></a><span class="sd">        manifest_data: Parsed YAML manifest as dict.</span>
</span><span id="__span-28-203"><a id="__codelineno-28-203" name="__codelineno-28-203" href="#__codelineno-28-203"></a>
</span><span id="__span-28-204"><a id="__codelineno-28-204" name="__codelineno-28-204" href="#__codelineno-28-204"></a><span class="sd">    Returns:</span>
</span><span id="__span-28-205"><a id="__codelineno-28-205" name="__codelineno-28-205" href="#__codelineno-28-205"></a><span class="sd">        Lambda response payload.</span>
</span><span id="__span-28-206"><a id="__codelineno-28-206" name="__codelineno-28-206" href="#__codelineno-28-206"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-28-207"><a id="__codelineno-28-207" name="__codelineno-28-207" href="#__codelineno-28-207"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-28-208"><a id="__codelineno-28-208" name="__codelineno-28-208" href="#__codelineno-28-208"></a>
</span><span id="__span-28-209"><a id="__codelineno-28-209" name="__codelineno-28-209" href="#__codelineno-28-209"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">.repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">Repository</span>
</span><span id="__span-28-210"><a id="__codelineno-28-210" name="__codelineno-28-210" href="#__codelineno-28-210"></a>
</span><span id="__span-28-211"><a id="__codelineno-28-211" name="__codelineno-28-211" href="#__codelineno-28-211"></a>    <span class="c1"># Resolve namespace to get namespace_id</span>
</span><span id="__span-28-212"><a id="__codelineno-28-212" name="__codelineno-28-212" href="#__codelineno-28-212"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_resolve</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-28-213"><a id="__codelineno-28-213" name="__codelineno-28-213" href="#__codelineno-28-213"></a>        <span class="n">repo</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Repository</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span><span id="__span-28-214"><a id="__codelineno-28-214" name="__codelineno-28-214" href="#__codelineno-28-214"></a>            <span class="n">name</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="o">=</span><span class="n">endpoint_url</span><span class="p">,</span>
</span><span id="__span-28-215"><a id="__codelineno-28-215" name="__codelineno-28-215" href="#__codelineno-28-215"></a>            <span class="n">namespace</span><span class="o">=</span><span class="n">manifest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">),</span>
</span><span id="__span-28-216"><a id="__codelineno-28-216" name="__codelineno-28-216" href="#__codelineno-28-216"></a>        <span class="p">)</span>
</span><span id="__span-28-217"><a id="__codelineno-28-217" name="__codelineno-28-217" href="#__codelineno-28-217"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-28-218"><a id="__codelineno-28-218" name="__codelineno-28-218" href="#__codelineno-28-218"></a>            <span class="k">return</span> <span class="n">repo</span><span class="o">.</span><span class="n">_namespace_id</span>
</span><span id="__span-28-219"><a id="__codelineno-28-219" name="__codelineno-28-219" href="#__codelineno-28-219"></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-28-220"><a id="__codelineno-28-220" name="__codelineno-28-220" href="#__codelineno-28-220"></a>            <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-28-221"><a id="__codelineno-28-221" name="__codelineno-28-221" href="#__codelineno-28-221"></a>
</span><span id="__span-28-222"><a id="__codelineno-28-222" name="__codelineno-28-222" href="#__codelineno-28-222"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-28-223"><a id="__codelineno-28-223" name="__codelineno-28-223" href="#__codelineno-28-223"></a>        <span class="n">namespace_id</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">_resolve</span><span class="p">())</span>
</span><span id="__span-28-224"><a id="__codelineno-28-224" name="__codelineno-28-224" href="#__codelineno-28-224"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-28-225"><a id="__codelineno-28-225" name="__codelineno-28-225" href="#__codelineno-28-225"></a>        <span class="c1"># If namespace doesn&#39;t exist yet, we need to register it</span>
</span><span id="__span-28-226"><a id="__codelineno-28-226" name="__codelineno-28-226" href="#__codelineno-28-226"></a>        <span class="c1"># The Lambda will handle auto-registration</span>
</span><span id="__span-28-227"><a id="__codelineno-28-227" name="__codelineno-28-227" href="#__codelineno-28-227"></a>        <span class="n">namespace_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-28-228"><a id="__codelineno-28-228" name="__codelineno-28-228" href="#__codelineno-28-228"></a>
</span><span id="__span-28-229"><a id="__codelineno-28-229" name="__codelineno-28-229" href="#__codelineno-28-229"></a>    <span class="n">function_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">-limits-provisioner&quot;</span>
</span><span id="__span-28-230"><a id="__codelineno-28-230" name="__codelineno-28-230" href="#__codelineno-28-230"></a>
</span><span id="__span-28-231"><a id="__codelineno-28-231" name="__codelineno-28-231" href="#__codelineno-28-231"></a>    <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-28-232"><a id="__codelineno-28-232" name="__codelineno-28-232" href="#__codelineno-28-232"></a>    <span class="k">if</span> <span class="n">region</span><span class="p">:</span>
</span><span id="__span-28-233"><a id="__codelineno-28-233" name="__codelineno-28-233" href="#__codelineno-28-233"></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;region_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
</span><span id="__span-28-234"><a id="__codelineno-28-234" name="__codelineno-28-234" href="#__codelineno-28-234"></a>    <span class="k">if</span> <span class="n">endpoint_url</span><span class="p">:</span>
</span><span id="__span-28-235"><a id="__codelineno-28-235" name="__codelineno-28-235" href="#__codelineno-28-235"></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;endpoint_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint_url</span>
</span><span id="__span-28-236"><a id="__codelineno-28-236" name="__codelineno-28-236" href="#__codelineno-28-236"></a>
</span><span id="__span-28-237"><a id="__codelineno-28-237" name="__codelineno-28-237" href="#__codelineno-28-237"></a>    <span class="n">lambda_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-28-238"><a id="__codelineno-28-238" name="__codelineno-28-238" href="#__codelineno-28-238"></a>
</span><span id="__span-28-239"><a id="__codelineno-28-239" name="__codelineno-28-239" href="#__codelineno-28-239"></a>    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-28-240"><a id="__codelineno-28-240" name="__codelineno-28-240" href="#__codelineno-28-240"></a>        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
</span><span id="__span-28-241"><a id="__codelineno-28-241" name="__codelineno-28-241" href="#__codelineno-28-241"></a>        <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
</span><span id="__span-28-242"><a id="__codelineno-28-242" name="__codelineno-28-242" href="#__codelineno-28-242"></a>        <span class="s2">&quot;namespace_id&quot;</span><span class="p">:</span> <span class="n">namespace_id</span><span class="p">,</span>
</span><span id="__span-28-243"><a id="__codelineno-28-243" name="__codelineno-28-243" href="#__codelineno-28-243"></a>        <span class="s2">&quot;manifest&quot;</span><span class="p">:</span> <span class="n">manifest_data</span><span class="p">,</span>
</span><span id="__span-28-244"><a id="__codelineno-28-244" name="__codelineno-28-244" href="#__codelineno-28-244"></a>    <span class="p">}</span>
</span><span id="__span-28-245"><a id="__codelineno-28-245" name="__codelineno-28-245" href="#__codelineno-28-245"></a>
</span><span id="__span-28-246"><a id="__codelineno-28-246" name="__codelineno-28-246" href="#__codelineno-28-246"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">lambda_client</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
</span><span id="__span-28-247"><a id="__codelineno-28-247" name="__codelineno-28-247" href="#__codelineno-28-247"></a>        <span class="n">FunctionName</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
</span><span id="__span-28-248"><a id="__codelineno-28-248" name="__codelineno-28-248" href="#__codelineno-28-248"></a>        <span class="n">InvocationType</span><span class="o">=</span><span class="s2">&quot;RequestResponse&quot;</span><span class="p">,</span>
</span><span id="__span-28-249"><a id="__codelineno-28-249" name="__codelineno-28-249" href="#__codelineno-28-249"></a>        <span class="n">Payload</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span>
</span><span id="__span-28-250"><a id="__codelineno-28-250" name="__codelineno-28-250" href="#__codelineno-28-250"></a>    <span class="p">)</span>
</span><span id="__span-28-251"><a id="__codelineno-28-251" name="__codelineno-28-251" href="#__codelineno-28-251"></a>
</span><span id="__span-28-252"><a id="__codelineno-28-252" name="__codelineno-28-252" href="#__codelineno-28-252"></a>    <span class="n">response_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Payload&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span id="__span-28-253"><a id="__codelineno-28-253" name="__codelineno-28-253" href="#__codelineno-28-253"></a>
</span><span id="__span-28-254"><a id="__codelineno-28-254" name="__codelineno-28-254" href="#__codelineno-28-254"></a>    <span class="k">if</span> <span class="s2">&quot;errorMessage&quot;</span> <span class="ow">in</span> <span class="n">response_payload</span><span class="p">:</span>
</span><span id="__span-28-255"><a id="__codelineno-28-255" name="__codelineno-28-255" href="#__codelineno-28-255"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">response_payload</span><span class="p">[</span><span class="s2">&quot;errorMessage&quot;</span><span class="p">]</span>
</span><span id="__span-28-256"><a id="__codelineno-28-256" name="__codelineno-28-256" href="#__codelineno-28-256"></a>        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Lambda execution failed: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-28-257"><a id="__codelineno-28-257" name="__codelineno-28-257" href="#__codelineno-28-257"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-28-258"><a id="__codelineno-28-258" name="__codelineno-28-258" href="#__codelineno-28-258"></a>
</span><span id="__span-28-259"><a id="__codelineno-28-259" name="__codelineno-28-259" href="#__codelineno-28-259"></a>    <span class="k">return</span> <span class="n">response_payload</span>
</span></code></pre></div>
<p>In <code>src/zae_limiter/cli.py</code>, add the import and registration:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1"># Near the top, with other imports (around line 16)</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.limits_cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">limits</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1"># At the bottom, with other add_command calls (around line 3820)</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">cli</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limits_cli.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>git add src/zae_limiter/limits_cli.py src/zae_limiter/cli.py tests/unit/test_limits_cli.py
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>git commit -m &quot;✨ feat(cli): add limits plan/apply/diff/cfn-template commands&quot;
</span></code></pre></div>
<hr />
<h2 id="task-11-integration-tests">Task 11: Integration Tests<a class="headerlink" href="#task-11-integration-tests" title="Permanent link">&para;</a></h2>
<p>Create integration tests that verify the full flow against LocalStack.</p>
<p><strong>Files:</strong>
- Create: <code>tests/integration/test_provisioner.py</code></p>
<p><strong>Step 1: Write integration tests</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="sd">&quot;&quot;&quot;Integration tests for declarative limits provisioner (LocalStack).&quot;&quot;&quot;</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest_asyncio</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Limit</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.manifest</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitsManifest</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.differ</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_diff</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter_provisioner.applier</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_changes</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestProvisionerIntegration</span><span class="p">:</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Full provisioner workflow against LocalStack.&quot;&quot;&quot;</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_apply_creates_and_reads_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply creates limits that are readable via Repository API.&quot;&quot;&quot;</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a>                <span class="s2">&quot;on_unavailable&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span><span class="p">,</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>                <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}},</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a>            <span class="p">},</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a>                <span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">}}},</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a>            <span class="p">},</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>        <span class="p">})</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{}}</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">)</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">created</span> <span class="o">==</span> <span class="mi">2</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="p">[]</span>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a>
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a>        <span class="c1"># Verify via Repository API</span>
</span><span id="__span-31-37"><a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a>        <span class="n">system</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">get_system_defaults</span><span class="p">()</span>
</span><span id="__span-31-38"><a id="__codelineno-31-38" name="__codelineno-31-38" href="#__codelineno-31-38"></a>        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;rpm&quot;</span> <span class="ow">and</span> <span class="n">l</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">1000</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">limits</span><span class="p">)</span>
</span><span id="__span-31-39"><a id="__codelineno-31-39" name="__codelineno-31-39" href="#__codelineno-31-39"></a>
</span><span id="__span-31-40"><a id="__codelineno-31-40" name="__codelineno-31-40" href="#__codelineno-31-40"></a>        <span class="n">resource_limits</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">get_resource_defaults</span><span class="p">(</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-31-41"><a id="__codelineno-31-41" name="__codelineno-31-41" href="#__codelineno-31-41"></a>        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;tpm&quot;</span> <span class="ow">and</span> <span class="n">l</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">50000</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">resource_limits</span><span class="p">)</span>
</span><span id="__span-31-42"><a id="__codelineno-31-42" name="__codelineno-31-42" href="#__codelineno-31-42"></a>
</span><span id="__span-31-43"><a id="__codelineno-31-43" name="__codelineno-31-43" href="#__codelineno-31-43"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
</span><span id="__span-31-44"><a id="__codelineno-31-44" name="__codelineno-31-44" href="#__codelineno-31-44"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_idempotent_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-31-45"><a id="__codelineno-31-45" name="__codelineno-31-45" href="#__codelineno-31-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applying the same manifest twice produces update actions (idempotent).&quot;&quot;&quot;</span>
</span><span id="__span-31-46"><a id="__codelineno-31-46" name="__codelineno-31-46" href="#__codelineno-31-46"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
</span><span id="__span-31-47"><a id="__codelineno-31-47" name="__codelineno-31-47" href="#__codelineno-31-47"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
</span><span id="__span-31-48"><a id="__codelineno-31-48" name="__codelineno-31-48" href="#__codelineno-31-48"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}}},</span>
</span><span id="__span-31-49"><a id="__codelineno-31-49" name="__codelineno-31-49" href="#__codelineno-31-49"></a>        <span class="p">})</span>
</span><span id="__span-31-50"><a id="__codelineno-31-50" name="__codelineno-31-50" href="#__codelineno-31-50"></a>
</span><span id="__span-31-51"><a id="__codelineno-31-51" name="__codelineno-31-51" href="#__codelineno-31-51"></a>        <span class="c1"># First apply</span>
</span><span id="__span-31-52"><a id="__codelineno-31-52" name="__codelineno-31-52" href="#__codelineno-31-52"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{}}</span>
</span><span id="__span-31-53"><a id="__codelineno-31-53" name="__codelineno-31-53" href="#__codelineno-31-53"></a>        <span class="n">changes1</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-31-54"><a id="__codelineno-31-54" name="__codelineno-31-54" href="#__codelineno-31-54"></a>        <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes1</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">)</span>
</span><span id="__span-31-55"><a id="__codelineno-31-55" name="__codelineno-31-55" href="#__codelineno-31-55"></a>
</span><span id="__span-31-56"><a id="__codelineno-31-56" name="__codelineno-31-56" href="#__codelineno-31-56"></a>        <span class="c1"># Second apply (same manifest, updated previous state)</span>
</span><span id="__span-31-57"><a id="__codelineno-31-57" name="__codelineno-31-57" href="#__codelineno-31-57"></a>        <span class="n">new_previous</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-31-58"><a id="__codelineno-31-58" name="__codelineno-31-58" href="#__codelineno-31-58"></a>        <span class="n">changes2</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">new_previous</span><span class="p">)</span>
</span><span id="__span-31-59"><a id="__codelineno-31-59" name="__codelineno-31-59" href="#__codelineno-31-59"></a>        <span class="n">result2</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes2</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">)</span>
</span><span id="__span-31-60"><a id="__codelineno-31-60" name="__codelineno-31-60" href="#__codelineno-31-60"></a>        <span class="k">assert</span> <span class="n">result2</span><span class="o">.</span><span class="n">updated</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-31-61"><a id="__codelineno-31-61" name="__codelineno-31-61" href="#__codelineno-31-61"></a>        <span class="k">assert</span> <span class="n">result2</span><span class="o">.</span><span class="n">created</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-31-62"><a id="__codelineno-31-62" name="__codelineno-31-62" href="#__codelineno-31-62"></a>        <span class="k">assert</span> <span class="n">result2</span><span class="o">.</span><span class="n">deleted</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-31-63"><a id="__codelineno-31-63" name="__codelineno-31-63" href="#__codelineno-31-63"></a>
</span><span id="__span-31-64"><a id="__codelineno-31-64" name="__codelineno-31-64" href="#__codelineno-31-64"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
</span><span id="__span-31-65"><a id="__codelineno-31-65" name="__codelineno-31-65" href="#__codelineno-31-65"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_removal_deletes_managed_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-31-66"><a id="__codelineno-31-66" name="__codelineno-31-66" href="#__codelineno-31-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Removing from YAML deletes managed items, leaves unmanaged alone.&quot;&quot;&quot;</span>
</span><span id="__span-31-67"><a id="__codelineno-31-67" name="__codelineno-31-67" href="#__codelineno-31-67"></a>        <span class="c1"># Set an unmanaged resource limit directly</span>
</span><span id="__span-31-68"><a id="__codelineno-31-68" name="__codelineno-31-68" href="#__codelineno-31-68"></a>        <span class="k">await</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">set_resource_defaults</span><span class="p">(</span><span class="s2">&quot;claude-3&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Limit</span><span class="o">.</span><span class="n">per_minute</span><span class="p">(</span><span class="s2">&quot;rpm&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)])</span>
</span><span id="__span-31-69"><a id="__codelineno-31-69" name="__codelineno-31-69" href="#__codelineno-31-69"></a>
</span><span id="__span-31-70"><a id="__codelineno-31-70" name="__codelineno-31-70" href="#__codelineno-31-70"></a>        <span class="c1"># Apply manifest with gpt-4 only</span>
</span><span id="__span-31-71"><a id="__codelineno-31-71" name="__codelineno-31-71" href="#__codelineno-31-71"></a>        <span class="n">manifest</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
</span><span id="__span-31-72"><a id="__codelineno-31-72" name="__codelineno-31-72" href="#__codelineno-31-72"></a>            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
</span><span id="__span-31-73"><a id="__codelineno-31-73" name="__codelineno-31-73" href="#__codelineno-31-73"></a>            <span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}}}},</span>
</span><span id="__span-31-74"><a id="__codelineno-31-74" name="__codelineno-31-74" href="#__codelineno-31-74"></a>        <span class="p">})</span>
</span><span id="__span-31-75"><a id="__codelineno-31-75" name="__codelineno-31-75" href="#__codelineno-31-75"></a>        <span class="n">previous</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;managed_system&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;managed_resources&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;managed_entities&quot;</span><span class="p">:</span> <span class="p">{}}</span>
</span><span id="__span-31-76"><a id="__codelineno-31-76" name="__codelineno-31-76" href="#__codelineno-31-76"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
</span><span id="__span-31-77"><a id="__codelineno-31-77" name="__codelineno-31-77" href="#__codelineno-31-77"></a>        <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">)</span>
</span><span id="__span-31-78"><a id="__codelineno-31-78" name="__codelineno-31-78" href="#__codelineno-31-78"></a>
</span><span id="__span-31-79"><a id="__codelineno-31-79" name="__codelineno-31-79" href="#__codelineno-31-79"></a>        <span class="c1"># Now remove gpt-4 from manifest</span>
</span><span id="__span-31-80"><a id="__codelineno-31-80" name="__codelineno-31-80" href="#__codelineno-31-80"></a>        <span class="n">manifest2</span> <span class="o">=</span> <span class="n">LimitsManifest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">})</span>
</span><span id="__span-31-81"><a id="__codelineno-31-81" name="__codelineno-31-81" href="#__codelineno-31-81"></a>        <span class="n">previous2</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">managed_set</span><span class="p">()</span>
</span><span id="__span-31-82"><a id="__codelineno-31-82" name="__codelineno-31-82" href="#__codelineno-31-82"></a>        <span class="n">changes2</span> <span class="o">=</span> <span class="n">compute_diff</span><span class="p">(</span><span class="n">manifest2</span><span class="p">,</span> <span class="n">previous2</span><span class="p">)</span>
</span><span id="__span-31-83"><a id="__codelineno-31-83" name="__codelineno-31-83" href="#__codelineno-31-83"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">apply_changes</span><span class="p">(</span><span class="n">changes2</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">)</span>
</span><span id="__span-31-84"><a id="__codelineno-31-84" name="__codelineno-31-84" href="#__codelineno-31-84"></a>
</span><span id="__span-31-85"><a id="__codelineno-31-85" name="__codelineno-31-85" href="#__codelineno-31-85"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">deleted</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># gpt-4 deleted</span>
</span><span id="__span-31-86"><a id="__codelineno-31-86" name="__codelineno-31-86" href="#__codelineno-31-86"></a>
</span><span id="__span-31-87"><a id="__codelineno-31-87" name="__codelineno-31-87" href="#__codelineno-31-87"></a>        <span class="c1"># claude-3 (unmanaged) should still exist</span>
</span><span id="__span-31-88"><a id="__codelineno-31-88" name="__codelineno-31-88" href="#__codelineno-31-88"></a>        <span class="n">claude_limits</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_repo</span><span class="o">.</span><span class="n">get_resource_defaults</span><span class="p">(</span><span class="s2">&quot;claude-3&quot;</span><span class="p">)</span>
</span><span id="__span-31-89"><a id="__codelineno-31-89" name="__codelineno-31-89" href="#__codelineno-31-89"></a>        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;rpm&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">claude_limits</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/integration/test_provisioner.py -v</code> (requires LocalStack)</p>
<p><strong>Step 3: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>git add tests/integration/test_provisioner.py
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>git commit -m &quot;✅ test(infra): add integration tests for declarative limits provisioner&quot;
</span></code></pre></div>
<hr />
<h2 id="task-12-documentation-updates">Task 12: Documentation Updates<a class="headerlink" href="#task-12-documentation-updates" title="Permanent link">&para;</a></h2>
<p>Update CLAUDE.md, CLI docs, and operator guide.</p>
<p><strong>Files:</strong>
- Modify: <code>CLAUDE.md</code> (add provisioner to schema, CLI commands, access patterns)
- Modify: <code>docs/cli.md</code> (add <code>limits</code> command group)
- Modify: <code>docs/infra/deployment.md</code> (add declarative limits section)</p>
<p><strong>Step 1: Update CLAUDE.md</strong></p>
<p>Add to Project Structure:
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>src/zae_limiter_provisioner/   # Lambda provisioner for declarative limits
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>├── __init__.py
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>├── handler.py           # Lambda entry point (CLI + CFN events)
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>├── manifest.py          # LimitsManifest YAML parsing
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>├── differ.py            # Diff engine (manifest vs #PROVISIONER state)
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>└── applier.py           # Applies changes via boto3 DynamoDB
</span></code></pre></div></p>
<p>Add to DynamoDB Access Patterns table:
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>| Get provisioner state | `PK={ns}/SYSTEM#, SK=#PROVISIONER` |
</span></code></pre></div></p>
<p>Add to CLI commands section:
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>limits plan, limits apply, limits diff, limits cfn-template
</span></code></pre></div></p>
<p><strong>Step 2: Update docs/cli.md</strong></p>
<p>Add <code>limits</code> command group with examples for plan, apply, diff, cfn-template.</p>
<p><strong>Step 3: Update docs/infra/deployment.md</strong></p>
<p>Add a "Declarative Limits Management" section with YAML format, CLI workflow, and CFN integration.</p>
<p><strong>Step 4: Commit</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>git add CLAUDE.md docs/cli.md docs/infra/deployment.md
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>git commit -m &quot;📝 docs(infra): add declarative limits management documentation&quot;
</span></code></pre></div>
<hr />
<p>Plan complete and saved to <code>docs/plans/2026-02-19-declarative-limits-implementation.md</code>. Two execution options:</p>
<p><strong>1. Subagent-Driven (this session)</strong> — I dispatch a fresh subagent per task, review between tasks, fast iteration</p>
<p><strong>2. Parallel Session (separate)</strong> — Open a new session with <code>executing-plans</code>, batch execution with checkpoints</p>
<p>Which approach?</p>












                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/zeroae/zae-limiter" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/zae-limiter/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.top", "navigation.footer", "content.code.copy", "content.code.annotate", "content.action.edit", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
    
  </body>
</html>