
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Rate limiting library backed by DynamoDB using the token bucket algorithm">
      
      
        <meta name="author" content="ZeroAE">
      
      
        <link rel="canonical" href="https://zeroae.github.io/zae-limiter/0.10.1/plans/2026-02-21-pre-shard-buckets-implementation/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/zae-limiter.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Pre-Shard Buckets Implementation Plan - zae-limiter</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pre-shard-buckets-implementation-plan" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="zae-limiter" class="md-header__button md-logo" aria-label="zae-limiter" data-md-component="logo">
      
  <img src="../../assets/zae-limiter-icon-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            zae-limiter
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pre-Shard Buckets Implementation Plan
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/zeroae/zae-limiter" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zeroae/zae-limiter
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="zae-limiter" class="md-nav__button md-logo" aria-label="zae-limiter" data-md-component="logo">
      
  <img src="../../assets/zae-limiter-icon-white.svg" alt="logo">

    </a>
    zae-limiter
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zeroae/zae-limiter" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zeroae/zae-limiter
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/token-bucket/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Token Bucket Algorithm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/basic-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/config-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hierarchical/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hierarchical Limits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/llm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/usage-snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage Snapshots
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/unavailability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unavailability Handling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Operator Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Operator Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/cloudformation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CloudFormation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Migrations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Migrations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../migrations/namespace-keys/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Namespace Keys (v0.10.0)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/auditing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Auditing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/limiter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RateLimiter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/repository/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repository
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmarks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmarks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Contributing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Development Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/localstack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LocalStack
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ADRs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    ADRs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/000-adr-format-standard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR Format
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Foundational (v0.1.0-v0.4.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Foundational (v0.1.0-v0.4.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/001-single-table-dynamodb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-001 Single-Table DynamoDB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/002-integer-arithmetic-millitokens/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-002 Integer Arithmetic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/003-cloudformation-infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-003 CloudFormation Infra
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/004-declarative-stack-options/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-004 StackOptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/005-exception-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-005 Exception Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/006-flat-schema-snapshots/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-006 Flat Schema Snapshots
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/007-input-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-007 Input Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/008-security-audit-logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-008 Audit Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/009-version-migration-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-009 Version Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/010-total-consumed-counter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-010 Consumed Counter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/011-api-cli-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-011 API/CLI Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/012-cloudformation-docs-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-012 CloudFormation Docs Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/013-module-documentation-parity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-013 Module Documentation Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Centralized Config (v0.5.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Centralized Config (v0.5.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/100-centralized-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-100 Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/101-flat-schema-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-101 Flat Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/102-config-hierarchy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-102 Config Hierarchy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/103-config-caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-103 Config Caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/104-stored-limits-default/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-104 Stored Limits Default
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/105-eventual-consistency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-105 Eventual Consistency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/106-audit-entity-ids-for-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-106 Audit Entity IDs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/107-iam-roles-for-application-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-107 IAM Roles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Repository Protocol (v0.5.0)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Repository Protocol (v0.5.0)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/108-repository-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-108 Repository Protocol
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/109-backend-capability-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-109 Backend Capabilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/110-deprecation-constructor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-110 Deprecation Strategy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Schema & Infra (v0.6.0+)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Schema & Infra (v0.6.0+)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/111-flatten-all-records/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-111 Flatten All Records
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/112-cascade-per-entity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-112 Cascade Per Entity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/113-lambda-packaging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-113 Lambda Packaging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#phase-1-schema-foundation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 1: Schema Foundation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 1: Schema Foundation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-1-add-bucket-pksk-builders-and-constants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 1: Add bucket PK/SK builders and constants
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-2-add-reserved-limit-name-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 2: Add reserved limit name validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-add-wcu-infrastructure-limit-constant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 3: Add WCU infrastructure limit constant
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-2-bucket-creation-with-new-pk" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Bucket Creation with New PK
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 2: Bucket Creation with New PK">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-4-update-build_composite_create-for-new-pk-scheme" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 4: Update build_composite_create for new PK scheme
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-5-update-_speculative_consume_single-for-new-pk-and-wcu" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 5: Update _speculative_consume_single for new PK and wcu
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-3-shard-selection-and-entity-cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 3: Shard Selection and Entity Cache
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 3: Shard Selection and Entity Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-6-extend-entity-cache-with-shard_count-per-resource" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 6: Extend entity cache with shard_count per resource
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-7-add-shard-selection-to-speculative_consume" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 7: Add shard selection to speculative_consume
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-4-shard-retry-and-doubling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 4: Shard Retry and Doubling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 4: Shard Retry and Doubling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-8-add-shard-retry-on-application-limit-exhaustion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 8: Add shard retry on application limit exhaustion
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-9-add-shard-doubling-on-wcu-exhaustion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 9: Add shard doubling on wcu exhaustion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-5-aggregator-updates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 5: Aggregator Updates
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 5: Aggregator Updates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-10-update-_parse_bucket_record-for-new-pk" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 10: Update _parse_bucket_record for new PK
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-11-update-aggregate_bucket_states-to-key-by-shard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 11: Update aggregate_bucket_states to key by shard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-12-update-try_refill_bucket-for-new-pk-and-effective-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 12: Update try_refill_bucket for new PK and effective limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-13-filter-wcu-from-usage-snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 13: Filter wcu from usage snapshots
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-14-add-aggregator-proactive-sharding" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 14: Add aggregator proactive sharding
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-15-add-aggregator-shard_count-propagation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 15: Add aggregator shard_count propagation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-6-bucket-discovery-and-reads" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 6: Bucket Discovery and Reads
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 6: Bucket Discovery and Reads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-16-add-bucket-discovery-via-gsi3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 16: Add bucket discovery via GSI3
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-7-hide-wcu-from-user-facing-output" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 7: Hide wcu from User-Facing Output
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 7: Hide wcu from User-Facing Output">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-17-filter-wcu-from-ratelimitexceeded-and-get_status" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 17: Filter wcu from RateLimitExceeded and get_status
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-8-sync-code-generation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 8: Sync Code Generation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 8: Sync Code Generation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-18-generate-sync-code-and-verify" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 18: Generate sync code and verify
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-9-integration-and-migration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 9: Integration and Migration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 9: Integration and Migration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-19-update-cloudformation-template-if-needed" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 19: Update CloudFormation template (if needed)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-20-schema-version-bump" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 20: Schema version bump
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-21-integration-test-with-localstack" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 21: Integration test with LocalStack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-22-update-claudemd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 22: Update CLAUDE.md
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-dependency-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Dependency Graph
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-10-design-review-fixes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 10: Design Review Fixes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 10: Design Review Fixes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-32-add-speculativefailurereason-enum" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 32: Add SpeculativeFailureReason enum
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-33-add-high-shard-count-warning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 33: Add high shard count warning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-34-add-missing-test-coverage-for-review-findings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 34: Add missing test coverage for review findings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-31-add-gsi4_sk_bucket-schema-builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 31: Add gsi4_sk_bucket schema builder
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-30-fix-inflated-capacity-in-get_resource_capacity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 30: Fix inflated capacity in get_resource_capacity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-35-handle-dynamodb-per-partition-throttling-with-shard-probe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 35: Handle DynamoDB per-partition throttling with shard probe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-36-fix-propagate_shard_count-to-pre-create-new-shard-items" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 36: Fix propagate_shard_count to pre-create new shard items
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-37-fix-proactive-sharding-signal-to-use-wcu-token-level" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 37: Fix proactive sharding signal to use wcu token level
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task 37: Fix proactive sharding signal to use wcu token level">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-37-test-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task 37 Test Plan
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task 37 Test Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests-testsunittest_processorpytesttryproactiveshard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unit Tests  tests/unit/test_processor.py::TestTryProactiveShard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caller-wiring-tests-testsunittest_processorpytestprocessstreamrecords" class="md-nav__link">
    <span class="md-ellipsis">
      
        Caller Wiring Tests  tests/unit/test_processor.py::TestProcessStreamRecords
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests-testsintegrationtest_bucket_shardingpytestproactiveshardingintegration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration Tests  tests/integration/test_bucket_sharding.py::TestProactiveShardingIntegration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#e2e-tests-testse2etest_localstackpy-new-class-testproactiveshardinge2e" class="md-nav__link">
    <span class="md-ellipsis">
      
        E2E Tests  tests/e2e/test_localstack.py (new class TestProactiveShardingE2E)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-edge-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Edge Cases
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
  
  
                  


  
    <a href="https://github.com/zeroae/zae-limiter/edit/main/docs/plans/2026-02-21-pre-shard-buckets-implementation.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="pre-shard-buckets-implementation-plan">Pre-Shard Buckets Implementation Plan<a class="headerlink" href="#pre-shard-buckets-implementation-plan" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>For Claude:</strong> REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.</p>
</blockquote>
<p><strong>Goal:</strong> Move bucket items to per-(entity, resource, shard) partition keys with auto-injected <code>wcu</code> infrastructure limit to mitigate DynamoDB hot partition throttling (GHSA-76rv-2r9v-c5m6).</p>
<p><strong>Architecture:</strong> Buckets move from <code>PK={ns}/ENTITY#{id}, SK=#BUCKET#{resource}</code> to <code>PK={ns}/BUCKET#{id}#{resource}#{shard}, SK=#STATE</code>. A reserved <code>wcu:1000</code> limit auto-injected on every bucket tracks per-partition write pressure. When exhausted, the client doubles shard count. The aggregator proactively shards before exhaustion and propagates shard_count changes. GSI3 (KEYS_ONLY) enables bucket discovery without impacting the $0.625/M hot path cost.</p>
<p><strong>Tech Stack:</strong> Python 3.11+, DynamoDB (boto3/aioboto3), pytest, moto</p>
<p><strong>Design doc:</strong> <code>docs/plans/2026-02-21-pre-shard-buckets-design.md</code></p>
<hr />
<h2 id="phase-1-schema-foundation">Phase 1: Schema Foundation<a class="headerlink" href="#phase-1-schema-foundation" title="Permanent link">&para;</a></h2>
<h3 id="task-1-add-bucket-pksk-builders-and-constants">Task 1: Add bucket PK/SK builders and constants<a class="headerlink" href="#task-1-add-bucket-pksk-builders-and-constants" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/schema.py:19-30</code> (add constants), <code>:108-135</code> (add new builders)
- Test: <code>tests/unit/test_schema.py</code></p>
<p><strong>Step 1: Write failing tests for new key builders</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_pk_bucket</span><span class="p">():</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_bucket</span><span class="p">(</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_bucket</span><span class="p">(</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#3&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_sk_state</span><span class="p">():</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">sk_state</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;#STATE&quot;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_parse_bucket_pk</span><span class="p">():</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">ns</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">shard</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">parse_bucket_pk</span><span class="p">(</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">assert</span> <span class="n">ns</span> <span class="o">==</span> <span class="s2">&quot;ns1&quot;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">assert</span> <span class="n">entity</span> <span class="o">==</span> <span class="s2">&quot;user-1&quot;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">assert</span> <span class="n">resource</span> <span class="o">==</span> <span class="s2">&quot;gpt-4&quot;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">assert</span> <span class="n">shard</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_parse_bucket_pk_invalid</span><span class="p">():</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">schema</span><span class="o">.</span><span class="n">parse_bucket_pk</span><span class="p">(</span><span class="s2">&quot;ns1/ENTITY#user-1&quot;</span><span class="p">)</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_gsi3_pk_entity</span><span class="p">():</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi3_pk_entity</span><span class="p">(</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ns1/ENTITY#user-1&quot;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_gsi3_sk_bucket</span><span class="p">():</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi3_sk_bucket</span><span class="p">(</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;BUCKET#gpt-4#0&quot;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi3_sk_bucket</span><span class="p">(</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;BUCKET#gpt-4#3&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py -k "test_pk_bucket or test_sk_state or test_parse_bucket_pk or test_gsi3_pk_entity or test_gsi3_sk_bucket" -v</code>
Expected: FAIL with <code>AttributeError: module 'zae_limiter.schema' has no attribute 'pk_bucket'</code></p>
<p><strong>Step 3: Implement new builders in schema.py</strong></p>
<p>Add constants after line 26:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">BUCKET_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;BUCKET#&quot;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">SK_STATE</span> <span class="o">=</span> <span class="s2">&quot;#STATE&quot;</span>
</span></code></pre></div>
<p>Add builders after <code>sk_bucket()</code> (line 135):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">pk_bucket</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build partition key for a bucket shard.&quot;&quot;&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">BUCKET_PREFIX</span><span class="si">}{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">sk_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build sort key for bucket state (fixed).&quot;&quot;&quot;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="k">return</span> <span class="n">SK_STATE</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_bucket_pk</span><span class="p">(</span><span class="n">pk</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse namespace, entity_id, resource, shard_id from a bucket PK.</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="sd">    Args:</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="sd">        pk: A bucket PK like &#39;ns1/BUCKET#user-1#gpt-4#0&#39;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="sd">    Returns:</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="sd">        Tuple of (namespace_id, entity_id, resource, shard_id)</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="sd">    Raises:</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="sd">        ValueError: If PK is not a valid bucket PK</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="n">namespace_id</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">parse_namespace</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">remainder</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">BUCKET_PREFIX</span><span class="p">):</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a bucket PK: </span><span class="si">{</span><span class="n">pk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>    <span class="n">rest</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">BUCKET_PREFIX</span><span class="p">):]</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>    <span class="c1"># Split from the right: last # is shard_id</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid bucket PK format: </span><span class="si">{</span><span class="n">pk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>    <span class="n">entity_resource</span><span class="p">,</span> <span class="n">shard_str</span> <span class="o">=</span> <span class="n">parts</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>    <span class="n">shard_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shard_str</span><span class="p">)</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>    <span class="c1"># Split entity_id and resource: first # separates them</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>    <span class="n">er_parts</span> <span class="o">=</span> <span class="n">entity_resource</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">er_parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid bucket PK format: </span><span class="si">{</span><span class="n">pk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>    <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">er_parts</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>    <span class="k">return</span> <span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">shard_id</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="k">def</span><span class="w"> </span><span class="nf">gsi3_pk_entity</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build GSI3 partition key for entity bucket discovery.&quot;&quot;&quot;</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ENTITY_PREFIX</span><span class="si">}{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">gsi3_sk_bucket</span><span class="p">(</span><span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build GSI3 sort key for bucket entry.&quot;&quot;&quot;</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BUCKET_PREFIX</span><span class="si">}{</span><span class="n">resource</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p>Also update <code>gsi2_sk_bucket()</code> to include shard_id:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">gsi2_sk_bucket</span><span class="p">(</span><span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build GSI2 sort key for composite bucket entry.&quot;&quot;&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;BUCKET#</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py -v</code>
Expected: PASS (new tests + existing tests)</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/schema.py<span class="w"> </span>tests/unit/test_schema.py
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(schema): add bucket PK builders and GSI3 entity keys&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-2-add-reserved-limit-name-validation">Task 2: Add reserved limit name validation<a class="headerlink" href="#task-2-add-reserved-limit-name-validation" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/models.py:24</code> (add reserved set), <code>:72-100</code> (update validate_name)
- Test: <code>tests/unit/test_models.py</code></p>
<p><strong>Step 1: Write failing test for reserved limit name</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_validate_name_rejects_reserved_wcu</span><span class="p">():</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidNameError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;reserved&quot;</span><span class="p">):</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>        <span class="n">validate_name</span><span class="p">(</span><span class="s2">&quot;wcu&quot;</span><span class="p">,</span> <span class="s2">&quot;limit_name&quot;</span><span class="p">)</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_validate_name_allows_normal_names</span><span class="p">():</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">validate_name</span><span class="p">(</span><span class="s2">&quot;rpm&quot;</span><span class="p">,</span> <span class="s2">&quot;limit_name&quot;</span><span class="p">)</span>  <span class="c1"># should not raise</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">validate_name</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="s2">&quot;limit_name&quot;</span><span class="p">)</span>  <span class="c1"># should not raise</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_models.py -k "test_validate_name_rejects_reserved_wcu" -v</code>
Expected: FAIL (no exception raised)</p>
<p><strong>Step 3: Add reserved names set and validation</strong></p>
<p>In <code>models.py</code> after line 31:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Reserved limit names (internal infrastructure limits, not user-configurable)</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">RESERVED_LIMIT_NAMES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;wcu&quot;</span><span class="p">})</span>
</span></code></pre></div>
<p>In <code>validate_name()</code> after the <code>FORBIDDEN_CHAR</code> check (line 92):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">RESERVED_LIMIT_NAMES</span><span class="p">:</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>        <span class="k">raise</span> <span class="n">InvalidNameError</span><span class="p">(</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>            <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; is a reserved limit name&quot;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_models.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/models.py<span class="w"> </span>tests/unit/test_models.py
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(models): add reserved limit name validation for wcu&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-3-add-wcu-infrastructure-limit-constant">Task 3: Add WCU infrastructure limit constant<a class="headerlink" href="#task-3-add-wcu-infrastructure-limit-constant" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/schema.py</code> (add WCU constants)
- Test: <code>tests/unit/test_schema.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_wcu_limit_constants</span><span class="p">():</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_LIMIT_NAME</span> <span class="o">==</span> <span class="s2">&quot;wcu&quot;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_LIMIT_CAPACITY</span> <span class="o">==</span> <span class="mi">1000</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_LIMIT_REFILL_AMOUNT</span> <span class="o">==</span> <span class="mi">1000</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_LIMIT_REFILL_PERIOD_SECONDS</span> <span class="o">==</span> <span class="mi">1</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py -k "test_wcu_limit_constants" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Add constants to schema.py</strong></p>
<p>After the <code>BUCKET_FIELD_RF</code> line (59):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Infrastructure limit: DynamoDB partition write capacity ceiling</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">WCU_LIMIT_NAME</span> <span class="o">=</span> <span class="s2">&quot;wcu&quot;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">WCU_LIMIT_CAPACITY</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># DynamoDB per-partition WCU/sec limit</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">WCU_LIMIT_REFILL_AMOUNT</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">WCU_LIMIT_REFILL_PERIOD_SECONDS</span> <span class="o">=</span> <span class="mi">1</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/schema.py<span class="w"> </span>tests/unit/test_schema.py
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(schema): add WCU infrastructure limit constants&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-2-bucket-creation-with-new-pk">Phase 2: Bucket Creation with New PK<a class="headerlink" href="#phase-2-bucket-creation-with-new-pk" title="Permanent link">&para;</a></h2>
<h3 id="task-4-update-build_composite_create-for-new-pk-scheme">Task 4: Update build_composite_create for new PK scheme<a class="headerlink" href="#task-4-update-build_composite_create-for-new-pk-scheme" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py:1794-1861</code> (build_composite_create)
- Test: <code>tests/unit/test_repository.py</code></p>
<p><strong>Step 1: Write failing test for new bucket PK and wcu injection</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_build_composite_create_new_pk</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">):</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Bucket items use new PK scheme with wcu limit auto-injected.&quot;&quot;&quot;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">make_repo</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">)</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">Limit</span><span class="o">.</span><span class="n">per_minute</span><span class="p">(</span><span class="s2">&quot;rpm&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">item</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">build_composite_create</span><span class="p">(</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>        <span class="n">entity_id</span><span class="o">=</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        <span class="n">shard_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="p">)</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="n">put_item</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Put&quot;</span><span class="p">][</span><span class="s2">&quot;Item&quot;</span><span class="p">]</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="c1"># New PK scheme</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="k">assert</span> <span class="n">put_item</span><span class="p">[</span><span class="s2">&quot;PK&quot;</span><span class="p">][</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_bucket</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    <span class="k">assert</span> <span class="n">put_item</span><span class="p">[</span><span class="s2">&quot;SK&quot;</span><span class="p">][</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">schema</span><span class="o">.</span><span class="n">sk_state</span><span class="p">()</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="c1"># GSI3 projection for bucket discovery</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>    <span class="k">assert</span> <span class="n">put_item</span><span class="p">[</span><span class="s2">&quot;GSI3PK&quot;</span><span class="p">][</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi3_pk_entity</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">)</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="k">assert</span> <span class="n">put_item</span><span class="p">[</span><span class="s2">&quot;GSI3SK&quot;</span><span class="p">][</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi3_sk_bucket</span><span class="p">(</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>    <span class="c1"># wcu limit auto-injected</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">bucket_attr</span><span class="p">(</span><span class="s2">&quot;wcu&quot;</span><span class="p">,</span> <span class="s2">&quot;tk&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">put_item</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">bucket_attr</span><span class="p">(</span><span class="s2">&quot;wcu&quot;</span><span class="p">,</span> <span class="s2">&quot;cp&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">put_item</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    <span class="c1"># shard_count stored</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>    <span class="k">assert</span> <span class="n">put_item</span><span class="p">[</span><span class="s2">&quot;shard_count&quot;</span><span class="p">][</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -k "test_build_composite_create_new_pk" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Update build_composite_create</strong></p>
<p>Modify <code>build_composite_create()</code> to:
1. Accept <code>shard_id: int = 0</code> and <code>shard_count: int = 1</code> parameters
2. Use <code>schema.pk_bucket()</code> instead of <code>schema.pk_entity()</code> + <code>schema.sk_bucket()</code>
3. Set <code>SK</code> to <code>schema.sk_state()</code>
4. Add GSI3PK/GSI3SK for bucket discovery
5. Update GSI2SK to include shard_id
6. Auto-inject wcu limit attributes (capacity=1000<em>1000 milli, refill=1000</em>1000 milli, period=1000ms, tokens=1000*1000 milli)
7. Store <code>shard_count</code> attribute</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -v</code>
Expected: PASS (new test + existing tests may need updates for new signature)</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span>tests/unit/test_repository.py
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(repository): update build_composite_create for new bucket PK&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-5-update-_speculative_consume_single-for-new-pk-and-wcu">Task 5: Update _speculative_consume_single for new PK and wcu<a class="headerlink" href="#task-5-update-_speculative_consume_single-for-new-pk-and-wcu" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py:2161-2253</code> (_speculative_consume_single)
- Test: <code>tests/unit/test_repository.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_consume_uses_new_pk</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">):</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;speculative_consume targets new bucket PK and includes wcu condition.&quot;&quot;&quot;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">make_repo</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="c1"># Create bucket with new PK scheme first</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="c1"># ... (create entity + bucket at new PK)</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        <span class="n">entity_id</span><span class="o">=</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="n">consume</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="p">)</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">==</span> <span class="mi">1</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -k "test_speculative_consume_uses_new_pk" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Update _speculative_consume_single</strong></p>
<p>Modify <code>_speculative_consume_single()</code> (lines 2161-2253) to:
1. Accept <code>shard_id: int = 0</code> parameter
2. Build Key using <code>schema.pk_bucket(self._namespace_id, entity_id, resource, shard_id)</code> + <code>schema.sk_state()</code>
3. Add <code>wcu</code> consumption to UpdateExpression: <code>ADD b_wcu_tk :neg_wcu, b_wcu_tc :pos_wcu</code>
4. Add <code>wcu</code> condition: <code>b_wcu_tk &gt;= :thresh_wcu</code> (value: 1000 millitokens = 1 token)
5. Extract <code>shard_count</code> from ALL_NEW response
6. Add <code>shard_id</code> and <code>shard_count</code> to <code>SpeculativeResult</code></p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span>tests/unit/test_repository.py
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(repository): update speculative_consume for new bucket PK and wcu&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-3-shard-selection-and-entity-cache">Phase 3: Shard Selection and Entity Cache<a class="headerlink" href="#phase-3-shard-selection-and-entity-cache" title="Permanent link">&para;</a></h2>
<h3 id="task-6-extend-entity-cache-with-shard_count-per-resource">Task 6: Extend entity cache with shard_count per resource<a class="headerlink" href="#task-6-extend-entity-cache-with-shard_count-per-resource" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py:129-131</code> (entity cache type)
- Modify: <code>src/zae_limiter/repository.py:2102-2159</code> (speculative_consume cache update)
- Test: <code>tests/unit/test_repository.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_entity_cache_stores_shard_count</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">):</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Entity cache includes shard_count per resource.&quot;&quot;&quot;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">make_repo</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">)</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="c1"># Create entity with bucket (shard_count=1)</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="c1"># ... setup</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="n">cache_entry</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">_entity_cache</span><span class="p">[(</span><span class="n">repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">)]</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="c1"># cache_entry now: (cascade, parent_id, {resource: shard_count})</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="k">assert</span> <span class="n">cache_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -k "test_entity_cache_stores_shard_count" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Update entity cache structure</strong></p>
<p>Change <code>_entity_cache</code> type from <code>dict[tuple, tuple[bool, str | None]]</code> to <code>dict[tuple, tuple[bool, str | None, dict[str, int]]]</code> where the third element is <code>{resource: shard_count}</code>.</p>
<p>Update all cache reads/writes in <code>speculative_consume()</code> and <code>_speculative_consume_single()</code>. On cache write, merge new resource shard_count into existing dict (don't replace entire entry).</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span>tests/unit/test_repository.py
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(repository): extend entity cache with shard_count per resource&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-7-add-shard-selection-to-speculative_consume">Task 7: Add shard selection to speculative_consume<a class="headerlink" href="#task-7-add-shard-selection-to-speculative_consume" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py:2102-2159</code> (speculative_consume)
- Test: <code>tests/unit/test_repository.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_consume_routes_to_random_shard</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">):</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;With cached shard_count &gt; 1, speculative_consume routes to a random shard.&quot;&quot;&quot;</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">make_repo</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">)</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="c1"># Pre-populate entity cache with shard_count=2</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="n">repo</span><span class="o">.</span><span class="n">_entity_cache</span><span class="p">[(</span><span class="n">repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="c1"># Create buckets at shard 0 and shard 1</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    <span class="c1"># ...</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>    <span class="n">shard_ids_hit</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>            <span class="n">shard_ids_hit</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shard_id</span><span class="p">)</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shard_ids_hit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># both shards hit</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -k "test_speculative_consume_routes_to_random_shard" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Add shard selection logic to speculative_consume</strong></p>
<p>In <code>speculative_consume()</code> before calling <code>_speculative_consume_single()</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1"># Determine shard from entity cache</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="n">shard_count</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="k">if</span> <span class="n">cache_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">shard_counts</span> <span class="o">=</span> <span class="n">cache_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># {resource: shard_count}</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="n">shard_count</span> <span class="o">=</span> <span class="n">shard_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="n">shard_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">shard_count</span><span class="p">)</span> <span class="k">if</span> <span class="n">shard_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
</span></code></pre></div>
<p>Pass <code>shard_id</code> to <code>_speculative_consume_single()</code>. Add <code>shard_id</code> to <code>SpeculativeResult</code>.</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span>tests/unit/test_repository.py
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(repository): add random shard selection to speculative_consume&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-4-shard-retry-and-doubling">Phase 4: Shard Retry and Doubling<a class="headerlink" href="#phase-4-shard-retry-and-doubling" title="Permanent link">&para;</a></h2>
<h3 id="task-8-add-shard-retry-on-application-limit-exhaustion">Task 8: Add shard retry on application limit exhaustion<a class="headerlink" href="#task-8-add-shard-retry-on-application-limit-exhaustion" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/limiter.py</code> (acquire flow)
- Test: <code>tests/unit/test_limiter.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_acquire_retries_on_another_shard</span><span class="p">(</span><span class="n">mock_limiter</span><span class="p">):</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;When one shard&#39;s app limit is exhausted, retry on another shard.&quot;&quot;&quot;</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="c1"># Setup: entity with 2 shards, shard 0 at 0 rpm tokens, shard 1 at full</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="c1"># ...</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="n">rpm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">lease</span><span class="p">:</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>        <span class="k">pass</span>  <span class="c1"># Should succeed via shard 1 after shard 0 fails</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limiter.py -k "test_acquire_retries_on_another_shard" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Add retry logic</strong></p>
<p>In the acquire flow, when speculative_consume returns failure:
1. Inspect old_buckets to determine failure cause
2. If <code>wcu</code> exhausted  trigger doubling (Task 9)
3. If app limit exhausted but <code>wcu</code> has tokens  retry on different shard (up to 2 retries)
4. Track tried shard IDs to avoid repeats</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">MAX_SHARD_RETRIES</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">tried_shards</span> <span class="o">=</span> <span class="p">{</span><span class="n">result</span><span class="o">.</span><span class="n">shard_id</span><span class="p">}</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_SHARD_RETRIES</span><span class="p">):</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="k">if</span> <span class="n">_is_wcu_exhausted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">old_buckets</span><span class="p">):</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>        <span class="k">break</span>  <span class="c1"># trigger doubling instead</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="c1"># Pick a new shard not yet tried</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="n">new_shard</span> <span class="o">=</span> <span class="n">_pick_untried_shard</span><span class="p">(</span><span class="n">shard_count</span><span class="p">,</span> <span class="n">tried_shards</span><span class="p">)</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    <span class="k">if</span> <span class="n">new_shard</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>        <span class="k">break</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>    <span class="n">tried_shards</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_shard</span><span class="p">)</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repository</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">consume</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="n">new_shard</span><span class="p">,</span> <span class="o">...</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="p">)</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>        <span class="k">return</span> <span class="n">result</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limiter.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/limiter.py<span class="w"> </span>tests/unit/test_limiter.py
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(limiter): add shard retry on application limit exhaustion&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-9-add-shard-doubling-on-wcu-exhaustion">Task 9: Add shard doubling on wcu exhaustion<a class="headerlink" href="#task-9-add-shard-doubling-on-wcu-exhaustion" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py</code> (add <code>bump_shard_count</code> method)
- Modify: <code>src/zae_limiter/limiter.py</code> (trigger doubling in acquire flow)
- Test: <code>tests/unit/test_limiter.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_acquire_doubles_shards_on_wcu_exhaustion</span><span class="p">(</span><span class="n">mock_limiter</span><span class="p">):</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;When wcu is exhausted, shard_count doubles and acquire retries.&quot;&quot;&quot;</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="c1"># Setup: entity with shard_count=1, wcu at 0 tokens, rpm has tokens</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>    <span class="c1"># ...</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="n">rpm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">lease</span><span class="p">:</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>        <span class="k">pass</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>    <span class="c1"># Verify shard_count was bumped</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>    <span class="k">assert</span> <span class="n">repo</span><span class="o">.</span><span class="n">_entity_cache</span><span class="p">[(</span><span class="n">ns</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">)][</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limiter.py -k "test_acquire_doubles_shards_on_wcu_exhaustion" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Implement bump_shard_count and doubling trigger</strong></p>
<p>Add <code>bump_shard_count()</code> to repository:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bump_shard_count</span><span class="p">(</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_count</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Double shard_count on shard 0 (conditional write).</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="sd">    Returns the new shard_count, or the current if another client already doubled.</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="n">new_count</span> <span class="o">=</span> <span class="n">current_count</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>            <span class="n">TableName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>            <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>                <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>                <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">sk_state</span><span class="p">()},</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>            <span class="p">},</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>            <span class="n">UpdateExpression</span><span class="o">=</span><span class="s2">&quot;SET shard_count = :new&quot;</span><span class="p">,</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>            <span class="n">ConditionExpression</span><span class="o">=</span><span class="s2">&quot;shard_count = :old&quot;</span><span class="p">,</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>            <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>                <span class="s2">&quot;:old&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_count</span><span class="p">)},</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>                <span class="s2">&quot;:new&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_count</span><span class="p">)},</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>            <span class="p">},</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>        <span class="p">)</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>        <span class="k">return</span> <span class="n">new_count</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>    <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">:</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>            <span class="k">return</span> <span class="n">current_count</span>  <span class="c1"># Another client already doubled</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>        <span class="k">raise</span>
</span></code></pre></div>
<p>In the acquire flow, after detecting <code>wcu</code> exhaustion from speculative failure:
1. Call <code>bump_shard_count(entity_id, resource, current_shard_count)</code>
2. Update entity cache with new shard_count
3. Retry acquire on a new shard (lazy creation via slow path if bucket doesn't exist)</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limiter.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span>src/zae_limiter/limiter.py<span class="w"> </span>tests/unit/test_limiter.py
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(limiter): add shard doubling on wcu exhaustion&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-5-aggregator-updates">Phase 5: Aggregator Updates<a class="headerlink" href="#phase-5-aggregator-updates" title="Permanent link">&para;</a></h2>
<h3 id="task-10-update-_parse_bucket_record-for-new-pk">Task 10: Update _parse_bucket_record for new PK<a class="headerlink" href="#task-10-update-_parse_bucket_record-for-new-pk" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py:258-349</code>
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_parse_bucket_record_new_pk</span><span class="p">():</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parser handles new BUCKET PK scheme.&quot;&quot;&quot;</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>        <span class="n">sk</span><span class="o">=</span><span class="s2">&quot;#STATE&quot;</span><span class="p">,</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">},</span>  <span class="c1"># bucket attributes with b_rpm_tc, b_wcu_tc, shard_count</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">},</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    <span class="p">)</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">_parse_bucket_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">namespace_id</span> <span class="o">==</span> <span class="s2">&quot;ns1&quot;</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">entity_id</span> <span class="o">==</span> <span class="s2">&quot;user-1&quot;</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">resource</span> <span class="o">==</span> <span class="s2">&quot;gpt-4&quot;</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shard_id</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">==</span> <span class="mi">1</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -k "test_parse_bucket_record_new_pk" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Update parser</strong></p>
<p>Modify <code>_parse_bucket_record()</code> to:
1. Check PK starts with <code>{ns}/BUCKET#</code> instead of checking SK for <code>#BUCKET#</code>
2. Parse entity_id, resource, shard_id from PK using <code>schema.parse_bucket_pk()</code>
3. Extract <code>shard_count</code> from NewImage
4. Add <code>shard_id</code> and <code>shard_count</code> to <code>ParsedBucketRecord</code></p>
<p>Update <code>ParsedBucketRecord</code> dataclass to add <code>shard_id: int</code> and <code>shard_count: int</code>.</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(aggregator): update parser for new bucket PK scheme&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-11-update-aggregate_bucket_states-to-key-by-shard">Task 11: Update aggregate_bucket_states to key by shard<a class="headerlink" href="#task-11-update-aggregate_bucket_states-to-key-by-shard" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py:390-447</code>
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_aggregate_bucket_states_keys_by_shard</span><span class="p">():</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Different shards for same (entity, resource) are aggregated separately.&quot;&quot;&quot;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>    <span class="n">records</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>        <span class="n">make_modify_record</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>        <span class="n">make_modify_record</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#1&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">),</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="p">]</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="n">states</span> <span class="o">=</span> <span class="n">aggregate_bucket_states</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -k "test_aggregate_bucket_states_keys_by_shard" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Update aggregate key to include shard_id</strong></p>
<p>Change key from <code>(namespace_id, entity_id, resource)</code> to <code>(namespace_id, entity_id, resource, shard_id)</code>.
Add <code>shard_id</code> and <code>shard_count</code> to <code>BucketRefillState</code>.</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(aggregator): key bucket states by shard_id&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-12-update-try_refill_bucket-for-new-pk-and-effective-limits">Task 12: Update try_refill_bucket for new PK and effective limits<a class="headerlink" href="#task-12-update-try_refill_bucket-for-new-pk-and-effective-limits" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py:450-554</code>
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_try_refill_bucket_new_pk_and_effective_limits</span><span class="p">():</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Refill uses new PK and divides capacity by shard_count.&quot;&quot;&quot;</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">BucketRefillState</span><span class="p">(</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>        <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>        <span class="n">entity_id</span><span class="o">=</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>        <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>        <span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>        <span class="n">shard_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>        <span class="n">rf_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>        <span class="n">limits</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>            <span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="n">LimitRefillInfo</span><span class="p">(</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>                <span class="n">tc_delta</span><span class="o">=</span><span class="mi">5000_000</span><span class="p">,</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>                <span class="n">tk_milli</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>                <span class="n">cp_milli</span><span class="o">=</span><span class="mi">10000_000</span><span class="p">,</span>  <span class="c1"># original capacity 10000</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>                <span class="n">ra_milli</span><span class="o">=</span><span class="mi">10000_000</span><span class="p">,</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>                <span class="n">rp_ms</span><span class="o">=</span><span class="mi">60_000</span><span class="p">,</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>            <span class="p">),</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>        <span class="p">},</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>    <span class="p">)</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a>    <span class="c1"># Effective capacity = 10000/2 = 5000</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_refill_bucket</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">now_ms</span><span class="o">=</span><span class="mi">61_000</span><span class="p">)</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>    <span class="n">call_kwargs</span> <span class="o">=</span> <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a>    <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">][</span><span class="s2">&quot;PK&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>    <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">][</span><span class="s2">&quot;SK&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#STATE&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -k "test_try_refill_bucket_new_pk_and_effective_limits" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Update try_refill_bucket</strong></p>
<ol>
<li>Use <code>schema.pk_bucket(state.namespace_id, state.entity_id, state.resource, state.shard_id)</code> and <code>schema.sk_state()</code> for Key</li>
<li>Compute effective limits: <code>effective_cp = cp_milli // shard_count</code>, <code>effective_ra = ra_milli // shard_count</code></li>
<li>Pass effective values to <code>refill_bucket()</code></li>
</ol>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(aggregator): use new bucket PK and effective limits for refill&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-13-filter-wcu-from-usage-snapshots">Task 13: Filter wcu from usage snapshots<a class="headerlink" href="#task-13-filter-wcu-from-usage-snapshots" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py:353-387</code> (extract_deltas)
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_extract_deltas_filters_wcu</span><span class="p">():</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;wcu limit deltas are excluded from usage snapshots.&quot;&quot;&quot;</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>        <span class="n">sk</span><span class="o">=</span><span class="s2">&quot;#STATE&quot;</span><span class="p">,</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;b_rpm_tc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">},</span> <span class="s2">&quot;b_wcu_tc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;50&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;b_rpm_tc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">},</span> <span class="s2">&quot;b_wcu_tc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>    <span class="p">)</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>    <span class="n">deltas</span> <span class="o">=</span> <span class="n">extract_deltas</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>    <span class="n">limit_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">limit_name</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deltas</span><span class="p">]</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>    <span class="k">assert</span> <span class="s2">&quot;rpm&quot;</span> <span class="ow">in</span> <span class="n">limit_names</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>    <span class="k">assert</span> <span class="s2">&quot;wcu&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limit_names</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -k "test_extract_deltas_filters_wcu" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Add filter in extract_deltas</strong></p>
<p>After parsing limits, skip <code>wcu</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">for</span> <span class="n">limit_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>    <span class="k">if</span> <span class="n">limit_name</span> <span class="o">==</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_LIMIT_NAME</span><span class="p">:</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>        <span class="k">continue</span>  <span class="c1"># Internal infrastructure limit, not for usage snapshots</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>    <span class="o">...</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(aggregator): filter wcu from usage snapshot deltas&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-14-add-aggregator-proactive-sharding">Task 14: Add aggregator proactive sharding<a class="headerlink" href="#task-14-add-aggregator-proactive-sharding" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py</code> (add <code>try_proactive_shard</code> function, call from <code>process_stream_records</code>)
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">WCU_PROACTIVE_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># 80% of capacity</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_try_proactive_shard_triggers_at_threshold</span><span class="p">():</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;When wcu tc_delta &gt;= 80% of capacity, aggregator bumps shard_count.&quot;&quot;&quot;</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">BucketRefillState</span><span class="p">(</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>        <span class="n">namespace_id</span><span class="o">=</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>        <span class="n">entity_id</span><span class="o">=</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>        <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>        <span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>        <span class="n">shard_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>        <span class="n">rf_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>        <span class="n">limits</span><span class="o">=</span><span class="p">{},</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>    <span class="p">)</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>    <span class="n">wcu_tc_delta</span> <span class="o">=</span> <span class="mi">900_000</span>  <span class="c1"># 900 tokens consumed (90% &gt; 80% threshold)</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>    <span class="n">wcu_capacity_milli</span> <span class="o">=</span> <span class="mi">1000_000</span>  <span class="c1"># 1000 tokens</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tc_delta</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>    <span class="c1"># Verify shard_count bumped on shard 0</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a>    <span class="n">call_kwargs</span> <span class="o">=</span> <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>    <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">][</span><span class="s2">&quot;PK&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>    <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="s2">&quot;ExpressionAttributeValues&quot;</span><span class="p">][</span><span class="s2">&quot;:new&quot;</span><span class="p">][</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a>    <span class="k">assert</span> <span class="n">call_kwargs</span><span class="p">[</span><span class="s2">&quot;ConditionExpression&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;shard_count = :old&quot;</span>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_try_proactive_shard_skips_below_threshold</span><span class="p">():</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Below threshold, no sharding.&quot;&quot;&quot;</span>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28" href="#__codelineno-36-28"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">BucketRefillState</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29" href="#__codelineno-36-29"></a>    <span class="n">wcu_tc_delta</span> <span class="o">=</span> <span class="mi">500_000</span>  <span class="c1"># 50% &lt; 80%</span>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30" href="#__codelineno-36-30"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tc_delta</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31" href="#__codelineno-36-31"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
</span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32" href="#__codelineno-36-32"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33" href="#__codelineno-36-33"></a>
</span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34" href="#__codelineno-36-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_try_proactive_shard_skips_non_shard_0</span><span class="p">():</span>
</span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35" href="#__codelineno-36-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Only shard 0 can be bumped.&quot;&quot;&quot;</span>
</span><span id="__span-36-36"><a id="__codelineno-36-36" name="__codelineno-36-36" href="#__codelineno-36-36"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">BucketRefillState</span><span class="p">(</span>
</span><span id="__span-36-37"><a id="__codelineno-36-37" name="__codelineno-36-37" href="#__codelineno-36-37"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shard_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span>
</span><span id="__span-36-38"><a id="__codelineno-36-38" name="__codelineno-36-38" href="#__codelineno-36-38"></a>    <span class="p">)</span>
</span><span id="__span-36-39"><a id="__codelineno-36-39" name="__codelineno-36-39" href="#__codelineno-36-39"></a>    <span class="n">wcu_tc_delta</span> <span class="o">=</span> <span class="mi">900_000</span>
</span><span id="__span-36-40"><a id="__codelineno-36-40" name="__codelineno-36-40" href="#__codelineno-36-40"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tc_delta</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span><span id="__span-36-41"><a id="__codelineno-36-41" name="__codelineno-36-41" href="#__codelineno-36-41"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
</span><span id="__span-36-42"><a id="__codelineno-36-42" name="__codelineno-36-42" href="#__codelineno-36-42"></a>
</span><span id="__span-36-43"><a id="__codelineno-36-43" name="__codelineno-36-43" href="#__codelineno-36-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_try_proactive_shard_conditional_check_failure</span><span class="p">():</span>
</span><span id="__span-36-44"><a id="__codelineno-36-44" name="__codelineno-36-44" href="#__codelineno-36-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;If another writer already bumped, silently skip.&quot;&quot;&quot;</span>
</span><span id="__span-36-45"><a id="__codelineno-36-45" name="__codelineno-36-45" href="#__codelineno-36-45"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ClientError</span><span class="p">(</span>
</span><span id="__span-36-46"><a id="__codelineno-36-46" name="__codelineno-36-46" href="#__codelineno-36-46"></a>        <span class="p">{</span><span class="s2">&quot;Error&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Code&quot;</span><span class="p">:</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">}},</span> <span class="s2">&quot;UpdateItem&quot;</span>
</span><span id="__span-36-47"><a id="__codelineno-36-47" name="__codelineno-36-47" href="#__codelineno-36-47"></a>    <span class="p">)</span>
</span><span id="__span-36-48"><a id="__codelineno-36-48" name="__codelineno-36-48" href="#__codelineno-36-48"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">900_000</span><span class="p">,</span> <span class="mi">1000_000</span><span class="p">)</span>
</span><span id="__span-36-49"><a id="__codelineno-36-49" name="__codelineno-36-49" href="#__codelineno-36-49"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>  <span class="c1"># Skipped, not raised</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -k "test_try_proactive_shard" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Implement try_proactive_shard</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">WCU_PROACTIVE_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># Shard when wcu consumption &gt;= 80% of capacity</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">try_proactive_shard</span><span class="p">(</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">BucketRefillState</span><span class="p">,</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>    <span class="n">wcu_tc_delta</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>    <span class="n">wcu_capacity_milli</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Proactively double shard_count when wcu consumption approaches capacity.</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="sd">    Only acts on shard 0 (source of truth for shard_count).</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="sd">    Uses conditional write to prevent double-bumping.</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="sd">    Args:</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="sd">        table: boto3 Table resource</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="sd">        state: Aggregated bucket state</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="sd">        wcu_tc_delta: Accumulated wcu tc_delta in this batch (millitokens)</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="sd">        wcu_capacity_milli: wcu capacity in millitokens</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a><span class="sd">    Returns:</span>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="sd">        True if shard_count was bumped, False otherwise</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a>    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">shard_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a>
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a>    <span class="k">if</span> <span class="n">wcu_capacity_milli</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-37-27"><a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-37-28"><a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a>
</span><span id="__span-37-29"><a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a>    <span class="n">consumption_ratio</span> <span class="o">=</span> <span class="n">wcu_tc_delta</span> <span class="o">/</span> <span class="n">wcu_capacity_milli</span>
</span><span id="__span-37-30"><a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a>    <span class="k">if</span> <span class="n">consumption_ratio</span> <span class="o">&lt;</span> <span class="n">WCU_PROACTIVE_THRESHOLD</span><span class="p">:</span>
</span><span id="__span-37-31"><a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-37-32"><a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a>
</span><span id="__span-37-33"><a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a>    <span class="n">new_count</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="__span-37-34"><a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a>
</span><span id="__span-37-35"><a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-37-36"><a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a>        <span class="n">table</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
</span><span id="__span-37-37"><a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a>            <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-37-38"><a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a>                <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="n">pk_bucket</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="__span-37-39"><a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a>                <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="n">sk_state</span><span class="p">(),</span>
</span><span id="__span-37-40"><a id="__codelineno-37-40" name="__codelineno-37-40" href="#__codelineno-37-40"></a>            <span class="p">},</span>
</span><span id="__span-37-41"><a id="__codelineno-37-41" name="__codelineno-37-41" href="#__codelineno-37-41"></a>            <span class="n">UpdateExpression</span><span class="o">=</span><span class="s2">&quot;SET shard_count = :new&quot;</span><span class="p">,</span>
</span><span id="__span-37-42"><a id="__codelineno-37-42" name="__codelineno-37-42" href="#__codelineno-37-42"></a>            <span class="n">ConditionExpression</span><span class="o">=</span><span class="s2">&quot;shard_count = :old&quot;</span><span class="p">,</span>
</span><span id="__span-37-43"><a id="__codelineno-37-43" name="__codelineno-37-43" href="#__codelineno-37-43"></a>            <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-37-44"><a id="__codelineno-37-44" name="__codelineno-37-44" href="#__codelineno-37-44"></a>                <span class="s2">&quot;:old&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">shard_count</span><span class="p">,</span>
</span><span id="__span-37-45"><a id="__codelineno-37-45" name="__codelineno-37-45" href="#__codelineno-37-45"></a>                <span class="s2">&quot;:new&quot;</span><span class="p">:</span> <span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-37-46"><a id="__codelineno-37-46" name="__codelineno-37-46" href="#__codelineno-37-46"></a>            <span class="p">},</span>
</span><span id="__span-37-47"><a id="__codelineno-37-47" name="__codelineno-37-47" href="#__codelineno-37-47"></a>        <span class="p">)</span>
</span><span id="__span-37-48"><a id="__codelineno-37-48" name="__codelineno-37-48" href="#__codelineno-37-48"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-37-49"><a id="__codelineno-37-49" name="__codelineno-37-49" href="#__codelineno-37-49"></a>            <span class="s2">&quot;Proactive shard doubling&quot;</span><span class="p">,</span>
</span><span id="__span-37-50"><a id="__codelineno-37-50" name="__codelineno-37-50" href="#__codelineno-37-50"></a>            <span class="n">entity_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-37-51"><a id="__codelineno-37-51" name="__codelineno-37-51" href="#__codelineno-37-51"></a>            <span class="n">resource</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-37-52"><a id="__codelineno-37-52" name="__codelineno-37-52" href="#__codelineno-37-52"></a>            <span class="n">old_count</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">shard_count</span><span class="p">,</span>
</span><span id="__span-37-53"><a id="__codelineno-37-53" name="__codelineno-37-53" href="#__codelineno-37-53"></a>            <span class="n">new_count</span><span class="o">=</span><span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-37-54"><a id="__codelineno-37-54" name="__codelineno-37-54" href="#__codelineno-37-54"></a>            <span class="n">consumption_ratio</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">consumption_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="__span-37-55"><a id="__codelineno-37-55" name="__codelineno-37-55" href="#__codelineno-37-55"></a>        <span class="p">)</span>
</span><span id="__span-37-56"><a id="__codelineno-37-56" name="__codelineno-37-56" href="#__codelineno-37-56"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-37-57"><a id="__codelineno-37-57" name="__codelineno-37-57" href="#__codelineno-37-57"></a>    <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-37-58"><a id="__codelineno-37-58" name="__codelineno-37-58" href="#__codelineno-37-58"></a>        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">:</span>
</span><span id="__span-37-59"><a id="__codelineno-37-59" name="__codelineno-37-59" href="#__codelineno-37-59"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="__span-37-60"><a id="__codelineno-37-60" name="__codelineno-37-60" href="#__codelineno-37-60"></a>                <span class="s2">&quot;Proactive shard skipped - concurrent bump&quot;</span><span class="p">,</span>
</span><span id="__span-37-61"><a id="__codelineno-37-61" name="__codelineno-37-61" href="#__codelineno-37-61"></a>                <span class="n">entity_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-37-62"><a id="__codelineno-37-62" name="__codelineno-37-62" href="#__codelineno-37-62"></a>                <span class="n">resource</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-37-63"><a id="__codelineno-37-63" name="__codelineno-37-63" href="#__codelineno-37-63"></a>            <span class="p">)</span>
</span><span id="__span-37-64"><a id="__codelineno-37-64" name="__codelineno-37-64" href="#__codelineno-37-64"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-37-65"><a id="__codelineno-37-65" name="__codelineno-37-65" href="#__codelineno-37-65"></a>        <span class="k">raise</span>
</span></code></pre></div>
<p>Call from <code>process_stream_records()</code> after <code>aggregate_bucket_states()</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># Proactive sharding (check wcu consumption per bucket)</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">bucket_states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>    <span class="n">wcu_info</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">WCU_LIMIT_NAME</span><span class="p">)</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    <span class="k">if</span> <span class="n">wcu_info</span><span class="p">:</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>            <span class="n">try_proactive_shard</span><span class="p">(</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>                <span class="n">table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>                <span class="n">wcu_tc_delta</span><span class="o">=</span><span class="n">wcu_info</span><span class="o">.</span><span class="n">tc_delta</span><span class="p">,</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>                <span class="n">wcu_capacity_milli</span><span class="o">=</span><span class="n">wcu_info</span><span class="o">.</span><span class="n">cp_milli</span><span class="p">,</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>            <span class="p">)</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in proactive sharding: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(aggregator): add proactive sharding on high wcu consumption&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-15-add-aggregator-shard_count-propagation">Task 15: Add aggregator shard_count propagation<a class="headerlink" href="#task-15-add-aggregator-shard_count-propagation" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py</code> (add <code>propagate_shard_count</code> function, call from <code>process_stream_records</code>)
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_propagate_shard_count_on_change</span><span class="p">():</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;When shard_count changes in stream record, propagate to other shards.&quot;&quot;&quot;</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>        <span class="n">sk</span><span class="o">=</span><span class="s2">&quot;#STATE&quot;</span><span class="p">,</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>    <span class="p">)</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>    <span class="n">propagated</span> <span class="o">=</span> <span class="n">propagate_shard_count</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>    <span class="k">assert</span> <span class="n">propagated</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># Updated shards 1, 2, 3 (not 0)</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>    <span class="c1"># Verify correct PKs were updated</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>    <span class="n">calls</span> <span class="o">=</span> <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">call_args_list</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>    <span class="n">updated_pks</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">][</span><span class="s2">&quot;PK&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">}</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#1&quot;</span> <span class="ow">in</span> <span class="n">updated_pks</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#2&quot;</span> <span class="ow">in</span> <span class="n">updated_pks</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#3&quot;</span> <span class="ow">in</span> <span class="n">updated_pks</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">updated_pks</span>  <span class="c1"># source, not updated</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_propagate_shard_count_no_change</span><span class="p">():</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;No propagation when shard_count unchanged.&quot;&quot;&quot;</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a>    <span class="p">)</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a>    <span class="n">propagated</span> <span class="o">=</span> <span class="n">propagate_shard_count</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
</span><span id="__span-40-28"><a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a>    <span class="k">assert</span> <span class="n">propagated</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-40-29"><a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</span><span id="__span-40-30"><a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a>
</span><span id="__span-40-31"><a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_propagate_shard_count_conditional_prevents_downgrade</span><span class="p">():</span>
</span><span id="__span-40-32"><a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Conditional write prevents overwriting a higher shard_count.&quot;&quot;&quot;</span>
</span><span id="__span-40-33"><a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a>    <span class="c1"># shard 1 already has shard_count=8, we&#39;re trying to set 4</span>
</span><span id="__span-40-34"><a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ClientError</span><span class="p">(</span>
</span><span id="__span-40-35"><a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a>        <span class="p">{</span><span class="s2">&quot;Error&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Code&quot;</span><span class="p">:</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">}},</span> <span class="s2">&quot;UpdateItem&quot;</span>
</span><span id="__span-40-36"><a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a>    <span class="p">)</span>
</span><span id="__span-40-37"><a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-40-38"><a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-40-39"><a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-40-40"><a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-40-41"><a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a>    <span class="p">)</span>
</span><span id="__span-40-42"><a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a>    <span class="n">propagated</span> <span class="o">=</span> <span class="n">propagate_shard_count</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
</span><span id="__span-40-43"><a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a>    <span class="k">assert</span> <span class="n">propagated</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># All skipped (higher value already present)</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -k "test_propagate_shard_count" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Implement propagate_shard_count</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">propagate_shard_count</span><span class="p">(</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>    <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Propagate shard_count changes to all other shard items.</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="sd">    Detects shard_count change in stream record (OldImage vs NewImage).</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="sd">    Only propagates from shard 0. Uses conditional write to prevent</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="sd">    overwriting a higher shard_count set by another writer.</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="sd">    Args:</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="sd">        table: boto3 Table resource</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="sd">        record: DynamoDB stream record</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="sd">    Returns:</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="sd">        Number of shard items updated</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a>    <span class="n">dynamodb_data</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>    <span class="n">new_image</span> <span class="o">=</span> <span class="n">dynamodb_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NewImage&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a>    <span class="n">old_image</span> <span class="o">=</span> <span class="n">dynamodb_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OldImage&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a>    <span class="n">new_count_raw</span> <span class="o">=</span> <span class="n">new_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shard_count&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a>    <span class="n">old_count_raw</span> <span class="o">=</span> <span class="n">old_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shard_count&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="__span-41-24"><a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_count_raw</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">old_count_raw</span><span class="p">:</span>
</span><span id="__span-41-25"><a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="__span-41-26"><a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a>
</span><span id="__span-41-27"><a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a>    <span class="n">new_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_count_raw</span><span class="p">)</span>
</span><span id="__span-41-28"><a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a>    <span class="n">old_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_count_raw</span><span class="p">)</span>
</span><span id="__span-41-29"><a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a>    <span class="k">if</span> <span class="n">new_count</span> <span class="o">&lt;=</span> <span class="n">old_count</span><span class="p">:</span>
</span><span id="__span-41-30"><a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="__span-41-31"><a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a>
</span><span id="__span-41-32"><a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a>    <span class="n">pk</span> <span class="o">=</span> <span class="n">new_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PK&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-41-33"><a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-41-34"><a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a>        <span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">shard_id</span> <span class="o">=</span> <span class="n">parse_bucket_pk</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
</span><span id="__span-41-35"><a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="__span-41-36"><a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="__span-41-37"><a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a>
</span><span id="__span-41-38"><a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a>    <span class="k">if</span> <span class="n">shard_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-41-39"><a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Only propagate from source of truth</span>
</span><span id="__span-41-40"><a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a>
</span><span id="__span-41-41"><a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a>    <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-41-42"><a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a>    <span class="k">for</span> <span class="n">target_shard</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_count</span><span class="p">):</span>
</span><span id="__span-41-43"><a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-41-44"><a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a>            <span class="n">table</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
</span><span id="__span-41-45"><a id="__codelineno-41-45" name="__codelineno-41-45" href="#__codelineno-41-45"></a>                <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-41-46"><a id="__codelineno-41-46" name="__codelineno-41-46" href="#__codelineno-41-46"></a>                    <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="n">pk_bucket</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">target_shard</span><span class="p">),</span>
</span><span id="__span-41-47"><a id="__codelineno-41-47" name="__codelineno-41-47" href="#__codelineno-41-47"></a>                    <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="n">sk_state</span><span class="p">(),</span>
</span><span id="__span-41-48"><a id="__codelineno-41-48" name="__codelineno-41-48" href="#__codelineno-41-48"></a>                <span class="p">},</span>
</span><span id="__span-41-49"><a id="__codelineno-41-49" name="__codelineno-41-49" href="#__codelineno-41-49"></a>                <span class="n">UpdateExpression</span><span class="o">=</span><span class="s2">&quot;SET shard_count = :new&quot;</span><span class="p">,</span>
</span><span id="__span-41-50"><a id="__codelineno-41-50" name="__codelineno-41-50" href="#__codelineno-41-50"></a>                <span class="n">ConditionExpression</span><span class="o">=</span><span class="s2">&quot;attribute_not_exists(shard_count) OR shard_count &lt; :new&quot;</span><span class="p">,</span>
</span><span id="__span-41-51"><a id="__codelineno-41-51" name="__codelineno-41-51" href="#__codelineno-41-51"></a>                <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-41-52"><a id="__codelineno-41-52" name="__codelineno-41-52" href="#__codelineno-41-52"></a>                    <span class="s2">&quot;:new&quot;</span><span class="p">:</span> <span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-41-53"><a id="__codelineno-41-53" name="__codelineno-41-53" href="#__codelineno-41-53"></a>                <span class="p">},</span>
</span><span id="__span-41-54"><a id="__codelineno-41-54" name="__codelineno-41-54" href="#__codelineno-41-54"></a>            <span class="p">)</span>
</span><span id="__span-41-55"><a id="__codelineno-41-55" name="__codelineno-41-55" href="#__codelineno-41-55"></a>            <span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-41-56"><a id="__codelineno-41-56" name="__codelineno-41-56" href="#__codelineno-41-56"></a>        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-41-57"><a id="__codelineno-41-57" name="__codelineno-41-57" href="#__codelineno-41-57"></a>            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">:</span>
</span><span id="__span-41-58"><a id="__codelineno-41-58" name="__codelineno-41-58" href="#__codelineno-41-58"></a>                <span class="k">continue</span>  <span class="c1"># Higher value already present</span>
</span><span id="__span-41-59"><a id="__codelineno-41-59" name="__codelineno-41-59" href="#__codelineno-41-59"></a>            <span class="k">raise</span>
</span><span id="__span-41-60"><a id="__codelineno-41-60" name="__codelineno-41-60" href="#__codelineno-41-60"></a>
</span><span id="__span-41-61"><a id="__codelineno-41-61" name="__codelineno-41-61" href="#__codelineno-41-61"></a>    <span class="k">if</span> <span class="n">updated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-41-62"><a id="__codelineno-41-62" name="__codelineno-41-62" href="#__codelineno-41-62"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-41-63"><a id="__codelineno-41-63" name="__codelineno-41-63" href="#__codelineno-41-63"></a>            <span class="s2">&quot;Shard count propagated&quot;</span><span class="p">,</span>
</span><span id="__span-41-64"><a id="__codelineno-41-64" name="__codelineno-41-64" href="#__codelineno-41-64"></a>            <span class="n">entity_id</span><span class="o">=</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-41-65"><a id="__codelineno-41-65" name="__codelineno-41-65" href="#__codelineno-41-65"></a>            <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-41-66"><a id="__codelineno-41-66" name="__codelineno-41-66" href="#__codelineno-41-66"></a>            <span class="n">new_count</span><span class="o">=</span><span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-41-67"><a id="__codelineno-41-67" name="__codelineno-41-67" href="#__codelineno-41-67"></a>            <span class="n">shards_updated</span><span class="o">=</span><span class="n">updated</span><span class="p">,</span>
</span><span id="__span-41-68"><a id="__codelineno-41-68" name="__codelineno-41-68" href="#__codelineno-41-68"></a>        <span class="p">)</span>
</span><span id="__span-41-69"><a id="__codelineno-41-69" name="__codelineno-41-69" href="#__codelineno-41-69"></a>    <span class="k">return</span> <span class="n">updated</span>
</span></code></pre></div>
<p>Call from <code>process_stream_records()</code> at the end of record processing:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1"># Propagate shard_count changes to other shards</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eventName&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;MODIFY&quot;</span><span class="p">:</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>        <span class="k">continue</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>        <span class="n">propagate_shard_count</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error propagating shard_count: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(aggregator): add shard_count propagation on change detection&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-6-bucket-discovery-and-reads">Phase 6: Bucket Discovery and Reads<a class="headerlink" href="#phase-6-bucket-discovery-and-reads" title="Permanent link">&para;</a></h2>
<h3 id="task-16-add-bucket-discovery-via-gsi3">Task 16: Add bucket discovery via GSI3<a class="headerlink" href="#task-16-add-bucket-discovery-via-gsi3" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py</code> (update <code>get_buckets</code> to use GSI3 + BatchGetItem)
- Test: <code>tests/unit/test_repository.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_buckets_uses_gsi3</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">):</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get_buckets queries GSI3 for bucket PKs then BatchGetItem.&quot;&quot;&quot;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">make_repo</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">)</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>    <span class="c1"># Create buckets at new PKs for 2 resources</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>    <span class="c1"># ...</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>    <span class="n">buckets</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_buckets</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">)</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">buckets</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>    <span class="n">resources</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="o">.</span><span class="n">resource</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">}</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>    <span class="k">assert</span> <span class="s2">&quot;gpt-4&quot;</span> <span class="ow">in</span> <span class="n">resources</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>    <span class="k">assert</span> <span class="s2">&quot;gpt-3.5&quot;</span> <span class="ow">in</span> <span class="n">resources</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -k "test_get_buckets_uses_gsi3" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Implement GSI3 bucket discovery</strong></p>
<p>Update <code>get_buckets()</code> to:
1. Query GSI3 with <code>GSI3PK={ns}/ENTITY#{entity_id}</code>
2. Extract PK/SK from the KEYS_ONLY response
3. BatchGetItem to fetch full bucket items
4. Deserialize and return</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span>tests/unit/test_repository.py
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(repository): add GSI3 bucket discovery with BatchGetItem&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-7-hide-wcu-from-user-facing-output">Phase 7: Hide wcu from User-Facing Output<a class="headerlink" href="#phase-7-hide-wcu-from-user-facing-output" title="Permanent link">&para;</a></h2>
<h3 id="task-17-filter-wcu-from-ratelimitexceeded-and-get_status">Task 17: Filter wcu from RateLimitExceeded and get_status<a class="headerlink" href="#task-17-filter-wcu-from-ratelimitexceeded-and-get_status" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/limiter.py</code> (filter wcu from LimitStatus lists)
- Test: <code>tests/unit/test_limiter.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limit_exceeded_hides_wcu</span><span class="p">(</span><span class="n">mock_limiter</span><span class="p">):</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;wcu violations never appear in RateLimitExceeded.&quot;&quot;&quot;</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="c1"># Setup: entity where only wcu is exhausted but rpm has tokens</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>    <span class="c1"># This should trigger doubling, not raise with wcu violation</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_status_hides_wcu</span><span class="p">(</span><span class="n">mock_limiter</span><span class="p">):</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;get_status omits wcu from returned limit statuses.&quot;&quot;&quot;</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>    <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">limiter</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>    <span class="n">limit_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ls</span><span class="o">.</span><span class="n">limit_name</span> <span class="k">for</span> <span class="n">ls</span> <span class="ow">in</span> <span class="n">status</span><span class="p">]</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>    <span class="k">assert</span> <span class="s2">&quot;wcu&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">limit_names</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limiter.py -k "test_rate_limit_exceeded_hides_wcu or test_get_status_hides_wcu" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Add filtering</strong></p>
<p>In the limiter, filter <code>wcu</code> from any list of <code>LimitStatus</code> before returning to user or building <code>RateLimitExceeded</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">statuses</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">statuses</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">limit_name</span> <span class="o">!=</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_LIMIT_NAME</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limiter.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/limiter.py<span class="w"> </span>tests/unit/test_limiter.py
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(limiter): hide wcu infrastructure limit from user-facing output&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-8-sync-code-generation">Phase 8: Sync Code Generation<a class="headerlink" href="#phase-8-sync-code-generation" title="Permanent link">&para;</a></h2>
<h3 id="task-18-generate-sync-code-and-verify">Task 18: Generate sync code and verify<a class="headerlink" href="#task-18-generate-sync-code-and-verify" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Generated: All <code>sync_*.py</code> files (see CLAUDE.md for list)
- Test: Generated test files</p>
<p><strong>Step 1: Run sync code generation</strong></p>
<p>Run: <code>hatch run generate-sync</code></p>
<p><strong>Step 2: Run sync tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_sync_repository.py tests/unit/test_sync_limiter.py -v</code>
Expected: PASS</p>
<p><strong>Step 3: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/sync_*.py<span class="w"> </span>tests/unit/test_sync_*.py
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;chore: regenerate sync code for pre-shard bucket changes&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="phase-9-integration-and-migration">Phase 9: Integration and Migration<a class="headerlink" href="#phase-9-integration-and-migration" title="Permanent link">&para;</a></h2>
<h3 id="task-19-update-cloudformation-template-if-needed">Task 19: Update CloudFormation template (if needed)<a class="headerlink" href="#task-19-update-cloudformation-template-if-needed" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Check: <code>src/zae_limiter/infra/cfn_template.yaml</code></p>
<p><strong>Step 1: Verify GSI3 definition</strong></p>
<p>GSI3 already exists in the template. Verify it's KEYS_ONLY projection. No changes expected since bucket items opt-in to GSI3 by setting GSI3PK/GSI3SK attributes.</p>
<p><strong>Step 2: Commit if changes needed</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/infra/cfn_template.yaml
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;chore(infra): verify GSI3 supports bucket discovery&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-20-schema-version-bump">Task 20: Schema version bump<a class="headerlink" href="#task-20-schema-version-bump" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/version.py</code> (bump schema version)
- Modify: <code>src/zae_limiter/migrations/__init__.py</code> (add migration entry)
- Test: <code>tests/unit/test_version.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_schema_version_bumped</span><span class="p">():</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Schema version reflects bucket PK change.&quot;&quot;&quot;</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="k">assert</span> <span class="n">version</span><span class="o">.</span><span class="n">SCHEMA_VERSION</span> <span class="o">&gt;=</span> <span class="n">NEW_VERSION</span>
</span></code></pre></div>
<p><strong>Step 2: Bump version and add migration</strong></p>
<p>The migration is a clean break  new code creates buckets at new PKs on first access. Old bucket items are ignored. Add a migration entry that documents this.</p>
<p><strong>Step 3: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/ -v</code>
Expected: PASS</p>
<p><strong>Step 4: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/version.py<span class="w"> </span>src/zae_limiter/migrations/
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat(schema): bump version for bucket PK migration&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-21-integration-test-with-localstack">Task 21: Integration test with LocalStack<a class="headerlink" href="#task-21-integration-test-with-localstack" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Create: <code>tests/integration/test_bucket_sharding.py</code></p>
<p><strong>Step 1: Write integration test</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestBucketSharding</span><span class="p">:</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_acquire_creates_bucket_at_new_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;First acquire creates bucket at BUCKET# PK.&quot;&quot;&quot;</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_sharded_acquire_distributes_across_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;With shard_count=2, acquires hit both shards.&quot;&quot;&quot;</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_wcu_exhaustion_triggers_doubling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;When wcu is exhausted, shard_count doubles.&quot;&quot;&quot;</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_shard_retry_on_drained_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retry on another shard when one is drained.&quot;&quot;&quot;</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_get_buckets_aggregates_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;get_buckets returns aggregated view across shards.&quot;&quot;&quot;</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_aggregator_proactive_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregator detects high wcu and proactively shards.&quot;&quot;&quot;</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_aggregator_propagates_shard_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_repo</span><span class="p">):</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregator propagates shard_count changes to all shards.&quot;&quot;&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run with LocalStack</strong></p>
<p>Run: <code>uv run pytest tests/integration/test_bucket_sharding.py -v</code>
Expected: PASS</p>
<p><strong>Step 3: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>git<span class="w"> </span>add<span class="w"> </span>tests/integration/test_bucket_sharding.py
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;test(integration): add bucket sharding integration tests&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-22-update-claudemd">Task 22: Update CLAUDE.md<a class="headerlink" href="#task-22-update-claudemd" title="Permanent link">&para;</a></h3>
<p><strong>Files:</strong>
- Modify: <code>CLAUDE.md</code></p>
<p>Update the DynamoDB Access Patterns table, bucket schema documentation, entity cache structure, speculative write pattern documentation, and aggregator responsibilities to reflect the new bucket PK scheme, wcu limit, proactive sharding, and shard_count propagation.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>git<span class="w"> </span>add<span class="w"> </span>CLAUDE.md
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;docs: update CLAUDE.md for pre-shard bucket PK scheme&quot;</span>
</span></code></pre></div>
<hr />
<h2 id="task-dependency-graph">Task Dependency Graph<a class="headerlink" href="#task-dependency-graph" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>Phase 1: Schema Foundation
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>  Task 1 (PK builders) 
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>  Task 2 (reserved names)  Phase 2: Bucket Creation
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>  Task 3 (WCU constants) 
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>                              Task 4 (build_composite_create) 
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>                              Task 5 (speculative_consume) 
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>                                                                
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>Phase 3: Shard Selection                                        
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>  Task 6 (entity cache)  Task 7 (shard selection) 
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>                                                                
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>Phase 4: Retry &amp; Doubling                                       
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>  Task 8 (shard retry)  Task 9 (doubling) 
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>                                                                
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>Phase 5: Aggregator                                             
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>  Task 10 (parser)  Task 11 (aggregate key)  Task 12 (refill)
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>  Task 13 (wcu filter)                                          
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>  Task 14 (proactive sharding)  Task 15 (shard propagation) 
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>                                                                
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>Phase 6: Discovery                                              
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>  Task 16 (GSI3 discovery) 
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>                                                                
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a>Phase 7: User-facing                                            
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a>  Task 17 (hide wcu) 
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a>                                                                
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>Phase 8: Sync                                                   
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a>  Task 18 (generate sync)  depends on all source changes 
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a>                                                                
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a>Phase 9: Integration                                            
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a>  Task 19 (CFN)  Task 20 (version)  Task 21 (integration)  Task 22 (docs)
</span></code></pre></div>
<hr />
<h2 id="phase-10-design-review-fixes">Phase 10: Design Review Fixes<a class="headerlink" href="#phase-10-design-review-fixes" title="Permanent link">&para;</a></h2>
<p>Review: https://github.com/zeroae/zae-limiter-ghsa-76rv-2r9v-c5m6/pull/1#pullrequestreview-3838469366</p>
<h3 id="task-32-add-speculativefailurereason-enum">Task 32: Add SpeculativeFailureReason enum<a class="headerlink" href="#task-32-add-speculativefailurereason-enum" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> On speculative failure, the limiter inspects <code>old_buckets</code> token values via <code>_is_wcu_exhausted()</code> to distinguish between app-limit exhaustion (retry on another shard) vs wcu exhaustion (double shards). This is implicit and fragile  the decision logic is spread across the limiter with no structured failure classification.</p>
<p><strong>Fix:</strong> Add a <code>SpeculativeFailureReason</code> enum to <code>repository_protocol.py</code> and populate it in <code>_speculative_consume_single()</code> when constructing the failure <code>SpeculativeResult</code>. Replace <code>_is_wcu_exhausted()</code> in the limiter with a match on <code>result.failure_reason</code>.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository_protocol.py</code> (add enum, add field to <code>SpeculativeResult</code>)
- Modify: <code>src/zae_limiter/repository.py:2402-2415</code> (set <code>failure_reason</code> on failure results)
- Modify: <code>src/zae_limiter/limiter.py:732-752</code> (replace <code>_is_wcu_exhausted</code> with <code>result.failure_reason</code>)
- Modify: <code>src/zae_limiter/limiter.py:1007-1026</code> (remove <code>_is_wcu_exhausted</code> method)
- Generate: sync code (<code>hatch run generate-sync</code>)
- Test: <code>tests/unit/test_repository.py</code>, <code>tests/unit/test_limiter.py</code></p>
<p><strong>Step 1: Write failing tests</strong></p>
<p>In <code>tests/unit/test_repository.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zae_limiter.repository_protocol</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpeculativeFailureReason</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_failure_reason_wcu_exhausted</span><span class="p">():</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Failure reason is WCU_EXHAUSTED when wcu tokens &lt; 1000 milli.&quot;&quot;&quot;</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="c1"># Setup: bucket with wcu at 0, rpm has tokens</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="n">entity_id</span><span class="o">=</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="n">consume</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">WCU_EXHAUSTED</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_failure_reason_app_limit_exhausted</span><span class="p">():</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Failure reason is APP_LIMIT_EXHAUSTED when user limit exhausted but wcu has tokens.&quot;&quot;&quot;</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>    <span class="c1"># Setup: bucket with rpm at 0, wcu full</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="n">entity_id</span><span class="o">=</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="n">consume</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">APP_LIMIT_EXHAUSTED</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_failure_reason_bucket_missing</span><span class="p">():</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Failure reason is BUCKET_MISSING when no bucket exists.&quot;&quot;&quot;</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="n">entity_id</span><span class="o">=</span><span class="s2">&quot;no-bucket&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="n">consume</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">BUCKET_MISSING</span>
</span></code></pre></div>
<p>In <code>tests/unit/test_limiter.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_wcu_exhausted_triggers_doubling_via_failure_reason</span><span class="p">():</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Limiter uses failure_reason instead of inspecting old_buckets.&quot;&quot;&quot;</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>    <span class="c1"># Setup: mock speculative result with failure_reason=WCU_EXHAUSTED</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    <span class="c1"># Verify bump_shard_count is called</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -k "test_speculative_failure_reason" -v</code>
Expected: FAIL with <code>ImportError: cannot import name 'SpeculativeFailureReason'</code></p>
<p><strong>Step 3: Add SpeculativeFailureReason enum</strong></p>
<p>In <code>repository_protocol.py</code> before <code>SpeculativeResult</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">SpeculativeFailureReason</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Classifies why a speculative write failed (GHSA-76rv).</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="sd">    Used by the limiter to decide the recovery path without</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="sd">    inspecting individual BucketState token values.</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>    <span class="n">APP_LIMIT_EXHAUSTED</span> <span class="o">=</span> <span class="s2">&quot;app_limit_exhausted&quot;</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>    <span class="n">WCU_EXHAUSTED</span> <span class="o">=</span> <span class="s2">&quot;wcu_exhausted&quot;</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>    <span class="n">BOTH_EXHAUSTED</span> <span class="o">=</span> <span class="s2">&quot;both_exhausted&quot;</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>    <span class="n">BUCKET_MISSING</span> <span class="o">=</span> <span class="s2">&quot;bucket_missing&quot;</span>
</span></code></pre></div>
<p>Add field to <code>SpeculativeResult</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>    <span class="n">failure_reason</span><span class="p">:</span> <span class="n">SpeculativeFailureReason</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></code></pre></div>
<p><strong>Step 4: Populate failure_reason in <code>_speculative_consume_single</code></strong></p>
<p>In <code>repository.py:2402-2415</code>, classify the failure:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">if</span> <span class="n">old_item</span><span class="p">:</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    <span class="n">old_buckets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deserialize_composite_bucket</span><span class="p">(</span><span class="n">old_item</span><span class="p">)</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>    <span class="n">old_shard_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shard_count&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="c1"># Classify failure reason</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="n">wcu_exhausted</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>        <span class="n">b</span><span class="o">.</span><span class="n">limit_name</span> <span class="o">==</span> <span class="n">WCU_LIMIT_NAME</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">tokens_milli</span> <span class="o">&lt;</span> <span class="mi">1000</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">old_buckets</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>    <span class="p">)</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>    <span class="n">app_exhausted</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>        <span class="n">b</span><span class="o">.</span><span class="n">limit_name</span> <span class="o">!=</span> <span class="n">WCU_LIMIT_NAME</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>        <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">tokens_milli</span> <span class="o">&lt;</span> <span class="n">consume</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">limit_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">old_buckets</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>    <span class="p">)</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>    <span class="k">if</span> <span class="n">wcu_exhausted</span> <span class="ow">and</span> <span class="n">app_exhausted</span><span class="p">:</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>        <span class="n">reason</span> <span class="o">=</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">BOTH_EXHAUSTED</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>    <span class="k">elif</span> <span class="n">wcu_exhausted</span><span class="p">:</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>        <span class="n">reason</span> <span class="o">=</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">WCU_EXHAUSTED</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>        <span class="n">reason</span> <span class="o">=</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">APP_LIMIT_EXHAUSTED</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>    <span class="k">return</span> <span class="n">SpeculativeResult</span><span class="p">(</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>        <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>        <span class="n">old_buckets</span><span class="o">=</span><span class="n">old_buckets</span><span class="p">,</span>
</span><span id="__span-61-25"><a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>        <span class="n">shard_id</span><span class="o">=</span><span class="n">shard_id</span><span class="p">,</span>
</span><span id="__span-61-26"><a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a>        <span class="n">shard_count</span><span class="o">=</span><span class="n">old_shard_count</span><span class="p">,</span>
</span><span id="__span-61-27"><a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>        <span class="n">failure_reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
</span><span id="__span-61-28"><a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a>    <span class="p">)</span>
</span><span id="__span-61-29"><a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-61-30"><a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>    <span class="k">return</span> <span class="n">SpeculativeResult</span><span class="p">(</span>
</span><span id="__span-61-31"><a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a>        <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-61-32"><a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a>        <span class="n">shard_id</span><span class="o">=</span><span class="n">shard_id</span><span class="p">,</span>
</span><span id="__span-61-33"><a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a>        <span class="n">failure_reason</span><span class="o">=</span><span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">BUCKET_MISSING</span><span class="p">,</span>
</span><span id="__span-61-34"><a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a>    <span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 5: Replace <code>_is_wcu_exhausted</code> in limiter</strong></p>
<p>In <code>limiter.py:732-752</code>, replace:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># Before:</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_wcu_exhausted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">old_buckets</span><span class="p">):</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>    <span class="o">...</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="o">...</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="c1"># After:</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>    <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">WCU_EXHAUSTED</span><span class="p">,</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>    <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">BOTH_EXHAUSTED</span><span class="p">,</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="p">):</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repository</span><span class="o">.</span><span class="n">bump_shard_count</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">shard_count</span><span class="p">)</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>    <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">APP_LIMIT_EXHAUSTED</span><span class="p">:</span>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>    <span class="n">retry_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_on_other_shard</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>    <span class="o">...</span>
</span></code></pre></div>
<p>Remove <code>_is_wcu_exhausted()</code> static method (lines 1007-1026).</p>
<p><strong>Step 6: Generate sync code</strong></p>
<p>Run: <code>hatch run generate-sync</code></p>
<p><strong>Step 7: Run all unit tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/ -v</code>
Expected: PASS</p>
<p><strong>Step 8: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository_protocol.py<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="w">    </span>src/zae_limiter/limiter.py<span class="w"> </span>src/zae_limiter/sync_*.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="w">    </span>tests/unit/test_repository.py<span class="w"> </span>tests/unit/test_limiter.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">    </span>tests/unit/test_sync_*.py
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; refactor(limiter): add SpeculativeFailureReason enum for deterministic shard decisions&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-33-add-high-shard-count-warning">Task 33: Add high shard count warning<a class="headerlink" href="#task-33-add-high-shard-count-warning" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> Shard count doubles without any observability signal. At 32 shards, <code>propagate_shard_count</code> issues 31 sequential DynamoDB writes per Lambda invocation. Operators have no visibility into runaway shard growth.</p>
<p><strong>Fix:</strong> Add <code>WCU_SHARD_WARN_THRESHOLD = 32</code> constant in <code>schema.py</code>. Emit a warning log when doubling crosses the threshold at both doubling sites: <code>Repository.bump_shard_count()</code> (client) and <code>try_proactive_shard()</code> (aggregator). No hard cap  doubling continues.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/schema.py</code> (add <code>WCU_SHARD_WARN_THRESHOLD</code> constant)
- Modify: <code>src/zae_limiter/repository.py:2435</code> (warning after doubling in <code>bump_shard_count</code>)
- Modify: <code>src/zae_limiter_aggregator/processor.py:665</code> (warning after doubling in <code>try_proactive_shard</code>)
- Generate: sync code (<code>hatch run generate-sync</code>)
- Test: <code>tests/unit/test_schema.py</code>, <code>tests/unit/test_repository.py</code>, <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing tests</strong></p>
<p>In <code>tests/unit/test_schema.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_wcu_shard_warn_threshold_constant</span><span class="p">():</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_SHARD_WARN_THRESHOLD</span> <span class="o">==</span> <span class="mi">32</span>
</span></code></pre></div>
<p>In <code>tests/unit/test_repository.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_bump_shard_count_warns_above_threshold</span><span class="p">(</span><span class="n">caplog</span><span class="p">):</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;bump_shard_count logs warning when new count exceeds threshold.&quot;&quot;&quot;</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">make_repo</span><span class="p">(</span><span class="n">mock_dynamodb</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">)</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>    <span class="c1"># Create entity + bucket with shard_count=32 (at threshold)</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>    <span class="c1"># ...</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">bump_shard_count</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">64</span>  <span class="c1"># doubling still happens</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>    <span class="k">assert</span> <span class="s2">&quot;shard count exceeded&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>        <span class="s2">&quot;shard&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;64&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">message</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">records</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>In <code>tests/unit/test_processor.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_try_proactive_shard_warns_above_threshold</span><span class="p">(</span><span class="n">caplog</span><span class="p">):</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Proactive sharding logs warning when new count exceeds threshold.&quot;&quot;&quot;</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">BucketRefillState</span><span class="p">(</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>        <span class="o">...</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shard_count</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="o">...</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>    <span class="p">)</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">900_000</span><span class="p">,</span> <span class="mi">1000_000</span><span class="p">)</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>  <span class="c1"># doubling still happens</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>    <span class="c1"># Verify warning was logged</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py -k "test_wcu_shard_warn" -v</code>
Expected: FAIL with <code>AttributeError</code></p>
<p><strong>Step 3: Add constant to schema.py</strong></p>
<p>After <code>WCU_LIMIT_REFILL_PERIOD_SECONDS</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="n">WCU_SHARD_WARN_THRESHOLD</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># Log warning when shard count exceeds this (GHSA-76rv)</span>
</span></code></pre></div>
<p><strong>Step 4: Add warning in bump_shard_count (repository.py)</strong></p>
<p>After the successful <code>update_item</code> (line ~2451), before updating the cache:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="k">if</span> <span class="n">new_count</span> <span class="o">&gt;</span> <span class="n">schema</span><span class="o">.</span><span class="n">WCU_SHARD_WARN_THRESHOLD</span><span class="p">:</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>        <span class="s2">&quot;High shard count after doubling&quot;</span><span class="p">,</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>        <span class="n">entity_id</span><span class="o">=</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>        <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>        <span class="n">shard_count</span><span class="o">=</span><span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>        <span class="n">threshold</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">WCU_SHARD_WARN_THRESHOLD</span><span class="p">,</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>    <span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 5: Add warning in try_proactive_shard (processor.py)</strong></p>
<p>After the successful <code>table.update_item</code> in the existing <code>logger.info</code> block:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="k">if</span> <span class="n">new_count</span> <span class="o">&gt;</span> <span class="n">WCU_SHARD_WARN_THRESHOLD</span><span class="p">:</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>        <span class="s2">&quot;High shard count after proactive doubling&quot;</span><span class="p">,</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>        <span class="n">entity_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>        <span class="n">resource</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>        <span class="n">shard_count</span><span class="o">=</span><span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>        <span class="n">threshold</span><span class="o">=</span><span class="n">WCU_SHARD_WARN_THRESHOLD</span><span class="p">,</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>Import <code>WCU_SHARD_WARN_THRESHOLD</code> from <code>zae_limiter.schema</code>.</p>
<p><strong>Step 6: Generate sync code</strong></p>
<p>Run: <code>hatch run generate-sync</code></p>
<p><strong>Step 7: Run all unit tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/ -v</code>
Expected: PASS</p>
<p><strong>Step 8: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/schema.py<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="w">    </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>src/zae_limiter/sync_*.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="w">    </span>tests/unit/test_schema.py<span class="w"> </span>tests/unit/test_repository.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="w">    </span>tests/unit/test_processor.py<span class="w"> </span>tests/unit/test_sync_*.py
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; fix(schema): warn when shard count exceeds WCU_SHARD_WARN_THRESHOLD=32&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-34-add-missing-test-coverage-for-review-findings">Task 34: Add missing test coverage for review findings<a class="headerlink" href="#task-34-add-missing-test-coverage-for-review-findings" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> Two test gaps identified in the design review (the third  propagation GSI attributes  is addressed by Task #29 which rewrites propagation with full attributes).</p>
<ol>
<li><strong>PK round-trip with <code>/</code> in resources</strong>  <code>parse_bucket_pk</code> is tested with <code>gpt-4</code> but not with resources containing <code>/</code>, <code>.</code>, <code>-</code>, <code>_</code>. Since resources like <code>openai/gpt-4</code> and <code>anthropic/claude-3/opus</code> are valid (see CLAUDE.md naming rules), the parser must handle <code>#</code>-delimited splitting correctly when the resource contains <code>/</code>.</li>
<li><strong>Batch size boundary condition</strong>  The test for <code>try_proactive_shard</code> passes <code>wcu_tc_delta=900_000</code> directly, but at <code>BatchSize=100</code>, the maximum achievable delta is <code>100 * 1000 = 100_000 milli</code> (100 writes  1 WCU each  1000 milli). A test should document that the threshold is unreachable at the current batch size.</li>
</ol>
<p><strong>Files:</strong>
- Modify: <code>tests/unit/test_schema.py</code> (parametric PK round-trip tests)
- Modify: <code>tests/unit/test_processor.py</code> (batch size boundary test)</p>
<p><strong>Step 1: Add parametric PK round-trip tests</strong></p>
<p>In <code>tests/unit/test_schema.py</code>, add to <code>TestBucketPKBuilders</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>    <span class="s2">&quot;resource&quot;</span><span class="p">,</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>    <span class="p">[</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>        <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>                   <span class="c1"># hyphen</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>        <span class="s2">&quot;gpt_4&quot;</span><span class="p">,</span>                   <span class="c1"># underscore</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>        <span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span>           <span class="c1"># dot</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>        <span class="s2">&quot;openai/gpt-4&quot;</span><span class="p">,</span>            <span class="c1"># slash (provider/model)</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>        <span class="s2">&quot;anthropic/claude-3/opus&quot;</span><span class="p">,</span> <span class="c1"># nested slash</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>    <span class="p">],</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="p">)</span>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_parse_bucket_pk_round_trip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;pk_bucket  parse_bucket_pk round-trips for all valid resource chars.&quot;&quot;&quot;</span>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>    <span class="n">pk</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_bucket</span><span class="p">(</span><span class="s2">&quot;ns1&quot;</span><span class="p">,</span> <span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>    <span class="n">ns</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">shard</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">parse_bucket_pk</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a>    <span class="k">assert</span> <span class="n">ns</span> <span class="o">==</span> <span class="s2">&quot;ns1&quot;</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>    <span class="k">assert</span> <span class="n">entity</span> <span class="o">==</span> <span class="s2">&quot;user-1&quot;</span>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>    <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="n">resource</span>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>    <span class="k">assert</span> <span class="n">shard</span> <span class="o">==</span> <span class="mi">0</span>
</span></code></pre></div>
<p><strong>Step 2: Add batch size boundary test</strong></p>
<p>In <code>tests/unit/test_processor.py</code>, add to <code>TestTryProactiveShard</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_unreachable_at_batch_size_100</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;At BatchSize=100, max wcu tc_delta is 100_000 milli (10% of capacity).</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="sd">    Documents that proactive sharding requires BatchSize &gt;= 800 to trigger</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="sd">    at the 80% threshold (WCU_PROACTIVE_THRESHOLD). With the default</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="sd">    BatchSize=100, the maximum achievable ratio is 100/1000 = 10%.</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="sd">    See Task #28 for the BatchSize fix.</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_state</span><span class="p">()</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>    <span class="c1"># Max possible: 100 records  1 WCU  1000 milli = 100_000</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>    <span class="n">max_tc_delta_at_batch_100</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1000</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>    <span class="n">wcu_capacity_milli</span> <span class="o">=</span> <span class="mi">1000_000</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a>        <span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">max_tc_delta_at_batch_100</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>    <span class="p">)</span>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>
</span><span id="__span-72-19"><a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>  <span class="c1"># 10% &lt; 80% threshold</span>
</span><span id="__span-72-20"><a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</span></code></pre></div>
<p><strong>Step 3: Run tests to verify they pass</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py::TestBucketPKBuilders -v</code>
Run: <code>uv run pytest tests/unit/test_processor.py::TestTryProactiveShard -v</code>
Expected: PASS (these test existing behavior, not new code)</p>
<p><strong>Step 4: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>git<span class="w"> </span>add<span class="w"> </span>tests/unit/test_schema.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; test: add PK round-trip and batch size boundary tests (review #34)&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-31-add-gsi4_sk_bucket-schema-builder">Task 31: Add gsi4_sk_bucket schema builder<a class="headerlink" href="#task-31-add-gsi4_sk_bucket-schema-builder" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> The GSI4SK format <code>BUCKET#{entity_id}#{resource}#{shard_id}</code> is inlined in <code>repository.py:1892</code> and <code>sync_repository.py:1552</code>. All other GSI SK formats have dedicated builders (<code>gsi2_sk_bucket</code>, <code>gsi3_sk_bucket</code>).</p>
<p><strong>Fix:</strong> Add <code>gsi4_sk_bucket(entity_id, resource, shard_id)</code> to <code>schema.py</code>, use it in <code>repository.py</code>, and regenerate sync code.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/schema.py</code> (add builder)
- Modify: <code>src/zae_limiter/repository.py:1891-1893</code> (use builder)
- Generate: sync code (<code>hatch run generate-sync</code>)
- Test: <code>tests/unit/test_schema.py</code></p>
<p><strong>Step 1: Write failing test</strong></p>
<p>In <code>tests/unit/test_schema.py</code>, add to <code>TestBucketPKBuilders</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_gsi4_sk_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi4_sk_bucket</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;BUCKET#user-1#gpt-4#0&quot;</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    <span class="k">assert</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi4_sk_bucket</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;BUCKET#user-1#gpt-4#3&quot;</span>
</span></code></pre></div>
<p><strong>Step 2: Run test to verify it fails</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_schema.py -k "test_gsi4_sk_bucket" -v</code>
Expected: FAIL with <code>AttributeError: module 'zae_limiter.schema' has no attribute 'gsi4_sk_bucket'</code></p>
<p><strong>Step 3: Add builder to schema.py</strong></p>
<p>After <code>gsi3_sk_bucket()</code> (~line 415):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">gsi4_sk_bucket</span><span class="p">(</span><span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build GSI4 sort key for bucket item (namespace-scoped discovery).</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="sd">    Args:</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="sd">        entity_id: Entity owning the bucket</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="sd">        resource: Resource name</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="sd">        shard_id: Shard index (0-based)</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="sd">    Returns:</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="sd">        GSI4SK string in format ``BUCKET#{entity_id}#{resource}#{shard_id}``</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BUCKET_PREFIX</span><span class="si">}{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p><strong>Step 4: Replace inline in repository.py</strong></p>
<p>At line 1891-1893, change:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="c1"># Before:</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="s2">&quot;GSI4SK&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schema</span><span class="o">.</span><span class="n">BUCKET_PREFIX</span><span class="si">}{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">shard_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a><span class="p">},</span>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="c1"># After:</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a><span class="s2">&quot;GSI4SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi4_sk_bucket</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">)},</span>
</span></code></pre></div>
<p><strong>Step 5: Generate sync code</strong></p>
<p>Run: <code>hatch run generate-sync</code></p>
<p><strong>Step 6: Run all unit tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/ -v</code>
Expected: PASS</p>
<p><strong>Step 7: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/schema.py<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="w">    </span>src/zae_limiter/sync_repository.py<span class="w"> </span>tests/unit/test_schema.py
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; refactor(schema): add gsi4_sk_bucket builder and use in repository&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-30-fix-inflated-capacity-in-get_resource_capacity">Task 30: Fix inflated capacity in get_resource_capacity<a class="headerlink" href="#task-30-fix-inflated-capacity-in-get_resource_capacity" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong></p>
<p><code>get_resource_capacity()</code> (<code>limiter.py:1844</code>) iterates all buckets from
<code>get_resource_buckets()</code> and sums <code>capacity</code> and <code>available</code>. With pre-shard buckets,
GSI2 returns one item per <code>(entity, shard)</code>. Each shard stores the <strong>full, undivided</strong>
capacity, so a 2-shard entity with <code>capacity=1000</code> produces <code>total_capacity=2000</code> and
two duplicate <code>EntityCapacity</code> entries.</p>
<p><strong>Fix:</strong> Deduplicate in <code>get_resource_capacity()</code>  group buckets by <code>entity_id</code>, use
capacity from shard 0, sum available tokens across shards.</p>
<p>Note: <code>get_resource_buckets()</code> still returns per-shard items to other callers. This is
acceptable  callers consuming raw buckets can decide how to aggregate.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/limiter.py</code> (<code>get_resource_capacity</code>  deduplicate by entity)
- Test: <code>tests/unit/test_limiter.py</code> (new test with sharded entity)</p>
<p><strong>Step 1: Write failing test</strong></p>
<p>Add to <code>TestGetResourceCapacity</code> in <code>tests/unit/test_limiter.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_get_resource_capacity_sharded_entity_deduplication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limiter</span><span class="p">):</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sharded entities should report capacity once, not per-shard.&quot;&quot;&quot;</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="k">await</span> <span class="n">limiter</span><span class="o">.</span><span class="n">create_entity</span><span class="p">(</span><span class="s2">&quot;sharded-user&quot;</span><span class="p">)</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>    <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">Limit</span><span class="o">.</span><span class="n">per_minute</span><span class="p">(</span><span class="s2">&quot;rpm&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="s2">&quot;sharded-user&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">):</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a>        <span class="k">pass</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>    <span class="c1"># Manually create shard 1 to simulate sharding</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">limiter</span><span class="o">.</span><span class="n">_repository</span>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a>    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a>    <span class="n">shard0_key</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a>        <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_bucket</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">,</span> <span class="s2">&quot;sharded-user&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>        <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">sk_state</span><span class="p">()},</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>    <span class="p">}</span>
</span><span id="__span-78-17"><a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a>    <span class="n">shard0_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="n">repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">shard0_key</span><span class="p">)</span>
</span><span id="__span-78-18"><a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a>    <span class="n">shard0_item</span> <span class="o">=</span> <span class="n">shard0_resp</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">]</span>
</span><span id="__span-78-19"><a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a>
</span><span id="__span-78-20"><a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a>    <span class="n">shard1_item</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shard0_item</span><span class="p">)</span>
</span><span id="__span-78-21"><a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a>    <span class="n">shard1_item</span><span class="p">[</span><span class="s2">&quot;PK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">pk_bucket</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">_namespace_id</span><span class="p">,</span> <span class="s2">&quot;sharded-user&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
</span><span id="__span-78-22"><a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a>    <span class="n">shard1_item</span><span class="p">[</span><span class="s2">&quot;GSI2SK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi2_sk_bucket</span><span class="p">(</span><span class="s2">&quot;sharded-user&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
</span><span id="__span-78-23"><a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a>    <span class="n">shard1_item</span><span class="p">[</span><span class="s2">&quot;GSI3SK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">gsi3_sk_bucket</span><span class="p">(</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
</span><span id="__span-78-24"><a id="__codelineno-78-24" name="__codelineno-78-24" href="#__codelineno-78-24"></a>    <span class="n">shard1_item</span><span class="p">[</span><span class="s2">&quot;shard_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}</span>
</span><span id="__span-78-25"><a id="__codelineno-78-25" name="__codelineno-78-25" href="#__codelineno-78-25"></a>    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
</span><span id="__span-78-26"><a id="__codelineno-78-26" name="__codelineno-78-26" href="#__codelineno-78-26"></a>        <span class="n">TableName</span><span class="o">=</span><span class="n">repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">shard0_key</span><span class="p">,</span>
</span><span id="__span-78-27"><a id="__codelineno-78-27" name="__codelineno-78-27" href="#__codelineno-78-27"></a>        <span class="n">UpdateExpression</span><span class="o">=</span><span class="s2">&quot;SET shard_count = :sc&quot;</span><span class="p">,</span>
</span><span id="__span-78-28"><a id="__codelineno-78-28" name="__codelineno-78-28" href="#__codelineno-78-28"></a>        <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;:sc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}},</span>
</span><span id="__span-78-29"><a id="__codelineno-78-29" name="__codelineno-78-29" href="#__codelineno-78-29"></a>    <span class="p">)</span>
</span><span id="__span-78-30"><a id="__codelineno-78-30" name="__codelineno-78-30" href="#__codelineno-78-30"></a>    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="n">repo</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Item</span><span class="o">=</span><span class="n">shard1_item</span><span class="p">)</span>
</span><span id="__span-78-31"><a id="__codelineno-78-31" name="__codelineno-78-31" href="#__codelineno-78-31"></a>
</span><span id="__span-78-32"><a id="__codelineno-78-32" name="__codelineno-78-32" href="#__codelineno-78-32"></a>    <span class="n">capacity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">limiter</span><span class="o">.</span><span class="n">get_resource_capacity</span><span class="p">(</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="s2">&quot;rpm&quot;</span><span class="p">)</span>
</span><span id="__span-78-33"><a id="__codelineno-78-33" name="__codelineno-78-33" href="#__codelineno-78-33"></a>
</span><span id="__span-78-34"><a id="__codelineno-78-34" name="__codelineno-78-34" href="#__codelineno-78-34"></a>    <span class="k">assert</span> <span class="n">capacity</span><span class="o">.</span><span class="n">total_capacity</span> <span class="o">==</span> <span class="mi">100</span>  <span class="c1"># Not 200</span>
</span><span id="__span-78-35"><a id="__codelineno-78-35" name="__codelineno-78-35" href="#__codelineno-78-35"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">capacity</span><span class="o">.</span><span class="n">entities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Not 2</span>
</span><span id="__span-78-36"><a id="__codelineno-78-36" name="__codelineno-78-36" href="#__codelineno-78-36"></a>    <span class="k">assert</span> <span class="n">capacity</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">entity_id</span> <span class="o">==</span> <span class="s2">&quot;sharded-user&quot;</span>
</span><span id="__span-78-37"><a id="__codelineno-78-37" name="__codelineno-78-37" href="#__codelineno-78-37"></a>    <span class="k">assert</span> <span class="n">capacity</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">100</span>
</span></code></pre></div>
<p><strong>Step 2: Run test  expect FAIL</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_limiter.py::TestGetResourceCapacity::test_get_resource_capacity_sharded_entity_deduplication -v</code>
Expected: FAIL (<code>total_capacity == 200</code>, <code>len(entities) == 2</code>)</p>
<p><strong>Step 3: Deduplicate by entity in <code>get_resource_capacity()</code></strong></p>
<p>In <code>limiter.py</code>, replace the per-bucket loop (lines 1879-1895) with entity-grouped
aggregation:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="n">entity_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">BucketState</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">:</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>    <span class="n">entity_buckets</span><span class="p">[</span><span class="n">bucket</span><span class="o">.</span><span class="n">entity_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="n">entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EntityCapacity</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="n">total_capacity</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="n">total_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">entity_bucket_list</span> <span class="ow">in</span> <span class="n">entity_buckets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>    <span class="c1"># Capacity is the same on all shards (undivided); take from first</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>    <span class="n">capacity</span> <span class="o">=</span> <span class="n">entity_bucket_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capacity</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>    <span class="c1"># Available tokens are distributed across shards; sum them</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>    <span class="n">available</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">calculate_available</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">now_ms</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">entity_bucket_list</span><span class="p">)</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>    <span class="n">available</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">available</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>    <span class="n">total_capacity</span> <span class="o">+=</span> <span class="n">capacity</span>
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>    <span class="n">total_available</span> <span class="o">+=</span> <span class="n">available</span>
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>
</span><span id="__span-79-21"><a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a>    <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-79-22"><a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a>        <span class="n">EntityCapacity</span><span class="p">(</span>
</span><span id="__span-79-23"><a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a>            <span class="n">entity_id</span><span class="o">=</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-79-24"><a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a>            <span class="n">capacity</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
</span><span id="__span-79-25"><a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a>            <span class="n">available</span><span class="o">=</span><span class="n">available</span><span class="p">,</span>
</span><span id="__span-79-26"><a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a>            <span class="n">utilization_pct</span><span class="o">=</span><span class="p">(</span>
</span><span id="__span-79-27"><a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a>                <span class="p">((</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">available</span><span class="p">)</span> <span class="o">/</span> <span class="n">capacity</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">capacity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="__span-79-28"><a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a>            <span class="p">),</span>
</span><span id="__span-79-29"><a id="__codelineno-79-29" name="__codelineno-79-29" href="#__codelineno-79-29"></a>        <span class="p">)</span>
</span><span id="__span-79-30"><a id="__codelineno-79-30" name="__codelineno-79-30" href="#__codelineno-79-30"></a>    <span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Generate sync code</strong></p>
<p>Run: <code>hatch run generate-sync</code></p>
<p><strong>Step 5: Run all unit tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/ -v</code>
Expected: PASS</p>
<p><strong>Step 6: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/limiter.py<span class="w"> </span>src/zae_limiter/sync_limiter.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="w">    </span>tests/unit/test_limiter.py<span class="w"> </span>tests/unit/test_sync_limiter.py
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; fix(limiter): deduplicate sharded entities in get_resource_capacity&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-35-handle-dynamodb-per-partition-throttling-with-shard-probe">Task 35: Handle DynamoDB per-partition throttling with shard probe<a class="headerlink" href="#task-35-handle-dynamodb-per-partition-throttling-with-shard-probe" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> The design plan's Failure Handling table (row 4) specifies catching <code>ProvisionedThroughputExceededException</code> for DynamoDB throttle retry with shard probe. This is only correct for provisioned tables. On-demand tables (<code>PAY_PER_REQUEST</code>) return <code>ThrottlingException</code> with <code>ThrottlingReason: TableWriteKeyRangeThroughputExceeded</code> for per-partition throttling. The code must handle both capacity modes as a defensive fallback behind the <code>wcu</code> infrastructure limit.</p>
<p><strong>References:</strong>
- <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Programming.Errors.html">DynamoDB Error Handling</a>: On-demand  <code>ThrottlingException</code>, provisioned  <code>ProvisionedThroughputExceededException</code>
- <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/throttling-key-range-limit-exceeded-mitigation.html">Key Range Throughput Exceeded</a>: Per-partition throttling uses <code>TableWriteKeyRangeThroughputExceeded</code> reason</p>
<p><strong>Fix:</strong> In <code>speculative_consume()</code> or the limiter's <code>_try_speculative_acquire()</code>, catch both:
1. <code>ProvisionedThroughputExceededException</code> (provisioned tables)
2. <code>ThrottlingException</code> where <code>ThrottlingReason</code> contains <code>KeyRangeThroughputExceeded</code> (on-demand tables)</p>
<p>On either, probe shard 1 with a GetItem. If it exists, read <code>shard_count</code> and update entity cache, then fall through to slow path on a different shard. If shard 1 doesn't exist, raise <code>RateLimiterUnavailable</code>.</p>
<p>Ignore <code>ThrottlingException</code> with other reasons (table-level caps, control plane throttling)  retry on a different shard won't help for those.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter/repository.py</code> (catch both exceptions in <code>_speculative_consume_single</code>)
- Modify: <code>src/zae_limiter/limiter.py</code> (shard probe logic on throttle)
- Modify: <code>docs/plans/2026-02-21-pre-shard-buckets-design.md</code> (update Failure Handling row 4)
- Generate: sync code (<code>hatch run generate-sync</code>)
- Test: <code>tests/unit/test_repository.py</code>, <code>tests/unit/test_limiter.py</code></p>
<p><strong>Step 1: Write failing tests</strong></p>
<p>In <code>tests/unit/test_repository.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_consume_handles_provisioned_throttle</span><span class="p">():</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ProvisionedThroughputExceededException returns throttled SpeculativeResult.&quot;&quot;&quot;</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>    <span class="c1"># Mock client to raise ProvisionedThroughputExceededException</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">PARTITION_THROTTLED</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_consume_handles_on_demand_throttle</span><span class="p">():</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ThrottlingException with KeyRangeThroughputExceeded returns throttled result.&quot;&quot;&quot;</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>    <span class="c1"># Mock client to raise ThrottlingException with ThrottlingReason</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">PARTITION_THROTTLED</span>
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>
</span><span id="__span-81-15"><a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_speculative_consume_reraises_non_partition_throttle</span><span class="p">():</span>
</span><span id="__span-81-16"><a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ThrottlingException without KeyRange reason is re-raised.&quot;&quot;&quot;</span>
</span><span id="__span-81-17"><a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a>    <span class="c1"># Mock client to raise ThrottlingException with MaxOnDemandThroughputExceeded</span>
</span><span id="__span-81-18"><a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ClientError</span><span class="p">):</span>
</span><span id="__span-81-19"><a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a>        <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">speculative_consume</span><span class="p">(</span><span class="s2">&quot;user-1&quot;</span><span class="p">,</span> <span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rpm&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_repository.py -k "test_speculative_consume_handles" -v</code>
Expected: FAIL</p>
<p><strong>Step 3: Add throttle handling in <code>_speculative_consume_single</code></strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_is_partition_throttle</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">ClientError</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a ClientError is a per-partition throttle (hot key).&quot;&quot;&quot;</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>    <span class="n">code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Code&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;ProvisionedThroughputExceededException&quot;</span><span class="p">:</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;ThrottlingException&quot;</span><span class="p">:</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>        <span class="n">reason</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ThrottlingReason&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>        <span class="k">return</span> <span class="s2">&quot;KeyRangeThroughputExceeded&quot;</span> <span class="ow">in</span> <span class="n">reason</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a>    <span class="k">return</span> <span class="kc">False</span>
</span></code></pre></div>
<p>In <code>_speculative_consume_single</code>, extend the <code>except ClientError</code> block:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Code&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">:</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>        <span class="c1"># ... existing logic ...</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>    <span class="k">elif</span> <span class="n">_is_partition_throttle</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>        <span class="k">return</span> <span class="n">SpeculativeResult</span><span class="p">(</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>            <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>            <span class="n">shard_id</span><span class="o">=</span><span class="n">shard_id</span><span class="p">,</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>            <span class="n">failure_reason</span><span class="o">=</span><span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">PARTITION_THROTTLED</span><span class="p">,</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>        <span class="p">)</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>    <span class="k">raise</span>
</span></code></pre></div>
<p><strong>Step 4: Add shard probe in limiter</strong></p>
<p>In <code>_try_speculative_acquire()</code>, after the existing wcu/shard-retry logic:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">==</span> <span class="n">SpeculativeFailureReason</span><span class="o">.</span><span class="n">PARTITION_THROTTLED</span><span class="p">:</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>    <span class="c1"># Probe shard 1 to discover shard_count</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>    <span class="n">probe</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repository</span><span class="o">.</span><span class="n">get_buckets</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">shard_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>    <span class="k">if</span> <span class="n">probe</span><span class="p">:</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>        <span class="n">shard_count</span> <span class="o">=</span> <span class="n">probe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shard_count</span>  <span class="c1"># or from item attributes</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>        <span class="c1"># Update entity cache, fall through to slow path on different shard</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>    <span class="k">raise</span> <span class="n">RateLimiterUnavailable</span><span class="p">(</span><span class="s2">&quot;DynamoDB partition throttled, no shards available&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 5: Update design plan Failure Handling table</strong></p>
<p>Replace row 4 in <code>docs/plans/2026-02-21-pre-shard-buckets-design.md</code>:</p>
<div class="language-markdown highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>| <span class="sb">`ProvisionedThroughputExceededException`</span> or <span class="sb">`ThrottlingException`</span> (KeyRange) | DynamoDB per-partition throttle | Probe shard 1; if exists, discover <span class="sb">`shard_count`</span> and retry; if not, <span class="sb">`RateLimiterUnavailable`</span> |
</span></code></pre></div>
<p><strong>Step 6: Generate sync code</strong></p>
<p>Run: <code>hatch run generate-sync</code></p>
<p><strong>Step 7: Run all unit tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/ -v</code>
Expected: PASS</p>
<p><strong>Step 8: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter/repository.py<span class="w"> </span>src/zae_limiter/limiter.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="w">    </span>src/zae_limiter/sync_*.py<span class="w"> </span>docs/plans/2026-02-21-pre-shard-buckets-design.md<span class="w"> </span><span class="se">\</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span>tests/unit/test_repository.py<span class="w"> </span>tests/unit/test_limiter.py<span class="w"> </span>tests/unit/test_sync_*.py
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; fix(repository): handle both ProvisionedThroughput and ThrottlingException for partition throttle&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-36-fix-propagate_shard_count-to-pre-create-new-shard-items">Task 36: Fix propagate_shard_count to pre-create new shard items<a class="headerlink" href="#task-36-fix-propagate_shard_count-to-pre-create-new-shard-items" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> <code>propagate_shard_count()</code> (<code>processor.py:700-768</code>) uses <code>attribute_not_exists(shard_count) OR shard_count &lt; :new</code> as the condition expression. When the target shard doesn't exist, this creates an incomplete item with only <code>PK</code>, <code>SK</code>, and <code>shard_count</code>  missing all GSI attributes (<code>GSI2PK</code>, <code>GSI2SK</code>, <code>GSI3PK</code>, <code>GSI3SK</code>, <code>GSI4PK</code>, <code>GSI4SK</code>), limit attributes, <code>cascade</code>, <code>parent_id</code>, and <code>wcu</code> infrastructure limit. These incomplete items are invisible to GSI3 bucket discovery and GSI2 resource capacity queries.</p>
<p>Without pre-creation, every new shard's first client access hits the slow path (+2 RT), which goes against the architecture's core principle: keep clients on the speculative fast path. The aggregator also can't refill new shards until a client creates them.</p>
<p><strong>Fix:</strong> Split propagation into two code paths based on <code>old_count</code>/<code>new_count</code> from the stream record's OldImage/NewImage:
1. <strong>Existing shards</strong> <code>range(1, old_count)</code>: UpdateItem with <code>shard_count &lt; :new</code> (drop <code>attribute_not_exists</code>)
2. <strong>New shards</strong> <code>range(old_count, new_count)</code>: PutItem cloned from shard 0's NewImage with adjusted PK/GSI keys, tokens set to effective capacity, condition <code>attribute_not_exists(PK)</code> to avoid overwriting client-created items</p>
<p><strong>Cost:</strong> +N WCU per doubling event in the aggregator Lambda (async, rare). Keeps clients on the fast path.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py:700-768</code> (<code>propagate_shard_count</code>)
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing tests</strong></p>
<p>In <code>tests/unit/test_processor.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_propagate_creates_full_items_for_new_shards</span><span class="p">():</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;New shards get full items cloned from shard 0&#39;s NewImage.&quot;&quot;&quot;</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>        <span class="n">sk</span><span class="o">=</span><span class="s2">&quot;#STATE&quot;</span><span class="p">,</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>            <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">},</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>            <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;#STATE&quot;</span><span class="p">},</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>            <span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">},</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>            <span class="s2">&quot;GSI2PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1/RESOURCE#gpt-4&quot;</span><span class="p">},</span>
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>            <span class="s2">&quot;GSI2SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;BUCKET#user-1#0&quot;</span><span class="p">},</span>
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a>            <span class="s2">&quot;GSI3PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1/ENTITY#user-1&quot;</span><span class="p">},</span>
</span><span id="__span-87-13"><a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>            <span class="s2">&quot;GSI3SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;BUCKET#gpt-4#0&quot;</span><span class="p">},</span>
</span><span id="__span-87-14"><a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a>            <span class="s2">&quot;GSI4PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1&quot;</span><span class="p">},</span>
</span><span id="__span-87-15"><a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a>            <span class="s2">&quot;GSI4SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;BUCKET#user-1#gpt-4#0&quot;</span><span class="p">},</span>
</span><span id="__span-87-16"><a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a>            <span class="s2">&quot;b_rpm_tk&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;50000000&quot;</span><span class="p">},</span>
</span><span id="__span-87-17"><a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a>            <span class="s2">&quot;b_rpm_cp&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;100000000&quot;</span><span class="p">},</span>
</span><span id="__span-87-18"><a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a>            <span class="s2">&quot;b_rpm_ra&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;100000000&quot;</span><span class="p">},</span>
</span><span id="__span-87-19"><a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a>            <span class="s2">&quot;b_rpm_rp&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;60000&quot;</span><span class="p">},</span>
</span><span id="__span-87-20"><a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a>            <span class="s2">&quot;b_rpm_tc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">},</span>
</span><span id="__span-87-21"><a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a>            <span class="s2">&quot;b_wcu_tk&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000&quot;</span><span class="p">},</span>
</span><span id="__span-87-22"><a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a>            <span class="s2">&quot;b_wcu_cp&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000&quot;</span><span class="p">},</span>
</span><span id="__span-87-23"><a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a>            <span class="s2">&quot;b_wcu_ra&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000&quot;</span><span class="p">},</span>
</span><span id="__span-87-24"><a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a>            <span class="s2">&quot;b_wcu_rp&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;1000&quot;</span><span class="p">},</span>
</span><span id="__span-87-25"><a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a>            <span class="s2">&quot;b_wcu_tc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;500&quot;</span><span class="p">},</span>
</span><span id="__span-87-26"><a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a>            <span class="s2">&quot;cascade&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;BOOL&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span><span id="__span-87-27"><a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a>            <span class="s2">&quot;rf&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;1000&quot;</span><span class="p">},</span>
</span><span id="__span-87-28"><a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a>        <span class="p">},</span>
</span><span id="__span-87-29"><a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-87-30"><a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a>            <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">},</span>
</span><span id="__span-87-31"><a id="__codelineno-87-31" name="__codelineno-87-31" href="#__codelineno-87-31"></a>            <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;#STATE&quot;</span><span class="p">},</span>
</span><span id="__span-87-32"><a id="__codelineno-87-32" name="__codelineno-87-32" href="#__codelineno-87-32"></a>            <span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span>
</span><span id="__span-87-33"><a id="__codelineno-87-33" name="__codelineno-87-33" href="#__codelineno-87-33"></a>        <span class="p">},</span>
</span><span id="__span-87-34"><a id="__codelineno-87-34" name="__codelineno-87-34" href="#__codelineno-87-34"></a>    <span class="p">)</span>
</span><span id="__span-87-35"><a id="__codelineno-87-35" name="__codelineno-87-35" href="#__codelineno-87-35"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-87-36"><a id="__codelineno-87-36" name="__codelineno-87-36" href="#__codelineno-87-36"></a>    <span class="n">propagated</span> <span class="o">=</span> <span class="n">propagate_shard_count</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
</span><span id="__span-87-37"><a id="__codelineno-87-37" name="__codelineno-87-37" href="#__codelineno-87-37"></a>
</span><span id="__span-87-38"><a id="__codelineno-87-38" name="__codelineno-87-38" href="#__codelineno-87-38"></a>    <span class="c1"># Shards 2 and 3 are NEW (old_count=2, new_count=4)</span>
</span><span id="__span-87-39"><a id="__codelineno-87-39" name="__codelineno-87-39" href="#__codelineno-87-39"></a>    <span class="c1"># Shard 1 is EXISTING (update only)</span>
</span><span id="__span-87-40"><a id="__codelineno-87-40" name="__codelineno-87-40" href="#__codelineno-87-40"></a>    <span class="n">calls</span> <span class="o">=</span> <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">call_args_list</span>
</span><span id="__span-87-41"><a id="__codelineno-87-41" name="__codelineno-87-41" href="#__codelineno-87-41"></a>    <span class="n">put_calls</span> <span class="o">=</span> <span class="n">mock_table</span><span class="o">.</span><span class="n">put_item</span><span class="o">.</span><span class="n">call_args_list</span>
</span><span id="__span-87-42"><a id="__codelineno-87-42" name="__codelineno-87-42" href="#__codelineno-87-42"></a>
</span><span id="__span-87-43"><a id="__codelineno-87-43" name="__codelineno-87-43" href="#__codelineno-87-43"></a>    <span class="c1"># 1 existing shard updated</span>
</span><span id="__span-87-44"><a id="__codelineno-87-44" name="__codelineno-87-44" href="#__codelineno-87-44"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-87-45"><a id="__codelineno-87-45" name="__codelineno-87-45" href="#__codelineno-87-45"></a>    <span class="k">assert</span> <span class="s2">&quot;shard_count &lt; :new&quot;</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ConditionExpression&quot;</span><span class="p">]</span>
</span><span id="__span-87-46"><a id="__codelineno-87-46" name="__codelineno-87-46" href="#__codelineno-87-46"></a>
</span><span id="__span-87-47"><a id="__codelineno-87-47" name="__codelineno-87-47" href="#__codelineno-87-47"></a>    <span class="c1"># 2 new shards pre-created with full attributes</span>
</span><span id="__span-87-48"><a id="__codelineno-87-48" name="__codelineno-87-48" href="#__codelineno-87-48"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">put_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span><span id="__span-87-49"><a id="__codelineno-87-49" name="__codelineno-87-49" href="#__codelineno-87-49"></a>    <span class="k">for</span> <span class="n">put_call</span> <span class="ow">in</span> <span class="n">put_calls</span><span class="p">:</span>
</span><span id="__span-87-50"><a id="__codelineno-87-50" name="__codelineno-87-50" href="#__codelineno-87-50"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">put_call</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">]</span>
</span><span id="__span-87-51"><a id="__codelineno-87-51" name="__codelineno-87-51" href="#__codelineno-87-51"></a>        <span class="k">assert</span> <span class="s2">&quot;GSI3PK&quot;</span> <span class="ow">in</span> <span class="n">item</span>  <span class="c1"># Has GSI attributes</span>
</span><span id="__span-87-52"><a id="__codelineno-87-52" name="__codelineno-87-52" href="#__codelineno-87-52"></a>        <span class="k">assert</span> <span class="s2">&quot;GSI2PK&quot;</span> <span class="ow">in</span> <span class="n">item</span>
</span><span id="__span-87-53"><a id="__codelineno-87-53" name="__codelineno-87-53" href="#__codelineno-87-53"></a>        <span class="k">assert</span> <span class="s2">&quot;b_rpm_tk&quot;</span> <span class="ow">in</span> <span class="n">item</span>  <span class="c1"># Has limit attributes</span>
</span><span id="__span-87-54"><a id="__codelineno-87-54" name="__codelineno-87-54" href="#__codelineno-87-54"></a>        <span class="k">assert</span> <span class="s2">&quot;b_wcu_tk&quot;</span> <span class="ow">in</span> <span class="n">item</span>  <span class="c1"># Has wcu</span>
</span><span id="__span-87-55"><a id="__codelineno-87-55" name="__codelineno-87-55" href="#__codelineno-87-55"></a>
</span><span id="__span-87-56"><a id="__codelineno-87-56" name="__codelineno-87-56" href="#__codelineno-87-56"></a>    <span class="c1"># Verify PKs are correct for new shards</span>
</span><span id="__span-87-57"><a id="__codelineno-87-57" name="__codelineno-87-57" href="#__codelineno-87-57"></a>    <span class="n">new_pks</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">][</span><span class="s2">&quot;PK&quot;</span><span class="p">][</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">put_calls</span><span class="p">}</span>
</span><span id="__span-87-58"><a id="__codelineno-87-58" name="__codelineno-87-58" href="#__codelineno-87-58"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#2&quot;</span> <span class="ow">in</span> <span class="n">new_pks</span>
</span><span id="__span-87-59"><a id="__codelineno-87-59" name="__codelineno-87-59" href="#__codelineno-87-59"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#3&quot;</span> <span class="ow">in</span> <span class="n">new_pks</span>
</span><span id="__span-87-60"><a id="__codelineno-87-60" name="__codelineno-87-60" href="#__codelineno-87-60"></a>
</span><span id="__span-87-61"><a id="__codelineno-87-61" name="__codelineno-87-61" href="#__codelineno-87-61"></a>
</span><span id="__span-87-62"><a id="__codelineno-87-62" name="__codelineno-87-62" href="#__codelineno-87-62"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_propagate_existing_shards_not_created</span><span class="p">():</span>
</span><span id="__span-87-63"><a id="__codelineno-87-63" name="__codelineno-87-63" href="#__codelineno-87-63"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Existing shards get UpdateItem, not PutItem.&quot;&quot;&quot;</span>
</span><span id="__span-87-64"><a id="__codelineno-87-64" name="__codelineno-87-64" href="#__codelineno-87-64"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-87-65"><a id="__codelineno-87-65" name="__codelineno-87-65" href="#__codelineno-87-65"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-87-66"><a id="__codelineno-87-66" name="__codelineno-87-66" href="#__codelineno-87-66"></a>        <span class="n">sk</span><span class="o">=</span><span class="s2">&quot;#STATE&quot;</span><span class="p">,</span>
</span><span id="__span-87-67"><a id="__codelineno-87-67" name="__codelineno-87-67" href="#__codelineno-87-67"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">},</span> <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">},</span> <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;#STATE&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-87-68"><a id="__codelineno-87-68" name="__codelineno-87-68" href="#__codelineno-87-68"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-87-69"><a id="__codelineno-87-69" name="__codelineno-87-69" href="#__codelineno-87-69"></a>    <span class="p">)</span>
</span><span id="__span-87-70"><a id="__codelineno-87-70" name="__codelineno-87-70" href="#__codelineno-87-70"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-87-71"><a id="__codelineno-87-71" name="__codelineno-87-71" href="#__codelineno-87-71"></a>    <span class="n">propagate_shard_count</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
</span><span id="__span-87-72"><a id="__codelineno-87-72" name="__codelineno-87-72" href="#__codelineno-87-72"></a>
</span><span id="__span-87-73"><a id="__codelineno-87-73" name="__codelineno-87-73" href="#__codelineno-87-73"></a>    <span class="c1"># Shard 1 is existing  UpdateItem, not PutItem</span>
</span><span id="__span-87-74"><a id="__codelineno-87-74" name="__codelineno-87-74" href="#__codelineno-87-74"></a>    <span class="n">update_pks</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">][</span><span class="s2">&quot;PK&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">}</span>
</span><span id="__span-87-75"><a id="__codelineno-87-75" name="__codelineno-87-75" href="#__codelineno-87-75"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#1&quot;</span> <span class="ow">in</span> <span class="n">update_pks</span>
</span><span id="__span-87-76"><a id="__codelineno-87-76" name="__codelineno-87-76" href="#__codelineno-87-76"></a>
</span><span id="__span-87-77"><a id="__codelineno-87-77" name="__codelineno-87-77" href="#__codelineno-87-77"></a>    <span class="n">put_pks</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">][</span><span class="s2">&quot;PK&quot;</span><span class="p">][</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mock_table</span><span class="o">.</span><span class="n">put_item</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">}</span>
</span><span id="__span-87-78"><a id="__codelineno-87-78" name="__codelineno-87-78" href="#__codelineno-87-78"></a>    <span class="k">assert</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">put_pks</span>
</span><span id="__span-87-79"><a id="__codelineno-87-79" name="__codelineno-87-79" href="#__codelineno-87-79"></a>
</span><span id="__span-87-80"><a id="__codelineno-87-80" name="__codelineno-87-80" href="#__codelineno-87-80"></a>
</span><span id="__span-87-81"><a id="__codelineno-87-81" name="__codelineno-87-81" href="#__codelineno-87-81"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_propagate_new_shard_skips_if_client_created</span><span class="p">():</span>
</span><span id="__span-87-82"><a id="__codelineno-87-82" name="__codelineno-87-82" href="#__codelineno-87-82"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;PutItem with attribute_not_exists(PK) skips client-created shards.&quot;&quot;&quot;</span>
</span><span id="__span-87-83"><a id="__codelineno-87-83" name="__codelineno-87-83" href="#__codelineno-87-83"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-87-84"><a id="__codelineno-87-84" name="__codelineno-87-84" href="#__codelineno-87-84"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">put_item</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ClientError</span><span class="p">(</span>
</span><span id="__span-87-85"><a id="__codelineno-87-85" name="__codelineno-87-85" href="#__codelineno-87-85"></a>        <span class="p">{</span><span class="s2">&quot;Error&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Code&quot;</span><span class="p">:</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">}},</span> <span class="s2">&quot;PutItem&quot;</span>
</span><span id="__span-87-86"><a id="__codelineno-87-86" name="__codelineno-87-86" href="#__codelineno-87-86"></a>    <span class="p">)</span>
</span><span id="__span-87-87"><a id="__codelineno-87-87" name="__codelineno-87-87" href="#__codelineno-87-87"></a>    <span class="n">record</span> <span class="o">=</span> <span class="n">make_modify_record</span><span class="p">(</span>
</span><span id="__span-87-88"><a id="__codelineno-87-88" name="__codelineno-87-88" href="#__codelineno-87-88"></a>        <span class="n">pk</span><span class="o">=</span><span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">,</span>
</span><span id="__span-87-89"><a id="__codelineno-87-89" name="__codelineno-87-89" href="#__codelineno-87-89"></a>        <span class="n">sk</span><span class="o">=</span><span class="s2">&quot;#STATE&quot;</span><span class="p">,</span>
</span><span id="__span-87-90"><a id="__codelineno-87-90" name="__codelineno-87-90" href="#__codelineno-87-90"></a>        <span class="n">new_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">},</span> <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1/BUCKET#user-1#gpt-4#0&quot;</span><span class="p">},</span> <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;#STATE&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-87-91"><a id="__codelineno-87-91" name="__codelineno-87-91" href="#__codelineno-87-91"></a>        <span class="n">old_image</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shard_count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">},</span> <span class="o">...</span><span class="p">},</span>
</span><span id="__span-87-92"><a id="__codelineno-87-92" name="__codelineno-87-92" href="#__codelineno-87-92"></a>    <span class="p">)</span>
</span><span id="__span-87-93"><a id="__codelineno-87-93" name="__codelineno-87-93" href="#__codelineno-87-93"></a>    <span class="n">propagated</span> <span class="o">=</span> <span class="n">propagate_shard_count</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
</span><span id="__span-87-94"><a id="__codelineno-87-94" name="__codelineno-87-94" href="#__codelineno-87-94"></a>    <span class="k">assert</span> <span class="n">propagated</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># Client already created it</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -k "test_propagate" -v</code>
Expected: FAIL (current code uses UpdateItem for all shards, no PutItem)</p>
<p><strong>Step 3: Rewrite propagate_shard_count with two code paths</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">propagate_shard_count</span><span class="p">(</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>    <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Propagate shard_count changes to all other shard items.</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="sd">    Detects shard_count change in stream record (OldImage vs NewImage).</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="sd">    Only propagates from shard 0. Two code paths:</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="sd">    - Existing shards (1..old_count-1): UpdateItem with shard_count &lt; :new</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="sd">    - New shards (old_count..new_count-1): PutItem cloned from shard 0&#39;s</span>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a><span class="sd">      NewImage with adjusted PK/GSI keys and effective token capacity.</span>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a><span class="sd">      Uses attribute_not_exists(PK) to avoid overwriting client-created items.</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a><span class="sd">    Args:</span>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a><span class="sd">        table: boto3 Table resource</span>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a><span class="sd">        record: DynamoDB stream record</span>
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a>
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a><span class="sd">    Returns:</span>
</span><span id="__span-88-19"><a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a><span class="sd">        Number of shard items created or updated</span>
</span><span id="__span-88-20"><a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-88-21"><a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a>    <span class="n">dynamodb_data</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-88-22"><a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a>    <span class="n">new_image</span> <span class="o">=</span> <span class="n">dynamodb_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NewImage&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-88-23"><a id="__codelineno-88-23" name="__codelineno-88-23" href="#__codelineno-88-23"></a>    <span class="n">old_image</span> <span class="o">=</span> <span class="n">dynamodb_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OldImage&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-88-24"><a id="__codelineno-88-24" name="__codelineno-88-24" href="#__codelineno-88-24"></a>
</span><span id="__span-88-25"><a id="__codelineno-88-25" name="__codelineno-88-25" href="#__codelineno-88-25"></a>    <span class="n">new_count_raw</span> <span class="o">=</span> <span class="n">new_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shard_count&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="__span-88-26"><a id="__codelineno-88-26" name="__codelineno-88-26" href="#__codelineno-88-26"></a>    <span class="n">old_count_raw</span> <span class="o">=</span> <span class="n">old_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shard_count&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="__span-88-27"><a id="__codelineno-88-27" name="__codelineno-88-27" href="#__codelineno-88-27"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_count_raw</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">old_count_raw</span><span class="p">:</span>
</span><span id="__span-88-28"><a id="__codelineno-88-28" name="__codelineno-88-28" href="#__codelineno-88-28"></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="__span-88-29"><a id="__codelineno-88-29" name="__codelineno-88-29" href="#__codelineno-88-29"></a>
</span><span id="__span-88-30"><a id="__codelineno-88-30" name="__codelineno-88-30" href="#__codelineno-88-30"></a>    <span class="n">new_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_count_raw</span><span class="p">)</span>
</span><span id="__span-88-31"><a id="__codelineno-88-31" name="__codelineno-88-31" href="#__codelineno-88-31"></a>    <span class="n">old_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_count_raw</span><span class="p">)</span>
</span><span id="__span-88-32"><a id="__codelineno-88-32" name="__codelineno-88-32" href="#__codelineno-88-32"></a>    <span class="k">if</span> <span class="n">new_count</span> <span class="o">&lt;=</span> <span class="n">old_count</span><span class="p">:</span>
</span><span id="__span-88-33"><a id="__codelineno-88-33" name="__codelineno-88-33" href="#__codelineno-88-33"></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="__span-88-34"><a id="__codelineno-88-34" name="__codelineno-88-34" href="#__codelineno-88-34"></a>
</span><span id="__span-88-35"><a id="__codelineno-88-35" name="__codelineno-88-35" href="#__codelineno-88-35"></a>    <span class="n">pk</span> <span class="o">=</span> <span class="n">new_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PK&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-88-36"><a id="__codelineno-88-36" name="__codelineno-88-36" href="#__codelineno-88-36"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-88-37"><a id="__codelineno-88-37" name="__codelineno-88-37" href="#__codelineno-88-37"></a>        <span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">shard_id</span> <span class="o">=</span> <span class="n">parse_bucket_pk</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
</span><span id="__span-88-38"><a id="__codelineno-88-38" name="__codelineno-88-38" href="#__codelineno-88-38"></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="__span-88-39"><a id="__codelineno-88-39" name="__codelineno-88-39" href="#__codelineno-88-39"></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="__span-88-40"><a id="__codelineno-88-40" name="__codelineno-88-40" href="#__codelineno-88-40"></a>
</span><span id="__span-88-41"><a id="__codelineno-88-41" name="__codelineno-88-41" href="#__codelineno-88-41"></a>    <span class="k">if</span> <span class="n">shard_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-88-42"><a id="__codelineno-88-42" name="__codelineno-88-42" href="#__codelineno-88-42"></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Only propagate from source of truth</span>
</span><span id="__span-88-43"><a id="__codelineno-88-43" name="__codelineno-88-43" href="#__codelineno-88-43"></a>
</span><span id="__span-88-44"><a id="__codelineno-88-44" name="__codelineno-88-44" href="#__codelineno-88-44"></a>    <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-88-45"><a id="__codelineno-88-45" name="__codelineno-88-45" href="#__codelineno-88-45"></a>
</span><span id="__span-88-46"><a id="__codelineno-88-46" name="__codelineno-88-46" href="#__codelineno-88-46"></a>    <span class="c1"># Path 1: Update existing shards (lightweight shard_count update)</span>
</span><span id="__span-88-47"><a id="__codelineno-88-47" name="__codelineno-88-47" href="#__codelineno-88-47"></a>    <span class="k">for</span> <span class="n">target_shard</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">old_count</span><span class="p">):</span>
</span><span id="__span-88-48"><a id="__codelineno-88-48" name="__codelineno-88-48" href="#__codelineno-88-48"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-88-49"><a id="__codelineno-88-49" name="__codelineno-88-49" href="#__codelineno-88-49"></a>            <span class="n">table</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
</span><span id="__span-88-50"><a id="__codelineno-88-50" name="__codelineno-88-50" href="#__codelineno-88-50"></a>                <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-88-51"><a id="__codelineno-88-51" name="__codelineno-88-51" href="#__codelineno-88-51"></a>                    <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="n">pk_bucket</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">target_shard</span><span class="p">),</span>
</span><span id="__span-88-52"><a id="__codelineno-88-52" name="__codelineno-88-52" href="#__codelineno-88-52"></a>                    <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="n">sk_state</span><span class="p">(),</span>
</span><span id="__span-88-53"><a id="__codelineno-88-53" name="__codelineno-88-53" href="#__codelineno-88-53"></a>                <span class="p">},</span>
</span><span id="__span-88-54"><a id="__codelineno-88-54" name="__codelineno-88-54" href="#__codelineno-88-54"></a>                <span class="n">UpdateExpression</span><span class="o">=</span><span class="s2">&quot;SET shard_count = :new&quot;</span><span class="p">,</span>
</span><span id="__span-88-55"><a id="__codelineno-88-55" name="__codelineno-88-55" href="#__codelineno-88-55"></a>                <span class="n">ConditionExpression</span><span class="o">=</span><span class="s2">&quot;shard_count &lt; :new&quot;</span><span class="p">,</span>
</span><span id="__span-88-56"><a id="__codelineno-88-56" name="__codelineno-88-56" href="#__codelineno-88-56"></a>                <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-88-57"><a id="__codelineno-88-57" name="__codelineno-88-57" href="#__codelineno-88-57"></a>                    <span class="s2">&quot;:new&quot;</span><span class="p">:</span> <span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-88-58"><a id="__codelineno-88-58" name="__codelineno-88-58" href="#__codelineno-88-58"></a>                <span class="p">},</span>
</span><span id="__span-88-59"><a id="__codelineno-88-59" name="__codelineno-88-59" href="#__codelineno-88-59"></a>            <span class="p">)</span>
</span><span id="__span-88-60"><a id="__codelineno-88-60" name="__codelineno-88-60" href="#__codelineno-88-60"></a>            <span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-88-61"><a id="__codelineno-88-61" name="__codelineno-88-61" href="#__codelineno-88-61"></a>        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-88-62"><a id="__codelineno-88-62" name="__codelineno-88-62" href="#__codelineno-88-62"></a>            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">:</span>
</span><span id="__span-88-63"><a id="__codelineno-88-63" name="__codelineno-88-63" href="#__codelineno-88-63"></a>                <span class="k">continue</span>  <span class="c1"># Higher value already present</span>
</span><span id="__span-88-64"><a id="__codelineno-88-64" name="__codelineno-88-64" href="#__codelineno-88-64"></a>            <span class="k">raise</span>
</span><span id="__span-88-65"><a id="__codelineno-88-65" name="__codelineno-88-65" href="#__codelineno-88-65"></a>
</span><span id="__span-88-66"><a id="__codelineno-88-66" name="__codelineno-88-66" href="#__codelineno-88-66"></a>    <span class="c1"># Path 2: Pre-create new shards (full item cloned from shard 0)</span>
</span><span id="__span-88-67"><a id="__codelineno-88-67" name="__codelineno-88-67" href="#__codelineno-88-67"></a>    <span class="k">for</span> <span class="n">target_shard</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">old_count</span><span class="p">,</span> <span class="n">new_count</span><span class="p">):</span>
</span><span id="__span-88-68"><a id="__codelineno-88-68" name="__codelineno-88-68" href="#__codelineno-88-68"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-88-69"><a id="__codelineno-88-69" name="__codelineno-88-69" href="#__codelineno-88-69"></a>            <span class="n">item</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new_image</span><span class="p">)</span>  <span class="c1"># Clone shard 0&#39;s NewImage</span>
</span><span id="__span-88-70"><a id="__codelineno-88-70" name="__codelineno-88-70" href="#__codelineno-88-70"></a>            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;PK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">pk_bucket</span><span class="p">(</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">target_shard</span><span class="p">)}</span>
</span><span id="__span-88-71"><a id="__codelineno-88-71" name="__codelineno-88-71" href="#__codelineno-88-71"></a>            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;GSI2SK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">gsi2_sk_bucket</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">target_shard</span><span class="p">)}</span>
</span><span id="__span-88-72"><a id="__codelineno-88-72" name="__codelineno-88-72" href="#__codelineno-88-72"></a>            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;GSI3SK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">gsi3_sk_bucket</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">target_shard</span><span class="p">)}</span>
</span><span id="__span-88-73"><a id="__codelineno-88-73" name="__codelineno-88-73" href="#__codelineno-88-73"></a>            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;GSI4SK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">gsi4_sk_bucket</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">target_shard</span><span class="p">)}</span>
</span><span id="__span-88-74"><a id="__codelineno-88-74" name="__codelineno-88-74" href="#__codelineno-88-74"></a>            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;shard_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_count</span><span class="p">)}</span>
</span><span id="__span-88-75"><a id="__codelineno-88-75" name="__codelineno-88-75" href="#__codelineno-88-75"></a>            <span class="c1"># Reset tokens to effective per-shard capacity (full bucket)</span>
</span><span id="__span-88-76"><a id="__codelineno-88-76" name="__codelineno-88-76" href="#__codelineno-88-76"></a>            <span class="k">for</span> <span class="n">limit_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">_extract_limit_attrs</span><span class="p">(</span><span class="n">new_image</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-88-77"><a id="__codelineno-88-77" name="__codelineno-88-77" href="#__codelineno-88-77"></a>                <span class="n">cp_milli</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;cp_milli&quot;</span><span class="p">]</span>
</span><span id="__span-88-78"><a id="__codelineno-88-78" name="__codelineno-88-78" href="#__codelineno-88-78"></a>                <span class="k">if</span> <span class="n">limit_name</span> <span class="o">==</span> <span class="n">WCU_LIMIT_NAME</span><span class="p">:</span>
</span><span id="__span-88-79"><a id="__codelineno-88-79" name="__codelineno-88-79" href="#__codelineno-88-79"></a>                    <span class="n">effective_cp</span> <span class="o">=</span> <span class="n">cp_milli</span>  <span class="c1"># wcu is per-partition, not divided</span>
</span><span id="__span-88-80"><a id="__codelineno-88-80" name="__codelineno-88-80" href="#__codelineno-88-80"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-88-81"><a id="__codelineno-88-81" name="__codelineno-88-81" href="#__codelineno-88-81"></a>                    <span class="n">effective_cp</span> <span class="o">=</span> <span class="n">cp_milli</span> <span class="o">//</span> <span class="n">new_count</span>
</span><span id="__span-88-82"><a id="__codelineno-88-82" name="__codelineno-88-82" href="#__codelineno-88-82"></a>                <span class="n">item</span><span class="p">[</span><span class="n">bucket_attr</span><span class="p">(</span><span class="n">limit_name</span><span class="p">,</span> <span class="n">BUCKET_FIELD_TK</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">effective_cp</span><span class="p">)}</span>
</span><span id="__span-88-83"><a id="__codelineno-88-83" name="__codelineno-88-83" href="#__codelineno-88-83"></a>                <span class="n">item</span><span class="p">[</span><span class="n">bucket_attr</span><span class="p">(</span><span class="n">limit_name</span><span class="p">,</span> <span class="n">BUCKET_FIELD_TC</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">}</span>
</span><span id="__span-88-84"><a id="__codelineno-88-84" name="__codelineno-88-84" href="#__codelineno-88-84"></a>            <span class="n">table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span id="__span-88-85"><a id="__codelineno-88-85" name="__codelineno-88-85" href="#__codelineno-88-85"></a>                <span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span>
</span><span id="__span-88-86"><a id="__codelineno-88-86" name="__codelineno-88-86" href="#__codelineno-88-86"></a>                <span class="n">ConditionExpression</span><span class="o">=</span><span class="s2">&quot;attribute_not_exists(PK)&quot;</span><span class="p">,</span>
</span><span id="__span-88-87"><a id="__codelineno-88-87" name="__codelineno-88-87" href="#__codelineno-88-87"></a>            <span class="p">)</span>
</span><span id="__span-88-88"><a id="__codelineno-88-88" name="__codelineno-88-88" href="#__codelineno-88-88"></a>            <span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-88-89"><a id="__codelineno-88-89" name="__codelineno-88-89" href="#__codelineno-88-89"></a>        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-88-90"><a id="__codelineno-88-90" name="__codelineno-88-90" href="#__codelineno-88-90"></a>            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">:</span>
</span><span id="__span-88-91"><a id="__codelineno-88-91" name="__codelineno-88-91" href="#__codelineno-88-91"></a>                <span class="k">continue</span>  <span class="c1"># Client already created this shard</span>
</span><span id="__span-88-92"><a id="__codelineno-88-92" name="__codelineno-88-92" href="#__codelineno-88-92"></a>            <span class="k">raise</span>
</span><span id="__span-88-93"><a id="__codelineno-88-93" name="__codelineno-88-93" href="#__codelineno-88-93"></a>
</span><span id="__span-88-94"><a id="__codelineno-88-94" name="__codelineno-88-94" href="#__codelineno-88-94"></a>    <span class="k">if</span> <span class="n">updated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-88-95"><a id="__codelineno-88-95" name="__codelineno-88-95" href="#__codelineno-88-95"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-88-96"><a id="__codelineno-88-96" name="__codelineno-88-96" href="#__codelineno-88-96"></a>            <span class="s2">&quot;Shard count propagated&quot;</span><span class="p">,</span>
</span><span id="__span-88-97"><a id="__codelineno-88-97" name="__codelineno-88-97" href="#__codelineno-88-97"></a>            <span class="n">entity_id</span><span class="o">=</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-88-98"><a id="__codelineno-88-98" name="__codelineno-88-98" href="#__codelineno-88-98"></a>            <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-88-99"><a id="__codelineno-88-99" name="__codelineno-88-99" href="#__codelineno-88-99"></a>            <span class="n">new_count</span><span class="o">=</span><span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-88-100"><a id="__codelineno-88-100" name="__codelineno-88-100" href="#__codelineno-88-100"></a>            <span class="n">shards_updated</span><span class="o">=</span><span class="n">updated</span><span class="p">,</span>
</span><span id="__span-88-101"><a id="__codelineno-88-101" name="__codelineno-88-101" href="#__codelineno-88-101"></a>        <span class="p">)</span>
</span><span id="__span-88-102"><a id="__codelineno-88-102" name="__codelineno-88-102" href="#__codelineno-88-102"></a>    <span class="k">return</span> <span class="n">updated</span>
</span></code></pre></div>
<p><strong>Note:</strong> <code>_extract_limit_attrs</code> is a helper that parses <code>b_{name}_cp</code> attributes from the NewImage to get limit names and their capacity values. This may already exist in the parser or can be extracted from <code>_parse_bucket_record</code>.</p>
<p><strong>Step 4: Run tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py -v</code>
Expected: PASS</p>
<p><strong>Step 5: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; fix(aggregator): pre-create full shard items during propagation to keep clients on fast path&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="task-37-fix-proactive-sharding-signal-to-use-wcu-token-level">Task 37: Fix proactive sharding signal to use wcu token level<a class="headerlink" href="#task-37-fix-proactive-sharding-signal-to-use-wcu-token-level" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> <code>try_proactive_shard()</code> (<code>processor.py:635-697</code>) compares <code>wcu_tc_delta / wcu_capacity_milli &gt;= 0.8</code>. This is dimensionally incorrect  <code>tc_delta</code> is a count (total consumed in this batch), while <code>capacity_milli</code> is a rate (tokens per second). The comparison produces a dimensionless ratio that varies with batch size rather than measuring actual partition pressure. With <code>BatchSize=100</code>, the maximum achievable ratio is <code>100  1000 / 1_000_000 = 0.1</code> (10%), so proactive sharding can never trigger.</p>
<p><strong>Three options considered:</strong>
- <strong>Option A (increase BatchSize):</strong> Requires <code>BatchSize &gt;= 800</code>  increases Lambda latency and cost, tight coupling to a constant.
- <strong>Option B (normalize by time span):</strong> <code>tc_delta / (time_span_sec  capacity_rate)</code>  requires per-bucket first/last timestamps, division-by-zero edge cases for sub-second batches.
- <strong>Option C (use remaining wcu token level):</strong> Check <code>wcu_tk_milli / wcu_cp_milli &lt; 0.2</code> (less than 20% tokens remaining). Token level directly measures partition headroom, naturally accounts for refill, requires no time span computation, and the data is already available in <code>BucketRefillState.tk_milli</code>.</p>
<p><strong>Decision: Option C.</strong> The token level from the last NewImage in the batch directly measures how much headroom the partition has. It naturally accounts for both consumption and refill. The only weakness is that aggregator refill can temporarily mask sustained pressure for one batch cycle, but this self-corrects: if pressure continues, tokens drain again and the next batch triggers sharding.</p>
<p><strong>Fix:</strong> Change <code>try_proactive_shard</code> signature and body:
- Remove <code>wcu_tc_delta</code> parameter
- Add <code>wcu_tk_milli</code> parameter (remaining wcu tokens from last NewImage)
- Change threshold check to <code>wcu_tk_milli / wcu_capacity_milli &lt; WCU_PROACTIVE_THRESHOLD_LOW</code> where <code>WCU_PROACTIVE_THRESHOLD_LOW = 0.2</code> (less than 20% remaining)
- Rename <code>WCU_PROACTIVE_THRESHOLD</code> to <code>WCU_PROACTIVE_THRESHOLD_LOW</code> to clarify it's a low-water mark</p>
<p><strong>BatchSize stays at 100</strong>  no CloudFormation change needed.</p>
<p><strong>Files:</strong>
- Modify: <code>src/zae_limiter_aggregator/processor.py</code> (<code>try_proactive_shard</code>, callers)
- Modify: <code>src/zae_limiter_aggregator/__init__.py</code> (if re-exports change)
- Test: <code>tests/unit/test_processor.py</code></p>
<p><strong>Step 1: Write failing tests</strong></p>
<p>In <code>tests/unit/test_processor.py</code>, update <code>TestTryProactiveShard</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_proactive_shard_triggers_at_low_token_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Proactive sharding triggers when wcu tokens &lt; 20% of capacity.&quot;&quot;&quot;</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_state</span><span class="p">(</span><span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shard_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>    <span class="c1"># 15% remaining  below 20% threshold  should trigger</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>    <span class="n">wcu_tk_milli</span> <span class="o">=</span> <span class="mi">150_000</span>  <span class="c1"># 15% of 1_000_000</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>    <span class="n">wcu_capacity_milli</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tk_milli</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_proactive_shard_skips_above_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-90-16"><a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;No sharding when wcu tokens &gt;= 20% of capacity.&quot;&quot;&quot;</span>
</span><span id="__span-90-17"><a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-90-18"><a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a>    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_state</span><span class="p">(</span><span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shard_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-90-19"><a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a>
</span><span id="__span-90-20"><a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a>    <span class="c1"># 25% remaining  above 20% threshold  no sharding</span>
</span><span id="__span-90-21"><a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a>    <span class="n">wcu_tk_milli</span> <span class="o">=</span> <span class="mi">250_000</span>
</span><span id="__span-90-22"><a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a>    <span class="n">wcu_capacity_milli</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span id="__span-90-23"><a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a>
</span><span id="__span-90-24"><a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tk_milli</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span><span id="__span-90-25"><a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a>
</span><span id="__span-90-26"><a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
</span><span id="__span-90-27"><a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a>    <span class="n">mock_table</span><span class="o">.</span><span class="n">update_item</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</span><span id="__span-90-28"><a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a>
</span><span id="__span-90-29"><a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_proactive_shard_triggers_at_zero_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-90-30"><a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Proactive sharding triggers when wcu tokens are completely exhausted.&quot;&quot;&quot;</span>
</span><span id="__span-90-31"><a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-90-32"><a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a>    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_state</span><span class="p">(</span><span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shard_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-90-33"><a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a>
</span><span id="__span-90-34"><a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="__span-90-35"><a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a>
</span><span id="__span-90-36"><a id="__codelineno-90-36" name="__codelineno-90-36" href="#__codelineno-90-36"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</span><span id="__span-90-37"><a id="__codelineno-90-37" name="__codelineno-90-37" href="#__codelineno-90-37"></a>
</span><span id="__span-90-38"><a id="__codelineno-90-38" name="__codelineno-90-38" href="#__codelineno-90-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_proactive_shard_boundary_at_exactly_20_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-90-39"><a id="__codelineno-90-39" name="__codelineno-90-39" href="#__codelineno-90-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;At exactly 20% remaining, no sharding (threshold is strictly less than).&quot;&quot;&quot;</span>
</span><span id="__span-90-40"><a id="__codelineno-90-40" name="__codelineno-90-40" href="#__codelineno-90-40"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-90-41"><a id="__codelineno-90-41" name="__codelineno-90-41" href="#__codelineno-90-41"></a>    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_state</span><span class="p">(</span><span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shard_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-90-42"><a id="__codelineno-90-42" name="__codelineno-90-42" href="#__codelineno-90-42"></a>
</span><span id="__span-90-43"><a id="__codelineno-90-43" name="__codelineno-90-43" href="#__codelineno-90-43"></a>    <span class="n">wcu_tk_milli</span> <span class="o">=</span> <span class="mi">200_000</span>  <span class="c1"># Exactly 20%</span>
</span><span id="__span-90-44"><a id="__codelineno-90-44" name="__codelineno-90-44" href="#__codelineno-90-44"></a>    <span class="n">wcu_capacity_milli</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span id="__span-90-45"><a id="__codelineno-90-45" name="__codelineno-90-45" href="#__codelineno-90-45"></a>
</span><span id="__span-90-46"><a id="__codelineno-90-46" name="__codelineno-90-46" href="#__codelineno-90-46"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tk_milli</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span><span id="__span-90-47"><a id="__codelineno-90-47" name="__codelineno-90-47" href="#__codelineno-90-47"></a>
</span><span id="__span-90-48"><a id="__codelineno-90-48" name="__codelineno-90-48" href="#__codelineno-90-48"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>  <span class="c1"># Not strictly less than 20%</span>
</span><span id="__span-90-49"><a id="__codelineno-90-49" name="__codelineno-90-49" href="#__codelineno-90-49"></a>
</span><span id="__span-90-50"><a id="__codelineno-90-50" name="__codelineno-90-50" href="#__codelineno-90-50"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_proactive_shard_negative_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-90-51"><a id="__codelineno-90-51" name="__codelineno-90-51" href="#__codelineno-90-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Negative tokens (overdrawn wcu) trigger sharding.&quot;&quot;&quot;</span>
</span><span id="__span-90-52"><a id="__codelineno-90-52" name="__codelineno-90-52" href="#__codelineno-90-52"></a>    <span class="n">mock_table</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-90-53"><a id="__codelineno-90-53" name="__codelineno-90-53" href="#__codelineno-90-53"></a>    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_state</span><span class="p">(</span><span class="n">shard_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shard_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-90-54"><a id="__codelineno-90-54" name="__codelineno-90-54" href="#__codelineno-90-54"></a>
</span><span id="__span-90-55"><a id="__codelineno-90-55" name="__codelineno-90-55" href="#__codelineno-90-55"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">mock_table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">-</span><span class="mi">50_000</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="__span-90-56"><a id="__codelineno-90-56" name="__codelineno-90-56" href="#__codelineno-90-56"></a>
</span><span id="__span-90-57"><a id="__codelineno-90-57" name="__codelineno-90-57" href="#__codelineno-90-57"></a>    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</span></code></pre></div>
<p><strong>Step 2: Run tests to verify they fail</strong></p>
<p>Run: <code>uv run pytest tests/unit/test_processor.py::TestTryProactiveShard -v</code>
Expected: FAIL (old signature takes <code>wcu_tc_delta</code>, not <code>wcu_tk_milli</code>; old logic checks <code>&gt;=0.8</code> not <code>&lt;0.2</code>)</p>
<p><strong>Step 3: Update try_proactive_shard</strong></p>
<p>In <code>processor.py</code>, replace the function:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="n">WCU_PROACTIVE_THRESHOLD_LOW</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># Shard when wcu tokens &lt; 20% of capacity</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">try_proactive_shard</span><span class="p">(</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a>    <span class="n">state</span><span class="p">:</span> <span class="n">BucketRefillState</span><span class="p">,</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>    <span class="n">wcu_tk_milli</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a>    <span class="n">wcu_capacity_milli</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-91-10"><a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Proactively double shard_count when wcu token level is low.</span>
</span><span id="__span-91-11"><a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>
</span><span id="__span-91-12"><a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a><span class="sd">    Checks remaining wcu tokens against capacity. When tokens drop</span>
</span><span id="__span-91-13"><a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a><span class="sd">    below 20% of capacity, the partition is under sustained write</span>
</span><span id="__span-91-14"><a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a><span class="sd">    pressure and should be split.</span>
</span><span id="__span-91-15"><a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a>
</span><span id="__span-91-16"><a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a><span class="sd">    Only acts on shard 0 (source of truth for shard_count).</span>
</span><span id="__span-91-17"><a id="__codelineno-91-17" name="__codelineno-91-17" href="#__codelineno-91-17"></a><span class="sd">    Uses conditional write to prevent double-bumping.</span>
</span><span id="__span-91-18"><a id="__codelineno-91-18" name="__codelineno-91-18" href="#__codelineno-91-18"></a>
</span><span id="__span-91-19"><a id="__codelineno-91-19" name="__codelineno-91-19" href="#__codelineno-91-19"></a><span class="sd">    Args:</span>
</span><span id="__span-91-20"><a id="__codelineno-91-20" name="__codelineno-91-20" href="#__codelineno-91-20"></a><span class="sd">        table: boto3 Table resource</span>
</span><span id="__span-91-21"><a id="__codelineno-91-21" name="__codelineno-91-21" href="#__codelineno-91-21"></a><span class="sd">        state: Aggregated bucket state</span>
</span><span id="__span-91-22"><a id="__codelineno-91-22" name="__codelineno-91-22" href="#__codelineno-91-22"></a><span class="sd">        wcu_tk_milli: Remaining wcu tokens in millitokens (from last NewImage)</span>
</span><span id="__span-91-23"><a id="__codelineno-91-23" name="__codelineno-91-23" href="#__codelineno-91-23"></a><span class="sd">        wcu_capacity_milli: wcu capacity in millitokens</span>
</span><span id="__span-91-24"><a id="__codelineno-91-24" name="__codelineno-91-24" href="#__codelineno-91-24"></a>
</span><span id="__span-91-25"><a id="__codelineno-91-25" name="__codelineno-91-25" href="#__codelineno-91-25"></a><span class="sd">    Returns:</span>
</span><span id="__span-91-26"><a id="__codelineno-91-26" name="__codelineno-91-26" href="#__codelineno-91-26"></a><span class="sd">        True if shard_count was bumped, False otherwise</span>
</span><span id="__span-91-27"><a id="__codelineno-91-27" name="__codelineno-91-27" href="#__codelineno-91-27"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-91-28"><a id="__codelineno-91-28" name="__codelineno-91-28" href="#__codelineno-91-28"></a>    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">shard_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-91-29"><a id="__codelineno-91-29" name="__codelineno-91-29" href="#__codelineno-91-29"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-91-30"><a id="__codelineno-91-30" name="__codelineno-91-30" href="#__codelineno-91-30"></a>
</span><span id="__span-91-31"><a id="__codelineno-91-31" name="__codelineno-91-31" href="#__codelineno-91-31"></a>    <span class="k">if</span> <span class="n">wcu_capacity_milli</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-91-32"><a id="__codelineno-91-32" name="__codelineno-91-32" href="#__codelineno-91-32"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-91-33"><a id="__codelineno-91-33" name="__codelineno-91-33" href="#__codelineno-91-33"></a>
</span><span id="__span-91-34"><a id="__codelineno-91-34" name="__codelineno-91-34" href="#__codelineno-91-34"></a>    <span class="n">token_ratio</span> <span class="o">=</span> <span class="n">wcu_tk_milli</span> <span class="o">/</span> <span class="n">wcu_capacity_milli</span>
</span><span id="__span-91-35"><a id="__codelineno-91-35" name="__codelineno-91-35" href="#__codelineno-91-35"></a>    <span class="k">if</span> <span class="n">token_ratio</span> <span class="o">&gt;=</span> <span class="n">WCU_PROACTIVE_THRESHOLD_LOW</span><span class="p">:</span>
</span><span id="__span-91-36"><a id="__codelineno-91-36" name="__codelineno-91-36" href="#__codelineno-91-36"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-91-37"><a id="__codelineno-91-37" name="__codelineno-91-37" href="#__codelineno-91-37"></a>
</span><span id="__span-91-38"><a id="__codelineno-91-38" name="__codelineno-91-38" href="#__codelineno-91-38"></a>    <span class="n">new_count</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="__span-91-39"><a id="__codelineno-91-39" name="__codelineno-91-39" href="#__codelineno-91-39"></a>
</span><span id="__span-91-40"><a id="__codelineno-91-40" name="__codelineno-91-40" href="#__codelineno-91-40"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-91-41"><a id="__codelineno-91-41" name="__codelineno-91-41" href="#__codelineno-91-41"></a>        <span class="n">table</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
</span><span id="__span-91-42"><a id="__codelineno-91-42" name="__codelineno-91-42" href="#__codelineno-91-42"></a>            <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-91-43"><a id="__codelineno-91-43" name="__codelineno-91-43" href="#__codelineno-91-43"></a>                <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="n">pk_bucket</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">namespace_id</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="__span-91-44"><a id="__codelineno-91-44" name="__codelineno-91-44" href="#__codelineno-91-44"></a>                <span class="s2">&quot;SK&quot;</span><span class="p">:</span> <span class="n">sk_state</span><span class="p">(),</span>
</span><span id="__span-91-45"><a id="__codelineno-91-45" name="__codelineno-91-45" href="#__codelineno-91-45"></a>            <span class="p">},</span>
</span><span id="__span-91-46"><a id="__codelineno-91-46" name="__codelineno-91-46" href="#__codelineno-91-46"></a>            <span class="n">UpdateExpression</span><span class="o">=</span><span class="s2">&quot;SET shard_count = :new&quot;</span><span class="p">,</span>
</span><span id="__span-91-47"><a id="__codelineno-91-47" name="__codelineno-91-47" href="#__codelineno-91-47"></a>            <span class="n">ConditionExpression</span><span class="o">=</span><span class="s2">&quot;shard_count = :old&quot;</span><span class="p">,</span>
</span><span id="__span-91-48"><a id="__codelineno-91-48" name="__codelineno-91-48" href="#__codelineno-91-48"></a>            <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-91-49"><a id="__codelineno-91-49" name="__codelineno-91-49" href="#__codelineno-91-49"></a>                <span class="s2">&quot;:old&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">shard_count</span><span class="p">,</span>
</span><span id="__span-91-50"><a id="__codelineno-91-50" name="__codelineno-91-50" href="#__codelineno-91-50"></a>                <span class="s2">&quot;:new&quot;</span><span class="p">:</span> <span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-91-51"><a id="__codelineno-91-51" name="__codelineno-91-51" href="#__codelineno-91-51"></a>            <span class="p">},</span>
</span><span id="__span-91-52"><a id="__codelineno-91-52" name="__codelineno-91-52" href="#__codelineno-91-52"></a>        <span class="p">)</span>
</span><span id="__span-91-53"><a id="__codelineno-91-53" name="__codelineno-91-53" href="#__codelineno-91-53"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-91-54"><a id="__codelineno-91-54" name="__codelineno-91-54" href="#__codelineno-91-54"></a>            <span class="s2">&quot;Proactive shard doubling&quot;</span><span class="p">,</span>
</span><span id="__span-91-55"><a id="__codelineno-91-55" name="__codelineno-91-55" href="#__codelineno-91-55"></a>            <span class="n">entity_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-91-56"><a id="__codelineno-91-56" name="__codelineno-91-56" href="#__codelineno-91-56"></a>            <span class="n">resource</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-91-57"><a id="__codelineno-91-57" name="__codelineno-91-57" href="#__codelineno-91-57"></a>            <span class="n">old_count</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">shard_count</span><span class="p">,</span>
</span><span id="__span-91-58"><a id="__codelineno-91-58" name="__codelineno-91-58" href="#__codelineno-91-58"></a>            <span class="n">new_count</span><span class="o">=</span><span class="n">new_count</span><span class="p">,</span>
</span><span id="__span-91-59"><a id="__codelineno-91-59" name="__codelineno-91-59" href="#__codelineno-91-59"></a>            <span class="n">token_ratio</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">token_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="__span-91-60"><a id="__codelineno-91-60" name="__codelineno-91-60" href="#__codelineno-91-60"></a>        <span class="p">)</span>
</span><span id="__span-91-61"><a id="__codelineno-91-61" name="__codelineno-91-61" href="#__codelineno-91-61"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-91-62"><a id="__codelineno-91-62" name="__codelineno-91-62" href="#__codelineno-91-62"></a>    <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-91-63"><a id="__codelineno-91-63" name="__codelineno-91-63" href="#__codelineno-91-63"></a>        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ConditionalCheckFailedException&quot;</span><span class="p">:</span>
</span><span id="__span-91-64"><a id="__codelineno-91-64" name="__codelineno-91-64" href="#__codelineno-91-64"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="__span-91-65"><a id="__codelineno-91-65" name="__codelineno-91-65" href="#__codelineno-91-65"></a>                <span class="s2">&quot;Proactive shard skipped - concurrent bump&quot;</span><span class="p">,</span>
</span><span id="__span-91-66"><a id="__codelineno-91-66" name="__codelineno-91-66" href="#__codelineno-91-66"></a>                <span class="n">entity_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">entity_id</span><span class="p">,</span>
</span><span id="__span-91-67"><a id="__codelineno-91-67" name="__codelineno-91-67" href="#__codelineno-91-67"></a>                <span class="n">resource</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
</span><span id="__span-91-68"><a id="__codelineno-91-68" name="__codelineno-91-68" href="#__codelineno-91-68"></a>            <span class="p">)</span>
</span><span id="__span-91-69"><a id="__codelineno-91-69" name="__codelineno-91-69" href="#__codelineno-91-69"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-91-70"><a id="__codelineno-91-70" name="__codelineno-91-70" href="#__codelineno-91-70"></a>        <span class="k">raise</span>
</span></code></pre></div>
<p><strong>Step 4: Update callers</strong></p>
<p>In the <code>process_records()</code> function, change the call site from:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="c1"># Before:</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="n">wcu_tc_delta</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># accumulated from extract_deltas</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tc_delta</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="c1"># After:</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="n">wcu_tk_milli</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="n">WCU_LIMIT_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">tk_milli</span>  <span class="c1"># from last NewImage</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="n">try_proactive_shard</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">wcu_tk_milli</span><span class="p">,</span> <span class="n">wcu_capacity_milli</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 5: Remove Task 34's <code>test_unreachable_at_batch_size_100</code> test</strong></p>
<p>This test documents that proactive sharding can't trigger at BatchSize=100 using the old tc_delta metric. With the new token-level signal, proactive sharding can trigger at any batch size, so this test becomes incorrect. Remove it.</p>
<p><strong>Step 6: Run all unit tests</strong></p>
<p>Run: <code>uv run pytest tests/unit/ -v</code>
Expected: PASS</p>
<p><strong>Step 7: Commit</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a>git<span class="w"> </span>add<span class="w"> </span>src/zae_limiter_aggregator/processor.py<span class="w"> </span>tests/unit/test_processor.py
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot; fix(aggregator): use wcu token level for proactive sharding signal instead of tc_delta&quot;</span>
</span></code></pre></div>
<h4 id="task-37-test-plan">Task 37 Test Plan<a class="headerlink" href="#task-37-test-plan" title="Permanent link">&para;</a></h4>
<p><strong>Scope:</strong> 24 tests across 4 layers validating the signal change from <code>tc_delta/capacity &gt;= 0.8</code> to <code>tk_milli/capacity &lt; 0.2</code>.</p>
<h5 id="unit-tests-testsunittest_processorpytesttryproactiveshard">Unit Tests  <code>tests/unit/test_processor.py::TestTryProactiveShard</code><a class="headerlink" href="#unit-tests-testsunittest_processorpytesttryproactiveshard" title="Permanent link">&para;</a></h5>
<p><strong>Existing tests to update</strong> (rename <code>wcu_tc_delta</code>  <code>wcu_tk_milli</code>, invert threshold logic):</p>
<table>
<thead>
<tr>
<th>#</th>
<th>Test</th>
<th>Old Params</th>
<th>New Params</th>
<th>Expected</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>test_triggers_at_threshold</code></td>
<td><code>tc_delta=900k</code> (90%&gt;80%)</td>
<td><code>tk_milli=100k</code> (10%&lt;20%)</td>
<td>True</td>
</tr>
<tr>
<td>2</td>
<td><code>test_skips_below_threshold</code></td>
<td><code>tc_delta=500k</code> (50%&lt;80%)</td>
<td><code>tk_milli=500k</code> (50%&gt;=20%)</td>
<td>False</td>
</tr>
<tr>
<td>3</td>
<td><code>test_skips_non_shard_0</code></td>
<td>param rename</td>
<td><code>tk_milli=100k</code></td>
<td>False</td>
</tr>
<tr>
<td>4</td>
<td><code>test_conditional_check_failure_returns_false</code></td>
<td>param rename</td>
<td><code>tk_milli=100k</code></td>
<td>False</td>
</tr>
<tr>
<td>5</td>
<td><code>test_zero_capacity_skips</code></td>
<td><code>tc_delta=900k, cap=0</code></td>
<td><code>tk_milli=0, cap=0</code></td>
<td>False</td>
</tr>
</tbody>
</table>
<p><strong>New unit tests:</strong></p>
<table>
<thead>
<tr>
<th>#</th>
<th>Test</th>
<th>Token Level</th>
<th>Capacity</th>
<th>Expected</th>
<th>Edge Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>6</td>
<td><code>test_triggers_at_low_token_level</code></td>
<td>150,000 (15%)</td>
<td>1,000,000</td>
<td>True</td>
<td>Core happy path</td>
</tr>
<tr>
<td>7</td>
<td><code>test_skips_above_threshold</code></td>
<td>250,000 (25%)</td>
<td>1,000,000</td>
<td>False</td>
<td>Core negative path</td>
</tr>
<tr>
<td>8</td>
<td><code>test_triggers_at_zero_tokens</code></td>
<td>0</td>
<td>1,000,000</td>
<td>True</td>
<td>Complete exhaustion</td>
</tr>
<tr>
<td>9</td>
<td><code>test_boundary_at_exactly_20_percent</code></td>
<td>200,000 (20%)</td>
<td>1,000,000</td>
<td>False</td>
<td>Boundary: <code>&gt;=</code> is safe, <code>&lt;</code> shards</td>
</tr>
<tr>
<td>10</td>
<td><code>test_negative_tokens_triggers</code></td>
<td>-50,000</td>
<td>1,000,000</td>
<td>True</td>
<td>Overdrawn wcu via adjustment</td>
</tr>
<tr>
<td>11</td>
<td><code>test_one_millitoken_below_threshold</code></td>
<td>199,999</td>
<td>1,000,000</td>
<td>True</td>
<td>Off-by-one: 19.9999% &lt; 20%</td>
</tr>
<tr>
<td>12</td>
<td><code>test_doubles_shard_count_from_2</code></td>
<td>100,000</td>
<td>1,000,000</td>
<td>True, new=4</td>
<td>Verify <code>shard_count * 2</code> with existing count=2</td>
</tr>
<tr>
<td>13</td>
<td><code>test_negative_capacity_skips</code></td>
<td>100,000</td>
<td>-1,000,000</td>
<td>False</td>
<td>Corrupted data guard</td>
</tr>
<tr>
<td>14</td>
<td><code>test_batch_size_independent</code></td>
<td>100,000</td>
<td>1,000,000</td>
<td>True</td>
<td>Token level is invariant to BatchSize</td>
</tr>
</tbody>
</table>
<p><strong>Test to remove:</strong>
- <code>test_unreachable_at_batch_size_100</code> (Task 34)  documents the tc_delta limitation; no longer applicable with token-level signal.</p>
<p><strong>Constant rename regression:</strong></p>
<table>
<thead>
<tr>
<th>#</th>
<th>Test</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>15</td>
<td><code>test_constant_renamed</code></td>
<td>Assert <code>WCU_PROACTIVE_THRESHOLD_LOW</code> exists and <code>WCU_PROACTIVE_THRESHOLD</code> is removed</td>
</tr>
</tbody>
</table>
<h5 id="caller-wiring-tests-testsunittest_processorpytestprocessstreamrecords">Caller Wiring Tests  <code>tests/unit/test_processor.py::TestProcessStreamRecords</code><a class="headerlink" href="#caller-wiring-tests-testsunittest_processorpytestprocessstreamrecords" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>#</th>
<th>Test</th>
<th>Description</th>
<th>Validate</th>
</tr>
</thead>
<tbody>
<tr>
<td>16</td>
<td><code>test_process_records_passes_tk_milli</code></td>
<td>Mock <code>try_proactive_shard</code>, verify call uses <code>wcu_tk_milli=wcu_info.tk_milli</code></td>
<td>Correct parameter wiring at <code>processor.py:233-238</code></td>
</tr>
<tr>
<td>17</td>
<td><code>test_process_records_proactive_shard_selective</code></td>
<td>Two bucket states: one with 15% wcu remaining, one with 50%</td>
<td>Only the low-level bucket triggers sharding</td>
</tr>
</tbody>
</table>
<h5 id="integration-tests-testsintegrationtest_bucket_shardingpytestproactiveshardingintegration">Integration Tests  <code>tests/integration/test_bucket_sharding.py::TestProactiveShardingIntegration</code><a class="headerlink" href="#integration-tests-testsintegrationtest_bucket_shardingpytestproactiveshardingintegration" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>#</th>
<th>Test</th>
<th>Description</th>
<th>Validate</th>
</tr>
</thead>
<tbody>
<tr>
<td>18</td>
<td><code>test_proactive_shard_doubles_count</code> (update)</td>
<td>Change call from <code>wcu_tc_delta=900k</code> to <code>wcu_tk_milli=100k</code></td>
<td>DynamoDB conditional write succeeds, shard_count 12</td>
</tr>
<tr>
<td>19</td>
<td><code>test_proactive_shard_skips_healthy_bucket</code></td>
<td>Seed bucket with <code>wcu_tk=500k</code> (50%), call with <code>wcu_tk_milli=500k</code></td>
<td>No write, shard_count unchanged</td>
</tr>
<tr>
<td>20</td>
<td><code>test_proactive_shard_after_refill</code></td>
<td>Seed bucket with <code>wcu_tk=800k</code> (80% after aggregator refill)</td>
<td>No sharding  refill masks pressure for one cycle (expected)</td>
</tr>
<tr>
<td>21</td>
<td><code>test_proactive_shard_sustained_pressure</code></td>
<td>Two sequential calls: first 80% tokens (no shard), second 10% (shard)</td>
<td>Self-correction: sustained pressure triggers on next batch</td>
</tr>
</tbody>
</table>
<h5 id="e2e-tests-testse2etest_localstackpy-new-class-testproactiveshardinge2e">E2E Tests  <code>tests/e2e/test_localstack.py</code> (new class <code>TestProactiveShardingE2E</code>)<a class="headerlink" href="#e2e-tests-testse2etest_localstackpy-new-class-testproactiveshardinge2e" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>#</th>
<th>Test</th>
<th>Description</th>
<th>Validate</th>
</tr>
</thead>
<tbody>
<tr>
<td>22</td>
<td><code>test_aggregator_proactive_sharding_e2e</code></td>
<td>Create entity, exhaust wcu via rapid speculative writes, wait for Lambda stream processing</td>
<td>Full pipeline: writes  Stream  Lambda  proactive shard  propagation</td>
</tr>
<tr>
<td>23</td>
<td><code>test_aggregator_no_shard_under_normal_load</code></td>
<td>Create entity, moderate writes (below threshold), wait for Lambda</td>
<td>No false positives under normal load</td>
</tr>
<tr>
<td>24</td>
<td><code>test_aggregator_refill_then_drain_e2e</code></td>
<td>Exhaust, wait for refill (tokens recover), exhaust again, verify shard on second cycle</td>
<td>End-to-end validation of the refill-masking self-correction</td>
</tr>
</tbody>
</table>
<p><strong>E2E markers:</strong> <code>@pytest.mark.e2e</code>, <code>@pytest.mark.slow</code> (stream processing delay ~30s).</p>
<h5 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Count</th>
<th>Files</th>
<th>Backend</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit (function-level)</td>
<td>14</td>
<td><code>test_processor.py</code></td>
<td>Mocked</td>
</tr>
<tr>
<td>Constant regression</td>
<td>1</td>
<td><code>test_processor.py</code></td>
<td>Mocked</td>
</tr>
<tr>
<td>Caller wiring</td>
<td>2</td>
<td><code>test_processor.py</code></td>
<td>Mocked</td>
</tr>
<tr>
<td>Integration (DynamoDB)</td>
<td>4</td>
<td><code>test_bucket_sharding.py</code></td>
<td>LocalStack</td>
</tr>
<tr>
<td>E2E (full pipeline)</td>
<td>3</td>
<td><code>test_localstack.py</code></td>
<td>LocalStack + Lambda</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>24</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h5 id="key-edge-cases">Key Edge Cases<a class="headerlink" href="#key-edge-cases" title="Permanent link">&para;</a></h5>
<ol>
<li><strong>Boundary precision:</strong> Exactly 20% is safe, 19.9999% triggers</li>
<li><strong>Negative tokens:</strong> Overdrawn wcu still triggers (strongest signal)</li>
<li><strong>Zero/negative capacity:</strong> Division-by-zero and corrupted data guards</li>
<li><strong>Aggregator refill masking:</strong> After refill, tokens recover  no shard for one cycle  self-corrects next batch</li>
<li><strong>Batch size independence:</strong> Token level is invariant to <code>BatchSize</code> (unlike tc_delta)</li>
<li><strong>Concurrent bumps:</strong> <code>ConditionalCheckFailedException</code> returns <code>False</code></li>
<li><strong>Non-shard-0:</strong> Only shard 0 triggers (source of truth)</li>
</ol>












                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/zeroae/zae-limiter" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/zae-limiter/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.top", "navigation.footer", "content.code.copy", "content.code.annotate", "content.action.edit", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
    
  </body>
</html>