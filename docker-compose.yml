# LocalStack for local development and testing
# Usage: docker compose up -d
#
# This starts LocalStack with all services needed for zae-limiter:
# - DynamoDB and DynamoDB Streams
# - Lambda (requires Docker socket mount)
# - CloudFormation, IAM, CloudWatch, SQS
#
# Once running, deploy the stack:
#   zae-limiter deploy --name limiter --endpoint-url http://localhost:4566 --region us-east-1
#
# Run tests (set AWS credentials for LocalStack):
#   export AWS_ENDPOINT_URL=http://localhost:4566 AWS_ACCESS_KEY_ID=test AWS_SECRET_ACCESS_KEY=test AWS_DEFAULT_REGION=us-east-1
#   uv run pytest tests/integration/ -v
#   uv run pytest tests/e2e/test_localstack.py -v

name: zae-limiter

services:
  localstack:
    image: localstack/localstack:4.14
    container_name: zae-limiter-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=dynamodb,dynamodbstreams,lambda,cloudformation,logs,iam,cloudwatch,sqs,s3,sts,resourcegroupstaggingapi
      - DEBUG=0
      - DYNAMODB_REMOVE_EXPIRED_ITEMS=1
    volumes:
      # Docker socket required for Lambda execution
      - "/var/run/docker.sock:/var/run/docker.sock"
      # Persistence for faster restarts
      - "${TMPDIR:-/tmp}/localstack:/var/lib/localstack"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 30
